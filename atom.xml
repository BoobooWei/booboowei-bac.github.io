<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Amy and Booboo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.toberoot.com/"/>
  <updated>2020-03-22T14:23:51.136Z</updated>
  <id>http://www.toberoot.com/</id>
  
  <author>
    <name>BoobooWei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://www.toberoot.com/2020/03/22/booboo_others/hello-world/"/>
    <id>http://www.toberoot.com/2020/03/22/booboo_others/hello-world/</id>
    <published>2020-03-22T14:23:51.136Z</published>
    <updated>2020-03-22T14:23:51.136Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="Hexo" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/Hexo/"/>
    
    
      <category term="hexo" scheme="http://www.toberoot.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>国庆前学洗手</title>
    <link href="http://www.toberoot.com/2018/09/30/amy_life/%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/"/>
    <id>http://www.toberoot.com/2018/09/30/amy_life/%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/</id>
    <published>2018-09-30T10:43:53.000Z</published>
    <updated>2020-03-22T08:31:38.472Z</updated>
    
    <content type="html"><![CDATA[<p>今天人少，我们坐小月亮，然后给他们每人用了免洗洗手液，洗小手，国庆节出去不要忘记带哦</p><a id="more"></a><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0NDI5Ng==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p><p><img src="%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/01.jpg" alt=""></p><p>君君老师:<br>他们让我发给你们😂</p><p>小慈的晚托班制作五星红旗</p><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0OTg4MA==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天人少，我们坐小月亮，然后给他们每人用了免洗洗手液，洗小手，国庆节出去不要忘记带哦&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>宝宝们上班啦</title>
    <link href="http://www.toberoot.com/2018/09/29/amy_life/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/"/>
    <id>http://www.toberoot.com/2018/09/29/amy_life/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/</id>
    <published>2018-09-29T10:43:41.000Z</published>
    <updated>2020-03-22T08:31:38.457Z</updated>
    
    <content type="html"><![CDATA[<p>君君老师:<br>最近我们孩子的角色游戏慢慢进入状态了，但也有几个孩子沉迷于积木游戏无法自拔，我们希望家长们在家里也可以和孩子们一起玩角色扮演游戏，和孩子多互动，也可以拓宽思路，可以做现实生活中不能做的，比如仙女啊，公主啊，小士兵等等</p><a id="more"></a><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/01.jpg" alt=""></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/02.jpg" alt="02"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/03.jpg" alt="03"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/04.jpg" alt="04"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/05.jpg" alt="05"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/06.jpg" alt="06"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/07.jpg" alt="07"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/08.jpg" alt="08"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/09.jpg" alt="09"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/10.jpg" alt="10"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/11.jpg" alt="11"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/12.jpg" alt="12"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/13.jpg" alt="13"></p><p>君君老师:<br>今天我们还认识了五星红旗，知道自己是一个中国人，我告诉他们过几天要给祖国妈妈过生日了，要休息七天，有孩子还反驳说不行，休息三天就够了，哈哈我还告诉他们祖国妈妈会请他们吃生日蛋糕的</p><p>午餐前还额外学了一首歌，送给我们的祖国妈妈</p><p><a href="https://music.163.com/#/song?id=498555737&market=baiduqk" target="_blank" rel="noopener">儿歌-祖国祖国我爱你</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;君君老师:&lt;br&gt;最近我们孩子的角色游戏慢慢进入状态了，但也有几个孩子沉迷于积木游戏无法自拔，我们希望家长们在家里也可以和孩子们一起玩角色扮演游戏，和孩子多互动，也可以拓宽思路，可以做现实生活中不能做的，比如仙女啊，公主啊，小士兵等等&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>月饼烘培和小小搬运工</title>
    <link href="http://www.toberoot.com/2018/09/21/amy_life/%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/"/>
    <id>http://www.toberoot.com/2018/09/21/amy_life/%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/</id>
    <published>2018-09-21T12:25:51.000Z</published>
    <updated>2020-03-22T08:31:38.460Z</updated>
    
    <content type="html"><![CDATA[<p>中秋节快到了，老师带宝宝们一起做了月饼，拿去烤了，宝宝们还帮老师一起搬桌子，虽然结局差强人意，但是孩子们都很开心呢！</p><a id="more"></a><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0NDg5Ng==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/01.jpg" alt=""></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/02.jpg" alt="02"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/03.jpg" alt="03"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/04.jpg" alt="04"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/05.jpg" alt="05"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/06.jpg" alt="06"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/07.jpg" alt="07"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/08.jpg" alt="08"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/09.jpg" alt="09"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/20.jpg" alt="20"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/00.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;中秋节快到了，老师带宝宝们一起做了月饼，拿去烤了，宝宝们还帮老师一起搬桌子，虽然结局差强人意，但是孩子们都很开心呢！&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>宝宝们开始漱口了</title>
    <link href="http://www.toberoot.com/2018/09/20/amy_life/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/"/>
    <id>http://www.toberoot.com/2018/09/20/amy_life/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/</id>
    <published>2018-09-20T12:08:51.000Z</published>
    <updated>2020-03-22T08:31:38.469Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～</p><a id="more"></a><p>君君老师语录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">各位亲们，通过昨天的家长会，我们看到了家长回去的努力，今天午饭明显进步的宝宝有：@张瑾安妈妈 @操梓桐妈妈 @但颐宸妈妈 @何晟睿妈妈 @张恬觅妈妈 @严魏慈妈妈 @王晟宁妈妈 ，其他宝宝们继续加油哦～</span><br><span class="line"></span><br><span class="line">吃饭我们是和孩子们说：小汽车装装满，转弯送到山洞里，滑滑梯滑到肚子里，因为很多宝宝勺子不对着嘴巴，所以饭宝宝掉在桌子上都哭了。</span><br><span class="line"></span><br><span class="line">另外，今天我们练习了宝宝们排队走楼梯，大多数已经像模像样的了，上下楼梯靠右走了，今天的运动量有点大，所以估计宝贝们今晚又要早早睡觉了.</span><br></pre></td></tr></table></figure><p>今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～</p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/01.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>家长会</title>
    <link href="http://www.toberoot.com/2018/09/19/amy_life/%E5%AE%B6%E9%95%BF%E4%BC%9A/"/>
    <id>http://www.toberoot.com/2018/09/19/amy_life/%E5%AE%B6%E9%95%BF%E4%BC%9A/</id>
    <published>2018-09-19T11:40:55.000Z</published>
    <updated>2020-03-22T08:31:38.466Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：幼儿园开学第10天，宝宝们逐渐稳定，融入这个大家庭，今天老师和我们分享宝宝们的幼儿园日常生活，以及我们对我们家长的一些建议，非常地用心。</p><a id="more"></a><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/001.jpg" alt=""></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/002.jpg" alt="002"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/003.jpg" alt="003"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/004.jpg" alt="004"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/005.jpg" alt="005"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/006.jpg" alt="006"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/007.jpg" alt="007"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/008.jpg" alt="008"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/010.jpg" alt="010"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/011.jpg" alt="011"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/012.jpg" alt="012"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/013.jpg" alt="013"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/014.jpg" alt="014"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/015.jpg" alt="015"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/016.jpg" alt="016"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/017.jpg" alt="017"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/018.jpg" alt="018"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/019.jpg" alt="019"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/020.jpg" alt="020"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/021.jpg" alt="021"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/022.jpg" alt="022"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/023.jpg" alt="023"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/024.jpg" alt="024"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/025.jpg" alt="025"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/026.jpg" alt="026"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/027.jpg" alt="027"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/028.jpg" alt="028"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/029.jpg" alt="029"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/030.jpg" alt="030"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：幼儿园开学第10天，宝宝们逐渐稳定，融入这个大家庭，今天老师和我们分享宝宝们的幼儿园日常生活，以及我们对我们家长的一些建议，非常地用心。&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>向月亮说晚安</title>
    <link href="http://www.toberoot.com/2018/09/10/amy_life/%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/"/>
    <id>http://www.toberoot.com/2018/09/10/amy_life/%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/</id>
    <published>2018-09-10T11:26:39.000Z</published>
    <updated>2020-03-22T08:31:38.463Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：今天中午讲了一个关于「晚安，月亮」的睡前故事，最后猫头鹰对月亮说了晚安，大家今天睡前还可以和宝宝说哦，再加一些其他的动物宝宝</p><a id="more"></a><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/01.jpg" alt=""></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/02.jpg" alt="02"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/03.jpg" alt="03"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/04.jpg" alt="04"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/05.jpg" alt="05"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/06.jpg" alt="06"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/07.jpg" alt="07"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：今天中午讲了一个关于「晚安，月亮」的睡前故事，最后猫头鹰对月亮说了晚安，大家今天睡前还可以和宝宝说哦，再加一些其他的动物宝宝&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>突破阿里限制实现&quot;RDS For MySQL 5.7到自建MySQL主从&quot;</title>
    <link href="http://www.toberoot.com/2018/08/22/booboo_others/rds-for-mysql-5-7%E5%88%B0%E8%87%AA%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E4%B9%8B%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3user%E8%A1%A8%E5%AE%9E%E7%8E%B0%E4%BB%8E%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%9B%B4%E6%94%B9%E5%8A%9F%E8%83%BD/"/>
    <id>http://www.toberoot.com/2018/08/22/booboo_others/rds-for-mysql-5-7%E5%88%B0%E8%87%AA%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E4%B9%8B%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3user%E8%A1%A8%E5%AE%9E%E7%8E%B0%E4%BB%8E%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%9B%B4%E6%94%B9%E5%8A%9F%E8%83%BD/</id>
    <published>2018-08-22T10:41:15.000Z</published>
    <updated>2020-03-22T08:32:42.581Z</updated>
    
    <content type="html"><![CDATA[<p>摘要: 阿里云的RDS For MySQL 5.7 到线下IDC机房的主从搭建相信看官方文档就可以完成，但是搭建之后却发现无法在本地进行认证权限的管理，这是为何？而阿里官方推荐使用DTS同步工具去实现，这个费用着实不少，又是否能够破解呢？本文详解如何暴力破解user表实现从库用户权限更改功能</p><a id="more"></a><h1 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h1><h2 id="数据库明细"><a href="#数据库明细" class="headerlink" title="数据库明细"></a>数据库明细</h2><p>说在前面：</p><ul><li>云上数据库： RDS For MySQL 5.7.20 普通用户权限</li><li>IDC数据库: MySQL 5.7.20 </li></ul><h2 id="故事情节"><a href="#故事情节" class="headerlink" title="故事情节"></a>故事情节</h2><p>现需要搭建RDS For MySQL 到线下IDC机房的主从，问题如下：</p><h3 id="同步系统表失败"><a href="#同步系统表失败" class="headerlink" title="同步系统表失败"></a>同步系统表失败</h3><h4 id="故障原因"><a href="#故障原因" class="headerlink" title="故障原因"></a>故障原因</h4><ul><li>RDS For MySQL 5.7.20 到自建MySQL 5.7.20主从同步异常的原因为RDS与MySQL官方版本使用的系统库不同</li><li>自建MySQL 5.7.20 无法同步主库RDS的系统表</li><li>自建MySQL 5.7.20 恢复RDS的全备份数据后无法执行授权语句,报错如下：</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1785 (HY000): Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.</span><br></pre></td></tr></table></figure><ul><li>自建MySQL 5.7.20 恢复RDS的全备份数据后无法对系统表执行更新操作，报错如下：</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1064 (42000): Unknown trigger has an error in its body: 'Unknown system variable 'maintain_user_list''</span><br></pre></td></tr></table></figure><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><ul><li>跳过系统表的同步</li></ul><hr><h3 id="从库添加认证授权失败"><a href="#从库添加认证授权失败" class="headerlink" title="从库添加认证授权失败"></a>从库添加认证授权失败</h3><p>RDS For MySQL 5.7.20 到自建MySQL 5.7.20 搭建主从同步架构:</p><ul><li>配置从库不同步RDS主库的系统表</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># skip rep</span><br><span class="line">replicate_wild_ignore_table&#x3D;mysql.%</span><br><span class="line">replicate_wild_ignore_table&#x3D;sys.%</span><br><span class="line">replicate_wild_ignore_table&#x3D;information_schema.%</span><br></pre></td></tr></table></figure><ul><li><strong>非系统库数据同步正常</strong></li><li>从库无法执行grant命令，即无法添加授权信息</li><li>从库无法对系统表mysql.user表执行insert操作</li><li>从库无法对系统表mysql.user表执行updat操作</li></ul><p>报错如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1064 (42000): Unknown trigger has an error in its body: 'Unknown system variable 'maintain_user_list''</span><br></pre></td></tr></table></figure><h4 id="失败原因"><a href="#失败原因" class="headerlink" title="失败原因"></a>失败原因</h4><p><strong>阿里工单答复</strong>：RDS 目前已经不支持 MYISAM 引擎创建了。所以如果是通过自建的replication 同步 就会有这个问题的，RDS 统一INNOB 引擎。<br>如果需求是从RDS 到自建数据库的同步关系，建议您使用DTS 做业务数据的同步。</p><h4 id="探索解决方法"><a href="#探索解决方法" class="headerlink" title="探索解决方法"></a>探索解决方法</h4><h5 id="从库尝试使用MySQL8-0-11"><a href="#从库尝试使用MySQL8-0-11" class="headerlink" title="从库尝试使用MySQL8.0.11"></a>从库尝试使用<code>MySQL8.0.11</code></h5><p>RDS For MySQL 5.7的备份文件 到线下自建MYSQL 8.0.11 无法恢复数据。因此该方法不可行。</p><h5 id="尝试临时关闭GTID模式"><a href="#尝试临时关闭GTID模式" class="headerlink" title="尝试临时关闭GTID模式"></a>尝试临时关闭GTID模式</h5><ol><li>临时停止slave同步</li><li>修改配置关闭gtid模式</li><li>重启服务</li></ol><p>对系统表mysql.user测试明细：</p><table><thead><tr><th>No.</th><th>测试项目</th><th>结果</th></tr></thead><tbody><tr><td>1</td><td>是否能够执行grant命令</td><td>×</td></tr><tr><td>2</td><td>是否能够执行update命令</td><td>×</td></tr><tr><td>3</td><td>是否能够执行insert命令</td><td>×</td></tr></tbody></table><p>该方法同样无法解决。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 权限相关的一些表：</span></span><br><span class="line">SCHEMA_PRIVILEGES：提供了数据库的相关权限，这个表是内存表是从mysql.db中拉去出来的。</span><br><span class="line">TABLE_PRIVILEGES:提供的是表权限相关信息，信息是从 mysql.tables_priv 表中加载的</span><br><span class="line">COLUMN_PRIVILEGES ：这个表可以清楚就能看到表授权的用户的对象，那张表那个库以及授予的是什么权限，如果授权的时候加上with grant option的话，我们可以看得到PRIVILEGE_TYPE这个值必须是YES。</span><br><span class="line">USER_PRIVILEGES:提供的是表权限相关信息，信息是从 mysql.user 表中加载的</span><br><span class="line">通过表我们可以很清晰看得到MySQL授权的层次，SCHEMA，TABLE，COLUMN级别，当然这些都是基于用户来授予的</span><br></pre></td></tr></table></figure><p>从数据库用户权限管理的原理可以了解到管理用户的是<code>user</code>表，如果要更细致的权限还需要<code>db</code>表和<code>tables_priv</code>表。<em>（本文只从user表着手）</em></p><h3 id="步骤概览"><a href="#步骤概览" class="headerlink" title="步骤概览"></a>步骤概览</h3><ol><li>创建新的user_1表</li><li>对user_1表添加新的用户</li><li>停服务</li><li>将user_1替换user表</li><li>启动该服务</li><li>可以通过update、insert、delete操作user表来添加权限（grant无法操作）</li></ol><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">root@MySQL-01 10:35:  [mysql]&gt; create table user_1 like user;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select * from user_1;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like user;</span><br><span class="line">ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'user' at line 1</span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like 'user_1';</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| Name   | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation | Checksum | Create_options | Comment                     |</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| user_1 | MyISAM |      10 | Dynamic    |    0 |              0 |           0 | 281474976710655 |         1024 |         0 |           NULL | 2019-01-04 10:36:00 | 2019-01-04 10:36:00 | NULL       | utf8_bin  |     NULL |                | Users and global privileges |</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like 'user';</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time          | Collation | Checksum | Create_options | Comment                     |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| user | MyISAM |      10 | Dynamic    |    3 |             53 |         160 | 281474976710655 |         2048 |         0 |           NULL | 2015-05-22 15:24:42 | 2019-01-04 09:27:49 | 2015-05-22 15:33:22 | utf8_bin  |     NULL |                | Users and global privileges |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; insert into user_1 select * from user;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select * from user_1;</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">| Host      | User | Password | Select_priv | Insert_priv | Update_priv | Delete_priv | Create_priv | Drop_priv | Reload_priv | Shutdown_priv | Process_priv | File_priv | Grant_priv | References_priv | Index_priv | Alter_priv | Show_db_priv | Super_priv | Create_tmp_table_priv | Lock_tables_priv | Execute_priv | Repl_slave_priv | Repl_client_priv | Create_view_priv | Show_view_priv | Create_routine_priv | Alter_routine_priv | Create_user_priv | Event_priv | Trigger_priv | Create_tablespace_priv | ssl_type | ssl_cipher | x509_issuer | x509_subject | max_questions | max_updates | max_connections | max_user_connections | plugin | authentication_string |</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">| localhost | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">| 127.0.0.1 | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">| ::1       | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select user,host,authentication_string from user_1;</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">| user | host      | authentication_string |</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">| root | localhost |                       |</span><br><span class="line">| root | 127.0.0.1 |                       |</span><br><span class="line">| root | ::1       |                       |</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; update user_1 set authentication_string=password('(Uploo00king)') where user='root';</span><br><span class="line">Query OK, 3 rows affected, 1 warning (0.01 sec)</span><br><span class="line">Rows matched: 3  Changed: 3  Warnings: 1</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:37:  [mysql]&gt; select user,host,authentication_string from user_1;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:37:  [mysql]&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@sh_02 data]# /etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@sh_02 mysql]# ll user_1*</span><br><span class="line">-rw-r-----. 1 mysql mysql 10630 Jan  4 10:36 user_1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql   328 Jan  4 10:37 user_1.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  2048 Jan  4 10:37 user_1.MYI</span><br><span class="line">[root@sh_02 mysql]# mv user_1.frm user.frm</span><br><span class="line">[root@sh_02 mysql]# mv user_1.MYD user.MYD</span><br><span class="line">[root@sh_02 mysql]# mv user_1.MYI user.MYI</span><br><span class="line">[root@sh_02 mysql]# ll user*</span><br><span class="line">-rw-r-----. 1 mysql mysql 10630 Jan  4 10:36 user.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql   328 Jan  4 10:37 user.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  2048 Jan  4 10:37 user.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql  3989 Aug 14 09:14 user_view.frm</span><br><span class="line">[root@sh_02 mysql]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@sh_02 mysql]# mysql -uroot -p'(Uploo00king)'</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| db1                |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [(none)]&gt; use mysql</span><br><span class="line">Database changed</span><br><span class="line">root@MySQL-01 10:39:  [mysql]&gt; select user,host from mysql.user;</span><br><span class="line">+------+-----------+</span><br><span class="line">| user | host      |</span><br><span class="line">+------+-----------+</span><br><span class="line">| root | 127.0.0.1 |</span><br><span class="line">| root | ::1       |</span><br><span class="line">| root | localhost |</span><br><span class="line">+------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [mysql]&gt; grant all on *.* to booboo@'%' identified by '(Uploo00king)';</span><br><span class="line">ERROR 1785 (HY000): Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 11:39:  [mysql]&gt; update mysql.user_1 set user='aliyun_root' where host='127.0.0.1';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 11:40:  [mysql]&gt; select user,host from mysql.user_1;</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| user        | host      |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| aliyun_root | 127.0.0.1 |</span><br><span class="line">| root        | ::1       |</span><br><span class="line">| root        | localhost |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">aliyun_root@MySQL-01 11:51:  [mysql]&gt; insert into mysql.user values ('%','jowing', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('Joowing@2017'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">aliyun_root@MySQL-01 11:51:  [mysql]&gt; select user,host from  mysql.user;</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| user        | host      |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| jowing      | %         |</span><br><span class="line">| aliyun_root | 127.0.0.1 |</span><br><span class="line">| root        | ::1       |</span><br><span class="line">| root        | localhost |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h3><h4 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h4><p>目标：IDC机房从库支持通过insert、update、delete命令来修改用户权限，权限比较简单，分为只读和写。</p><p>需要设置以下权限：权限作用于所有的库多有的表</p><table><thead><tr><th align="left">用户名</th><th align="left">密码</th><th align="left">权限</th></tr></thead><tbody><tr><td align="left">root</td><td align="left">123</td><td align="left">读写</td></tr><tr><td align="left">joowingbuz</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">ottersync</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">syncdw</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">datasis</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">joowingv</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">datadev</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">readonly</td><td align="left">123</td><td align="left">只读</td></tr></tbody></table><h4 id="步骤概览-1"><a href="#步骤概览-1" class="headerlink" title="步骤概览"></a>步骤概览</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 登陆数据库后操作如下：</span></span><br><span class="line">use mysql;</span><br><span class="line">create table user_1 like user;</span><br><span class="line">insert into user_1 select * from user;</span><br><span class="line">delete from mysql.user_1 where user='root';</span><br><span class="line">insert into mysql.user_1 values ('%','root', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','joowingbuz', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','ottersync', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','syncdw', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','datasis', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','joowingv', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','datadev', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','readonly', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 退出数据库并停止服务</span></span><br><span class="line">/data/mysql/support-files/mysql.server stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 将user_1表的物理文件覆盖user表</span></span><br><span class="line">cd /data/xtrabackup_data/mysql/</span><br><span class="line">mv user.frm user.ibd user.MYD user.MYI user.TRG /tmp</span><br><span class="line">mv user_1.frm user.frm</span><br><span class="line">mv user_1.MYI user.MYI</span><br><span class="line">mv user_1.MYD user.MYD</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动数据库</span></span><br><span class="line">/data/mysql/support-files/mysql.server start</span><br></pre></td></tr></table></figure><h4 id="操作明细"><a href="#操作明细" class="headerlink" title="操作明细"></a>操作明细</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">root@MySQL-01 15:42:  [(none)]&gt; use mysql</span><br><span class="line">Database changed</span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; create table user_1 like user;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; insert into user_1 select * from user;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; select user,host,authentication_string from mysql.user;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; select user,host,authentication_string from mysql.user_1;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; desc mysql.user_1;</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">| Field                  | Type                              | Null | Key | Default | Extra |</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">| Host                   | char(60)                          | NO   | PRI |         |       |</span><br><span class="line">| User                   | char(16)                          | NO   | PRI |         |       |</span><br><span class="line">| Password               | char(41)                          | NO   |     |         |       |</span><br><span class="line">| Select_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Insert_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Update_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Delete_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Drop_priv              | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Reload_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Shutdown_priv          | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Process_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| File_priv              | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Grant_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| References_priv        | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Index_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Alter_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Show_db_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Super_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_tmp_table_priv  | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Lock_tables_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Execute_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Repl_slave_priv        | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Repl_client_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_view_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Show_view_priv         | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_routine_priv    | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Alter_routine_priv     | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_user_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Event_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Trigger_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_tablespace_priv | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| ssl_type               | enum('','ANY','X509','SPECIFIED') | NO   |     |         |       |</span><br><span class="line">| ssl_cipher             | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| x509_issuer            | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| x509_subject           | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| max_questions          | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_updates            | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_connections        | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_user_connections   | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| plugin                 | char(64)                          | YES  |     |         |       |</span><br><span class="line">| authentication_string  | text                              | YES  |     | NULL    |       |</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">42 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:47:  [mysql]&gt; delete from mysql.user_1 where user='root';</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:51:  [mysql]&gt; insert into mysql.user_1 values ('%','root', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','joowingbuz', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','ottersync', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','syncdw', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','datasis', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','joowingv', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','datadev', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','readonly', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; select user,host,authentication_string from mysql.user;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; select user,host,authentication_string from mysql.user_1;</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">| user       | host | authentication_string                     |</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">| ottersync  | %    | *9443FA914A2D69FE8832F8294E7422CC1B02A492 |</span><br><span class="line">| joowingbuz | %    | *DFFDA1CA6135E355EF468AB13A465BB5D4FE2B11 |</span><br><span class="line">| root       | %    | *89BE852E4EECFD217F0C5463FB30AD25BD0751E0 |</span><br><span class="line">| syncdw     | %    | *3DD7B4B4F6EE968FF3452B607BDEE6294B6A425A |</span><br><span class="line">| datasis    | %    | *011D511C71990F832C531A0F9CFB34CF7BB4E485 |</span><br><span class="line">| joowingv   | %    | *56B364074270DF7F6D670A6B4F5A4AD13322397A |</span><br><span class="line">| datadev    | %    | *D3D73E0F6BFC3159B024EF31484B6F9CC2963C5B |</span><br><span class="line">| readonly   | %    | *E2BA196C0C7F409990FDB3FAB5F9C7CE95F7C449 |</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@joowing-server-06:~# /data/mysql/support-files/mysql.server stop</span><br><span class="line">Shutting down MySQL</span><br><span class="line">...... * </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@joowing-server-06:~# cd /data/xtrabackup_data/</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data# cd mysql</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user_1.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user_1.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user_1.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月   9 20:14 user.frm</span><br><span class="line">-rw-r----- 1 mysql mysql 98304 8月   9 20:14 user.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   328 8月   9 20:14 user.MYD</span><br><span class="line">-rw-r--r-- 1 mysql mysql  2048 8月   9 20:14 user.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3569 8月   9 20:14 user.TRG</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user.frm user.ibd user.MYD user.MYI user.TRG /data</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user_1.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user_1.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user_1.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.frm user.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.MYI user.MYI</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.MYD user.MYD</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# /data/mysql/support-files/mysql.server start</span><br><span class="line">Starting MySQL</span><br><span class="line">...... * </span><br><span class="line"></span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mysql -uroot -p'123'</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:55:  [(none)]&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: rm-uf6f05k2rg95s23bp.mysql.rds.aliyuncs.com</span><br><span class="line">                  Master_User: idc_slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.001641</span><br><span class="line">          Read_Master_Log_Pos: 447207506</span><br><span class="line">               Relay_Log_File: joowing-server-06-relay-bin.000225</span><br><span class="line">                Relay_Log_Pos: 35529076</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.001641</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: mysql.%,sys.%,information_schema.%</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 447207506</span><br><span class="line">              Relay_Log_Space: 35529295</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1095052097</span><br><span class="line">                  Master_UUID: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc:97478646-97483368</span><br><span class="line">            Executed_Gtid_Set: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc:1-97483368,</span><br><span class="line">c39ecf19-5daa-11e8-aa9c-7cd30ac4764a:1-178658794,</span><br><span class="line">c69289d7-9bc9-11e8-b922-44a842431b62:1-12</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证只读账号</span></span><br><span class="line">mysql -uroot-p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -ujoowingbuz -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -uottersync -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -usyncdw -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -udatasis -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -ujoowingv -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -udatadev -p'123' -e "create database dbzyadmin;"</span><br><span class="line">mysql -ureadonly -p'123'  -e "create database dbzyadmin;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 只读账号无法执行写操作，验证成功</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1044 (42000) at line 1: Access denied for user 'readonly'@'%' to database 'dbzyadmin'</span><br></pre></td></tr></table></figure><h4 id="后续用户权限变更操作指南"><a href="#后续用户权限变更操作指南" class="headerlink" title="后续用户权限变更操作指南"></a>后续用户权限变更操作指南</h4><blockquote><p>后续新增用户、删除用户、更改密码命令如下：</p></blockquote><h5 id="新增读写用户"><a href="#新增读写用户" class="headerlink" title="新增读写用户"></a>新增读写用户</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql.user_1 values ('%','【用户名】', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('【密码】'));</span><br></pre></td></tr></table></figure><h5 id="新增只读用户"><a href="#新增只读用户" class="headerlink" title="新增只读用户"></a>新增只读用户</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql.user_1 values ('%','【用户名】', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('【密码】'));</span><br></pre></td></tr></table></figure><h5 id="删除用户命令"><a href="#删除用户命令" class="headerlink" title="删除用户命令"></a>删除用户命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from mysql.user where user='【用户名】';</span><br></pre></td></tr></table></figure><h5 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update mysql.user set authentication_string=password('【密码】') where user='【用户名】';</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>RDS目前使用MySQL版本和官方在系统库上差异还是很大的，若需要搭建RDS到线下自建MySQL5.7的主从时，可以通过此法去实现。</p><p>本文中对user表的破解，同样适适用于<code>mysql.db</code> 、<code>mysql.tables_priv</code>表，都破解则可以将权限从用户拓展到库表列。读者可自行实验测试。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要: 阿里云的RDS For MySQL 5.7 到线下IDC机房的主从搭建相信看官方文档就可以完成，但是搭建之后却发现无法在本地进行认证权限的管理，这是为何？而阿里官方推荐使用DTS同步工具去实现，这个费用着实不少，又是否能够破解呢？本文详解如何暴力破解user表实现从库用户权限更改功能&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="RDS" scheme="http://www.toberoot.com/tags/RDS/"/>
    
      <category term="主从同步" scheme="http://www.toberoot.com/tags/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5/"/>
    
  </entry>
  
  <entry>
    <title>利用split工具解决一次MongoDB日志异常问题</title>
    <link href="http://www.toberoot.com/2018/08/03/booboo_others/%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/"/>
    <id>http://www.toberoot.com/2018/08/03/booboo_others/%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/</id>
    <published>2018-08-03T12:25:24.000Z</published>
    <updated>2020-03-22T08:32:42.584Z</updated>
    
    <content type="html"><![CDATA[<p>摘要： </p><ul><li>某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？</li><li>进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？</li><li>第二天到公司，由于客户环境我们也是第一次接手，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！</li></ul><a id="more"></a><h2 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h2><h3 id="数据库明细"><a href="#数据库明细" class="headerlink" title="数据库明细"></a>数据库明细</h3><p>说在前面：</p><ul><li>数据库：MongoDB集群 4个分片节点</li><li>分片节点规格：16核 / 32G CentOS 7.4 64位</li><li>数据目录所在磁盘: 300G   49G  252G  17% /data</li></ul><h3 id="故事情节"><a href="#故事情节" class="headerlink" title="故事情节"></a>故事情节</h3><ul><li>某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？</li><li>进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？</li><li>第二天到公司，由于客户环境我们也是第一次接受，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！</li></ul><h2 id="复现与剖析"><a href="#复现与剖析" class="headerlink" title="复现与剖析"></a>复现与剖析</h2><h3 id="拉取日志异常"><a href="#拉取日志异常" class="headerlink" title="拉取日志异常"></a>拉取日志异常</h3><p><strong>使用mlogfilter过滤文件时报错说文件非mongodb的日志文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 booboo]# mlogfilter shard.log.2018-08-01 --from 2018-08-01T15:00:00.000+0800 --to "+1h" --slow 1000 &gt; /alidata/booboo/tf.1</span><br><span class="line">报错:非mongodb日志格式</span><br></pre></td></tr></table></figure><p>回到客户服务器检查日志文件格式，明细如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@MONGO-SHARD-18 logs]# file *</span><br><span class="line">shard.log:            PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-25: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01: PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure><p>mongodb的日志正常应该为：<code>ASCII text, with very long lines</code>，但是现在却变成了<code>PCX ver. 2.5 image data</code>。需要弄清楚原因。</p><h3 id="日志异常分析"><a href="#日志异常分析" class="headerlink" title="日志异常分析"></a>日志异常分析</h3><ul><li>为什么客户每天的日志量达到22个G，并且每天的日志量都是大于等于前一天？很显然，日志截断有问题。</li><li>这个是近7天的日志，而日志格式变成了PCX图片格式是为何？</li><li>怀疑每次日志轮询时都没有真正截断日志！</li></ul><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/01.png" alt=""></p><h3 id="分析原日志切割明细"><a href="#分析原日志切割明细" class="headerlink" title="分析原日志切割明细"></a>分析原日志切割明细</h3><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/03.png" alt=""></p><p>怀疑与<code>echo &gt;</code>有关，进行验证。</p><h3 id="验证echo-gt-与PCX图片头部0a一致"><a href="#验证echo-gt-与PCX图片头部0a一致" class="headerlink" title="验证echo &gt;与PCX图片头部0a一致"></a>验证<code>echo &gt;</code>与<code>PCX图片头部0a一致</code></h3><ol><li>建一个空文档<code>log</code>；执行<code>echo &gt; log</code>；通过<code>cat -A log</code>查看文件中插入了一个符号即换行符<code>\n</code></li><li>通过<code>hexdump -c log</code> 查看测试文件头部显示为ASCII字符 <code>\n</code></li><li>通过<code>hexdump -d log</code> 查看测试文件头部显示为16进制<code>00010</code> 即<code>0a</code></li><li>通过<code>vim</code> 用16进制查看文档<code>log</code>可以看到log的文件头部为<code>0a</code>，正是PCX图片的头部</li><li>生产环境查看客户有问题的mongodb系统日志文件格式为<code>PCX</code>图片格式</li><li>通过<code>hexdump -c log</code> 显示为ASCII字符，生产日志文件头部与测试的log一致，都是<code>\n</code></li><li>通过<code>hexdump -d log</code>显示为16进制，生产日志文件头部与测试的log一致<code>00010</code> 即 <code>0a</code></li></ol><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/02.png" alt=""></p><p><strong>到此验证成功:通过<code>echo &gt; log</code>的方式会往文件头部新增’0a’</strong></p><hr><h3 id="复现MongoDB日志从ASCII-text转变为PCX-格式"><a href="#复现MongoDB日志从ASCII-text转变为PCX-格式" class="headerlink" title="复现MongoDB日志从ASCII text转变为PCX 格式"></a>复现MongoDB日志从ASCII text转变为PCX 格式</h3><p>在测试环境中复现日志从<code>ASCII text</code>变成<code>PCX ver. 2.5 image data</code></p><ol><li>通过mongo登陆数据库执行大量的插入操作</li><li>通过echo &gt; mongod27017.log  命令尝试清空mongod27017.log</li><li>查看截断后的日志文件格式，变成了very short file (no magic)</li><li>等文档插入完毕</li><li>通过<code>tail -f</code> 查看日志明细，看到确实有日志写入</li><li>查看日志格式，发现变成了<code>PCX ver. 2.5 image data</code></li></ol><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/05.png" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 ~]# mongo</span><br><span class="line">MongoDB shell version: 3.2.16</span><br><span class="line">connecting to: test</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.auth(<span class="string">'test_dev'</span>,<span class="string">'uplooking'</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.t1.find()</span></span><br><span class="line">&#123; "_id" : ObjectId("5b5ebb6796b8b74a73ee30f6"), "a" : 1, "b" : 2 &#125;</span><br><span class="line">&#123; "_id" : ObjectId("5b5ebb6996b8b74a73ee30f7"), "a" : 1, "b" : 1 &#125;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">for</span> (i=1;i&lt;200000;i++)&#123;</span></span><br><span class="line">... db.t1.insert(&#123;id:i&#125;)&#125;</span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line"></span><br><span class="line">[root@sh_01 ~]# cd /alidata/mongodb/logs</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">-rw-r--r-- 1 root root 2182 Aug  3 10:28 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root    1 Aug  3 10:29 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# tail -f mongod27017.log</span><br><span class="line"></span><br><span class="line">2018-08-03T10:30:21.936+0800 I NETWORK  [initandlisten] connection accepted from 127.0.0.1:43720 #2 (2 connections now open)</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# ll -h</span><br><span class="line">total 12K</span><br><span class="line">-rw-r--r-- 1 root root 2.8K Aug  3 10:30 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3.1K Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1.5K Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一边不断产生日志，一边多次执行<span class="built_in">echo</span>&gt; </span></span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# ll -h</span><br><span class="line">total 16K</span><br><span class="line">-rw-r--r-- 1 root root    1 Aug  3 11:28 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3.1K Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1.5K Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">-rw-r--r-- 1 root root 2.9K Aug  3 11:05 mongod27017.log.2018-08-03T03-09-08</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# hexdump -c mongod27017.log</span><br><span class="line">0000000  \n  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000010  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">*</span><br><span class="line">0000850  \0  \0  \0  \0  \0  \0  \0   2   0   1   8   -   0   8   -   0</span><br><span class="line">0000860   3   T   1   1   :   2   9   :   0   6   .   7   2   9   +   0</span><br><span class="line">0000870   8   0   0       I       A   C   C   E   S   S               [</span><br><span class="line">0000880   c   o   n   n   3   ]       U   n   a   u   t   h   o   r   i</span><br><span class="line">0000890   z   e   d   :       n   o   t       a   u   t   h   o   r   i</span><br><span class="line">00008a0   z   e   d       o   n       t   e   s   t       t   o       e</span><br><span class="line">00008b0   x   e   c   u   t   e       c   o   m   m   a   n   d       &#123;</span><br><span class="line">00008c0       f   i   n   d   :       "   t   1   "   ,       f   i   l</span><br><span class="line">00008d0   t   e   r   :       &#123;   &#125;       &#125;  \n</span><br></pre></td></tr></table></figure><p>成功复现了客户的情况：</p><ol><li><p>第一次<code>echo &gt; log</code>，文件头部新增<code>\n</code></p></li><li><p>多次<code>echo &gt; log</code>,文件头部如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000  \n  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000010  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">*</span><br></pre></td></tr></table></figure></li></ol><p>确实是mongodb日志轮询出了问题：</p><ol><li><code>echo &gt; log</code>会往文件头部插入<code>\n</code>即16进制的<code>0a</code></li><li>在数据库正常运行中，对log文件是加了锁的，强制执行<code>echo &gt; log</code>是无法进行覆盖的，会将所有的数据全部置为<code>0</code></li><li>强制覆盖后，文件头部变成了无数的空白</li></ol><h3 id="待解决问题"><a href="#待解决问题" class="headerlink" title="待解决问题"></a>待解决问题</h3><ul><li>MongoDB日志轮询方法调整为<strong>kill -SIGUSER1 [mongodpid]</strong></li><li>修复目前已经变为图片格式的日志，并拉取15点到16点的日志</li></ul><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h3 id="MongoDB日志轮询"><a href="#MongoDB日志轮询" class="headerlink" title="MongoDB日志轮询"></a>MongoDB日志轮询</h3><h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 log]# pidof mongod</span><br><span class="line">1828</span><br><span class="line">[root@sh_01 log]# kill -SIGUSER1 1828</span><br><span class="line">-bash: kill: SIGUSER1: invalid signal specification</span><br><span class="line">[root@sh_01 log]# kill -SIGUSR1 1828</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  3 11:09 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">-rw-r--r-- 1 root root 2942 Aug  3 11:05 mongod27017.log.2018-08-03T03-09-08</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/04.png" alt=""></p><p>修改日志轮询脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@MONGO-SHARD-18 logs]# cat /etc/init.d/mongo_logspit.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2018/08/02 Apple</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Rotate the MongoDB logs to prevent a single logfile from consuming too much disk space.</span></span><br><span class="line"></span><br><span class="line">cmd=mongod</span><br><span class="line">mongodpath=/opt/mongodb/bin</span><br><span class="line">pidarray=`pidof $&#123;mongodpath&#125;/$cmd`</span><br><span class="line">LOGPATH_SHARD=/data/mongodb/shard1/logs</span><br><span class="line"></span><br><span class="line">for pid in $pidarray;do</span><br><span class="line">if [ $pid ]</span><br><span class="line">then</span><br><span class="line">    kill -SIGUSR1 $pid</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash">clear logfile more than 7 days</span></span><br><span class="line">cd $LOGPATH_SHARD</span><br><span class="line">find ./ -xdev -mtime +7 -name "shard.log.*" -exec rm -f &#123;&#125;  \;</span><br></pre></td></tr></table></figure><p>所有的分片都去执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -SIGUSR1 pidof mongod</span><br></pre></td></tr></table></figure><p>分片15操作如下：其他分片同样</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[zyadmin@MONGO-SHARD-15 ~]$ sudo -i</span><br><span class="line">[root@MONGO-SHARD-15 ~]# cd /data/mongodb/shard1/logs/</span><br><span class="line">[root@MONGO-SHARD-15 logs]# ll -h</span><br><span class="line">total 1.7G</span><br><span class="line">-rw-r--r-- 1 root root 20G Aug  2 15:27 shard.log</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 25 23:50 shard.log.2018-07-25</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 26 23:50 shard.log.2018-07-26</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 27 23:50 shard.log.2018-07-27</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 28 23:50 shard.log.2018-07-28</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 29 23:50 shard.log.2018-07-29</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 30 23:50 shard.log.2018-07-30</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 31 23:50 shard.log.2018-07-31</span><br><span class="line">-rw-r--r-- 1 root root 20G Aug  1 23:50 shard.log.2018-08-01</span><br><span class="line">[root@MONGO-SHARD-15 logs]# file *</span><br><span class="line">shard.log:            PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-25: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01: PCX ver. 2.5 image data</span><br><span class="line">[root@MONGO-SHARD-15 logs]# kill -SIGUSR1 `pidof mongod`</span><br><span class="line">[root@MONGO-SHARD-15 logs]# file *</span><br><span class="line">shard.log:                     ASCII text, with very long lines</span><br><span class="line">shard.log.2018-07-25:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-02T07-27-29: PCX ver. 2.5 image data</span><br><span class="line">[root@MONGO-SHARD-15 logs]# ll -h</span><br><span class="line">total 1.7G</span><br><span class="line">-rw-r--r-- 1 root root 2.0K Aug  2 15:27 shard.log</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 25 23:50 shard.log.2018-07-25</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 26 23:50 shard.log.2018-07-26</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 27 23:50 shard.log.2018-07-27</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 28 23:50 shard.log.2018-07-28</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 29 23:50 shard.log.2018-07-29</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 30 23:50 shard.log.2018-07-30</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 31 23:50 shard.log.2018-07-31</span><br><span class="line">-rw-r--r-- 1 root root  20G Aug  1 23:50 shard.log.2018-08-01</span><br><span class="line">-rw-r--r-- 1 root root  20G Aug  2 15:27 shard.log.2018-08-02T07-27-29</span><br></pre></td></tr></table></figure><h3 id="修复异常日志"><a href="#修复异常日志" class="headerlink" title="修复异常日志"></a>修复异常日志</h3><h4 id="修复思路"><a href="#修复思路" class="headerlink" title="修复思路"></a>修复思路</h4><p>弄清楚日志变更的原因以及复现过程后，不难发现，日志因为头部变化从而导致文件格式变更。因此推测异常日志的组成如下：</p><ol><li>头部为<code>0a</code></li><li>中间全部都是<code>0</code></li><li>最后是正常的字符串记录着mongodb的日志信息，类似于<code>2018-08-03T10:30:21.936+0800 I NETWORK  [initandlisten] connection accepted from 127.0.0.1:43720 #2 (2 connections now open)</code>由日志和日志明细组成</li></ol><p>因此修复的思路如下：</p><ul><li>23G的日志，首先按照大小6G做切分<code>split -b 6G log</code>，切分成4个文件</li><li>查看切分后的日志格式，如果最后一个日志为<code>ASCII text</code>则不再切分否则，将最后一个日志继续切分</li><li>循环上一步，直到最后一个文件切分出来没有<code>ASCII text</code>为止</li></ul><h4 id="操作明细"><a href="#操作明细" class="headerlink" title="操作明细"></a>操作明细</h4><blockquote><p>日志轮询的部署距离现在大概4个月</p></blockquote><ol><li><p>第一次将23G的文件以6G切分成4个文件：xaa\xab\xac\xad，查看4个文件的属性为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xaa:               PCX ver. 2.5 image data</span><br><span class="line">xab:               PCX ver. 2.5 image data</span><br><span class="line">xac:               PCX ver. 2.5 image data</span><br><span class="line">xad:                PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure></li><li><p>重命名xad为x1第二次切分x1 5G，按照1G切分成5份，查看文件属性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xaa:               PCX ver. 2.5 image data</span><br><span class="line">xab:               PCX ver. 2.5 image data</span><br><span class="line">xac:               PCX ver. 2.5 image data</span><br><span class="line">xad:                PCX ver. 2.5 image data</span><br><span class="line">xae:                ASCII text, with very long lines</span><br></pre></td></tr></table></figure></li><li><p>重名xad 为 x2 按照15M的大小切分，查看文件的属性如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xaa:      PCX ver. 2.5 image data</span><br><span class="line">此处省略。。。</span><br><span class="line">xdo:               PCX ver. 2.5 image data</span><br><span class="line">xdp:               ASCII text, with very long lines</span><br><span class="line">xdq:               ASCII text, with very long lines</span><br><span class="line">xdr:               ASCII text, with very long lines</span><br><span class="line">xds:               ASCII text, with very long lines</span><br><span class="line">xdt:               ASCII text, with very long lines</span><br><span class="line">xdu:               ASCII text, with very long lines</span><br><span class="line">xdv:               UTF-8 Unicode text, with very long lines</span><br><span class="line">xdw:               ASCII text, with very long lines</span><br><span class="line">xdx:               ASCII text, with very long lines</span><br><span class="line">xdy:               ASCII text, with very long lines</span><br></pre></td></tr></table></figure></li><li><p>切分后文件类型为<code>ASCII text</code>的文件中找到15点~16点的文档</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 mongolog_20180801]# head -n 2 xdv</span><br><span class="line">re: "x86_64", version: "Kernel 3.10.0-693.2.2.el7.x86_64" &#125; &#125;</span><br><span class="line">2018-08-01T16:13:44.958+0800 I ACCESS   [conn4972925] Successfully authenticated as principal __system on local</span><br><span class="line">[root@sh_01 mongolog_20180801]# head -n 2 xdu</span><br><span class="line">38422 #4967772 (445 connections now open)</span><br><span class="line">2018-08-01T14:00:10.575+0800 I NETWORK  [thread1] connection accepted from 172.16.0.44:38430 #4967773 (446 connections now open)</span><br></pre></td></tr></table></figure></li></ol><ul><li><code>xdv</code> 的头部是<code>2018-08-01T16:13:44.958+0800</code>,因此可以确定15~16的日志在xdu中</li><li><code>xdu</code>记录的日志时间段为<code>2018-08-01T14:00:10.575+0800</code>~<code>2018-08-01T16:13:44.958+0800</code></li><li>重命名<code>xdu</code>为<code>mongolog.18.14_16</code></li></ul><h3 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h3><h4 id="分析命令"><a href="#分析命令" class="headerlink" title="分析命令"></a>分析命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取08月01号下午3点开始到4点执行时间超过5秒的查询</span></span><br><span class="line">mlogfilter mongolog.18.14_16 --from 2018-08-01T15 --to "+1h" --slow 5000 &gt; slowlog.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取08月01号下午3点开始到4点语句的执行次数、用时等统计信息</span></span><br><span class="line">mloginfo slowlog.txt  --queries &gt; an_slowlog.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过mplotqueries进行慢查询散点分布图绘制，且只返回前10个</span></span><br><span class="line">mplotqueries slowlog.txt --output-file 01.png --logscale --group-limit 10</span><br></pre></td></tr></table></figure><h4 id="慢查询散点分布图"><a href="#慢查询散点分布图" class="headerlink" title="慢查询散点分布图"></a>慢查询散点分布图</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 booboo]# mplotqueries slowlog.txt --output-file 01.png --logscale --group-limit 10</span><br><span class="line">                                                                                          </span><br><span class="line">SCATTER plot</span><br><span class="line">   id   #points  group</span><br><span class="line">    1       692  order.order</span><br><span class="line">    2       615  omdmain.item_region_erp</span><br><span class="line">    3         1  omdmain.customer</span><br><span class="line">()</span><br></pre></td></tr></table></figure><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/10.png" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="mongodb日志轮询的问题"><a href="#mongodb日志轮询的问题" class="headerlink" title="mongodb日志轮询的问题"></a>mongodb日志轮询的问题</h3><ol><li><code>echo &gt; log</code>会往文件头部插入<code>\n</code>即16进制的<code>0a</code></li><li>在数据库正常运行中，对log文件是加了锁的，强制执行<code>echo &gt; log</code>是无法进行覆盖的，会将所有的数据全部置为<code>0</code></li><li>强制覆盖后，文件头部变成了无数的空白</li></ol><h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><ul><li>MongoDB日志轮询方法调整为<strong>kill -SIGUSER1 [mongodpid]</strong></li><li>修复目前已经变为图片格式的日志，并拉取15点到16点的日志</li></ul><p>该case花了一整天，从怀疑被攻击到确认是日志轮询引起文件格式变更是一个关键转折点；</p><p>另外PCX格式是第一次碰到，疑惑了半天~最后是@培尧发现了<code>echo</code>的端倪，@衾袭@大宝去验证最终确认了问题的根源。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要： &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？&lt;/li&gt;
&lt;li&gt;进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？&lt;/li&gt;
&lt;li&gt;第二天到公司，由于客户环境我们也是第一次接手，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MongoDB" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MongoDB/"/>
    
    
      <category term="数据救援" scheme="http://www.toberoot.com/tags/%E6%95%B0%E6%8D%AE%E6%95%91%E6%8F%B4/"/>
    
  </entry>
  
  <entry>
    <title>Oracle数据库SQL优化_索引缺失</title>
    <link href="http://www.toberoot.com/2018/05/29/booboo_others/oracle%E6%95%B0%E6%8D%AE%E5%BA%93SQL%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1/"/>
    <id>http://www.toberoot.com/2018/05/29/booboo_others/oracle%E6%95%B0%E6%8D%AE%E5%BA%93SQL%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1/</id>
    <published>2018-05-28T18:09:32.000Z</published>
    <updated>2020-03-22T08:32:42.573Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：Oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒，如何进行复杂查询的SQL优化，本文提供通用的一个思路。</p><a id="more"></a><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；</p><p>老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒。</p><table><thead><tr><th>库</th><th>原查询时间</th><th>优化后的查询时间</th></tr></thead><tbody><tr><td>老库</td><td>11秒</td><td>1.4秒 缓存后 0.4秒</td></tr><tr><td>新库RAC</td><td>360秒</td><td>1.4秒 缓存后0.4秒排查思路</td></tr></tbody></table><h2 id="待优化SQL"><a href="#待优化SQL" class="headerlink" title="待优化SQL"></a>待优化SQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">prj.PROVINCE_AD_NAME,</span><br><span class="line">prj.CITY_AD_NAME,</span><br><span class="line">prj.AD_NAME,</span><br><span class="line">prj.CHANNEL_SYS_CAT,</span><br><span class="line">prj.EXCUTE_EL,</span><br><span class="line">prj.PRJ_CODE AS PRJ_CODE,</span><br><span class="line">prj.PRJ_NAME AS PRJ_NAME,</span><br><span class="line">prj.POS_CODE AS POS_CODE,</span><br><span class="line">prj.POS_NAME AS POS_NAME,</span><br><span class="line">prj.CUST_CHANNEL_CODE,</span><br><span class="line">prj.CUST_CHANNEL_NAME,</span><br><span class="line">prj.EMP_CODE AS EMP_CODE,</span><br><span class="line">prj.NAME AS EMP_NAME,</span><br><span class="line">prj.ATT_DATE AS APPLY_DATE,</span><br><span class="line">prj.EMP_PK AS EMP_PK,</span><br><span class="line">prj.ATT_START_TIME AS START_TIME,</span><br><span class="line">prj.ATT_END_TIME AS END_TIME,</span><br><span class="line">prj.ATT_ISWORK AS ISWORK,</span><br><span class="line">prj.ATT_UNWORK AS ATTTYPE,</span><br><span class="line">prj.START_XPOS AS ON_WORK_POSITION_LON,</span><br><span class="line">prj.START_YPOS AS ON_WORK_POSITION_LAT,</span><br><span class="line">prj.START_ISEXCEP AS ON_WORK_POSITION_STAUS,</span><br><span class="line">prj.END_XPOS AS OFF_WORK_POSITION_LAT,</span><br><span class="line">prj.END_YPOS AS OFF_WORK_POSITION_LON,</span><br><span class="line">prj.END_ISEXCEP AS OFF_WORK_POSITION_STAUS,</span><br><span class="line">ifcl1Staus.COMPARE_TYPE AS FACE_ATT_TYPE,</span><br><span class="line">ifcl1.STATUS AS FACE_ATT_STATUS,</span><br><span class="line">NVL( ifaceCount.faceCount, 0 ) AS FACE_ATT_COUNT,</span><br><span class="line">NVL( levLeave.LEAVECount, 0 ) AS LEAVE_WORK_COUNT,</span><br><span class="line">NVL( levRtn.RETURNCount, 0 ) AS RETURN_WORK_COUNT,</span><br><span class="line">wq.STATUS AS PRJ_QUESTION_TYPE,</span><br><span class="line">iface2.FACE_ATT_IMG AS FACE_ATT_IMG,</span><br><span class="line">prj.SA_TYPE</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">dpsi.ID AS ID,</span><br><span class="line">P.ID AS PRJ_ID,</span><br><span class="line">mad.AD_CODE,</span><br><span class="line">mad.PROVINCE_AD_NAME,</span><br><span class="line">mad.CITY_AD_NAME,</span><br><span class="line">mad.AD_NAME,</span><br><span class="line">mpk.POS_KIND_CODE,</span><br><span class="line">mpk.POS_KIND_NAME,</span><br><span class="line">P.CODE AS PRJ_CODE,</span><br><span class="line">P.NAME AS PRJ_NAME,</span><br><span class="line">P.START_DATE,</span><br><span class="line">p.END_DATE,</span><br><span class="line">dpsi.CUST_CHANNEL,</span><br><span class="line">dpsi.CUST_SYS,</span><br><span class="line">dpsi.CUST_CHANNEL_CODE,</span><br><span class="line">dpsi.CUST_CHANNEL_NAME,</span><br><span class="line">dcs.CHANNEL_SYS_CAT,</span><br><span class="line">dcs.CHANNEL_CAT_CODE,</span><br><span class="line">dcs.CHANNEL_AD_CODE,</span><br><span class="line">dcs.CHANNEL_PROVINCE_AD_CODE,</span><br><span class="line">dcs.CHANNEL_CITY_AD_CODE,</span><br><span class="line">dcs.ID AS POS_ID,</span><br><span class="line">dcs.CHANNEL_CODE AS POS_CODE,</span><br><span class="line">dcs.CHANNEL_NAME AS POS_NAME,</span><br><span class="line">dcs.LONGITUDE AS LONGITUDE,</span><br><span class="line">dcs.LATITUDE AS LATITUDE,</span><br><span class="line">dss.id AS SALES_ID,</span><br><span class="line">TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' ) AS sc_schedule_date,</span><br><span class="line">wor.SW_BEGIN_TIME AS SALES_WORK_START,</span><br><span class="line">wor.SW_END_TIME AS SALES_WORK_END,</span><br><span class="line">dss.SALES_EAT_START,</span><br><span class="line">dss.SALES_EAT_END,</span><br><span class="line">memp.EMP_PK,</span><br><span class="line">memp.EMP_CODE,</span><br><span class="line">dss.SALES_NAME AS NAME,</span><br><span class="line">dss.SALES_PHONE AS TEL,</span><br><span class="line">dss.SALES_CARD_ID AS ID_CARD,</span><br><span class="line">spp.PRJ_ATT_CHECK_TYPE,</span><br><span class="line">spp.ALLOW_LEAVE_TIME,</span><br><span class="line">e1.EMP_CODE AS EXCUTE_CODE,</span><br><span class="line">e1.emp_name AS EXCUTE_EL,</span><br><span class="line">e2.EMP_CODE AS CITY_CODE,</span><br><span class="line">e2.emp_name AS CITY_EL,</span><br><span class="line">e3.EMP_CODE AS AREA_CODE,</span><br><span class="line">e3.EMP_NAME AS AREA_NAME,</span><br><span class="line">dpsi.SCHEDULE_TYPE,</span><br><span class="line">sac.ATT_START_TIME,</span><br><span class="line">sac.ATT_END_TIME,</span><br><span class="line">sac.ATT_ISWORK,</span><br><span class="line">sac.ATT_UNWORK,</span><br><span class="line">sac.START_XPOS,</span><br><span class="line">sac.START_YPOS,</span><br><span class="line">DECODE( sac.START_ISEXCEP, 0, 2201, 1, 2202, 2, 2203, 3, 2204, 4, 2205, 2206 ) AS START_ISEXCEP,</span><br><span class="line">sac.END_XPOS,</span><br><span class="line">sac.END_YPOS,</span><br><span class="line">sac.END_ISEXCEP,</span><br><span class="line">sac.ATT_SCH_PK,</span><br><span class="line">sac.ATT_DATE,</span><br><span class="line">CASE</span><br><span class="line">WHEN sac.ATT_START_TIME IS NOT NULL</span><br><span class="line">AND sac.ATT_END_TIME IS NOT NULL THEN '1'</span><br><span class="line">WHEN sac.ATT_START_TIME IS NOT NULL</span><br><span class="line">OR sac.ATT_END_TIME IS NOT NULL THEN '2'</span><br><span class="line">ELSE '2'</span><br><span class="line">END AS SA_TYPE</span><br><span class="line">FROM</span><br><span class="line">DM_PROJECT_SELLIN_INFO dpsi</span><br><span class="line">LEFT JOIN MD_EMP e1 ON</span><br><span class="line">dpsi.EMP_CODE = e1.EMP_CODE</span><br><span class="line">LEFT JOIN MD_EMP e2 ON</span><br><span class="line">dpsi.CITY_EMP_CODE = e2.EMP_CODE</span><br><span class="line">LEFT JOIN MD_EMP e3 ON</span><br><span class="line">dpsi.AREA_MANAGER_CODE = e3.EMP_CODE,</span><br><span class="line">DM_PROJECT P,</span><br><span class="line">DM_PROJECT_SELLIN_SALES dss,</span><br><span class="line">DM_CHANNEL_SYNC dcs,</span><br><span class="line">MD_EMP memp,</span><br><span class="line">SP_PRJ_PARM spp,</span><br><span class="line">Md_Admin_Div mad,</span><br><span class="line">MD_POS_KIND mpk,</span><br><span class="line">dm_sales_schedule_calendar cal,</span><br><span class="line">dm_sales_schedule_work wor,</span><br><span class="line">SP_ATT_SCH sac</span><br><span class="line">WHERE</span><br><span class="line">dpsi.PROJECT_ID = P.ID</span><br><span class="line">AND dss.id = cal.sales_id</span><br><span class="line">AND cal.schedule_work_id = wor.id</span><br><span class="line">AND dcs.CHANNEL_CAT_CODE = mpk.POS_KIND_CODE</span><br><span class="line">AND dss.PROJECT_SELLIN_INFO_ID = dpsi.ID</span><br><span class="line">AND dss.DELETE_FLAG = '0'</span><br><span class="line">AND dpsi.CHANNEL_SYNC_ID = dcs.ID</span><br><span class="line">AND LOWER( memp.EMP_S_CODE )= LOWER( dss.SALES_CARD_ID )</span><br><span class="line">AND P.IS_DELETE IS NULL</span><br><span class="line">AND memp.IS_DEL = '0'</span><br><span class="line">AND spp.PRJ_CODE = P.CODE</span><br><span class="line">AND mad.AD_ID = dcs.CHANNEL_ADMIN_DIV_ID</span><br><span class="line">AND mad.IS_DEL = '0'</span><br><span class="line">AND memp.EMP_TYPE = '1001'</span><br><span class="line">AND TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )&gt;='2018-04-01'</span><br><span class="line">AND TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )&lt;='2018-04-30'</span><br><span class="line">AND sac.PRJ_CODE = p.CODE</span><br><span class="line">AND sac.POS_CODE = dcs.CHANNEL_CODE</span><br><span class="line">AND sac.EMP_PK = memp.EMP_PK</span><br><span class="line">AND sac.ATT_DATE = TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )</span><br><span class="line">AND TO_CHAR( sac.CRT_DATE, 'yyyy-mm-dd' )&gt;='2018-04-01'</span><br><span class="line">AND TO_CHAR( sac.CRT_DATE, 'yyyy-mm-dd' )&lt;='2018-04-30'</span><br><span class="line">) prj,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">ifcl.STATUS</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifcl</span><br><span class="line">WHERE</span><br><span class="line">ifcl.HANDLE_TYPE = 0</span><br><span class="line">AND ifcl.DELETE_FLAG = '0'</span><br><span class="line">AND ifcl.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND ifcl.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifcl.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">GROUP BY</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">ifcl.STATUS</span><br><span class="line">HAVING</span><br><span class="line">AVG( STATUS )&lt; 1</span><br><span class="line">) ifcl1,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">*</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">EMP_PK,</span><br><span class="line">COMPARE_DATE,</span><br><span class="line">COMPARE_TYPE,</span><br><span class="line">ROW_NUMBER() OVER(</span><br><span class="line">PARTITION BY EMP_PK,</span><br><span class="line">COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">CREATED DESC</span><br><span class="line">) rn</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG</span><br><span class="line">WHERE</span><br><span class="line">COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">) t</span><br><span class="line">WHERE</span><br><span class="line">t.rn &lt;= 1</span><br><span class="line">) ifcl1Staus,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK,</span><br><span class="line">COUNT(*) AS LEAVECount</span><br><span class="line">FROM</span><br><span class="line">SP_LEV_RPT</span><br><span class="line">WHERE</span><br><span class="line">SP_LEV_RPT.START_TIME IS NOT NULL</span><br><span class="line">GROUP BY</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK</span><br><span class="line">) levLeave,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK,</span><br><span class="line">COUNT(*) AS RETURNCount</span><br><span class="line">FROM</span><br><span class="line">SP_LEV_RPT</span><br><span class="line">WHERE</span><br><span class="line">SP_LEV_RPT.END_TIME IS NOT NULL</span><br><span class="line">GROUP BY</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK</span><br><span class="line">) levRtn,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">WX_QUESTION.PRJ_ID,</span><br><span class="line">DM_PROJECT.CODE,</span><br><span class="line">'Y' AS STATUS</span><br><span class="line">FROM</span><br><span class="line">WX_QUESTION,</span><br><span class="line">DM_PROJECT</span><br><span class="line">WHERE</span><br><span class="line">DM_PROJECT.ID = WX_QUESTION.PRJ_ID</span><br><span class="line">AND WX_QUESTION.IS_DEL = '0'</span><br><span class="line">AND WX_QUESTION.STATUS = '0'</span><br><span class="line">GROUP BY</span><br><span class="line">WX_QUESTION.PRJ_ID,</span><br><span class="line">DM_PROJECT.CODE</span><br><span class="line">) wq,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">COUNT(*) AS faceCount</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifcl</span><br><span class="line">WHERE</span><br><span class="line">ifcl.HANDLE_TYPE = 0</span><br><span class="line">AND ifcl.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND ifcl.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifcl.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">GROUP BY</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE</span><br><span class="line">) ifaceCount,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE,</span><br><span class="line">wm_concat(</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">NVL( TRIM( T.PAR_VALUE ), TRIM( T.OLD_PAR_VALUE ))</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'OLD_PIC_PATH'</span><br><span class="line">) AS OLD_PAR_VALUE,</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'ATT_COS_PATH'</span><br><span class="line">) T</span><br><span class="line">)|| REPLACE( SUBSTR( iface.COMPARE_MSG, INSTR( iface.COMPARE_MSG, 'compare', 1, 1 )), ']', '' )</span><br><span class="line">) AS FACE_ATT_IMG</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE,</span><br><span class="line">ifa.COMPARE_MSG,</span><br><span class="line">RANK() OVER(</span><br><span class="line">PARTITION BY ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">ifa.created DESC</span><br><span class="line">) rankno</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifa</span><br><span class="line">WHERE</span><br><span class="line">ifa.HANDLE_TYPE = 0</span><br><span class="line">AND ifa.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND INSTR( ifa.COMPARE_MSG, 'compare' )&gt; 0</span><br><span class="line">AND ifa.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifa.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">) iface</span><br><span class="line">WHERE</span><br><span class="line">iface.rankno &lt;= 3</span><br><span class="line">GROUP BY</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE</span><br><span class="line">) iface2</span><br><span class="line">WHERE</span><br><span class="line">prj.PRJ_NAME ='(2013)行政项目'</span><br><span class="line">AND prj.ATT_DATE &gt;='2018-04-01'</span><br><span class="line">AND prj.ATT_DATE &lt;='2018-04-30'</span><br><span class="line">AND prj.EMP_PK = ifcl1.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifcl1.COMPARE_DATE(+)</span><br><span class="line">AND prj.EMP_PK = ifcl1Staus.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifcl1Staus.COMPARE_DATE(+)</span><br><span class="line">AND prj.ATT_SCH_PK = levLeave.ATT_SCH_PK(+)</span><br><span class="line">AND prj.ATT_SCH_PK = levRtn.ATT_SCH_PK(+)</span><br><span class="line">AND prj.PRJ_CODE = wq.CODE(+)</span><br><span class="line">AND prj.EMP_PK = ifaceCount.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifaceCount.COMPARE_DATE(+)</span><br><span class="line">AND prj.EMP_PK = iface2.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.sc_schedule_date, 'yyyy-mm-dd' ), 'yyyymmdd' )= iface2.COMPARE_DATE(+)</span><br><span class="line">ORDER BY</span><br><span class="line">APPLY_DATE DESC,</span><br><span class="line">ATTTYPE DESC</span><br></pre></td></tr></table></figure><h2 id="SQL优化思路"><a href="#SQL优化思路" class="headerlink" title="SQL优化思路"></a>SQL优化思路</h2><p>SQL语句较复杂，8个子查询的left outer join，每个子查询中又有连接。思路如下：</p><ol><li>从外往内拆分子查询</li><li>老旧对比子查询执行计划和执行效率</li><li>子查询连接从1到2到3一直到8个联查对比，寻找瓶颈</li></ol><h3 id="拆分子查询"><a href="#拆分子查询" class="headerlink" title="拆分子查询"></a>拆分子查询</h3><table><thead><tr><th>子查询</th><th>老库 （秒）</th><th>新库（秒）</th></tr></thead><tbody><tr><td>prj</td><td>1.182</td><td>0.318</td></tr><tr><td>ifcl1</td><td>14.229</td><td>13.168</td></tr><tr><td>ifclStatus</td><td>15.739</td><td>16.769</td></tr><tr><td>levLeave</td><td>10.147</td><td>9.813</td></tr><tr><td>levRtn</td><td>9.148</td><td>8.3</td></tr><tr><td>wq</td><td>0.141</td><td>0.165</td></tr><tr><td>ifcl1Count</td><td>3.498</td><td>1.966</td></tr><tr><td>iface2</td><td>49.255</td><td>50.897</td></tr></tbody></table><h3 id="寻找瓶颈"><a href="#寻找瓶颈" class="headerlink" title="寻找瓶颈"></a>寻找瓶颈</h3><table><thead><tr><th>连接</th><th>老库（秒）</th><th>新库（秒）</th></tr></thead><tbody><tr><td>prj+ifcl1</td><td>1.522</td><td>1.129</td></tr><tr><td>+ifclStatus</td><td>2.343</td><td>1.957</td></tr><tr><td>+levLeave</td><td>2.525</td><td>1.955</td></tr><tr><td>+levRtn</td><td>2.658</td><td>1.653</td></tr><tr><td>+wq</td><td>2.561</td><td>1.999</td></tr><tr><td>+ifcl1Count</td><td>3.498</td><td>1.966</td></tr><tr><td>+iface2</td><td>11.124</td><td>383</td></tr></tbody></table><p>发现瓶颈出现在<code>iface2</code></p><h2 id="优化iface2"><a href="#优化iface2" class="headerlink" title="优化iface2"></a>优化iface2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE,</span><br><span class="line">wm_concat(</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">NVL( TRIM( T.PAR_VALUE ), TRIM( T.OLD_PAR_VALUE ))</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'OLD_PIC_PATH'</span><br><span class="line">) AS OLD_PAR_VALUE,</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'ATT_COS_PATH'</span><br><span class="line">) T</span><br><span class="line">)|| REPLACE( SUBSTR( iface.COMPARE_MSG, INSTR( iface.COMPARE_MSG, 'compare', 1, 1 )), ']', '' )</span><br><span class="line">) AS FACE_ATT_IMG</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE,</span><br><span class="line">ifa.COMPARE_MSG,</span><br><span class="line">RANK() OVER(</span><br><span class="line">PARTITION BY ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">ifa.created DESC</span><br><span class="line">) rankno</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifa</span><br><span class="line">WHERE</span><br><span class="line">ifa.HANDLE_TYPE = 0</span><br><span class="line">AND ifa.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND INSTR( ifa.COMPARE_MSG, 'compare' )&gt; 0</span><br><span class="line">AND ifa.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifa.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">) iface</span><br><span class="line">WHERE</span><br><span class="line">iface.rankno &lt;= 3</span><br><span class="line">GROUP BY</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE</span><br></pre></td></tr></table></figure><p><code>IPG_FACE_COMPARE_LOG</code>表中<code>COMPARE_DATE列</code>需要新增索引。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>oracle小版本不同引起优化器无法获取相同的执行计划</li><li>索引缺失是本次的慢查询的主要原因</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：Oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒，如何进行复杂查询的SQL优化，本文提供通用的一个思路。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="Oracle" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/Oracle/"/>
    
    
      <category term="SQL优化" scheme="http://www.toberoot.com/tags/SQL%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>MySQL一次惊心动魄地数据强制恢复</title>
    <link href="http://www.toberoot.com/2018/05/17/booboo_others/MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/"/>
    <id>http://www.toberoot.com/2018/05/17/booboo_others/MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/</id>
    <published>2018-05-16T19:58:02.000Z</published>
    <updated>2020-03-22T08:32:42.588Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：Cash恢复的正确方式是：<strong>备份文件（逻辑或物理）+ binlog</strong>进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效</p><p>在本次案例中，某客户数据库因存储空间不够导致数据库服务宕掉，而客户在数据库宕机后，只拷贝了单个<code>cy</code>库所属的目录进行了文件层面的备份，就将其他文件全部清空，当他想重新启动数据库时发现数据库服务启动。MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的<code>.frm</code>和<code>.ibd</code>文件。</p><a id="more"></a><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>Cash恢复的正确方式是：<strong>备份文件（逻辑或物理）+ binlog</strong>进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效</p><p>在本次案例中，某客户只对单个<code>cy</code>库所属的目录进行了文件层面的备份，MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的<code>.frm</code>和<code>.ibd</code>文件。</p><h2 id="强制还原步骤"><a href="#强制还原步骤" class="headerlink" title="强制还原步骤"></a>强制还原步骤</h2><table><thead><tr><th>步骤</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td><strong>创建同版本的MySQL服务实例一枚</strong></td><td></td></tr><tr><td>2</td><td><strong>获取表的列数</strong></td><td>如果有ddl备份直接导入，可惜都是没有的，哭。。。</td></tr><tr><td>2.1</td><td>创建同名表，结构无所谓</td><td>数据库的世界也需要身份证，先造个人拿上身份证，至于人长得啥样几条胳膊都无所谓，名字最重要</td></tr><tr><td>2.2</td><td>停服务；使用备份的frm文件覆盖当前的frm</td><td>偷梁换柱</td></tr><tr><td>2.3</td><td>配置文件添加强制恢复innodb的参数；启动服务</td><td>蒙蔽她的双眼</td></tr><tr><td>2.4</td><td>查看表结构</td><td>数据库会拿着身份证和面前的人（frm文件）做对比</td></tr><tr><td>2.5</td><td>查看错误日志中关于该表的报错</td><td>数据库发现身份证上的人只有1条胳膊，而被检查的人有10条胳膊，明显对不上啊</td></tr><tr><td>2.6</td><td>成功获取表的真实列数；删除这些表</td><td>通过警告可以知道应该造一个有10条胳膊的人</td></tr><tr><td>3</td><td><strong>获取表的结构</strong></td><td></td></tr><tr><td>3.1</td><td>创建同名表，列数一致，列名无所谓</td><td>这一次造人的时候，造一个有10条胳膊的，每条胳膊的名字无所谓，关键是身份证上面的人名和10条胳膊</td></tr><tr><td>3.2</td><td>停服务；使用备份的frm文件覆盖当前的frm</td><td>偷梁换柱</td></tr><tr><td>3.3</td><td>配置文件添加强制恢复innodb的参数；启动服务</td><td>蒙蔽她的双眼</td></tr><tr><td>3.4</td><td>查看表结构</td><td>数据库会拿着新的身份证和面前的人（frm文件）做对比</td></tr><tr><td>3.5</td><td>成功获取表结构</td><td>数据库发现身份证上信息和被检查的人信息一致，名字，胳膊的数量，对上了就认可啦！（数据库只检查表名和列的个数）</td></tr><tr><td>4</td><td><strong>强制恢复表数据</strong></td><td></td></tr><tr><td>4.1</td><td>丢弃当前表的数据</td><td>把这个人的五脏六腑都挖出来</td></tr><tr><td>4.2</td><td>将备份的ibd放到对应路径</td><td>将之前备份的吃了肉的五脏六腑放进去</td></tr><tr><td>4.3</td><td>导入新的数据，如果数据库加载成功则可以看到数据；否则加载失败。</td><td>跟大脑汇报一下新的五脏六腑已经就位可以开始使用了；如果使用得没问题就成功；如果器官已经损坏那么手术失败。</td></tr></tbody></table><h2 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h2><h3 id="数据量"><a href="#数据量" class="headerlink" title="数据量"></a>数据量</h3><table><thead><tr><th>明细</th><th>大小</th><th>备注</th></tr></thead><tbody><tr><td>物理文件</td><td>174M</td><td></td></tr><tr><td>数据库</td><td>1个</td><td>cy</td></tr><tr><td>表</td><td>57张</td><td></td></tr></tbody></table><h3 id="恢复结果"><a href="#恢复结果" class="headerlink" title="恢复结果"></a>恢复结果</h3><blockquote><p>在客户服务器上面结果如下：</p></blockquote><table><thead><tr><th>明细</th><th>成功</th><th>失败</th><th>恢复率</th></tr></thead><tbody><tr><td>表结构</td><td>58</td><td>0</td><td>100%</td></tr><tr><td>表数据</td><td>56</td><td>2</td><td>96%</td></tr></tbody></table><blockquote><p>在我的服务器上面结果如下：</p></blockquote><table><thead><tr><th>明细</th><th>成功</th><th>失败</th><th>恢复率</th></tr></thead><tbody><tr><td>表结构</td><td>58</td><td>0</td><td>100%</td></tr><tr><td>表数据</td><td>58</td><td>0</td><td>100%</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot mysql]# /alidata/mysql/bin/mysqld --initialize-insecure --datadir=/alidata/mysql/data/  --user=mysql</span><br><span class="line">[root@toberoot mysql]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot mysql]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.17, for linux-glibc2.5 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">[root@toberoot mysql]# cd ~/home/cy02/</span><br><span class="line">[root@toberoot cy02]# ll</span><br><span class="line">total 178140</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9022 Aug 14  2017 base_dict.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar 14 15:00 base_dict.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8822 Mar  2 11:14 biz_advise.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 14 14:39 biz_advise.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8850 Mar  2 11:14 biz_bank.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar  2 11:14 biz_bank.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9580 Mar  2 11:14 biz.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9286 Mar  2 11:14 biz_gift.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Apr 24 14:08 biz_gift.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8890 Mar  2 11:14 biz_gprs_bind.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8745 Mar  2 11:14 biz_gprs_bind_his.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   180224 May 15 09:40 biz_gprs_bind_his.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   180224 May 15 09:42 biz_gprs_bind.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 14:33 biz.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8845 Aug 14  2017 biz_msg_template.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 biz_msg_template.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8881 Aug 14  2017 biz_take_bank.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 13 19:26 biz_take_bank.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9411 Nov 24 13:22 biz_take.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   196608 May 15 15:22 biz_take.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8862 Aug 14  2017 biz_take_wwlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 15:22 biz_take_wwlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8854 Aug 14  2017 biz_take_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 11:52 biz_take_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8925 Aug 14  2017 biz_vip.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar 16 09:31 biz_vip.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8852 Aug 14  2017 biz_wlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 18:30 biz_wlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8926 Aug 14  2017 biz_wx_focus.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 10 16:24 biz_wx_focus.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9339 Nov 24 13:25 biz_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 10 16:24 biz_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8874 Aug 14  2017 biz_wx_walt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 biz_wx_walt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8776 Aug 14  2017 cfg_area.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   311296 Aug 14  2017 cfg_area.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8721 Aug 14  2017 cfg_id_gen.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 18:41 cfg_id_gen.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql       61 Aug 14  2017 db.opt</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9053 Aug 14  2017 gprs_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   212992 May 15 18:47 gprs_model.ibd</span><br><span class="line">-r--r--r-- 1 mysql mysql 79691776 May 16 14:04 ibdata1</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8801 Dec 19 15:00 mbr_coin_chged.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  2097152 May 15 17:27 mbr_coin_chged.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8766 Dec 19 14:53 mbr_coin.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 19:12 mbr_coin.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9155 May 14 11:55 mbr.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   212992 May 15 20:58 mbr.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8876 Aug 14  2017 mbr_oauth.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   475136 May 15 19:37 mbr_oauth.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9011 Aug 14  2017 mbr_pay.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 mbr_pay.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8740 Aug 14  2017 mbr_prizen.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 mbr_prizen.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9147 Dec 19 14:56 mbr_recharge.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   294912 May 15 19:11 mbr_recharge.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8801 Aug 14  2017 mbr_wallet_chged.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 17:27 mbr_wallet_chged.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8845 Aug 14  2017 mbr_wallet.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   262144 May 15 19:12 mbr_wallet.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    10100 Dec 19 15:47 ord.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql 31457280 May 15 18:41 ord.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8940 Aug 14  2017 ord_item.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_item.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8917 Aug 14  2017 ord_pay_ali.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_pay_ali.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8924 Dec 19 15:55 ord_pay_coin.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   475136 May 15 17:27 ord_pay_coin.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8926 Aug 14  2017 ord_pay_return.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_pay_return.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8966 Dec 20 16:50 ord_pay_wlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 17:27 ord_pay_wlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9036 Aug 14  2017 ord_pay_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql 32505856 May 15 18:41 ord_pay_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9098 Aug 14  2017 prod_base_args.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_base_args.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8790 Aug 14  2017 prod_bug_rpt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_bug_rpt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8887 Aug 14  2017 prod_cmd.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_cmd.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8984 Aug 14  2017 prod_cmd_invoke.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_cmd_invoke.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9058 Aug 14  2017 prod_coin_rpt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 14:24 prod_coin_rpt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8798 Aug 14  2017 prod_coin_rpt_log.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 14:24 prod_coin_rpt_log.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9834 Dec 13 14:12 prod.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8835 Aug 14  2017 prod_gprs_bind.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8793 Aug 14  2017 prod_gprs_bind_his.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   196608 May 15 09:42 prod_gprs_bind_his.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_gprs_bind.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   425984 May 15 09:42 prod.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8851 Aug 14  2017 prod_instl_imgs.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_instl_imgs.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9388 Dec 13 14:13 prod_instl_pos.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   147456 May 15 16:25 prod_instl_pos.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9384 Dec 13 14:14 prod_instl_pos_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   131072 May 15 16:24 prod_instl_pos_model.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8892 Aug 14  2017 prod_mod_attr.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_attr.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8873 Aug 14  2017 prod_mod_attr_val.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_attr_val.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9642 Dec 13 14:11 prod_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 11 11:58 prod_model.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8815 Aug 14  2017 prod_mod_sku.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_sku.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9050 Aug 14  2017 prod_onl_log.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   163840 May 15 18:42 prod_onl_log.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9143 Aug 14  2017 prod_sp_args.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_sp_args.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8876 Aug 14  2017 prod_sp_arg_vals.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_sp_arg_vals.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9190 Dec 13 14:14 sys_acct.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 14 11:16 sys_acct.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8776 Aug 14  2017 sys_acct_res.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   229376 May 11 11:52 sys_acct_res.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9106 Aug 14  2017 sys_res.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 sys_res.ibd</span><br><span class="line"><span class="meta">#</span><span class="bash">获取待恢复表名</span></span><br><span class="line">[root@toberoot cy02]# ll *.frm |awk '&#123;print $9&#125;'|awk -F '.' '&#123;print $1&#125;' &gt; /alidata/cy_table.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> python脚本自动生成建表语句</span></span><br><span class="line">[root@toberoot alidata]# cat py_createtable01.py </span><br><span class="line"><span class="meta">#</span><span class="bash">-*- coding : utf8 -*-</span></span><br><span class="line"></span><br><span class="line">def create_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    create_table_test('/alidata/cy_table.txt','/alidata/cy_sql1.sql')</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# python /alidata/py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql1.sql </span><br><span class="line">create table base_dict</span><br><span class="line"> (id int);create table biz_advise</span><br><span class="line"> (id int);create table biz_bank</span><br><span class="line"> (id int);create table biz</span><br><span class="line"> (id int);create table biz_gift</span><br><span class="line"> (id int);create table biz_gprs_bind</span><br><span class="line"> (id int);create table biz_gprs_bind_his</span><br><span class="line"> (id int);create table biz_msg_template</span><br><span class="line"> (id int);create table biz_take_bank</span><br><span class="line"> (id int);create table biz_take</span><br><span class="line">省略。。。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入测试表结构</span></span><br><span class="line">[root@toberoot alidata]# mysql -e "show databases"</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@toberoot alidata]# mysql -e "create database cy;"</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; /alidata/cy_sql1.sql </span><br><span class="line">[root@toberoot alidata]# mysql -e "desc cy.sys_res"</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11) | YES  |     | NULL    |       |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始获取表结构中列的信息</span></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# yes|cp ~/home/cy02/*.frm /alidata/mysql/data/cy/</span><br><span class="line">cp: overwrite ‘/alidata/mysql/data/cy/base_dict.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_advise.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_bank.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gift.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gprs_bind.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gprs_bind_his.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_msg_template.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_bank.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_wwlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_vip.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx_focus.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx_walt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/cfg_area.frm’? cp: overwrite ‘/alidata/mysql/data/cy/cfg_id_gen.frm’? cp: overwrite ‘/alidata/mysql/data/cy/gprs_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_coin_chged.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_coin.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_oauth.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_pay.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_prizen.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_recharge.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_wallet_chged.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_wallet.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_item.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_ali.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_coin.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_return.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_wlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_base_args.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_bug_rpt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_cmd.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_cmd_invoke.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_coin_rpt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_coin_rpt_log.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_gprs_bind.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_gprs_bind_his.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_imgs.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_pos.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_pos_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_attr.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_attr_val.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_sku.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_onl_log.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_sp_args.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_sp_arg_vals.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_acct.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_acct_res.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_res.frm’? [root@toberoot alidata]# </span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# cat py_createtable01.py </span><br><span class="line"><span class="meta">#</span><span class="bash">-*- coding : utf8 -*-</span></span><br><span class="line"></span><br><span class="line">def create_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line">   </span><br><span class="line">def desc_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "desc &#123;&#125;;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    #create_table_test('/alidata/cy_table.txt','/alidata/cy_sql1.sql')</span><br><span class="line">    desc_table_test('/alidata/cy_table.txt','/alidata/cy_sql2.sql')</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py</span><br><span class="line">[root@toberoot alidata]# head cy_sql2.sql </span><br><span class="line">desc base_dict</span><br><span class="line">;desc biz_advise</span><br><span class="line">;desc biz_bank</span><br><span class="line">;desc biz</span><br><span class="line">;desc biz_gift</span><br><span class="line">;desc biz_gprs_bind</span><br><span class="line">;desc biz_gprs_bind_his</span><br><span class="line">;desc biz_msg_template</span><br><span class="line">;desc biz_take_bank</span><br><span class="line">;desc biz_take</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 截取包含列名的报错</span></span><br><span class="line">[root@toberoot alidata]# grep contains  mysql/dataerror.log &gt; cy_error1.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 报错格式如下：</span></span><br><span class="line">2018-05-17T07:58:32.926555Z 3 [Warning] InnoDB: Table cy/base_dict contains 1 user defined columns in InnoDB, but 11 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-05-17T07:59:03.555492Z 4 [Warning] InnoDB: Table cy/biz_advise contains 1 user defined columns in InnoDB, but 7 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-05-17T07:59:03.556045Z 4 [Warning] InnoDB: Table cy/biz_bank contains 1 user defined columns in InnoDB, but 7 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将表名和列数存放至文件中</span></span><br><span class="line">[root@toberoot alidata]# awk '&#123;print $6,$15&#125;' cy_error1.log | awk -F '/' '&#123;print $2&#125;' &gt; cy_table_col.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据以上表名和列数生成新的测试表</span></span><br><span class="line">def create_table_col(table_col_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_col_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    # b_list = ['t1 10','t2 20']</span><br><span class="line">    str_list = []</span><br><span class="line">    for table_col_str in b_list:</span><br><span class="line">        table_col_list = table_col_str.split()</span><br><span class="line">table = table_col_list[0]</span><br><span class="line">col = int(table_col_list[1])</span><br><span class="line">        string = "create table &#123;&#125; (".format(table)</span><br><span class="line">        str_list.append(string)</span><br><span class="line">for i in range(1,col+1):</span><br><span class="line">            if i!=col:</span><br><span class="line">                string = 'id&#123;&#125; int,'.format(i)</span><br><span class="line">    else:</span><br><span class="line">                string = 'id&#123;&#125; int);'.format(i)</span><br><span class="line">            str_list.append(string)</span><br><span class="line">    for line in str_list:</span><br><span class="line">        a_file.write(line)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">create_table_col('/alidata/cy_table_col.txt','/alidata/cy_sql3.sql')</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除这些测试表</span></span><br><span class="line">[root@toberoot alidata]# vim py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# ll</span><br><span class="line">total 60</span><br><span class="line">-rw-r--r--  1 root  root  16729 May 17 16:00 cy_error1.log</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 15:12 cy_sql1.sql</span><br><span class="line">-rw-r--r--  1 root  root   1047 May 17 15:56 cy_sql2.sql</span><br><span class="line">-rw-r--r--  1 root  root   6353 May 17 16:15 cy_sql3.sql</span><br><span class="line">-rw-r--r--  1 root  root   1395 May 17 16:17 cy_sql4.sql</span><br><span class="line">-rw-r--r--  1 root  root    837 May 17 16:03 cy_table_col.txt</span><br><span class="line">-rw-r--r--  1 root  root    699 May 17 15:56 cy_table.txt</span><br><span class="line">drwxr-xr-x  3 root  root   4096 May 17 12:12 install</span><br><span class="line">drwxr-xr-x 11 mysql mysql  4096 May 17 15:44 mysql</span><br><span class="line">-rw-r--r--  1 root  root   1798 May 17 16:17 py_createtable01.py</span><br><span class="line"><span class="meta">#</span><span class="bash">python代码如下：</span></span><br><span class="line">def drop_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "drop table &#123;&#125;;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">drop_table_test('/alidata/cy_table.txt','/alidata/cy_sql4.sql')</span><br><span class="line">    </span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql4.sql </span><br><span class="line">drop table base_dict</span><br><span class="line">;drop table biz_advise</span><br><span class="line">;drop table biz_bank</span><br><span class="line">;drop table biz</span><br><span class="line">;drop table biz_gift</span><br><span class="line">;drop table biz_gprs_bind</span><br><span class="line">;drop table biz_gprs_bind_his</span><br><span class="line">;drop table biz_msg_template</span><br><span class="line">;drop table biz_take_bank</span><br><span class="line">;drop table biz_take</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除数据库的时候直接卡死了，原因未知。也没有报错。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">清数据启动服务</span></span><br><span class="line"></span><br><span class="line">ln: failed to create symbolic link ‘/usr/local/mysql/bin/mysqld’: File exists</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot ~]# mysql -e 'create database cy'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始尝试获取表的结构</span></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql3.sql</span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# cp ~/home/cy02/*.frm /alidata/mysql/data/cy/ -p</span><br><span class="line">cp: overwrite ‘/alidata/mysql/data/cy/base_dict.frm’? ^C</span><br><span class="line">[root@toberoot alidata]# yes | cp ~/home/cy02/*.frm /alidata/mysql/data/cy/ -p</span><br><span class="line">[root@toberoot alidata]# ll /alidata/mysql/data/cy/sys_res*</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9106 Aug 14  2017 /alidata/mysql/data/cy/sys_res.frm</span><br><span class="line">-rw-r----- 1 mysql mysql 98304 May 17 16:44 /alidata/mysql/data/cy/sys_res.ibd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_force_recovery=6</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表结构成功获取</span></span><br><span class="line">[root@toberoot alidata]# mysql cy -e 'desc sys_res'</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type         | Null | Key | Default | Extra |</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">| ID     | varchar(64)  | NO   | PRI | NULL    |       |</span><br><span class="line">| NAME   | varchar(32)  | NO   |     | NULL    |       |</span><br><span class="line">| CODE   | varchar(128) | NO   |     | NULL    |       |</span><br><span class="line">| URI    | varchar(128) | NO   |     | NULL    |       |</span><br><span class="line">| LOGO   | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| TYPE   | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| PCODE  | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| SORT   | int(11)      | YES  |     | 0       |       |</span><br><span class="line">| STATE  | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| ADMIN  | int(11)      | YES  |     | 0       |       |</span><br><span class="line">| REMARK | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| CRTIME | datetime     | NO   |     | NULL    |       |</span><br><span class="line">| UPTIME | datetime     | NO   |     | NULL    |       |</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">root@MySQL-01 16:49:  [(none)]&gt; select table_name,table_schema from information_schema.tables where table_schema='cy';</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">| table_name           | table_schema |</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">| base_dict            | cy           |</span><br><span class="line">| biz                  | cy           |</span><br><span class="line">| biz_advise           | cy           |</span><br><span class="line">| biz_bank             | cy           |</span><br><span class="line">| biz_gift             | cy           |</span><br><span class="line">| biz_gprs_bind        | cy           |</span><br><span class="line">| biz_gprs_bind_his    | cy           |</span><br><span class="line">| biz_msg_template     | cy           |</span><br><span class="line">| biz_take             | cy           |</span><br><span class="line">| biz_take_bank        | cy           |</span><br><span class="line">| biz_take_wwlt        | cy           |</span><br><span class="line">| biz_take_wx          | cy           |</span><br><span class="line">| biz_vip              | cy           |</span><br><span class="line">| biz_wlt              | cy           |</span><br><span class="line">| biz_wx               | cy           |</span><br><span class="line">| biz_wx_focus         | cy           |</span><br><span class="line">| biz_wx_walt          | cy           |</span><br><span class="line">| cfg_area             | cy           |</span><br><span class="line">| cfg_id_gen           | cy           |</span><br><span class="line">| gprs_model           | cy           |</span><br><span class="line">| mbr                  | cy           |</span><br><span class="line">| mbr_coin             | cy           |</span><br><span class="line">| mbr_coin_chged       | cy           |</span><br><span class="line">| mbr_oauth            | cy           |</span><br><span class="line">| mbr_pay              | cy           |</span><br><span class="line">| mbr_prizen           | cy           |</span><br><span class="line">| mbr_recharge         | cy           |</span><br><span class="line">| mbr_wallet           | cy           |</span><br><span class="line">| mbr_wallet_chged     | cy           |</span><br><span class="line">| ord                  | cy           |</span><br><span class="line">| ord_item             | cy           |</span><br><span class="line">| ord_pay_ali          | cy           |</span><br><span class="line">| ord_pay_coin         | cy           |</span><br><span class="line">| ord_pay_return       | cy           |</span><br><span class="line">| ord_pay_wlt          | cy           |</span><br><span class="line">| ord_pay_wx           | cy           |</span><br><span class="line">| prod                 | cy           |</span><br><span class="line">| prod_base_args       | cy           |</span><br><span class="line">| prod_bug_rpt         | cy           |</span><br><span class="line">| prod_cmd             | cy           |</span><br><span class="line">| prod_cmd_invoke      | cy           |</span><br><span class="line">| prod_coin_rpt        | cy           |</span><br><span class="line">| prod_coin_rpt_log    | cy           |</span><br><span class="line">| prod_gprs_bind       | cy           |</span><br><span class="line">| prod_gprs_bind_his   | cy           |</span><br><span class="line">| prod_instl_imgs      | cy           |</span><br><span class="line">| prod_instl_pos       | cy           |</span><br><span class="line">| prod_instl_pos_model | cy           |</span><br><span class="line">| prod_mod_attr        | cy           |</span><br><span class="line">| prod_mod_attr_val    | cy           |</span><br><span class="line">| prod_mod_sku         | cy           |</span><br><span class="line">| prod_model           | cy           |</span><br><span class="line">| prod_onl_log         | cy           |</span><br><span class="line">| prod_sp_arg_vals     | cy           |</span><br><span class="line">| prod_sp_args         | cy           |</span><br><span class="line">| sys_acct             | cy           |</span><br><span class="line">| sys_acct_res         | cy           |</span><br><span class="line">| sys_res              | cy           |</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">58 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 58张表dump备份出来</span></span><br><span class="line">[root@toberoot alidata]# mysqldump -B cy -d &gt; /alidata/new_yc_ddl.sql</span><br><span class="line">[root@toberoot alidata]# tail -n 30 /alidata/new_yc_ddl.sql </span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `sys_res` (</span><br><span class="line">  `ID` varchar(64) NOT NULL COMMENT 'ID',</span><br><span class="line">  `NAME` varchar(32) NOT NULL COMMENT '菜单名称',</span><br><span class="line">  `CODE` varchar(128) NOT NULL COMMENT '菜单编码',</span><br><span class="line">  `URI` varchar(128) NOT NULL COMMENT 'URI',</span><br><span class="line">  `LOGO` varchar(64) DEFAULT NULL COMMENT '图标',</span><br><span class="line">  `TYPE` int(11) NOT NULL COMMENT '@菜单类型（1菜单；2按钮）',</span><br><span class="line">  `PCODE` varchar(64) DEFAULT NULL COMMENT '父菜单',</span><br><span class="line">  `SORT` int(11) DEFAULT '0' COMMENT '排序',</span><br><span class="line">  `STATE` int(11) NOT NULL COMMENT '@@状态（0 无效；1 正常）',</span><br><span class="line">  `ADMIN` int(11) DEFAULT '0' COMMENT '是否管理员菜单（默认0否）',</span><br><span class="line">  `REMARK` varchar(64) DEFAULT NULL COMMENT '备注',</span><br><span class="line">  `CRTIME` datetime NOT NULL COMMENT 'CRTIME',</span><br><span class="line">  `UPTIME` datetime NOT NULL COMMENT 'UPTIME',</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='权限_系统资源';</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2018-05-17 16:52:28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> discard和import命令</span></span><br><span class="line">def discard_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "alter table &#123;&#125; discard tablespace;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def import_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "alter table &#123;&#125; import tablespace;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">discard_table_test('/alidata/cy_table.txt','/alidata/cy_sql5.sql')</span><br><span class="line">import_table_test('/alidata/cy_table.txt','/alidata/cy_sql6.sql')</span><br><span class="line">   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成sql</span></span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# ll</span><br><span class="line">total 124</span><br><span class="line">-rw-r--r--  1 root  root  16729 May 17 16:00 cy_error1.log</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 15:12 cy_sql1.sql</span><br><span class="line">-rw-r--r--  1 root  root   1047 May 17 15:56 cy_sql2.sql</span><br><span class="line">-rw-r--r--  1 root  root   6353 May 17 16:15 cy_sql3.sql</span><br><span class="line">-rw-r--r--  1 root  root   1395 May 17 16:17 cy_sql4.sql</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 16:55 cy_sql5.sql</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 16:55 cy_sql6.sql</span><br><span class="line">-rw-r--r--  1 root  root    837 May 17 16:03 cy_table_col.txt</span><br><span class="line">-rw-r--r--  1 root  root    699 May 17 15:56 cy_table.txt</span><br><span class="line">drwxr-xr-x  3 root  root   4096 May 17 16:41 install</span><br><span class="line">drwxr-xr-x 11 mysql mysql  4096 May 17 16:47 mysql</span><br><span class="line">-rw-r--r--  1 root  root  57068 May 17 16:52 new_yc_ddl.sql</span><br><span class="line">-rw-r--r--  1 root  root   2489 May 17 16:55 py_createtable01.py</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql5.sql </span><br><span class="line">alter table base_dict</span><br><span class="line"> discard tablespace;alter table biz_advise</span><br><span class="line"> discard tablespace;alter table biz_bank</span><br><span class="line"> discard tablespace;alter table biz</span><br><span class="line"> discard tablespace;alter table biz_gift</span><br><span class="line"> discard tablespace;alter table biz_gprs_bind</span><br><span class="line"> discard tablespace;alter table biz_gprs_bind_his</span><br><span class="line"> discard tablespace;alter table biz_msg_template</span><br><span class="line"> discard tablespace;alter table biz_take_bank</span><br><span class="line"> discard tablespace;alter table biz_take</span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql6.sql </span><br><span class="line">alter table base_dict</span><br><span class="line"> import tablespace;alter table biz_advise</span><br><span class="line"> import tablespace;alter table biz_bank</span><br><span class="line"> import tablespace;alter table biz</span><br><span class="line"> import tablespace;alter table biz_gift</span><br><span class="line"> import tablespace;alter table biz_gprs_bind</span><br><span class="line"> import tablespace;alter table biz_gprs_bind_his</span><br><span class="line"> import tablespace;alter table biz_msg_template</span><br><span class="line"> import tablespace;alter table biz_take_bank</span><br><span class="line"> import tablespace;alter table biz_take</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld restart</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# cp /root/home/cy02/*.ibd /alidata/mysql/data/cy/ -rp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 2013 (HY000) at line 1: Lost connection to MySQL server during query</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld restart</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# rm -rf /alidata/mysql/data/*</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot alidata]# mysql &lt; new_yc_ddl.sql </span><br><span class="line">[root@toberoot alidata]# mysql -e 'use cy;select * from sys_res'</span><br><span class="line"></span><br><span class="line">开启强制恢复参数</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql</span><br><span class="line">cy_sql1.sql  cy_sql2.sql  cy_sql3.sql  cy_sql4.sql  cy_sql5.sql  cy_sql6.sql  </span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql </span><br><span class="line">[root@toberoot alidata]# cp /root/home/cy02/*.ibd /alidata/mysql/data/cy/ -rp</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 全备份数据</span></span><br><span class="line">[root@toberoot alidata]# mysqldump -B cy &gt; new_cy_all.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看备份的数据量</span></span><br><span class="line">-rw-r--r--  1 root  root   26M May 17 17:13 new_cy_all.sql</span><br></pre></td></tr></table></figure><h2 id="报错汇总"><a href="#报错汇总" class="headerlink" title="报错汇总"></a>报错汇总</h2><h3 id="ERROR-1036-（HY00）"><a href="#ERROR-1036-（HY00）" class="headerlink" title="ERROR 1036 （HY00）"></a>ERROR 1036 （HY00）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br></pre></td></tr></table></figure><p>解决方法：</p><ol><li>检查是否配置文件中存在innodb_force_recovery参数</li><li>如果存在去除或注释掉，重启服务即可</li><li>还不行就清空数据库导入结构后再继续</li></ol><h3 id="ERROR-2013-HY000"><a href="#ERROR-2013-HY000" class="headerlink" title="ERROR 2013 (HY000)"></a>ERROR 2013 (HY000)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 2013 (HY000) at line 1: Lost connection to MySQL server during query</span><br></pre></td></tr></table></figure><p>解决方法：</p><ol><li><p>sql脚本中执行import tablespace的操作需要开启recovery的参数</p></li><li><p>重启服务 </p><p>在客户服务上，执行以上操作还是报错无法连接，尝试多次都不行。</p></li></ol><p><img src="MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/04.jpg" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次case的教训就是，备份！一定要有周期性的有效备份！</p><p>欺骗MySQL进程蒙混过关只能是没办法的办法，而且不能保证成功率。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -*- coding : utf8 -*-</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> py_createtable01.py</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> auth： booboowei</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class mysql_tools():</span><br><span class="line">    def __init__(self, in_file):</span><br><span class="line">        self.b_list = open(in_file).readlines()</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">    def create_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def desc_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "desc &#123;&#125;;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def create_table_col(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        str_list = []</span><br><span class="line">        for table_col_str in self.b_list:</span><br><span class="line">            table_col_list = table_col_str.split()</span><br><span class="line">            table = table_col_list[0]</span><br><span class="line">            col = int(table_col_list[1])</span><br><span class="line">            string = "create table &#123;&#125; (".format(table)</span><br><span class="line">            str_list.append(string)</span><br><span class="line">            for i in range(1, col + 1):</span><br><span class="line">                if i != col:</span><br><span class="line">                    string = 'id&#123;&#125; int,'.format(i)</span><br><span class="line">                else:</span><br><span class="line">                    string = 'id&#123;&#125; int);'.format(i)</span><br><span class="line">                str_list.append(string)</span><br><span class="line">        for line in str_list:</span><br><span class="line">            a_file.write(line)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def drop_table_test(self,  sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "drop table &#123;&#125;;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def discard_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "alter table &#123;&#125; discard tablespace;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def import_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "alter table &#123;&#125; import tablespace;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').create_table_test('/alidata/cy_sql1.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').desc_table_test('/alidata/cy_sql2.sql')</span><br><span class="line">    # 根据以上表名和列数生成新的测试表</span><br><span class="line">    mysql_tools('/alidata/cy_table_col.txt').create_table_col('/alidata/cy_sql3.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').drop_table_test('/alidata/cy_sql4.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').discard_table_test('/alidata/cy_sql5.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').import_table_test('/alidata/cy_sql6.sql')</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：Cash恢复的正确方式是：&lt;strong&gt;备份文件（逻辑或物理）+ binlog&lt;/strong&gt;进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效&lt;/p&gt;
&lt;p&gt;在本次案例中，某客户数据库因存储空间不够导致数据库服务宕掉，而客户在数据库宕机后，只拷贝了单个&lt;code&gt;cy&lt;/code&gt;库所属的目录进行了文件层面的备份，就将其他文件全部清空，当他想重新启动数据库时发现数据库服务启动。MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的&lt;code&gt;.frm&lt;/code&gt;和&lt;code&gt;.ibd&lt;/code&gt;文件。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="数据救援" scheme="http://www.toberoot.com/tags/%E6%95%B0%E6%8D%AE%E6%95%91%E6%8F%B4/"/>
    
  </entry>
  
  <entry>
    <title>MySQL的元锁MDL发生场景和解决方法总结</title>
    <link href="http://www.toberoot.com/2017/08/19/booboo_others/MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"/>
    <id>http://www.toberoot.com/2017/08/19/booboo_others/MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/</id>
    <published>2017-08-18T20:06:27.000Z</published>
    <updated>2020-03-22T08:32:42.577Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。</p><p>今天有客户(MySQL 5.6)遇到该问题，最关键的是属于第三种情况，google上根本找不到类似的故障案例，唯一一个非常接近的故障案例中数据库版本却不同（具体看下文慢慢聊），哎，困难重重啊，最终还是解决了哈。</p><p>alter table的语句是很危险的，在操作之前最好确认对要操作的表没有任何进行中的操作、没有未提交事务、也没有显式事务中的报错语句。如果有alter table的维护任务，在无人监管的时候运行，最好通过lock_wait_timeout设置好超时时间，避免长时间的metedata锁等待。</p><a id="more"></a><h2 id="什么是metadata-lock？"><a href="#什么是metadata-lock？" class="headerlink" title="什么是metadata lock？"></a>什么是metadata lock？</h2><p>MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。</p><h3 id="MetaData-Lock的前世今生"><a href="#MetaData-Lock的前世今生" class="headerlink" title="MetaData Lock的前世今生"></a><strong>MetaData Lock的前世今生</strong></h3><p>MDL锁是为了解决一个有名的<a href="https://bugs.mysql.com/bug.php?id=989" target="_blank" rel="noopener">bug#989</a>，所以在5.5.3版本引入了MDL锁。其实5.5也有类似保护元数据的机制，只是没有明确提出MDL概念而已。但是5.5之前版本(比如5.1)与5.5之后版本在保护元数据这块有一个显著的不同点是，5.1对于元数据的保护是语句级别的，5.5对于metadata的保护是事务级别的。所谓语句级别，即语句执行完成后，无论事务是否提交或回滚，其表结构可以被其他会话更新；而事务级别则是在事务结束后才释放MDL。引入MDL锁主要是为了<strong>解决两个问题</strong>：</p><ul><li>事务隔离问题：比如在可重复隔离级别下，会话A在2次查询期间，会话B对表结构做了修改，两次查询结果就会不一致，无法满足可重复读的要求。</li><li>数据复制问题：比如会话A执行了多条更新语句期间，另外一个会话B做了表结构变更并且先提交，就会导致slave在重做时，先重做alter，再重做update时就会出现复制错误的现象。也就是上面提到的<a href="https://bugs.mysql.com/bug.php?id=989" target="_blank" rel="noopener">bug#989</a>。</li></ul><hr><h3 id="DDL操作与MetaData-Lock"><a href="#DDL操作与MetaData-Lock" class="headerlink" title="DDL操作与MetaData Lock"></a>DDL操作与MetaData Lock</h3><ul><li>metadata lock 机制是为了保证数据一致性存在的，在有事务的操作时候，需要首先获得metadata lock ,然后操作，如果这个时候，又来了一个事务也要ddl操作同一个表，就会出现 metadata lock。</li><li>自动提交模式下，单语句就是一个事务，执行完了，事务也就结束了。</li><li>preparestatement  会获得 metalock，一旦prepare 完毕， metalock 就释放了。</li><li>online DDL应该是指在alter table进行的时候， 插入/修改/删除数据的sql语句不会Waiting for table metadata lock。一旦alter table TableA的操作停滞在Waiting for table metadata lock的状态，后续对TableA的任何操作（包括读）都无法进行，也会在Opening tables的阶段进入Waiting for table metadata lock的队列。</li></ul><h2 id="Alter-table-会发生锁的三种场景"><a href="#Alter-table-会发生锁的三种场景" class="headerlink" title="Alter table 会发生锁的三种场景"></a>Alter table 会发生锁的三种场景</h2><h3 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h3><ul><li>会话A对booboo表执行读操作<code>select *,sleep(60) from booboo;</code>，正在进行未提交事务</li><li>会话B对booboo表执行在线DDL操作<code>alter table booboo add q4 int default 0;</code></li><li>会话C对booboo表执行隐式读操作<code>select *,sleep(60) from booboo;</code>,进行等待</li><li>会话D对booboo表执行显示读操作<code>begin;select * from booboo;</code>也会进行等待</li><li>通过<code>show processlist</code>可以看到会话A（对booboo表上正在进行的操作），此时会话B（alter table语句）无法获取到metadata 独占锁，会进行等待，会话C和会话D都会进行等待，且能从processlist表中看到对booboo表的操作</li><li>会话A提交事务后或kill之后，会话C事务结束，会话D<code>select</code>语句执行成功，事务提交则会话B可执行，否则进入场景2</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;</span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |  167 | Waiting for table metadata lock | alter table booboo add q4 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Query   |  155 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">|  9 | root | localhost | uplooking | Query   |  181 | User sleep                      | select *,sleep(60) from booboo          |</span><br><span class="line">| 10 | root | localhost | uplooking | Query   |    7 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> id=9的线程为会话A 虽然是隐式事务，但是没有执行成功，所以为未提交的事务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=6的线程为会话B 在会话A有事务未提交的情况下，执行Alter操作,争抢metadata lock</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=7的线程为会话C 隐式查询事务也会进入等待</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=10的线程为会话D 显示查询事务同样进入等待</span></span><br></pre></td></tr></table></figure><p>解决方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看metadatalock</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 第一种情况，则定位到长时间未提交的事务kill即可</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询 information_schema.innodb_trx 看到有长时间未完成的事务， 使用 <span class="built_in">kill</span> 命令终止该查询。</span></span><br><span class="line"></span><br><span class="line">select concat('kill ',i.trx_mysql_thread_id,';') from information_schema.innodb_trx i,</span><br><span class="line">  (select </span><br><span class="line">         id, time</span><br><span class="line">     from</span><br><span class="line">         information_schema.processlist</span><br><span class="line">     where</span><br><span class="line">         time = (select </span><br><span class="line">                 max(time)</span><br><span class="line">             from</span><br><span class="line">                 information_schema.processlist</span><br><span class="line">             where</span><br><span class="line">                 state = 'Waiting for table metadata lock'</span><br><span class="line">                     and substring(info, 1, 5) in ('alter' , 'optim', 'repai', 'lock ', 'drop ', 'creat'))) p</span><br><span class="line">  where timestampdiff(second, i.trx_started, now()) &gt; p.time</span><br><span class="line">  and i.trx_mysql_thread_id  not in (connection_id(),p.id);</span><br></pre></td></tr></table></figure><h3 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h3><ul><li>通过<code>show processlist</code>看不到booboo上有任何操作，但实际上存在有未提交的事务，可以在<code>information_schema.innodb_trx</code>中查看到。在事务没有完成之前，booboo的锁不会释放，alter table同样获取不到metadata的独占锁</li><li>会话D提交事务或回滚或kill，则会话B中的Alter可继续执行</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在场景1的基础上，将会话A的事务完成或者<span class="built_in">kill</span>掉，会话C执行成功，但是会话B和会话D继续进入metadata锁的等待。原因是会话D虽然select可以执行，但是事务没有提交，则表上的metadata锁还存在，导致会话B的ddl操作无法执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B和会话D，情况1：知道有未完成的事务D，则结束会话D的事务，会话B正常执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B和会话D，情况2：不知道有未结束的事务D，如何排错呢？</span></span><br><span class="line">=================================</span><br><span class="line"></span><br><span class="line">-- 请根据具体的情景修改查询语句</span><br><span class="line">-- 如果导致阻塞的语句的用户与当前用户不同，请使用导致阻塞的语句的用户登录来终止会话</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 场景2的情况，是在场景1的基础上，还是有metadatalock锁（*一般生产环境不会停服务，因此不停的有新的query发送过来，就会出现场景2*），则手动继续kill掉长事务即可，注意生产环境中，有可能ddl操作需要保留（*例如MDL锁出现在主从同步的从中，从库需要去执行主发送的表变更，当然，也可以先将主从停掉，手动执行alter操作，都可以*）以下方法是在停止对从库的读操作后，将非ddl的连接kill掉</span></span></span><br><span class="line"></span><br><span class="line">select id,State,command from information_schema.processlist where State="Waiting for table metadata lock";</span><br><span class="line">select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id;</span><br><span class="line">show processlist;</span><br><span class="line">select  concat('kill ',trx_mysql_thread_id,';') from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id and State!="Waiting for table metadata lock";</span><br><span class="line"></span><br><span class="line">===============================</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                             </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |  275 | Waiting for table metadata lock | alter table booboo add q6 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Sleep   |  269 |                                 | NULL                                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 10 | root | localhost | uplooking | Sleep   |  249 |                                 | NULL                                    |</span><br><span class="line">| 12 | root | localhost | uplooking | Sleep   |  191 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前进程发现除了Alter之外没有对booboo表的操作</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">| timediff | sysdate()           | trx_started         | id | USER | DB        | COMMAND | STATE                           | trx_state | trx_query                               |</span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">| 00:05:38 | 2017-08-18 20:21:07 | 2017-08-18 20:15:29 |  6 | root | uplooking | Query   | Waiting for table metadata lock | RUNNING   | alter table booboo add q6 int default 0 |</span><br><span class="line">| 00:05:38 | 2017-08-18 20:21:07 | 2017-08-18 20:15:29 | 10 | root | uplooking | Sleep   |                                 | RUNNING   | NULL                                    |</span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看innodb_trx表可以看到除了alter之外有未完成的事务，但是看不到具体query，得到线程id为10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就可以<span class="built_in">kill</span> 10来结束事务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后Alter正常操作</span></span><br></pre></td></tr></table></figure><h3 id="场景3"><a href="#场景3" class="headerlink" title="场景3"></a>场景3</h3><blockquote><p>与场景2对比的现象不同于：</p><ul><li>场景2：未完成事务中存在未完成事务</li><li>场景3：未完成事务中不存在未完成事务：确认有错误事务未提交或回滚，找到该事务的session_id然后杀死</li></ul></blockquote><ul><li>通过<code>show processlist</code>看不到<code>booboo</code>表有任何操作，在<code>information_schema.innodb_trx</code>中也没有任何进行中的事务。</li><li>这很可能是因为在一个显式的事务中，对<code>booboo</code>表进行了一个失败的操作（比如查询了一个不存在的字段），这时事务没有开始，但是失败语句获取到的锁依然有效。从<code>performance_schema.events_statements_current</code>表中可以查到失败的语句</li><li>也就是说除了语法错误，其他错误语句获取到的锁在这个事务提交或回滚之前，仍然不会释放掉。<code>because the failed statement is written to the binary log and the locks protect log consistency</code>但是解释这一行为的原因很难理解，因为错误的语句根本不会被记录到二进制日志</li><li>解决方法：确认有错误事务未提交或回滚，找到该事务的sessionid然后杀死（难点）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 场景3的出现和前两种不同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看线程情况，看到alter操作metadata锁，还有其他的select操作有metadata锁</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 第一反应就是有可能是场景1，于是kill掉执行select的线程，再次查看线程情况，就只剩下执行alter线程了</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 接下来查看未完成的事务，如果是场景1，在kill掉冲突的线程后应该出现两种情况（A.alter操作正常执行B.线程中只有alter操作为waiting metadata lock状态；未完成事务中存在未完成事务）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 但是却发现和B情况有所不同的是：未完成事务中不存在未完成事务，总结第三种情况(C.线程中只有alter操作为waiting metadata lock状态；未完成事务中不存在未完成事务）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过搜索资料定位到是场景3，但资料中没有说怎么解决问题，又不能重新启动服务器，只有一个资料里提到了方法（确认有错误事务未提交或回滚，找到该事务的sessionid然后杀死，关键就是如何找到sessionid呢？performance_schema.events_statements_current中的thread_id为线程id并不是sessionid或者说会话id、连接id，如何通过thread_id找到session_id成为了难点？5.7中有个session表可以直接查到，而5.6中必须通过三表才能查到，分别为performance_schema.events_statements_current,performance_schema.threads,information_schema.processlist表。）</span></span><br><span class="line">=====================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">kill</span>掉除了写操作以外的query</span></span><br><span class="line">select concat('kill ',id) from information_schema.processlist where State="Waiting for table metadata lock" and substring(info, 1, 5) not in ('alter' , 'optim', 'repai', 'lock ', 'drop ', 'creat');</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 寻找未提交或未回滚的错误事务，并<span class="built_in">kill</span>即可</span></span><br><span class="line">select t.processlist_id,t.processlist_time,e.sql_text from performance_schema.threads t,performance_schema.events_statements_current e where t.thread_id=e.thread_id and e.SQL_TEXT like '%t1%';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 案例中假设是在t1表上有MDL锁，则，e.sql_text 近似匹配t1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本方法5.5 5.6 5.7 都通用。</span></span><br><span class="line">=============================================================================</span><br></pre></td></tr></table></figure><p>第一步：模拟第三种情况，会话11执行一个显示事务，且query出现列错误，t1表中不存在xx列，不提交。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93%5Cmdl01.png" alt=""></p><p>第二步：会话14中执行alter操作</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl02.png" alt="mdl02"></p><p>第三步：执行一条query</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl03.png" alt="mdl03"></p><p>第四步：会话15执行一个显示事务，查询t1表</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl04.png" alt="mdl04"></p><p>第五步：查看当前的processlist情况，可以看到只要是对t1表的操作都出现了MDL锁等待；尝试通过第一种情况的解决方法找出阻塞的事务会话进行kill，发现不存在阻塞会话；查看当前未提交的事务发现返回空；通过过滤processlist中进行MDL锁等待且不是alter的会话id，进行kill。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl06.png" alt="mdl06"></p><p>第六步：只kill 12，15，留下执行alter的会话14；有人会想为什么都kill掉呢？因为即使现在kill掉了，t1表的MDL锁也不会释放掉，还不如留下会话14的ddl操作，等彻底解决了，自然就能执行这个操作。具体可以看下面的分析。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl07.png" alt="mdl07"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl08.png" alt="mdl08"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl09.png" alt="mdl09"></p><p>第七步：给大家做个测试，即使将会话14的alter动作kill掉：</p><ul><li>processlist中看不到任何等待MDL锁的会话；</li><li>sys.schema_table_lock_waits中也不存在表锁（5.7才有sys库）；</li><li>performance_schema.metadata_locks中也不存在任何锁记录；</li><li>会话16想再去执行alter操作，又开始了MDL锁等待。</li></ul><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl10.png" alt="mdl10"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl11.png" alt="mdl11"></p><p>第八步：此时就一定可以确定当前属于【<strong>有错误事务未提交或回滚导致的MDL锁</strong>】的情况了。我们找出这个错误事务，进行kill</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl12.png" alt="mdl12"></p><p>第九步：kill掉会话11后，成功将MDL锁释放。</p><blockquote><p>有人又会问咯：为什么不将数据库重启？</p><p>回答：</p><p>如果说——</p><ol><li><p>业务允许重启</p></li><li><p>不想找到问题的根源</p><p>那么重启吧</p></li></ol><p>如果说—— </p><ol><li><p>数据库上面多个库，关联多个业务，不能重启</p></li><li><p>想找到问题的根源，防止下次再次出现类似的问题</p><p>那么你懂的</p></li></ol><p>那么为什么不直接kill所有会话呢？同样如果你要找出问题的根源那么就排查，不想问为什么就直接kill吧，末尾有kill的脚本</p></blockquote><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl13.png" alt="mdl13"></p><p>一步步分析如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                                                                                   </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |   17 | Waiting for table metadata lock | alter table booboo add q9 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Query   |   11 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 14 | root | localhost | uplooking | Query   |    5 | Waiting for table metadata lock | select * from booboo where id=3         |</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |   28 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 7 ;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 14;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                                                                                   </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |   86 | Waiting for table metadata lock | alter table booboo add q9 int default 0 |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |   97 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果符合情况C，需要去查看performance_schema.events_statements_current表中是否有对booboo的错误语句（这里的错误语句是非语法错误的，例如select中写了不存在的列等情况）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从下面的查询结果可以看到，确实存在一个错误语句事件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过该错误语句事件的THREAD_ID，到performance_schema.threads表查到该线程对应的PROCESSLIST_ID，而PROCESSLIST_ID进程id等于processlist中的id</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from performance_schema.events_statements_current <span class="built_in">where</span> SQL_TEXT like <span class="string">'%booboo%'</span>\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              THREAD_ID: 31</span><br><span class="line">               EVENT_ID: 16</span><br><span class="line">           END_EVENT_ID: NULL</span><br><span class="line">             EVENT_NAME: statement/sql/alter_table</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3292336129737000</span><br><span class="line">              TIMER_END: 3521408438190000</span><br><span class="line">             TIMER_WAIT: 229072308453000</span><br><span class="line">              LOCK_TIME: 0</span><br><span class="line">               SQL_TEXT: alter table booboo add q9 int default 0</span><br><span class="line">                 DIGEST: NULL</span><br><span class="line">            DIGEST_TEXT: NULL</span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 0</span><br><span class="line">      RETURNED_SQLSTATE: NULL</span><br><span class="line">           MESSAGE_TEXT: NULL</span><br><span class="line">                 ERRORS: 0</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 0</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 0</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 0</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">              THREAD_ID: 33</span><br><span class="line">               EVENT_ID: 74</span><br><span class="line">           END_EVENT_ID: NULL</span><br><span class="line">             EVENT_NAME: statement/sql/select</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3521408132304000</span><br><span class="line">              TIMER_END: 3521408462141000</span><br><span class="line">             TIMER_WAIT: 329837000</span><br><span class="line">              LOCK_TIME: 184000000</span><br><span class="line">               SQL_TEXT: select * from performance_schema.events_statements_current where SQL_TEXT like '%booboo%'</span><br><span class="line">                 DIGEST: NULL</span><br><span class="line">            DIGEST_TEXT: NULL</span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 0</span><br><span class="line">      RETURNED_SQLSTATE: NULL</span><br><span class="line">           MESSAGE_TEXT: NULL</span><br><span class="line">                 ERRORS: 0</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 1</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 1</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 1</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">              THREAD_ID: 40</span><br><span class="line">               EVENT_ID: 8</span><br><span class="line">           END_EVENT_ID: 8</span><br><span class="line">             EVENT_NAME: statement/sql/select</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3280938133699000</span><br><span class="line">              TIMER_END: 3280938258470000</span><br><span class="line">             TIMER_WAIT: 124771000</span><br><span class="line">              LOCK_TIME: 0</span><br><span class="line">               SQL_TEXT: select abc from booboo</span><br><span class="line">                 DIGEST: 871dd43dfdfb143e81439bbe7bf7b57e</span><br><span class="line">            DIGEST_TEXT: SELECT `abc` FROM `booboo` </span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 1054</span><br><span class="line">      RETURNED_SQLSTATE: 42S22</span><br><span class="line">           MESSAGE_TEXT: Unknown column 'abc' in 'field list'</span><br><span class="line">                 ERRORS: 1</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 0</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 0</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 0</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select THREAD_ID,DIGEST_TEXT from performance_schema.events_statements_current <span class="built_in">where</span> DIGEST_TEXT=<span class="string">"SELECT `abc` FROM `booboo`"</span>;</span></span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">| THREAD_ID | DIGEST_TEXT                 |</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">|        40 | SELECT `abc` FROM `booboo`  |</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from performance_schema.threads <span class="built_in">where</span> thread_id=40\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">          THREAD_ID: 40</span><br><span class="line">               NAME: thread/sql/one_connection</span><br><span class="line">               TYPE: FOREGROUND</span><br><span class="line">     PROCESSLIST_ID: 15</span><br><span class="line">   PROCESSLIST_USER: root</span><br><span class="line">   PROCESSLIST_HOST: localhost</span><br><span class="line">     PROCESSLIST_DB: uplooking</span><br><span class="line">PROCESSLIST_COMMAND: Sleep</span><br><span class="line">   PROCESSLIST_TIME: 402</span><br><span class="line">  PROCESSLIST_STATE: NULL</span><br><span class="line">   PROCESSLIST_INFO: NULL</span><br><span class="line">   PARENT_THREAD_ID: NULL</span><br><span class="line">               ROLE: NULL</span><br><span class="line">       INSTRUMENTED: YES</span><br><span class="line">            HISTORY: YES</span><br><span class="line">    CONNECTION_TYPE: Socket</span><br><span class="line">       THREAD_OS_ID: 22758</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select PROCESSLIST_ID from performance_schema.threads <span class="built_in">where</span> thread_id=40;</span></span><br><span class="line">+----------------+</span><br><span class="line">| PROCESSLIST_ID |</span><br><span class="line">+----------------+</span><br><span class="line">|             15 |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from information_schema.processlist <span class="built_in">where</span> id=(select PROCESSLIST_ID from performance_schema.threads <span class="built_in">where</span> thread_id=40);</span></span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">| ID | USER | HOST      | DB        | COMMAND | TIME | STATE | INFO |</span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |  466 |       | NULL |</span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 15;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table booboo add q9 int default 0;</span></span><br><span class="line">Query OK, 0 rows affected (9 min 54.35 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><h2 id="小知识点总结"><a href="#小知识点总结" class="headerlink" title="小知识点总结"></a>小知识点总结</h2><h3 id="三张表的关系"><a href="#三张表的关系" class="headerlink" title="三张表的关系"></a>三张表的关系</h3><blockquote><p>MySQL 5.6</p></blockquote><ol><li><code>performance_schema</code>库中，<code>events_statements_current</code>表中<code>theard_id</code>与<code>threads</code>表中的<code>thread_id</code>相同</li><li><code>performance_schema</code>库中，threads表中，thread_id和processlist_id为对应关系，<code>thread_id</code>表示一个独特的线程标识符;<code>processlist_id</code>是<code>show processlist</code>显示的<code>id</code>值，连接标识符；而对于后台线程(与用户连接不相关的线程)，<code>PROCESSLIST_ID</code>为空，此值不是唯一的。</li><li><code>information_schema</code>库中,<code>PROCESSLIST</code>表是一个非标准表。<code>id</code>连接标识符，并由CONNECTION_ID()函数返回。</li></ol><table><thead><tr><th>performance_schema</th><th>performance_schema</th><th>performance_schema</th><th>information_schema</th></tr></thead><tbody><tr><td>events_statements_current</td><td>threads</td><td>threads</td><td>processlist</td></tr><tr><td>THREAD_ID</td><td>THREAD_ID</td><td>PROCESSLIST_ID</td><td>ID</td></tr></tbody></table><h3 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h3><ol><li>线程表中保存了所有线程的信息，有前台的有后台运行的；</li><li>如果是由连接产生的线程，一般都是前台线程，会分配一个processlist_id，可以在information_schema.processlist中看到</li></ol><h3 id="资料参考"><a href="#资料参考" class="headerlink" title="资料参考"></a>资料参考</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/threads-table.html" target="_blank" rel="noopener">官网关于threads表的说明</a></p><p><a href="https://dev.mysql.com/doc/refman/5.7/en/show-processlist.html" target="_blank" rel="noopener">官方关于processlist表的说明</a></p><p><a href="http://www.voidcn.com/article/p-hjsjvnlz-bog.html" target="_blank" rel="noopener">MySQL5.7 MetaData Lock 案例分享</a></p><h3 id="不同版本"><a href="#不同版本" class="headerlink" title="不同版本"></a>不同版本</h3><blockquote><p>MySQL 5.7</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.events_statements_current\G</span><br><span class="line">select * from sys.x$session\G</span><br><span class="line">select * from sys.x$processlist\G</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from x$session\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                thd_id: 3904</span><br><span class="line">               conn_id: 3879</span><br><span class="line">                  user: root@localhost</span><br><span class="line">                    db: sys</span><br><span class="line">               command: Query</span><br><span class="line">                 state: Sending data</span><br><span class="line">                  time: 0</span><br><span class="line">     current_statement: select * from x$session</span><br><span class="line">     statement_latency: 1564453000</span><br><span class="line">              progress: NULL</span><br><span class="line">          lock_latency: 847000000</span><br><span class="line">         rows_examined: 0</span><br><span class="line">             rows_sent: 0</span><br><span class="line">         rows_affected: 0</span><br><span class="line">            tmp_tables: 4</span><br><span class="line">       tmp_disk_tables: 1</span><br><span class="line">             full_scan: YES</span><br><span class="line">        last_statement: NULL</span><br><span class="line">last_statement_latency: NULL</span><br><span class="line">        current_memory: 0</span><br><span class="line">             last_wait: NULL</span><br><span class="line">     last_wait_latency: NULL</span><br><span class="line">                source: NULL</span><br><span class="line">           trx_latency: NULL</span><br><span class="line">             trx_state: NULL</span><br><span class="line">        trx_autocommit: NULL</span><br><span class="line">                   pid: 12880</span><br><span class="line">          program_name: mysql</span><br><span class="line">1 row in set (0.05 sec)</span><br><span class="line">mysql&gt; select * from  x$processlist limit 1\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                thd_id: 1</span><br><span class="line">               conn_id: NULL</span><br><span class="line">                  user: sql&#x2F;main</span><br><span class="line">                    db: NULL</span><br><span class="line">               command: NULL</span><br><span class="line">                 state: NULL</span><br><span class="line">                  time: 230927</span><br><span class="line">     current_statement: NULL</span><br><span class="line">     statement_latency: NULL</span><br><span class="line">              progress: NULL</span><br><span class="line">          lock_latency: NULL</span><br><span class="line">         rows_examined: NULL</span><br><span class="line">             rows_sent: NULL</span><br><span class="line">         rows_affected: NULL</span><br><span class="line">            tmp_tables: NULL</span><br><span class="line">       tmp_disk_tables: NULL</span><br><span class="line">             full_scan: NO</span><br><span class="line">        last_statement: NULL</span><br><span class="line">last_statement_latency: NULL</span><br><span class="line">        current_memory: 0</span><br><span class="line">             last_wait: NULL</span><br><span class="line">     last_wait_latency: NULL</span><br><span class="line">                source: NULL</span><br><span class="line">           trx_latency: NULL</span><br><span class="line">             trx_state: NULL</span><br><span class="line">        trx_autocommit: NULL</span><br><span class="line">                   pid: NULL</span><br><span class="line">          program_name: NULL</span><br><span class="line">1 row in set (0.06 sec)</span><br><span class="line">mysql&gt; select * from information_schema.processlist;</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">| ID   | USER | HOST      | DB   | COMMAND | TIME | STATE     | INFO                                         |</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">| 3879 | root | localhost | sys  | Query   |    0 | executing | select * from information_schema.processlist |</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="MDL故障自愈"><a href="#MDL故障自愈" class="headerlink" title="MDL故障自愈"></a>MDL故障自愈</h2><h3 id="kill所有会话"><a href="#kill所有会话" class="headerlink" title="kill所有会话"></a>kill所有会话</h3><blockquote><p>不想知道故障原因，只想快速解决故障</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">kill</span>掉 所有会话</span></span><br><span class="line">user=xxx</span><br><span class="line">password=xxx</span><br><span class="line">host=xxxx.mysql.rds.aliyuncs.com</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">mysql -u$user -p$password -h$host  -P$port -e "select  concat('KILL ',id,';') from information_schema.processlist;" &gt; tmpfile</span><br><span class="line"></span><br><span class="line">awk '&#123;if (NR != 1) print $0 &#125;' tmpfile | mysql -u$user -p$password -h$host  -P$port</span><br></pre></td></tr></table></figure><h3 id="MDL故障排查和解决"><a href="#MDL故障排查和解决" class="headerlink" title="MDL故障排查和解决"></a>MDL故障排查和解决</h3><p><a href="https://github.com/BoobooWei/DevOps-Database-Troubleshooting/blob/master/fault_self_healing_metadatalock.py" target="_blank" rel="noopener">MDL故障自愈脚本GitHub地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。&lt;/p&gt;
&lt;p&gt;今天有客户(MySQL 5.6)遇到该问题，最关键的是属于第三种情况，google上根本找不到类似的故障案例，唯一一个非常接近的故障案例中数据库版本却不同（具体看下文慢慢聊），哎，困难重重啊，最终还是解决了哈。&lt;/p&gt;
&lt;p&gt;alter table的语句是很危险的，在操作之前最好确认对要操作的表没有任何进行中的操作、没有未提交事务、也没有显式事务中的报错语句。如果有alter table的维护任务，在无人监管的时候运行，最好通过lock_wait_timeout设置好超时时间，避免长时间的metedata锁等待。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="锁故障" scheme="http://www.toberoot.com/tags/%E9%94%81%E6%95%85%E9%9A%9C/"/>
    
  </entry>
  
  <entry>
    <title>LINUX 基础服务课程环境使用说明</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/00_linux_classroom_env/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/00_linux_classroom_env/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.699Z</updated>
    
    <content type="html"><![CDATA[<p>UP100 课程基于RHEL6.5、RHEL7.0、ubuntu1604、WindowsXP和Windows2012R2系统</p><p>需要开启虚拟机可以直接双击图标，第一次启动时将从讲师机下载映像文件，可能会比较慢。</p><p>控制虚拟机可以使用kiosk用户，执行rht-vmctl命令，请自行查看命令使用。</p><h3 id="授课网络环境配置如下"><a href="#授课网络环境配置如下" class="headerlink" title="授课网络环境配置如下"></a>授课网络环境配置如下</h3><p><strong>f0~fN</strong>为教室物理机，其域名为<code>foundationN.ilt.example.com</code> ,可简写为<code>fN</code>。其IP为<code>172.25.N.250</code>，<code>f0</code>特殊为<code>172.25.254.250</code>。</p><p><code>classroom</code>虚拟机为所有物理机和虚拟机的默认网关，配置了多个网卡设置了所有<code>172.25.N.254</code>的地址，保证虚拟机、物理机和各个学生机之间的路由。配置了<code>DHCP</code>、<code>DNS</code>和<code>HTTP</code>服务，其域名为<code>classroom.example.com</code>可简写为<code>classroom</code>。</p><p>rhel6虚拟机均安装RHEL6.5系统，rhel7虚拟机均安装RHEL7.0系统，ubuntu1604虚拟机均安装Ubuntu1604系统，均安装图形化界面并配置runlevel 5启动，root密码为uplooking ，配置了基础的YUM源指向classroom， rhel6、rhel7、ubuntu1604、winxp和win2012r2虚拟机均配置了1块虚拟机网卡，eth0接入物理机br0网桥，动态获得ip地址:</p><table><thead><tr><th align="left">hostname</th><th align="left">ipaddr</th></tr></thead><tbody><tr><td align="left">rhel7</td><td align="left">172.25.N.10</td></tr><tr><td align="left">rhel6</td><td align="left">172.25.N.11</td></tr><tr><td align="left">winxp</td><td align="left">172.25.N.12</td></tr><tr><td align="left">ubuntu</td><td align="left">172.25.N.14</td></tr><tr><td align="left">win2012r2</td><td align="left">172.25.N.15</td></tr></tbody></table><p>rhel6、rhel7、ubuntu1604虚拟机均配置两块虚拟硬盘vda和vdb，以方便授课演示。除winxp和win2012r2之外其它虚拟机均配置2GB运行内存，winxp配置1GB运行内存，win2012r2配置4GB运行内存。</p><p>winxp虚拟机主机上安装了如下软件：</p><ul><li>Cisco Packet Tracer</li><li>Putty</li><li>Winscp</li><li>Xshell</li><li>Wireshark</li><li>Navicat for Mysql</li><li>Microsoft Visio 2010</li><li>7-zip</li></ul><p>已在classroom上完成DNS配置，正向和方向域名及邮件代理域名和虚拟机域名设置如下：</p><p>rhel7主机：172.25.N.10</p><ul><li>rhel7-fN.example.com</li><li>dN.example.com</li><li>imapN.example.com</li><li>smtpN.example.com (MX)</li></ul><p>rhel6主机： 172.25.N.11</p><ul><li>rhel6-fN.example.com</li><li>sN.example.com</li><li>wwwN.example.com</li><li>webapp-fN.example.com</li></ul><p>winxp主机： 172.25.N.12</p><ul><li>winxp-fN.example.com</li><li>install 主机：172.25.N.13</li><li>install-fN.example.com</li><li>ubuntu主机：172.25.N.14</li><li>ubuntu-fN.example.com</li></ul><p>win2012r2主机：172.25.N.15</p><ul><li>win2012r2-fN.example.com</li></ul><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>rhel6.5 SElinux有bug，光盘中默认没有selinux相关manpage，看manpage需要安装selinux-policy-doc包，但这个包需要从RHN下载。</p><h3 id="网络拓扑图"><a href="#网络拓扑图" class="headerlink" title="网络拓扑图"></a>网络拓扑图</h3><p><img src="pic/01-up100.png" alt="up100"></p><hr><h2 id="基础服务简介"><a href="#基础服务简介" class="headerlink" title="基础服务简介"></a>基础服务简介</h2><p>本章将讲解以下内容：</p><ul><li>RHEL6 中Linux系统服务的基础知识、System V与Xinetd的概念，以及通过 servcie 命令来启动某一服务，通过 chkconfig 命令来设置服务是否开机启动</li><li>RHEL7 中 已经替换掉 System V init，并正式采用全新的初始化进程 Systemd，以及通过systemctl 命令来启动某一服务和设置该服务是否开机启动</li></ul><blockquote><p>重点简介rhel6，rhel7只做命令的介绍，具体内容请参考《systemd说明》</p></blockquote><h3 id="系统服务的基本概念"><a href="#系统服务的基本概念" class="headerlink" title="系统服务的基本概念"></a>系统服务的基本概念</h3><p>服务，其实就是运行在操作系统后台的一个或者多个应用程序，为计算机系统或用户提供某项特定的服务。</p><p>在我们的windows操作系统中，其在后台也运行了许许多多的服务。例如我们装的杀毒软件，其在后台运行了许多我们看不见的服务程序，通过这些服务来为用户或者计算机系统来提高特定的功能。</p><p>服务通常是不中断运行的，随时准备接受请求，从而提供某项服务。例如我们日常使用的网页服务，其就是由一个运行在所访问网站的服务器上的httpd服务提供的服务，我们通过在浏览器输入需要访问网站的域名，服务器端的httpd服务就会随时的接收我们发送过来的请求，并响应回给我们的用户。</p><p>我们Linux系统绝大多数服务都是网络服务，例如邮件服务、FTP服务、httpd服务等等，网络服务可以使为其他用户、其他计算机提供特定的服务。</p><h3 id="services-和-daemons"><a href="#services-和-daemons" class="headerlink" title="services 和 daemons"></a>services 和 daemons</h3><table><thead><tr><th align="left">服务名</th><th align="left">守护进程名</th></tr></thead><tbody><tr><td align="left">rsyslog</td><td align="left">rsyslogd</td></tr><tr><td align="left">atd</td><td align="left">atd</td></tr><tr><td align="left">crond</td><td align="left">crond</td></tr></tbody></table><p><strong>服务的分类</strong> 服务名通常有两个，一个这个基于程序的服务名称，我们把它叫做service，比如说ftp服务，samba服务等等。<br>还有一个是基于进程的服务名称，我们通常把它叫做daemon，守护进程，也就是我们使用ps命令时候看到的名称，比如httpd，比如named之类的等等，一般服务的进程名都是程序名称后加上一个d，当然也有不少的特例。之后我们都会一一去说这些服务。</p><h3 id="基于-daemon-分类"><a href="#基于-daemon-分类" class="headerlink" title="基于 daemon 分类"></a>基于 daemon 分类</h3><p>那么根据daemon，也就是守护进程，我们可以把服务分成两类，一类是独立启动的服务，叫做stand alone daemon，我们之后学的服务基本上都是独立启动的服务。另外一种叫做super daemon。我们分开来来说一下这两种服务的特征。</p><ul><li>1&gt; stand alone daemon 独立启动服务</li><li>2&gt; super daemon 超级服务 xinted</li></ul><h4 id="System-V"><a href="#System-V" class="headerlink" title="System V"></a>System V</h4><p>总的来说，Linux系统通常作为服务器端的操作系统来用的，所以Linux系统提供了许许多的的服务，有些服务需要我们自己来进行配置，这些服务的目的就是为了给我们的计算机、用户提供某项特定的功能。那么对于各种不同的服务，Linux系统是怎么样来统一进行管理的呢？</p><p>在Linux操作系统中，Linux对于服务的管理体系是沿用了System V的服务管理体系，System V原来是早期AT&amp;T的一个操作系统。</p><p>对于Linux系统，System V提供了运行级别的概念，还记得之前一直提到过的Linux的启动运行级别吗？没错，System V一共提供了7种运行级别</p><p>0   关机</p><p>1   单用户模式</p><p>2   不带网络的多用户模式</p><p>3   带网络的多用户模式，纯文本界面</p><p>4   未使用</p><p>5   带网络的多用户模式，图形界面</p><p>6   重启</p><p>对于我们来说，通常使用的是级别3和级别5，每个级别下都有对应的启动、不启动的服务，比如单用户模式下，所有的服务都是不启动，这些都是通过System V这个服务管理体系来决定的</p><p>System V定义了init为系统启动的第一个进程，进程PID=1，这个进程的目的就是去查看 /etc/inittab 中的系统启动级别从而来启动对应的服务</p><p>对于不同的服务，因为其提供该服务的厂家不同，所以这些的服务的启动、关闭机制通常不同，在Linux系统中，为了方便的管理这些服务，每个服务的启动、结束、重启等操作都由一个System V脚本来进行控制，拥有固定的格式。</p><p>对于Linux系统上的服务，这些服务的System V脚本文件都是存放在 /etc/rc.d/init.d 这个目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# cd /etc/rc.d/init.d/</span><br><span class="line">[root@rhel6 ~]# ls</span><br><span class="line">abrt-ccpp         firstboot     messagebus      quota_nld    snmptrapd</span><br><span class="line">abrtd             functions     mysqld          rdisc        spice-vdagentd</span><br><span class="line">abrt-oops         haldaemon     netconsole      restorecond  sshd</span><br><span class="line">acpid             halt          netfs           rngd         sssd</span><br><span class="line">atd               htcacheclean  network         rpcbind      sysstat</span><br><span class="line">auditd            httpd         NetworkManager  rpcgssd      udev-post</span><br><span class="line">autofs            ip6tables     nfs             rpcidmapd    vboxadd</span><br><span class="line">blk-availability  iptables      nfslock         rpcsvcgssd   vboxadd-service</span><br><span class="line">bluetooth         irqbalance    ntpd            rsyslog      vboxadd-x11</span><br><span class="line">certmonger        kdump         ntpdate         sandbox      vncserver</span><br><span class="line">cpuspeed          killall       oddjobd         saslauthd    wdaemon</span><br><span class="line">crond             lvm2-lvmetad  portreserve     single       winbind</span><br><span class="line">cups              lvm2-monitor  postfix         smartd       wpa_supplicant</span><br><span class="line">dnsmasq           mdmonitor     psacct          snmpd        ypbind</span><br></pre></td></tr></table></figure><p>我们看到在这个目录下，存在了许多纯文本文件，这些文件都是系统每一个服务的System V的脚本文件，对于该脚本文件，我们要启动什么服务，都是通过这些脚本文件来启动的，我们也可以通过编写System V脚本文件来手工创建一个我们自己的由System V来控制的服务。</p><p>对于Linux的所有的这些服务，我们通过 service 这个命令来进行统一的管理</p><p>命令 service 可以调用指定服务的System V脚本，并执行指定的动作</p><p><code>service 服务名 [start | stop | restart | status]</code></p><p>对于Linux系统的这些服务，我们都是通过 service 这个命令去调用该服务对应的System V脚本，并执行其指定的动作</p><p>刚才我们也说到了，System V定义了运行级别的概念，每个运行级别对应有启动、不启动的服务，在 <code>/etc/rc.d</code> 这个目录下，除了我们刚才的 init.d 这个目录，我们还发现还有其它的一些目录，诸如 rc0.d、rc1.d等这些目录就分别对应了系统的7中启动级别，每个目录里面都存放了许多的<br>文件，每个文件对应着一个特定的服务，并标志有是否开机启动以及启动顺序。</p><p>我们发现，在这些目录里面，存放的都是链接文件，不过这每一个链接文件的名字都有着严格的规定。每一个链接文件都由3部分组成</p><p><code>K15httpd -&gt; ../init.d/httpd　　　　S55sshd -&gt; ../init.d/sshd</code></p><ul><li>①第一个部分是第一个字母K或者S，表示该服务是不是是不是开机自动启动，K表示开机不启动，S表示开机就启动</li><li>②第二个部分是一个数字，这个数字代表的是该服务的启动顺序，服务启动的顺序非常的重要，例如我们的网络服务需要在邮件服务之前启动</li><li>③第三个部分就是对应服务的名字，该链接文件其实都是指向的是 init.d 这个目录下的System V脚本文件</li></ul><p>我们如果希望某服务开机就启动，可以通过修改 rc5.d 目录下的链接文件，不过这样做很麻烦，Linux系统提供了一个 <code>chkconfig</code> 命令可以来设置服务是否开机启动</p><p>我们通过 <code>chkconfig --list</code> 命令来查看所有服务的开机启动情况</p><p>比如我们需要设置 network 服务开启自动启动，可以使用 <code>chkconfig httpd on</code> 命令即可</p><p>比如我们需要设置 network 服务开启不启动，可以使用 <code>chkconfig httpd off</code> 命令即可</p><h4 id="xinetd"><a href="#xinetd" class="headerlink" title="xinetd"></a>xinetd</h4><p>其实对于上面通过 System V来管理的一些服务都属于Linux系统的常驻运行的服务，其实在Linux系统中还有许多不常驻的一些服务，例如 telnet、rsync服务，这些服务则是通过 xinetd 这个服务来进行管理的。</p><p>xinetd 控制的就是那些不常驻的服务，功能较为简单的服务</p><p>xinetd其实自己本身就是作为一个系统的常驻的服务运行在后台，而xinetd所控制的服务在没有连接请求的时候是不运行的，所有xinetd控制的服务的连接请求都会提交给xinetd来进行代理</p><p>xinetd在收到一个请求后，会根据请求的协议及服务启动相应的服务进程，进程处理完后请求就会结束</p><p>xinetd本身就是一个系统服务，通过 System V来对其进行管理，在CentOS6/RHEL6中，xinetd服务默认是没有安装的，我们若要使用该服务，首先需要安装它<code>yum install xinetd</code></p><p>在我们安装好我们的<code>xinetd</code>服务以后，我们这时再通过 <code>chkconfig --list</code> 命令来查看所有的服务启动设置</p><p>我们看到，在安装了xinetd服务以后，其下面出现了一些其他的服务选项，例如<code>rsync</code>，<code>chargen-dgram</code>等这些服务，这些服务都是系统的一些不常驻服务，都是通过xinetd这个服务来对其进行管理的</p><p><code>xinetd</code>服务的配置文件是 <code>/etc/xinetd.conf</code></p><h3 id="端口号"><a href="#端口号" class="headerlink" title="端口号"></a>端口号</h3><ul><li>查看 <code>netstat -luntp</code></li><li>软件名    <code>net-tools</code></li></ul><h3 id="基础服务总结"><a href="#基础服务总结" class="headerlink" title="基础服务总结"></a>基础服务总结</h3><p><strong>RHEL 6</strong></p><p>服务的启动 停止 重启 状态    <code>service 服务名 [start | stop | restart | status]</code></p><p>服务开机启动状态        <code>chkconfig --list</code></p><p>设置服务开机启动        <code>chkconfig 服务名 on</code></p><p>设置服务开机不启动        <code>chkconfig 服务名 off</code></p><p><strong>RHEL 7</strong></p><p>服务的启动 停止 重启 状态    <code>systemctl [start | stop | restart | status] 服务名</code></p><p>设置服务开机启动        <code>systemctl enable 服务名</code></p><p>设置服务开机不启动        <code>systemctl disable 服务名</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;UP100 课程基于RHEL6.5、RHEL7.0、ubuntu1604、WindowsXP和Windows2012R2系统&lt;/p&gt;
&lt;p&gt;需要开启虚拟机可以直接双击图标，第一次启动时将从讲师机下载映像文件，可能会比较慢。&lt;/p&gt;
&lt;p&gt;控制虚拟机可以使用kiosk用户，执
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>FTP文件共享服务</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/02_ftp/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/02_ftp/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.715Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>课程要求</p></blockquote><ol><li>设置vsftpd服务匿名用户能够对/var/ftp/pub/目录有上传下载的权限。</li><li>系统用户能够访问家目录，上传下载删除</li><li>除了系统用户student有chroot的权限，其他系统用户没有chroot的权限</li></ol><h3 id="FTP服务"><a href="#FTP服务" class="headerlink" title="FTP服务"></a>FTP服务</h3><p>FTP 是File Transfer Protocol（文件传输协议）的英文简称，而中文简称为“文传协议”。用于<br>Internet上的控制文件的双向传输。同时，它也是一个应用程序（Application）。基于不同的操作系统有<br>不同的FTP应用程序，而所有这些应用程序都遵守同一种协议以传输文件。在FTP的使用当中，用户经常遇到两<br>个概念：”下载”（Download）和”上传”（Upload）。”下载”文件就是从远程主机拷贝文件至自己的计算机<br>上；”上传”文件就是将文件从自己的计算机中拷贝至远程主机上。用Internet语言来说，用户可通过客户机程<br>序向（从）远程主机上传（下载）文件。</p><h3 id="FTP原理"><a href="#FTP原理" class="headerlink" title="FTP原理"></a>FTP原理</h3><p>FTP只通过TCP连接,没有用于FTP的UDP组件。</p><p>FTP不同于其他服务的是它使用了两个端口, 一个数据端口和一个命令端口(或称为控制端口)。</p><p>通常21端口是命令端口，20端口是数据端口。当混入主动/被动模式的概念时，数据端口就有可能不是20了。</p><p><strong>工作模式</strong> FTP支持两种模式：</p><ul><li>Standard (PORT方式，主动方式)</li><li>Passive (PASV，被动方式)。</li></ul><p><strong>Port模式</strong></p><p>主动模式下，FTP客户端从任意的非特殊的端口（N &gt; 1023）连入到FTP服务器的命令端口–21端口。然后客户端在N+1（N+1 &gt;= 1024）端口监听，并且通过N+1（N+1 &gt;= 1024）端口发送命令给FTP服务器。服务器会反过来连接用户本地指定的数据端口，比如20端口。</p><p>以服务器端防火墙为立足点，要支持主动模式FTP需要打开如下交互中使用到的端口：</p><ul><li>FTP服务器命令（21）端口接受客户端任意端口（客户端初始连接）</li><li>FTP服务器命令（21）端口到客户端端口（&gt;1023）（服务器响应客户端命令）</li><li>FTP服务器数据（20）端口到客户端端口（&gt;1023）（服务器初始化数据连接到客户端数据端口）</li><li>FTP服务器数据（20）端口接受客户端端口（&gt;1023）（客户端发送ACK包到服务器的数据端口）</li></ul><p>用图表示如下：</p><p><img src="pic/15.jpg" alt="15"></p><p>在第1步中，客户端的命令端口与FTP服务器的命令端口建立连接，并发送命令“PORT 1027”。然后在第2步中，FTP服务器给客户端的命令端口返回一个”ACK”。在第3步中，FTP服务器发起一个从它自己的数据端口（20）到客户端先前指定的数据端口（1027）的连接，最后客户端在第4步中给服务器端返回一个”ACK”。</p><p>主动方式FTP的主要问题实际上在于客户端。FTP的客户端并没有实际建立一个到服务器数据端口的连接，它只是简单的告诉服务器自己监听的端口号，服务器再回来连接客户端这个指定的端口。对于客户端的防火墙来说，这是从外部系统建立到内部客户端的连接，这是通常会被阻塞的。</p><p><strong>Passive模式</strong></p><p>为了解决服务器发起到客户的连接的问题，人们开发了一种不同的FTP连接方式。这就是所谓的被动方式，或者叫做PASV，当客户端通知服务器它处于被动模式时才启用。</p><p>在被动方式FTP中，命令连接和数据连接都由客户端，这样就可以解决从服务器到客户端的数据端口的入方向连接被防火墙过滤掉的问题。当开启一个FTP连接时，客户端打开两个任意的非特权本地端口（N &gt;; 1024和N+1）。第一个端口连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口，而是提交PASV命令。这样做的结果是服务器会开启一个任意的非特权端口（P &gt;; 1024），并发送PORT P命令给客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。</p><p>对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的FTP:</p><ul><li>FTP服务器命令（21）端口接受客户端任意端口（客户端初始连接）</li><li>FTP服务器命令（21）端口到客户端端口（&gt;1023）（服务器响应客户端命令）</li><li>FTP服务器数据端口（&gt;1023）接受客户端端口（&gt;1023）（客户端初始化数据连接到服务器指定的任意端口）</li><li>FTP服务器数据端口（&gt;1023）到客户端端口（&gt;1023）（服务器发送ACK响应和数据到客户端的数据端口）</li></ul><p>用图表示如下：</p><p><img src="pic/16.jpg" alt="16"></p><p>在第1步中，客户端的命令端口与服务器的命令端口建立连接，并发送命令“PASV”。然后在第2步中，服务器返回命令”PORT 2024”，告诉客户端（服务器）用哪个端口侦听数据连接。在第3步中，客户端初始化一个从自己的数据端口到服务器端指定的数据端口的数据连接。最后服务器在第4 步中给客户端的数据端口返回一个”ACK”响应。</p><p>被动方式的FTP解决了客户端的许多问题，但同时给服务器端带来了更多的问题。最大的问题是需要允许从任意远程终端到服务器高位端口的连接。幸运的是，许多FTP守护程序，包括流行的WU-FTPD允许管理员指定FTP服务器使用的端口范围。详细内容参看附录1。</p><p>第二个问题是客户端有的支持被动模式，有的不支持被动模式，必须考虑如何能支持这些客户端，以及为他们提供解决办法。例如，Solaris提供的FTP命令行工具就不支持被动模式，需要第三方的FTP客户端，比如ncftp。</p><p>随着WWW的广泛流行，许多人习惯用web浏览器作为FTP客户端。大多数浏览器只在访问ftp://这样的URL时才支持被动模式。这到底是好还是坏取决于服务器和防火墙的配置。</p><p>下面的图表会帮助管理员们记住每种FTP方式是怎样工作的：</p><p><strong>主动FTP：</strong></p><ol><li>命令连接：客户端 &gt;1023端口 -&gt; 服务器 21端口</li><li>数据连接：客户端 &gt;1023端口 &lt;- 服务器 20端口</li></ol><p><strong>被动FTP：</strong></p><ol><li>命令连接：客户端 &gt;1023端口 -&gt; 服务器 21端口</li><li>数据连接：客户端 &gt;1023端口 -&gt; 服务器 &gt;1023端口</li></ol><p>下面是主动与被动FTP优缺点的简要总结：</p><p>主动FTP对FTP服务器的管理有利，但对客户端的管理不利。因为FTP服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。被动FTP对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。</p><p>幸运的是，有折衷的办法。既然FTP服务器的管理员需要他们的服务器有最多的客户连接，那么必须得支持被动FTP。我们可以通过为FTP服务器指定一个有限的端口范围来减小服务器高位端口的暴露。这样，不在这个范围的任何端口会被服务器的防火墙阻塞。虽然这没有消除所有针对服务器的危险，但它大大减少了危险。</p><h3 id="VSFTPD-软件"><a href="#VSFTPD-软件" class="headerlink" title="VSFTPD 软件"></a>VSFTPD 软件</h3><p>如果你想在你的Linux/Unix服务器上搭建一个安全、高性能、稳定性好的FTP服务器，那么vsftpd可能是你的首选应用。vsftpd意思为“very secure FTP daemon(非常安全的FTP进程)”，是一个基于GPL发布的类UNIX类操作系统上运行的服务器的名字（是一种守护进程），可以运行在诸如Linux、BSD、Solaris、HP-UX以及Irix等系统上面。vsftpd支持很多其他传统的FTP服务器不支持的良好特性。</p><p>最新的vsftpd版本可在其官网获取：<a href="www.vsftpd.org">www.vsftpd.org</a></p><p>vsftpd 是“very secure FTP daemon”的缩写，安全性是它的一个最大的特点。vsftpd 是一个 UNIX 类操作系统上运行的服务器的名字，它可以运行在诸如 Linux、BSD、Solaris、 HP-UNIX等系统上面，是一个完全免费的、开发源代码的ftp服务器软件，支持很多其他的 FTP 服务器所不支持的特征。比如：非常高的安全性需求、带宽限制、良好的可伸缩性、可创建虚拟用户、支持IPv6、速率高等。</p><p>看看都有哪些网站在使用vsftpd吧：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ftp.RedHat.com</span><br><span class="line">ftp.SUSE.com</span><br><span class="line">ftp.debian.org</span><br><span class="line">ftp.openbsd.org</span><br><span class="line">ftp.freebsd.org</span><br><span class="line">ftp.gnu.org</span><br><span class="line">ftp.gnome.org</span><br><span class="line">ftp.kde.org</span><br><span class="line">ftp.kernel.org</span><br><span class="line">rpmfind.net</span><br><span class="line">ftp.linux.org.uk</span><br><span class="line">ftp.gimp.org</span><br><span class="line">ftp-stud.fht-esslingen.de</span><br><span class="line">gd.tuwien.ac.at</span><br><span class="line">ftp.sunet.se</span><br><span class="line">ftp.ximian.com</span><br><span class="line">ftp.engardelinux.org</span><br><span class="line">ftp.sunsite.org.uk</span><br><span class="line">ftp.isc.org</span><br></pre></td></tr></table></figure><h4 id="什么是vsftpd"><a href="#什么是vsftpd" class="headerlink" title="什么是vsftpd"></a>什么是vsftpd</h4><p>Vsftpd是一种在GPL许可下开放源代码的FTP服务器，用于多种UNIX系统和Linux系统。Vsftpd也称为Very Secure FTP Daemon，它是一种安全、快速、稳定的FTP服务器，能够高效地处理大量的并发连接。</p><p>Vsftpd的主要特点包括：</p><ul><li>提供安全的体系结构，根据任务的最低特权需求单独执行每个任务。</li><li>支持虚拟IP配置，可以在提供一个IP地址的情况下，在域中用该地址建立多个FTP服务器。</li><li>允许配置并使用虚拟用户，从而与系统用户账户分离。</li><li>支持TCP封装。</li><li>允许配置匿名服务器，用户可以在不需要身份验证的情况下上传和下载文件。</li><li>性能稳定，可以处理大量的并发连接。</li><li>可以配置为独立的服务器。</li><li>Vsftpd服务器支持带宽控制。</li></ul><blockquote><p>用户类型</p></blockquote><p><strong>r 真实用户</strong></p><p>这类用户是指在FTP服务上拥有帐号，即/etc/passwd里的用户。当这类用户登录FTP服务器的时候，其默认的主目录就是其帐号命名的目录。但是，其还可以变更到其他目录中去。如系统的主目录等等。</p><p><strong>g 来宾用户</strong></p><p>在vsFTP软件里没有这类用户，但是在FTP服务器中有，我们往往会给不同的部门或者某个特定的用户设置一个帐户。但是，这个账户有个特点，就是其只能够访问自己的主目录。服务器通过这种方式来保障FTP服务上其他文件的安全性。这类帐户，在Vsftpd软件中就叫做Guest用户。拥有这类用户的帐户，只能够访问其主目录下的目录，而不得访问主目录以外的文件。</p><p><strong>a 匿名用户</strong></p><p>Anonymous（匿名）用户，这也是我们通常所说的匿名访问。这类用户是指在FTP服务器中没有指定帐户，但是其仍然可以进行匿名访问某些公开的资源。<br>在组建FTP服务器的时候，我们就需要根据用户的类型，对用户进行归类。默认情况下，Vsftpd服务器会把建立的所有帐户都归属为Real用户。但是，这往往不符合企业安全的需要。因为这类用户不仅可以访问自己的主目录，而且，还可以访问其他用户的目录。这就给其他用户所在的空间带来一定的安全隐患。所以，企业要根据实际情况，修改用户所在的类别。</p><hr><h4 id="项目实践1-设置vsftpd服务匿名用户能够对-var-ftp-pub-目录有上传下载的权限"><a href="#项目实践1-设置vsftpd服务匿名用户能够对-var-ftp-pub-目录有上传下载的权限" class="headerlink" title="项目实践1: 设置vsftpd服务匿名用户能够对/var/ftp/pub/目录有上传下载的权限"></a>项目实践1: 设置vsftpd服务匿名用户能够对/var/ftp/pub/目录有上传下载的权限</h4><h5 id="实验准备阶段"><a href="#实验准备阶段" class="headerlink" title="实验准备阶段"></a>实验准备阶段</h5><ol><li>网络拓扑图</li><li>规划软件安装</li><li>修改配置文件</li><li>启动服务</li><li>注意防火墙关闭</li><li>客户端测试服务        </li></ol><blockquote><p>网络拓扑图</p></blockquote><p><img src="pic/17.png" alt="17"></p><blockquote><p>规划软件安装</p></blockquote><p><img src="pic/18.png" alt="18"></p><h5 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h5><p>Linux几乎所有的发行版本都内置了Vsftpd服务。</p><p><strong>服务器端rhel6</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# yum install -y vsftpd</span><br><span class="line">Loaded plugins: product-id, refresh-packagekit, security, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">Setting up Install Process</span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Running transaction check</span></span><br><span class="line"><span class="meta">---&gt;</span><span class="bash"> Package vsftpd.x86_64 0:2.2.2-11.el6_4.1 will be installed</span></span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Finished Dependency Resolution</span></span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================</span><br><span class="line"> Package            Arch               Version                      Repository          Size</span><br><span class="line">=============================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> vsftpd             x86_64             2.2.2-11.el6_4.1             server             151 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================</span><br><span class="line">Install       1 Package(s)</span><br><span class="line"></span><br><span class="line">Total download size: 151 k</span><br><span class="line">Installed size: 331 k</span><br><span class="line">Downloading Packages:</span><br><span class="line">vsftpd-2.2.2-11.el6_4.1.x86_64.rpm                                    | 151 kB     00:00     </span><br><span class="line">Running rpm_check_debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line">  Installing : vsftpd-2.2.2-11.el6_4.1.x86_64                                            1/1</span><br><span class="line">  Verifying  : vsftpd-2.2.2-11.el6_4.1.x86_64                                            1/1</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  vsftpd.x86_64 0:2.2.2-11.el6_4.1                                                           </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# service iptables stop</span><br><span class="line">iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span><br><span class="line">iptables: Flushing firewall rules:                         [  OK  ]</span><br><span class="line">iptables: Unloading modules:                               [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# getenforce</span><br><span class="line">Enforcing</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# rpm -q vsftpd</span><br><span class="line">vsftpd-2.2.2-11.el6_4.1.x86_64</span><br><span class="line">[root@rhel6 ~]# rpm -ql vsftpd</span><br><span class="line">/etc/logrotate.d/vsftpd</span><br><span class="line">/etc/pam.d/vsftpd</span><br><span class="line">/etc/rc.d/init.d/vsftpd</span><br><span class="line">/etc/vsftpd</span><br><span class="line">/etc/vsftpd/ftpusers</span><br><span class="line">/etc/vsftpd/user_list</span><br><span class="line">/etc/vsftpd/vsftpd.conf</span><br><span class="line">/etc/vsftpd/vsftpd_conf_migrate.sh</span><br><span class="line">/usr/sbin/vsftpd</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/AUDIT</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/BENCHMARKS</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/BUGS</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/COPYING</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/Changelog</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE/README.configuration</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE/vsftpd.conf</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE/vsftpd.xinetd</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE_NOINETD</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE_NOINETD/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE_NOINETD/README.configuration</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/INTERNET_SITE_NOINETD/vsftpd.conf</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/PER_IP_CONFIG</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/PER_IP_CONFIG/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/PER_IP_CONFIG/README.configuration</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/PER_IP_CONFIG/hosts.allow</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_HOSTS</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_HOSTS/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS/README.configuration</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS/logins.txt</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS/vsftpd.conf</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS/vsftpd.pam</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS_2</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/EXAMPLE/VIRTUAL_USERS_2/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/FAQ</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/INSTALL</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/LICENSE</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/README</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/README.security</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/REWARD</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SECURITY</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SECURITY/DESIGN</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SECURITY/IMPLEMENTATION</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SECURITY/OVERVIEW</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SECURITY/TRUST</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SIZE</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/SPEED</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/TODO</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/TUNING</span><br><span class="line">/usr/share/doc/vsftpd-2.2.2/vsftpd.xinetd</span><br><span class="line">/usr/share/man/man5/vsftpd.conf.5.gz</span><br><span class="line">/usr/share/man/man8/vsftpd.8.gz</span><br><span class="line">/var/ftp</span><br><span class="line">/var/ftp/pub</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# service vsftpd start</span><br><span class="line">Starting vsftpd for vsftpd:                                [  OK  ]</span><br><span class="line">[root@rhel6 ~]# netstat -luntp|grep vsftpd</span><br><span class="line">tcp        0      0 0.0.0.0:21                  0.0.0.0:*                   LISTEN      2940/vsftpd</span><br></pre></td></tr></table></figure><p><strong>客户端 rhel7</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# yum install -y lftp</span><br><span class="line">Loaded plugins: langpacks, product-id, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">server                                                                | 4.1 kB  00:00:00     </span><br><span class="line">(1/2): server/group_gz                                                | 134 kB  00:00:00     </span><br><span class="line">(2/2): server/primary_db                                              | 3.4 MB  00:00:00     </span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Running transaction check</span></span><br><span class="line"><span class="meta">---&gt;</span><span class="bash"> Package lftp.x86_64 0:4.4.8-3.el7 will be installed</span></span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Finished Dependency Resolution</span></span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================</span><br><span class="line"> Package           Arch                Version                     Repository           Size</span><br><span class="line">=============================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> lftp              x86_64              4.4.8-3.el7                 server              749 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 749 k</span><br><span class="line">Installed size: 2.4 M</span><br><span class="line">Downloading packages:</span><br><span class="line">lftp-4.4.8-3.el7.x86_64.rpm                                           | 749 kB  00:00:00     </span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : lftp-4.4.8-3.el7.x86_64                                                   1/1</span><br><span class="line">server/productid                                                      | 1.6 kB  00:00:00     </span><br><span class="line">  Verifying  : lftp-4.4.8-3.el7.x86_64                                                   1/1</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  lftp.x86_64 0:4.4.8-3.el7                                                                  </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@rhel7 ~]# systemctl stop firewalld</span><br><span class="line">[root@rhel7 ~]# getenforce</span><br><span class="line">Enforcing</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# rpm -ql lftp</span><br><span class="line">/etc/lftp.conf</span><br><span class="line">/usr/bin/lftp</span><br><span class="line">/usr/bin/lftpget</span><br><span class="line">/usr/lib64/lftp</span><br><span class="line">/usr/lib64/lftp/4.4.8</span><br><span class="line">/usr/lib64/lftp/4.4.8/cmd-mirror.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/cmd-sleep.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/cmd-torrent.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/liblftp-network.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/liblftp-pty.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/proto-file.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/proto-fish.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/proto-ftp.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/proto-http.so</span><br><span class="line">/usr/lib64/lftp/4.4.8/proto-sftp.so</span><br><span class="line">/usr/lib64/liblftp-jobs.so.0</span><br><span class="line">/usr/lib64/liblftp-jobs.so.0.0.0</span><br><span class="line">/usr/lib64/liblftp-tasks.so.0</span><br><span class="line">/usr/lib64/liblftp-tasks.so.0.0.0</span><br><span class="line">/usr/share/doc/lftp-4.4.8</span><br><span class="line">/usr/share/doc/lftp-4.4.8/BUGS</span><br><span class="line">/usr/share/doc/lftp-4.4.8/COPYING</span><br><span class="line">/usr/share/doc/lftp-4.4.8/ChangeLog</span><br><span class="line">/usr/share/doc/lftp-4.4.8/FAQ</span><br><span class="line">/usr/share/doc/lftp-4.4.8/FEATURES</span><br><span class="line">/usr/share/doc/lftp-4.4.8/NEWS</span><br><span class="line">/usr/share/doc/lftp-4.4.8/README</span><br><span class="line">/usr/share/doc/lftp-4.4.8/README.debug-levels</span><br><span class="line">/usr/share/doc/lftp-4.4.8/README.dnssec</span><br><span class="line">/usr/share/doc/lftp-4.4.8/README.modules</span><br><span class="line">/usr/share/doc/lftp-4.4.8/THANKS</span><br><span class="line">/usr/share/doc/lftp-4.4.8/TODO</span><br><span class="line">/usr/share/locale/cs/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/de/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/es/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/fr/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/it/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/ja/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/ko/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/pl/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/pt_BR/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/ru/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/zh_CN/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/zh_HK/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/locale/zh_TW/LC_MESSAGES/lftp.mo</span><br><span class="line">/usr/share/man/man1/lftp.1.gz</span><br><span class="line">/usr/share/man/man1/lftpget.1.gz</span><br><span class="line">/usr/share/man/man5/lftp.conf.5.gz</span><br></pre></td></tr></table></figure><blockquote><p>1.从客户端以匿名用户来访问ftp服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# lftp 172.25.0.11</span><br><span class="line">lftp 172.25.0.11:~&gt; cd pub</span><br><span class="line">cd ok, cwd=/pub</span><br><span class="line">lftp 172.25.0.11:/pub&gt; ls</span><br><span class="line">lftp 172.25.0.11:/pub&gt; put rhel7</span><br><span class="line">put: Access failed: 550 Permission denied. (rhel7)</span><br></pre></td></tr></table></figure><p><strong>当前的情况</strong></p><p>匿名用户能够访问/var/ftp/pub，能够查看文件内容，能够下载；不能上传文件,不能删除文件。</p><p><strong>问题的解决</strong></p><p>报错550，没有权限上传文件</p><p>我们要分析权限有哪些？</p><ol><li>vsftpd的配置文件</li><li>UGO、特殊、隐藏、ACL、</li><li>SELINUX</li></ol><p><strong>1.修改主配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">anon_upload_enable=YES</span><br></pre></td></tr></table></figure><p><strong>2./var/ftp/pub 目录o-rwx</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 pub]# ll -d /var/ftp/pub</span><br><span class="line">drwxr-xrwx. 2 root root 4096 Aug  3 10:35 /var/ftp/pub</span><br></pre></td></tr></table></figure><p><strong>3.测试</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lftp 172.25.0.11:/pub&gt; put rhel7</span><br><span class="line">put: Access failed: 553 Could not create file. (rhel7)</span><br></pre></td></tr></table></figure><p>目前修改了配置文件和ugo权限还是报错553，不能create file</p><p>我们分析一下，只有selinux的权限问题了</p><p><strong>4.SELINUX</strong></p><p>如何确定是否是selinux的原因，可以通过以下步骤：</p><ul><li>1)先关闭selinux，测试ok的</li><li>2)开启selinux，测试no的</li></ul><p>我们需要去分析selinux的记录，分析工具是<code>sealert</code>,由<code>setroubleshoot</code>软件安装。</p><ol><li>查看当前系统中是否有sealert工具    <code>which sealert</code></li><li>安装setroubleshoot        <code>yum install -y setroubleshoot</code></li><li>分析selinux记录        <code>sealert -a /var/log/audit/audit.log</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*****  Plugin allow_anon_write (53.1 confidence) suggests  *******************</span><br><span class="line"></span><br><span class="line">If you want to allow /usr/sbin/vsftpd to be able to write to shared public content</span><br><span class="line">Then you need to change the label on pub to public_content_rw_t, and potentially turn on the</span><br><span class="line">allow_httpd_sys_script_anon_write boolean.</span><br><span class="line">Do</span><br><span class="line"><span class="meta">#</span><span class="bash"> semanage fcontext -a -t public_content_rw_t pub</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> restorecon -R -v pub</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setsebool -P allow_ftpd_anon_write 1</span></span><br><span class="line"></span><br><span class="line">[root@rhel6 pub]# semanage fcontext -a -t public_content_rw_t /var/ftp/pub</span><br><span class="line">[root@rhel6 pub]# restorecon -R -v /var/ftp/pub</span><br><span class="line">[root@rhel6 pub]# ll -Zd /var/ftp/pub</span><br><span class="line">drwxr-xrwx. root root system_u:object_r:public_content_rw_t:s0 /var/ftp/pub</span><br></pre></td></tr></table></figure><p><strong>5.再测试</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lftp 172.25.0.11:/pub&gt; put rhel7</span><br><span class="line">lftp 172.25.0.11:/pub&gt; ls</span><br><span class="line">-rw-------    1 14       50              0 Aug 03 05:53 rhel7</span><br><span class="line">lftp 172.25.0.11:/pub&gt; exit</span><br></pre></td></tr></table></figure><p>此时，我们发现匿名用户已经可以成功地对/var/ftp/pub目录进行上传下载了！</p><hr><h4 id="项目实践2-真实用户（系统用户）能够访问家目录，上传下载删除"><a href="#项目实践2-真实用户（系统用户）能够访问家目录，上传下载删除" class="headerlink" title="项目实践2: 真实用户（系统用户）能够访问家目录，上传下载删除"></a>项目实践2: 真实用户（系统用户）能够访问家目录，上传下载删除</h4><p>在项目实践1的基础上完成。</p><p><strong>服务端 rhel6</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ftp]# id student</span><br><span class="line">uid=500(student) gid=500(student) groups=500(student)</span><br><span class="line">[root@rhel6 ftp]# passwd student</span><br><span class="line">Changing password for user student.</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: it is based on a dictionary word</span><br><span class="line">Retype new password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line">[root@rhel6 ftp]# su - student</span><br><span class="line">[student@rhel6 ~]$ pwd</span><br><span class="line">/home/student</span><br><span class="line">[student@rhel6 ~]$ touch file1</span><br><span class="line">[student@rhel6 ~]$ echo aaa &gt; file1</span><br></pre></td></tr></table></figure><p><strong>客户端 rhel7</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# lftp student@172.25.0.11</span><br><span class="line">Password:</span><br><span class="line">lftp student@172.25.0.11:~&gt; ls      </span><br><span class="line">ls: Login failed: 500 OOPS: cannot change directory:/home/student</span><br></pre></td></tr></table></figure><p><strong>当前的情况</strong> 系统用户student不能访问家目录。</p><p><strong>问题的解决</strong></p><p>报错500，没有权限进入用户家目录</p><p>配置文件没有问题，ugo权限没有问题，只剩下selinux，需要分析</p><p><strong>1.分析selinux</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器端</span></span><br><span class="line">[root@rhel6 ftp]# sealert -a /var/log/audit/audit.log</span><br><span class="line"></span><br><span class="line">*****  Plugin catchall_boolean (47.5 confidence) suggests  *******************</span><br><span class="line"></span><br><span class="line">If you want to allow ftp to read and write files in the user home directories</span><br><span class="line">Then you must tell SELinux about this by enabling the 'ftp_home_dir'boolean.</span><br><span class="line">Do</span><br><span class="line">setsebool -P ftp_home_dir 1</span><br></pre></td></tr></table></figure><p><strong>2.修改布尔值</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ftp]# setsebool -P ftp_home_dir 1</span><br></pre></td></tr></table></figure><p><strong>3.测试</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 客户端</span></span><br><span class="line">lftp student@172.25.0.11:~&gt; ls</span><br><span class="line">lftp student@172.25.0.11:~&gt; pwd  </span><br><span class="line">ftp://student@172.25.0.11/%2Fhome/student</span><br><span class="line">lftp student@172.25.0.11:~&gt; ls</span><br><span class="line">-rw-rw-r--    1 500      500             4 Aug 03 07:13 file1</span><br><span class="line">lftp student@172.25.0.11:~&gt; cat file1</span><br><span class="line">aaa</span><br><span class="line">4 bytes transferred</span><br><span class="line">lftp student@172.25.0.11:~&gt; get file1</span><br><span class="line">4 bytes transferred</span><br><span class="line">lftp student@172.25.0.11:~&gt; put</span><br><span class="line">.ICEauthority  .bashrc .dbus/     .tcshrcMusic/    Videos/  rhel7</span><br><span class="line">.bash_history  .cache/ .esd_auth  Desktop/Pictures/   anaconda-ks.cfg  test1</span><br><span class="line">.bash_logout   .config/  .local/    Documents/Public/     file1</span><br><span class="line">.bash_profile  .cshrc .ssh/    Downloads/Templates/  initial-setup-ks.cfg</span><br><span class="line">lftp student@172.25.0.11:~&gt; put rhel7</span><br><span class="line">lftp student@172.25.0.11:~&gt; ls</span><br><span class="line">-rw-rw-r--    1 500      500             4 Aug 03 07:13 file1</span><br><span class="line">-rw-r--r--    1 500      500             0 Aug 03 07:13 rhel7</span><br><span class="line">lftp student@172.25.0.11:~&gt; rm file1</span><br><span class="line">rm ok, \`file1\' removed</span><br><span class="line">lftp student@172.25.0.11:~&gt; ls</span><br><span class="line">-rw-r--r--    1 500      500             0 Aug 03 07:13 rhel7</span><br></pre></td></tr></table></figure><p>系统用户已经可以实现能够访问家目录，并且能够下载、上传、删除了！</p><hr><h4 id="项目实践3-除了系统用户student有chroot的权限，其他系统用户没有chroot的权限"><a href="#项目实践3-除了系统用户student有chroot的权限，其他系统用户没有chroot的权限" class="headerlink" title="项目实践3: 除了系统用户student有chroot的权限，其他系统用户没有chroot的权限"></a>项目实践3: 除了系统用户student有chroot的权限，其他系统用户没有chroot的权限</h4><ul><li>匿名用户的根目录    /var/ftp/</li><li>系统用户的根目录    /home/student/</li></ul><table><thead><tr><th align="left"></th><th align="left">chroot_local_user=YES</th><th align="left">chroot_local_user=NO</th></tr></thead><tbody><tr><td align="left">chroot_list_enable=YES</td><td align="left">不能换根，有例外</td><td align="left">都能换根，有例外</td></tr><tr><td align="left">chroot_list_enable=NO</td><td align="left">不能换根，没例外</td><td align="left">都能换根，没例外</td></tr></tbody></table><p>如果指定 <code>chroot_list_enable=YES</code> 则需要指定文件位置 <code>chroot_list_file=/etc/vsftpd/chroot_list</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# lftp batman@172.25.0.11</span><br><span class="line">Password:</span><br><span class="line">lftp batman@172.25.0.11:~&gt; ls       </span><br><span class="line">lftp batman@172.25.0.11:~&gt; cd /tmp</span><br><span class="line">cd ok, cwd=/tmp</span><br><span class="line">lftp batman@172.25.0.11:/tmp&gt; pwd</span><br><span class="line">ftp://batman@172.25.0.11/%2Ftmp</span><br><span class="line">lftp batman@172.25.0.11:/tmp&gt; exit</span><br></pre></td></tr></table></figure><p><strong>当前的情况</strong> 所有的系统用户都能够chroot，而要求除了student用户之外的所有系统用户都不能chroot。</p><p><strong>解决方法</strong></p><p>可以选择<code>不能换根，有例外</code></p><p><strong>1.修改配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器端</span></span><br><span class="line">[root@rhel6 ~]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br></pre></td></tr></table></figure><p><strong>2.创建chroot_list</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/vsftpd/chroot_list</span><br><span class="line">[root@rhel6 ~]# cat /etc/vsftpd/chroot_list</span><br><span class="line">student</span><br></pre></td></tr></table></figure><p><strong>3.重启服务</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# service vsftpd restart</span><br><span class="line">Shutting down vsftpd:                                      [  OK  ]</span><br><span class="line">Starting vsftpd for vsftpd:                                [  OK  ]</span><br></pre></td></tr></table></figure><p><strong>2.测试</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 客户端    </span></span><br><span class="line">[root@rhel7 ~]# lftp batman@172.25.0.11</span><br><span class="line">Password:</span><br><span class="line">lftp batman@172.25.0.11:~&gt; cd /etc/</span><br><span class="line">cd: Access failed: 550 Failed to change directory. (/etc)</span><br><span class="line">lftp batman@172.25.0.11:/&gt; exit</span><br><span class="line">[root@rhel7 ~]# lftp student@172.25.0.11</span><br><span class="line">Password:</span><br><span class="line">lftp student@172.25.0.11:~&gt; cd /etc</span><br><span class="line">cd ok, cwd=/etc                  </span><br><span class="line">lftp student@172.25.0.11:/etc&gt; exit</span><br></pre></td></tr></table></figure><p><strong>当前的情况</strong></p><p>系统用户student可以切换根目录，而batman不在chroot_list文件中所以不能切换根目录。</p><h5 id="拓展内容"><a href="#拓展内容" class="headerlink" title="拓展内容"></a>拓展内容</h5><p><strong>为什么root用户不能通过ftp协议访问服务器？</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# lftp root@172.25.0.11</span><br><span class="line">Password:</span><br><span class="line">lftp root@172.25.0.11:~&gt; ls         </span><br><span class="line">ls: Login failed: 530 Permission denied.</span><br></pre></td></tr></table></figure><p>因为有用户访问控制列表<code>/etc/vsftpd/user_list</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# grep userlist_enable /etc/vsftpd/vsftpd.conf</span><br><span class="line">userlist_enable=YES</span><br><span class="line"></span><br><span class="line">[root@rhel6 ftp]# cat /etc/vsftpd/user_list</span><br><span class="line"><span class="meta">#</span><span class="bash"> vsftpd userlist</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If userlist_deny=NO, only allow users <span class="keyword">in</span> this file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If userlist_deny=YES (default), never allow users <span class="keyword">in</span> this file, and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not even prompt <span class="keyword">for</span> a password.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that the default vsftpd pam config also checks /etc/vsftpd/ftpusers</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> users that are denied.</span></span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line">shutdown</span><br><span class="line">halt</span><br><span class="line">mail</span><br><span class="line">news</span><br><span class="line">uucp</span><br><span class="line">operator</span><br><span class="line">games</span><br><span class="line">nobody</span><br></pre></td></tr></table></figure><hr><h4 id="了解vsftpd的配置文件"><a href="#了解vsftpd的配置文件" class="headerlink" title="了解vsftpd的配置文件"></a>了解vsftpd的配置文件</h4><table><thead><tr><th align="left">配置文件</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">/etc/vsftpd/vsftpd.conf</td><td align="left">主配置文件</td></tr><tr><td align="left">/usr/sbin/vsftpd</td><td align="left">Vsftpd的主程序</td></tr><tr><td align="left">/etc/rc.d/init.d/vsftpd</td><td align="left">启动脚本</td></tr><tr><td align="left">/etc/pam.d/vsftpd</td><td align="left">PAM认证文件（此文件中file=/etc/vsftpd/ftpusers字段，指明阻止访问的用户来自/etc/vsftpd/ftpusers文件中的用户）</td></tr><tr><td align="left">/etc/vsftpd/ftpusers</td><td align="left">禁止使用vsftpd的用户列表文件。记录不允许访问FTP服务器的用户名单，管理员可以把一些对系统安全有威胁的用户账号记录在此文件中，以免用户从FTP登录后获得大于上传下载操作的权利，而对系统造成损坏。</td></tr><tr><td align="left">/etc/vsftpd/user_list</td><td align="left">禁止或允许使用vsftpd的用户列表文件。这个文件中指定的用户缺省情况（即在/etc/vsftpd/vsftpd.conf中设置userlist_deny=YES）下也不能访问FTP服务器，在设置了userlist_deny=NO时,仅允许user_list中指定的用户访问FTP服务器。</td></tr><tr><td align="left">/var/ftp</td><td align="left">匿名用户主目录；本地用户主目录为：/home/用户主目录，即登录后进入自己家目录</td></tr><tr><td align="left">/var/ftp/pub</td><td align="left">匿名用户的下载目录，此目录需赋权根chmod 1777 pub（1为特殊权限，使上载后无法删除）</td></tr><tr><td align="left">/etc/logrotate.d/vsftpd.log</td><td align="left">Vsftpd的日志文件</td></tr></tbody></table><h5 id="vsftpd的主配置文件-etc-vsftpd-vsftpd-conf说明"><a href="#vsftpd的主配置文件-etc-vsftpd-vsftpd-conf说明" class="headerlink" title="vsftpd的主配置文件/etc/vsftpd/vsftpd.conf说明"></a>vsftpd的主配置文件/etc/vsftpd/vsftpd.conf说明</h5><p>和Linux系统中的大多数配置文件一样，vsftpd的配置文件中以#开始注释。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">是否允许匿名登录FTP服务器，默认设置为YES允许</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户可使用用户名ftp或anonymous进行ftp登录，口令为用户的E-mail地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如不允许匿名访问则设置为NO</span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许本地用户(即linux系统中的用户帐号)登录FTP服务器，默认设置为YES允许</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地用户登录后会进入用户主目录，而匿名用户登录后进入匿名用户的下载目录/var/ftp/pub</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若只允许匿名用户访问，前面加上<span class="comment">#注释掉即可阻止本地用户访问FTP服务器</span></span></span><br><span class="line">local_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许本地用户对FTP服务器文件具有写权限，默认设置为YES允许</span></span><br><span class="line">write_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 掩码，本地用户默认掩码为077</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 你可以设置本地用户的文件掩码为缺省022，也可根据个人喜好将其设置为其他值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_umask=022</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许匿名用户上传文件，须将全局的write_enable=YES。默认为YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">anon_upload_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许匿名用户创建新文件夹</span></span><br><span class="line"><span class="meta">#</span><span class="bash">anon_mkdir_write_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否激活目录欢迎信息功能</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当用户用CMD模式首次访问服务器上某个目录时，FTP服务器将显示欢迎信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下，欢迎信息是通过该目录下的.message文件获得的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件保存自定义的欢迎信息，由用户自己建立</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dirmessage_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否让系统自动维护上传和下载的日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况该日志文件为/var/<span class="built_in">log</span>/vsftpd.log,也可以通过下面的xferlog_file选项对其进行设定</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为NO</span></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> Make sure PORT transfer connections originate from port 20 (ftp-data).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否设定FTP服务器将启用FTP数据端口的连接请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ftp-data数据传输，21为连接控制端口</span></span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设定是否允许改变上传文件的属主，与下面一个设定项配合使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意，不推荐使用root用户上传文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chown_uploads=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置想要改变的上传文件的属主，如果需要，则输入一个系统用户名</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以把上传的文件都改成root属主。whoever：任何人</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chown_username=whoever</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设定系统维护记录FTP服务器上传和下载情况的日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /var/<span class="built_in">log</span>/vsftpd.log是默认的，也可以另设其它</span></span><br><span class="line"><span class="meta">#</span><span class="bash">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以标准xferlog的格式书写传输日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认为/var/<span class="built_in">log</span>/xferlog，也可以通过xferlog_file选项对其进行设定</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为NO</span></span><br><span class="line"><span class="meta">#</span><span class="bash">xferlog_std_format=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下是附加配置，添加相应的选项将启用相应的设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否生成两个相似的日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认在/var/<span class="built_in">log</span>/xferlog和/var/<span class="built_in">log</span>/vsftpd.log目录下</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 前者是wu_ftpd类型的传输日志，可以利用标准日志工具对其进行分析；后者是vsftpd类型的日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dual_log_enable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否将原本输出到/var/<span class="built_in">log</span>/vsftpd.log中的日志，输出到系统日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_enable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置数据传输中断间隔时间，此语句表示空闲的用户会话中断时间为600秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 即当数据传输结束后，用户连接FTP服务器的时间不应超过600秒。可以根据实际情况对该值进行修改</span></span><br><span class="line"><span class="meta">#</span><span class="bash">idle_session_timeout=600</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置数据连接超时时间，该语句表示数据连接超时时间为120秒，可根据实际情况对其个修改</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_connection_timeout=120</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行vsftpd需要的非特权系统用户，缺省是nobody</span></span><br><span class="line"><span class="meta">#</span><span class="bash">nopriv_user=ftpsecure</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否识别异步ABOR请求。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果FTP client会下达“async ABOR”这个指令时，这个设定才需要启用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 而一般此设定并不安全，所以通常将其取消</span></span><br><span class="line"><span class="meta">#</span><span class="bash">async_abor_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以ASCII方式传输数据。默认情况下，服务器会忽略ASCII方式的请求。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用此选项将允许服务器以ASCII方式传输数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不过，这样可能会导致由<span class="string">"SIZE /big/file"</span>方式引起的DoS攻击</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ascii_upload_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ascii_download_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录FTP服务器时显示的欢迎信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如有需要，可在更改目录欢迎信息的目录下创建名为.message的文件，并写入欢迎信息保存后</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ftpd_banner=Welcome to blah FTP service.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 黑名单设置。如果很讨厌某些email address，就可以使用此设定来取消他的登录权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以将某些特殊的email address抵挡住。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">deny_email_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当上面的deny_email_enable=YES时，可以利用这个设定项来规定哪些邮件地址不可登录vsftpd服务器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件需用户自己创建，一行一个email address即可</span></span><br><span class="line"><span class="meta">#</span><span class="bash">banned_email_file=/etc/vsftpd/banned_emails</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户登录FTP服务器后是否具有访问自己目录以外的其他文件的权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为YES时，用户被锁定在自己的home目录中，vsftpd将在下面chroot_list_file选项值的位置寻找chroot_list文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 必须与下面的设置项配合</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chroot_list_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 被列入此文件的用户，在登录后将不能切换到自己目录以外的其他目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从而有利于FTP服务器的安全管理和隐私保护。此文件需自己建立</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chroot_list_file=/etc/vsftpd/chroot_list</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许递归查询。默认为关闭，以防止远程用户造成过量的I/O</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ls_recurse_enable=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许监听。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果设置为YES，则vsftpd将以独立模式运行，由vsftpd自己监听和处理IPv4端口的连接请求</span></span><br><span class="line">listen=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设定是否支持IPV6。如要同时监听IPv4和IPv6端口，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 则必须运行两套vsftpd，采用两套配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时确保其中有一个监听选项是被注释掉的</span></span><br><span class="line"><span class="meta">#</span><span class="bash">listen_ipv6=YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置PAM外挂模块提供的认证服务所使用的配置文件名，即/etc/pam.d/vsftpd文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此文件中file=/etc/vsftpd/ftpusers字段，说明了PAM模块能抵挡的帐号内容来自文件/etc/vsftpd/ftpusers中</span></span><br><span class="line"><span class="meta">#</span><span class="bash">pam_service_name=vsftpd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否允许ftpusers文件中的用户登录FTP服务器，默认为NO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若此项设为YES，则user_list文件中的用户允许登录FTP服务器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 而如果同时设置了userlist_deny=YES，则user_list文件中的用户将不允许登录FTP服务器，甚至连输入密码提示信息都没有</span></span><br><span class="line"><span class="meta">#</span><span class="bash">userlist_enable=YES/NO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置是否阻扯user_list文件中的用户登录FTP服务器，默认为YES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">userlist_deny=YES/NO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否使用tcp_wrappers作为主机访问控制方式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp_wrappers可以实现linux系统中网络服务的基于主机地址的访问控制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/etc目录中的hosts.allow和hosts.deny两个文件用于设置tcp_wrappers的访问控制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 前者设置允许访问记录，后者设置拒绝访问记录。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如想限制某些主机对FTP服务器192.168.57.2的匿名访问，编缉/etc/hosts.allow文件，如在下面增加两行命令：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vsftpd:192.168.57.1:DENY 和vsftpd:192.168.57.9:DENY</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 表明限制IP为192.168.57.1/192.168.57.9主机访问IP为192.168.57.2的FTP服务器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时FTP服务器虽可以PING通，但无法连接</span></span><br><span class="line">tcp_wrappers=YES</span><br></pre></td></tr></table></figure><p>除了上述那些基本设定，我们还可以在vsftpd.conf文件中添加更多的安全选项。其中几个常用的如下：</p><p>限制最大连接数和传输速率</p><p>在FTP服务器的管理中，无论对本地用户还是匿名用户，对于FTP服务器资源的使用都需要进行控控制，避免由于负担过大造成FTP服务器运行异常，可以添加以下配置项对FTP客户机使用FTP服务器资源进行控制：</p><ul><li><code>max_client</code>设置项 用于设置FTP服务器所允许的最大客户端连接数，值为0时表示不限制。例如<code>max_client=100</code>表示FTP服务器的所有客户端最大连接数不超过100个。</li><li><code>max_per_ip</code>设置项 用于设置对于同一IP地址允许的最大客户端连接数，值为0时表示不限制。例如<code>max_per_ip=5</code>表示同一IP地址的FTP客户机与FTP服务器建立的最大连接数不超过5个。</li><li><code>local_max_rate</code>设置项 用于设置本地用户的最大传输速率，单位为B/s，值为0时表示不限制。例如<code>local_max_rate=500000</code>表示FTP服务器的本地用户最大传输速率设置为500KB/s.</li><li><code>anon_max_rate</code>设置项 用于设置匿名用户的最大传输速率，单位为B/s,值为0表示不限制。例如<code>ano_max_rate=200000</code>，表示FTP服务器的匿名用户最大传输速率设置为200KB/s.</li></ul><p>指定用户的权限设置</p><p><code>vsftpd.user_list</code>文件需要与<code>vsftpd.conf</code>文件中的配置项结合来实现对于<code>vsftpd.user_list</code>文件中指定用户账号的访问控制：</p><p>（1）设置禁止登录的用户账号</p><p>当<code>vsftpd.conf</code>配置文件中包括以下设置时，<code>vsftpd.user_list</code>文件中的用户账号被禁止进行FTP登录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=YES</span><br></pre></td></tr></table></figure><p><code>userlist_enable</code>设置项设置使用<code>vsftpd.user_list</code>文件，<code>userlist_deny</code>设置为<code>YES</code>表示<code>vsftpd.user_list</code>文件用于设置禁止的用户账号。</p><p>（2）设置只允许登录的用户账号</p><p>当vsftpd.conf配置文件中包括以下设置时，只有<code>vsftpd.user_list</code>文件中的用户账号能够进行FTP登录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=NO</span><br></pre></td></tr></table></figure><p><code>userlist_enable</code>设置项设置使用vsftpd.user_list文件，<code>userlist _deny</code>设置为<code>NO</code>表示<code>vsftpd.usre_list</code>文件用于设置只允许登录的用户账号，文件中未包括的用户账号被禁止FTP登录。</p><p><code>userlist_deny</code>和<code>userlist_enable</code>选项限制用户登录FTP服务器（使用<code>userlist_deny</code>选项和<code>user_list</code>文件一起能有效阻止<code>root,apache,www</code>等系统用户登录FTP服务器，从而保证FTP服务器的分级安全性）。以下是两个选项的具体表现形式和两种搭配使用方式的效果：</p><table><thead><tr><th align="left">配置</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">Userlist_enable=YES</td><td align="left">Ftpusers中用户允许访问;User_list中用户允许访问</td></tr><tr><td align="left">Userlist_enable=NO</td><td align="left">Ftpusers中用户禁止访问;User_list中用户允许访问</td></tr><tr><td align="left">Userlist_deny=YES</td><td align="left">Ftpusers中用户禁止访问（登录时可以看到密码输入提示，但仍无法访问）;user_list 中用户禁止访问</td></tr><tr><td align="left">Userlist_deny=NO</td><td align="left">ftpusers中用户禁止访问;user_list中用户允许访</td></tr><tr><td align="left">Userlist_enable=YES 并且Userlist_deny=YES</td><td align="left">Ftpusers中用户禁止访问;User_list中用户禁止访问（登录时不会出现密码提示，直接被服务器拒绝）</td></tr><tr><td align="left">Userlist_enable=YES 并且Userlist_deny=NO</td><td align="left">Ftpusers中用户禁止访问;User_list中用户允许访问</td></tr></tbody></table><p>修改默认端口</p><p>默认FTP服务器端口号是21，出于安全目的，有时需修改默认端口号，修改/etc/vsftpd/vsftpd.conf，添加语句(例)：</p><p><code>listen_port=4449</code></p><p>语句指定了修改后FTP服务器的端口号，应尽量大于4000。修改后访问</p><p><code>#ftp 192.168.57.2 4449</code></p><p>注意这里需加上正确的端口号了，否则不能正常连接。</p><p>设置用户组</p><p>有关FTP用户和用户组的重要性，我们在之前介绍vsftpd的时候便已经提到过。这里主要是简单的说明用户组的技术实现，至于具体如何应用，还是具体需求具体对待。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/try  递归创建新目录</span><br><span class="line">groupadd try        新建组</span><br><span class="line">useradd -g try -d /home/try try1 新建用户try1并指定家目录和属组</span><br><span class="line">useradd -g try -d /home/try try2 新建用户try2并指定家目录和属组</span><br><span class="line">useradd -g try -d /home/try try3 新建用户try3并指定家目录和属组</span><br><span class="line">passwd try1  为新用户设密码</span><br><span class="line">passwd try2  为新用户设密码</span><br><span class="line">passwd try3  为新用户设密码</span><br><span class="line">chown try1 /home/try 设置目录属主为用户try1</span><br><span class="line">chown .try /home/try 设置目录属组为组try</span><br><span class="line">chmod 750 /home/try  设置目录访问权限try1为读，写，执行；try2，try3为读，执行</span><br></pre></td></tr></table></figure><p>由于本地用户登录FTP服务器后进入自己主目录，而try1,try2 try3对主目录/home/try分配的权限不同，所以通过FTP访问的权限也不同，try1访问权限为：上传，下载，建目录；try2，try3访问权限为下载，浏览，不能建目录和上传。实现了群组中用户不同访问级别，加强了对FTP服务器的分级安全管理。</p><p>连接超时（本部分内容由李洋提供）</p><p>配置空闲的用户会话的中断时间：如下配置将在用户会话空闲5分钟后被中断，以释放服务器的资源</p><p><code>Idle_session_timeout=300</code></p><p>配置空闲的数据连接的中断时间：如下配置将在数据空闲连接1分钟后被中断，同样也是为了释放服务器的资源</p><p><code>Data_connection_timeout=60</code></p><p>配置客户端空闲时的自动中断和激活连接的时间：如下配置将使客户端空闲1分钟后自动中断连接，并在30秒后自动激活连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Accept_timeout=60</span><br><span class="line">Connect_timeout=30</span><br></pre></td></tr></table></figure><h5 id="vsftpd的日志"><a href="#vsftpd的日志" class="headerlink" title="vsftpd的日志"></a>vsftpd的日志</h5><p>常见的vsftpd日志解决方案</p><p>在vsftpd.conf中有如下内容定义了日志的记录方式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 表明FTP服务器记录上传下载的情况</span></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表明将记录的上传下载情况写在xferlog_file所指定的文件中，即xferlog_file选项指定的文件中</span></span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">xferlog_file=/var/log/xferlog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用双份日志。在用xferlog文件记录服务器上传下载情况的同时，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vsftpd_log_file所指定的文件，即/var/<span class="built_in">log</span>/vsftpd.log也将用来记录服务器的传输情况</span></span><br><span class="line">dual_log_enable=YES</span><br><span class="line">vsftpd_log_file=/var/log/vsftpd.log</span><br></pre></td></tr></table></figure><p>vsftpd的两个日志文件分析如下：</p><p>/var/log/xferlog</p><p>记录内容举例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thu Sep 6 09:07:48 2007 7 192.168.57.1 4323279 /home/student/phpMyadmin-2.11.0-all-languages.tar.gz b -i r student ftp 0 * c</span><br></pre></td></tr></table></figure><p>/var/log/vsftpd.log</p><p>记录内容举例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tue Sep 11 14:59:03 2007 [pid 3460]    CONNECT: Client "127.0.0.1"</span><br><span class="line">Tue Sep 11 14:59:24 2007 [pid 3459] [ftp] OK LOGIN;Client "127.0.0.1" ,anon password ”</span><br></pre></td></tr></table></figure><p>/var/log/xferlog日志文件中数据的分析和参数说明</p><p>|记录数据|参数名称|参数说明|<br>|Thu Sep 6 09:07:48 2007|当前时间|当前服务器本地时间，格式为： DDD MMM dd hh:mm:ss YYY|<br>|7|传输时间|传送文件所用时间，单位为秒|<br>|192.168.57.1|远程主机名称/IP|远程主机名称/IP|<br>|4323279|文件大小|传送文件的大小，单位为byte|<br>|/home/student/phpMyadmin-2.11.0-all-languages.tar.gz|文件名|传输文件名，包括路径|<br>|b|传输类型|传输方式的类型，包括两种：a以ASCII传输 b以二进制文件传输|<br>|–|特殊处理标志|特殊处理的标志位，可能的值包括：_ 不做任何特殊处理；C 文件是压缩格式；U 文件是非压缩格式；T 文件是tar格式|<br>|i|传输方向|文件传输方向，包括两种：o 从FTP服务器向客户端传输；i 从客户端向FTP服务器传输|<br>|r|访问模式|用户访问模式，包括：a 匿名用户；g 来宾用户；r 真实用户，即系统中的用户|<br>|student|用户名|用户名称|<br>|ftp|服务名|所使用的服务名称，一般为FTP|<br>|0|认证方式|认证方式，包括：0 无；1 RFC931认证|<br>|<em>|认证用户id|认证用户的id，如果使用</em>，则表示无法获得该id|<br>|c|完成状态|传输的状态：c 表示传输已完成；i 表示传输示完成|</p><h5 id="常见的FTP命令，以及FTP数字代码的意义"><a href="#常见的FTP命令，以及FTP数字代码的意义" class="headerlink" title="常见的FTP命令，以及FTP数字代码的意义"></a>常见的FTP命令，以及FTP数字代码的意义</h5><p>命令格式如下显示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FTP命令</span><br><span class="line">  功能</span><br><span class="line">  FTP命令</span><br><span class="line">  功能</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">ls</span><br><span class="line">显示服务器上的目录</span><br><span class="line">  ls [remote-dir][local-file]</span><br><span class="line">  显示远程目录remote-dir，并存入本地文件local-file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get remote-file [local-file]</span><br><span class="line">从服务器下载指定文件到客户端</span><br><span class="line">  mget remote-files</span><br><span class="line">  下载多个远程文件(mget命令允许用通配符下载多个文件)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">put local-file [remote-file]</span><br><span class="line">从客户端上传指定文件到服务器</span><br><span class="line">  mput local-file</span><br><span class="line">  将多个文件上传至远程主机(mput命令允许用通配符上传多个文件)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">open</span><br><span class="line">连接FTP服务器</span><br><span class="line">  mdelete [remote-file]</span><br><span class="line">  删除远程主机文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">close</span><br><span class="line">中断与远程服务器的ftp会话（与open对应）</span><br><span class="line">  mkdir dir-name</span><br><span class="line">  在远程主机中创建目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">open host[port]</span><br><span class="line">建立指定的ftp服务器连接，可指定连接端口</span><br><span class="line">  newer file-name</span><br><span class="line">  如果远程主机中file-name的修改时间比本地硬盘同名文件的时间更近，则重传该文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd directory</span><br><span class="line">改变服务器的工作目录</span><br><span class="line">  rename [from][to]</span><br><span class="line">  更改远程主机的文件名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lcd directory</span><br><span class="line">在客户端上(本地)改变工作目录</span><br><span class="line">  pwd</span><br><span class="line">  显示远程主机的当前工作目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bye</span><br><span class="line">退出FTP命令状态</span><br><span class="line">  quit</span><br><span class="line">  同bye,退出ftp会话</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ascii</span><br><span class="line">设置文件传输方式为ASCII模式</span><br><span class="line">  reget remote-file [local-file]</span><br><span class="line">  类似于get,但若local-file存在，则从上次传输中断处续传</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary</span><br><span class="line">设置文件传输方式为二进制模式</span><br><span class="line">  rhelp [cmd-name]</span><br><span class="line">  请求获得远程主机的帮助</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![cmd [args]]</span><br><span class="line">在本地主机中交互shell后退回到ftp环境，如:!ls *.zip</span><br><span class="line">  rstatus [file-name]</span><br><span class="line">  若未指定文件名，则显示远程主机的状态，否则显示文件状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">accout [password]</span><br><span class="line">提供登录远程系统成功后访问系统资源所需的密码</span><br><span class="line">  hash</span><br><span class="line">  每传输1024字节，显示一个hash符号（#）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">append local-file [remote-file]</span><br><span class="line">将本地文件追加到远程系统主机，若未指定远程系统文件名，则使用本地文件名</span><br><span class="line">  restart marker</span><br><span class="line">  从指定的标志marker处，重新开始get或put，如restart 130</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bye</span><br><span class="line">退出ftp会话过程</span><br><span class="line">  rmdir dir-name</span><br><span class="line">  删除远程主机目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">case</span><br><span class="line">在使用mget命令时，将远程主机文件名中的大写转为小写字母</span><br><span class="line">  size file-name</span><br><span class="line">  显示远程主机文件大小，如：</span><br><span class="line">size idle 7200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd remote-dir</span><br><span class="line">进入远程主机目录</span><br><span class="line">  status</span><br><span class="line">  显示当前ftp状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cdup</span><br><span class="line">进入远程主机目录的父目录</span><br><span class="line">  system</span><br><span class="line">  显示远程主机的操作系统</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete remote-file</span><br><span class="line">删除远程主机文件</span><br><span class="line">  user user-name [password][account]</span><br><span class="line">  向远程主机表明自己的身份，需要密码时，必须输入密码，如:user anonymous my@email</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dir [remote-dir][local-file]</span><br><span class="line">显示远程主机目录，并将结果存入本地文件</span><br><span class="line">  help [cmd]</span><br><span class="line">  显示ftp内部命令cmd的帮助信息，如help get</span><br></pre></td></tr></table></figure><p><strong>FTP数字代码的意义</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">110 重新启动标记应答。</span><br><span class="line">120 服务在多久时间内ready。</span><br><span class="line">125 数据链路端口开启，准备传送。</span><br><span class="line">150 文件状态正常，开启数据连接端口。</span><br><span class="line">200 命令执行成功。</span><br><span class="line">202 命令执行失败。</span><br><span class="line">211 系统状态或是系统求助响应。</span><br><span class="line">212 目录的状态。</span><br><span class="line">213 文件的状态。</span><br><span class="line">214 求助的讯息。</span><br><span class="line">215 名称系统类型。</span><br><span class="line">220 新的联机服务ready。</span><br><span class="line">221 服务的控制连接端口关闭，可以注销。</span><br><span class="line">225 数据连结开启，但无传输动作。</span><br><span class="line">226 关闭数据连接端口，请求的文件操作成功。</span><br><span class="line">227 进入passive mode。</span><br><span class="line">230 使用者登入。</span><br><span class="line">250 请求的文件操作完成。</span><br><span class="line">257 显示目前的路径名称。</span><br><span class="line">331 用户名称正确，需要密码。</span><br><span class="line">332 登入时需要账号信息。</span><br><span class="line">350 请求的操作需要进一部的命令。</span><br><span class="line">421 无法提供服务，关闭控制连结。</span><br><span class="line">425 无法开启数据链路。</span><br><span class="line">426 关闭联机，终止传输。</span><br><span class="line">450 请求的操作未执行。</span><br><span class="line">451 命令终止:有本地的错误。</span><br><span class="line">452 未执行命令:磁盘空间不足。</span><br><span class="line">500 格式错误，无法识别命令。</span><br><span class="line">501 参数语法错误。</span><br><span class="line">502 命令执行失败。</span><br><span class="line">503 命令顺序错误。</span><br><span class="line">504 命令所接的参数不正确。</span><br><span class="line">530 未登入。</span><br><span class="line">532 储存文件需要账户登入。</span><br><span class="line">550 未执行请求的操作。</span><br><span class="line">551 请求的命令终止，类型未知。</span><br><span class="line">552 请求的文件终止，储存位溢出。  </span><br><span class="line">553 未执行请求的的命令，名称不正确。</span><br></pre></td></tr></table></figure><h3 id="项目实践"><a href="#项目实践" class="headerlink" title="项目实践"></a>项目实践</h3><ol><li>设置vsftpd服务匿名用户能够对/var/ftp/test/目录有上传下载的权限。</li><li>系统用户能够访问家目录，上传下载删除</li><li>除了系统用户batman有chroot的权限，其他系统用户没有chroot的权限</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="pic/05.png" alt="05"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;课程要求&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;设置vsftpd服务匿名用户能够对/var/ftp/pub/目录有上传下载的权限。&lt;/li&gt;
&lt;li&gt;系统用户能够访问家目录，上传下载删除&lt;/li&gt;
&lt;li&gt;除了系统用户student
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>NFS文件共享服务</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/03_nfs/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/03_nfs/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.709Z</updated>
    
    <content type="html"><![CDATA[<h3 id="NFS是什么"><a href="#NFS是什么" class="headerlink" title="NFS是什么"></a>NFS是什么</h3><p>NFS（Network File System）即网络文件系统，SUN公司开发的,是FreeBSD支持的文件系统中的一种，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p><h3 id="NFS的原理"><a href="#NFS的原理" class="headerlink" title="NFS的原理"></a>NFS的原理</h3><p>假设我们有一个服务器，两个客户端。客户端可以将网络中的NFS服务器共享的目录挂载到本地端的文件系统中，而在本地端的系统中看来，那个远程主机的目录就好像自己的一个磁盘分区一样。</p><p>比如将配置好的NFS服务器上的<code>/var/share/student1</code>目录挂在到A客户端的<code>/home/share/student1</code>上面，那在客户端A上面进入<code>/home/share/student1</code>内，就可以看到NFS服务器系统中<code>/var/share/student1</code>目录下所有的内容了，并且可以执行<code>cd，cp，mv，rm</code>等命令。当然，权限要足够。这个<code>/var/share/student1</code>就好像NFS客户端的一个文件系统一样。所以，NFS也可以简单的看做是一个文件服务器（file system）</p><p>只要权限足够，客户端也可以对该目录下的内容进行读写操作等等。</p><p><strong>NFS指的是一种服务</strong> 既然是服务，肯定会用到一些监听端口，那NFS用的是什么端口进行数据传输的？我也不知道，谁都不知道。基本上NFS这个服务的端口开在2049端口，但由于文件系统非常复杂，NFS支持的功能又相当的多，每一个功能就会启用一些端口来传输数据，所以，NFS需要调用额外的端口，那额外的端口号又是什么呢？额外的端口号并不固定。因为NFS默认传输的端口是随机取用未被使用的小于1024的端口用于传输。但如此一来，客户端连接服务器又成了问题，客户端并不知道我要链接那些端口。这时候就需要用到远程过程调用RPC服务了 remote procedure call。</p><p>RPC就是指定NFS各功能对应的端口号，然后通知给客户端，让客户端可以连接到正确的端口上。</p><p><img src="pic/20.png" alt="20"></p><p>对于服务端来说，在NFS启动的时候，会自动向RPC注册其各个功能所需要的随机端口号，让RPC了解NFS各项功能的端口号，PID，NFS所监听的IP等等。当客户端通过111端口号向server端RPC发出NFS访问请求时候，RPC就会找到对应已注册的端口号，并返还给客户端，客户端就可以通过这些端口号与NFS发起链接。比如说我是NFS，我在启动的时候，就会告诉RPC，我的A端口用于做什么事情，我的B端口用于做什么事情，RPC就会将其端口注册信息登记，等客户端发起请求的时候就可以直接找到RPC，而不是直接找我NFS，RPC可以直接告知客户端所需请求对应的正确的端口号。</p><p>当客户端执行操作文件系统的各项命令时候，会转交给客户端的RPC，客户端RPC负责接受各个程序与对应的端口后负责对主机进行解析。所以要使用NFS时，无论是客户端还是服务端，都需要启动RPC。</p><p>启动NFS之前，RPC就要先启动了，不然NFS无法向RPC注册，并且，RPC重启以后，原来注册的数据就没有了，所以RPC重新启动后，NFS也要重启，重新想RPC注册才行。</p><p>同样，A客户端对NFS服务器上的共享文件进行了修改后，B服务器能看到改后的文件，也就完成了各个主机之间文件的共享。所以如果重启了rpc，nfs也必须要重新启动，以便于重新像rpc注册相应的端口号。</p><ul><li>NFS：处理客户端数据请求，</li><li>RPC：处理客户端链接请求。</li></ul><h3 id="NFS的用处"><a href="#NFS的用处" class="headerlink" title="NFS的用处"></a>NFS的用处</h3><ul><li>存储共享方案</li><li>网络共享文件系统</li></ul><h3 id="项目实践1：配置NFS网络共享文件服务器"><a href="#项目实践1：配置NFS网络共享文件服务器" class="headerlink" title="项目实践1：配置NFS网络共享文件服务器"></a>项目实践1：配置NFS网络共享文件服务器</h3><p>要求rhel7 172.25.X.10 作为NFS网络共享文件服务器：</p><ol><li>允许172.25.X.11这个客户端来挂接使用/tmp目录，有读写权限。</li><li>将读写权限改成只读权限；(ro)</li><li>允许172.25.X.0/24网段挂接/tmp目录，有读写权限；</li><li>服务器上创建uid=1200的用户tom，并使用tom用户创建/tmp/tomfile；在客户端创建uid=1200的用户jack，尝试去删除tomfile目录;</li><li>为什么不建议使用(rw,no_root_squash)</li></ol><h5 id="实验准备阶段"><a href="#实验准备阶段" class="headerlink" title="实验准备阶段"></a>实验准备阶段</h5><ol><li>网络拓扑图</li><li>规划软件安装</li><li>修改配置文件</li><li>启动服务</li><li>客户端测试服务        </li></ol><blockquote><p>网络拓扑图</p></blockquote><p><img src="pic/12.png" alt="12"></p><blockquote><p>规划软件安装</p></blockquote><table><thead><tr><th align="left">主机名</th><th align="left">ip地址</th><th align="left">软件</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">rhel6</td><td align="left">172.25.0.11</td><td align="left">rpcbind nfs-utils</td><td align="left">服务端</td></tr><tr><td align="left">rhel7</td><td align="left">172.25.0.10</td><td align="left">rpcbind nfs-utils</td><td align="left">客户端</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# yum install -y nfs-utils rpcbind</span><br><span class="line">Loaded plugins: product-id, refresh-packagekit, security, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">server                                                                                    | 3.9 kB     00:00     </span><br><span class="line">server/primary_db                                                                         | 3.1 MB     00:00     </span><br><span class="line">Setting up Install Process</span><br><span class="line">Package 1:nfs-utils-1.2.3-39.el6.x86_64 already installed and latest version</span><br><span class="line">Package rpcbind-0.2.0-11.el6.x86_64 already installed and latest version</span><br><span class="line">Nothing to do</span><br></pre></td></tr></table></figure><p>rpcbind</p><ul><li>rpc:管理客户端和服务端的ip和端口号—连接</li><li>remote    procedure call——远程过程调用协议</li></ul><p>nfs-utils</p><ul><li>nfs:传输数据</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# rpm -qf /etc/exports</span><br><span class="line">setup-2.8.14-20.el6_4.1.noarch</span><br><span class="line">[root@rhel6 ~]# rpm -ql rpcbind</span><br><span class="line">/etc/rc.d/init.d/rpcbind</span><br><span class="line">/sbin/rpcbind</span><br><span class="line">/usr/sbin/rpcinfo</span><br><span class="line">/usr/share/doc/rpcbind-0.2.0</span><br><span class="line">/usr/share/doc/rpcbind-0.2.0/AUTHORS</span><br><span class="line">/usr/share/doc/rpcbind-0.2.0/ChangeLog</span><br><span class="line">/usr/share/doc/rpcbind-0.2.0/README</span><br><span class="line">/usr/share/man/man8/rpcbind.8.gz</span><br><span class="line">/usr/share/man/man8/rpcinfo.8.gz</span><br><span class="line">/var/cache/rpcbind</span><br><span class="line">[root@rhel6 ~]# rpm -ql nfs-utils</span><br><span class="line">/etc/nfsmount.conf</span><br><span class="line">/etc/rc.d/init.d/nfs</span><br><span class="line">/etc/rc.d/init.d/nfslock</span><br><span class="line">/etc/rc.d/init.d/rpcgssd</span><br><span class="line">/etc/rc.d/init.d/rpcidmapd</span><br><span class="line">/etc/rc.d/init.d/rpcsvcgssd</span><br><span class="line">/etc/request-key.d/id_resolver.conf</span><br><span class="line">/etc/sysconfig/nfs</span><br><span class="line">/sbin/mount.nfs</span><br><span class="line">/sbin/mount.nfs4</span><br><span class="line">/sbin/nfs_cache_getent</span><br><span class="line">/sbin/rpc.statd</span><br><span class="line">/sbin/umount.nfs</span><br><span class="line">/sbin/umount.nfs4</span><br><span class="line">/usr/sbin/exportfs</span><br><span class="line">/usr/sbin/mountstats</span><br><span class="line">/usr/sbin/nfsidmap</span><br><span class="line">/usr/sbin/nfsiostat</span><br><span class="line">/usr/sbin/nfsstat</span><br><span class="line">/usr/sbin/rpc.gssd</span><br><span class="line">/usr/sbin/rpc.idmapd</span><br><span class="line">/usr/sbin/rpc.mountd</span><br><span class="line">/usr/sbin/rpc.nfsd</span><br><span class="line">/usr/sbin/rpc.svcgssd</span><br><span class="line">/usr/sbin/rpcdebug</span><br><span class="line">/usr/sbin/showmount</span><br><span class="line">/usr/sbin/sm-notify</span><br><span class="line">/usr/sbin/start-statd</span><br><span class="line">/usr/share/doc/n7/nfsd.7.gz</span><br><span class="line">... ...</span><br><span class="line">/var/lib/nfs</span><br><span class="line">/var/lib/nfs/etab</span><br><span class="line">/var/lib/nfs/rmtab</span><br><span class="line">/var/lib/nfs/rpc_pipefs</span><br><span class="line">/var/lib/nfs/statd</span><br><span class="line">/var/lib/nfs/statd/sm</span><br><span class="line">/var/lib/nfs/statd/sm.bak</span><br><span class="line">/var/lib/nfs/state</span><br><span class="line">/var/lib/nfs/v4recovery</span><br><span class="line">/var/lib/nfs/xtab</span><br></pre></td></tr></table></figure><blockquote><p>修改配置文件</p></blockquote><p><strong>主配置文件</strong> <code>/etc/exports</code></p><p><strong>服务名</strong> <code>rpcbind</code> <code>nfs</code></p><p>根据要求，允许172.25.X.10这个客户端来挂接使用/tmp目录，有读写权限。配置<code>/etc/exports</code>内容为<code>/tmp 172.25.0.10(rw)</code>后，根据服务名来打开相应的服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/exports</span><br><span class="line">[root@rhel6 ~]# cat /etc/exports</span><br><span class="line">/tmp 172.25.0.10(rw)</span><br></pre></td></tr></table></figure><blockquote><p>启动服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# service rpcbind start</span><br><span class="line">[root@rhel6 ~]# service nfs start</span><br><span class="line">Starting NFS services:                                     [  OK  ]</span><br><span class="line">Starting NFS quotas:                                       [  OK  ]</span><br><span class="line">Starting NFS mountd:                                       [  OK  ]</span><br><span class="line">Starting NFS daemon:                                       [  OK  ]</span><br><span class="line">Starting RPC idmapd:                                       [  OK  ]</span><br><span class="line">[root@rhel6 ~]# netstat -luntp |grep rpcbind</span><br><span class="line">tcp        0      0 0.0.0.0:111                 0.0.0.0:*                   LISTEN      1174/rpcbind        </span><br><span class="line">tcp        0      0 :::111                      :::*                        LISTEN      1174/rpcbind        </span><br><span class="line">udp        0      0 0.0.0.0:111                 0.0.0.0:*                               1174/rpcbind        </span><br><span class="line">udp        0      0 0.0.0.0:925                 0.0.0.0:*                               1174/rpcbind        </span><br><span class="line">udp        0      0 :::111                      :::*                                    1174/rpcbind        </span><br><span class="line">udp        0      0 :::925                      :::*                                    1174/rpcbind        </span><br><span class="line">[root@rhel6 ~]# netstat -luntp |grep nfs</span><br><span class="line">[root@rhel6 ~]# ps -ef|grep nfs</span><br><span class="line">root      1888     2  0 15:20 ?        00:00:00 [nfsd4]</span><br><span class="line">root      1889     2  0 15:20 ?        00:00:00 [nfsd4_callbacks]</span><br><span class="line">root      1890     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1891     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1892     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1893     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1894     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1895     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1896     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1897     2  0 15:20 ?        00:00:00 [nfsd]</span><br><span class="line">root      1928  1745  0 15:20 pts/0    00:00:00 grep nfs</span><br><span class="line">[root@rhel6 ~]# service iptables stop</span><br><span class="line">iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span><br><span class="line">iptables: Flushing firewall rules:                         [  OK  ]</span><br><span class="line">iptables: Unloading modules:                               [  OK  ]</span><br></pre></td></tr></table></figure><p><strong>守护进程daemon</strong> <code>rpcbind</code> <code>nfsd</code></p><p><strong>监听端口号</strong> 111 925</p><blockquote><p>客户端测试使用</p></blockquote><p>查看服务器共享目录的情况 <code>showmount -e 172.25.0.11</code></p><p>远程挂载 <code>mount 172.25.0.10:/tmp /mnt</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# yum install -y nfs-utils rpcbind</span><br><span class="line">Loaded plugins: langpacks, product-id, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">Package 1:nfs-utils-1.3.0-0.el7.x86_64 already installed and latest version</span><br><span class="line">Package rpcbind-0.2.0-23.el7.x86_64 already installed and latest version</span><br><span class="line">Nothing to do</span><br><span class="line">[root@rhel7 ~]# showmount -e 172.25.0.11</span><br><span class="line">Export list for 172.25.0.11:</span><br><span class="line">/tmp 172.25.0.10</span><br><span class="line">[root@rhel7 ~]# mount 172.25.0.11:/tmp /mnt</span><br><span class="line">[root@rhel7 ~]# mount |tail -n 1</span><br><span class="line">172.25.0.11:/tmp on /mnt type nfs4 (rw,relatime,vers=4.0,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.25.0.10,local_lock=none,addr=172.25.0.11)</span><br><span class="line">[root@rhel7 mnt]# touch rhel7test</span><br><span class="line">[root@rhel7 mnt]# ll</span><br><span class="line">total 12</span><br><span class="line">drwx------. 2 gdm       gdm       4096 Sep 25 02:59 orbit-gdm</span><br><span class="line">drwx------. 2 root      root      4096 Jul  2  2015 pulse-oCBy0hGD1JT6</span><br><span class="line">drwx------. 2 gdm       gdm       4096 Sep 25 02:59 pulse-q5sECpImz7Ju</span><br><span class="line">-rw-r--r--. 1 nfsnobody nfsnobody    0 Sep 25  2016 rhel7test</span><br><span class="line">[root@rhel7 mnt]# cd</span><br><span class="line">[root@rhel7 ~]# umount /mnt</span><br></pre></td></tr></table></figure><p><strong>nfsnobody</strong> 以 root 用户创建的文件被映射成 nfsnobody 用户 , 因为在服务器上没有指定 no_root_squash</p><blockquote><p>将读写权限改成只读权限；(ro)</p></blockquote><p>服务器端修改配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/exports</span><br><span class="line">[root@rhel6 ~]# cat /etc/exports</span><br><span class="line">/tmp 172.25.0.10(ro)</span><br><span class="line">[root@rhel6 ~]# service rpcbind restart</span><br><span class="line">Stopping rpcbind:                                          [  OK  ]</span><br><span class="line">Starting rpcbind:                                          [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service nfs restart</span><br><span class="line">Shutting down NFS daemon:                                  [  OK  ]</span><br><span class="line">Shutting down NFS mountd:                                  [  OK  ]</span><br><span class="line">Shutting down NFS quotas:                                  [  OK  ]</span><br><span class="line">Shutting down NFS services:                                [  OK  ]</span><br><span class="line">Shutting down RPC idmapd:                                  [  OK  ]</span><br><span class="line">Starting NFS services:                                     [  OK  ]</span><br><span class="line">Starting NFS quotas:                                       [  OK  ]</span><br><span class="line">Starting NFS mountd:                                       [  OK  ]</span><br><span class="line">Starting NFS daemon:                                       [  OK  ]</span><br><span class="line">Starting RPC idmapd:                                       [  OK  ]</span><br></pre></td></tr></table></figure><p>客户端rhel7</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# mount 172.25.0.11:/tmp /mnt</span><br><span class="line">[root@rhel7 ~]# touch /mnt/rhel7test2</span><br><span class="line">touch: cannot touch ‘/mnt/rhel7test2’: Read-only file system</span><br><span class="line">[root@rhel7 ~]# umount /mnt</span><br></pre></td></tr></table></figure><blockquote><p>允许172.25.X.0/24网段挂接/tmp目录，有读写权限；</p></blockquote><p>修改配置文件为 <code>/tmp 172.25.0.0/24(rw)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/exports</span><br><span class="line">[root@rhel6 ~]# cat /etc/exports</span><br><span class="line">/tmp 172.25.0.0/24(rw)</span><br><span class="line">[root@rhel6 ~]# service rpcbind restart</span><br><span class="line">Stopping rpcbind:                                          [  OK  ]</span><br><span class="line">Starting rpcbind:                                          [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service nfs restart</span><br><span class="line">Shutting down NFS daemon:                                  [  OK  ]</span><br><span class="line">Shutting down NFS mountd:                                  [  OK  ]</span><br><span class="line">Shutting down NFS quotas:                                  [  OK  ]</span><br><span class="line">Shutting down NFS services:                                [  OK  ]</span><br><span class="line">Shutting down RPC idmapd:                                  [  OK  ]</span><br><span class="line">Starting NFS services:                                     [  OK  ]</span><br><span class="line">Starting NFS quotas:                                       [  OK  ]</span><br><span class="line">Starting NFS mountd:                                       [  OK  ]</span><br><span class="line">Starting NFS daemon:                                       [  OK  ]</span><br><span class="line">Starting RPC idmapd:                                       [  OK  ]</span><br></pre></td></tr></table></figure><blockquote><p>分别在客户端和服务器上都创建一个id=1200的用户tom，在客户端用tom用户新建一个文件rhel7tomfile，并查看属性，再到服务器上去查看该文件的属性；在服务器上用tom用户去创建rhel6tomfile，查看属性，再到客户端上查看属性。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端rhel6</span></span><br><span class="line">[root@rhel6 ~]# useradd -u 1200 tom</span><br><span class="line">[root@rhel6 ~]# echo uplooking|passwd --stdin tom</span><br><span class="line">Changing password for user tom.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@rhel6 ~]# su - tom</span><br><span class="line">[tom@rhel6 ~]$ touch /tmp/tomfile</span><br><span class="line">[tom@rhel6 ~]$ ll /tmp/tomfile</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Sep 25 15:55 /tmp/tomfile</span><br><span class="line">[tom@rhel6 tmp]$ touch rhel6tomfile</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端rhel7</span></span><br><span class="line">[tom@rhel7 mnt]$ touch rhel7tomfile</span><br><span class="line">[tom@rhel7 mnt]$ ll</span><br><span class="line">total 12</span><br><span class="line">-rw-rw-r--. 1 nobody nobody    0 Sep 25 04:03 4913</span><br><span class="line">drwx------. 2 gdm    gdm    4096 Sep 25 02:59 orbit-gdm</span><br><span class="line">drwx------. 2 root   root   4096 Jul  2  2015 pulse-oCBy0hGD1JT6</span><br><span class="line">drwx------. 2 gdm    gdm    4096 Sep 25 02:59 pulse-q5sECpImz7Ju</span><br><span class="line">-rw-rw-r--. 1 nobody nobody    0 Sep 25 04:07 rhel7tomfile</span><br><span class="line">-rw-rw-r--. 1 nobody nobody    0 Sep 25 04:06 tomfile</span><br><span class="line">[tom@rhel7 mnt]$ rm -rf rhel7tomfile</span><br><span class="line">rm: cannot remove ‘rhel7tomfile’: Operation not permitted</span><br><span class="line">[tom@rhel7 mnt]$ rm -rf rhel6tomfile</span><br><span class="line">rm: cannot remove ‘rhel6tomfile’: Operation not permitted</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端rhel6</span></span><br><span class="line">[tom@rhel6 tmp]$ ll</span><br><span class="line">total 12</span><br><span class="line">-rw-rw-r--. 1 tom  tom     0 Sep 25 16:03 4913</span><br><span class="line">drwx------. 2 gdm  gdm  4096 Sep 25 14:59 orbit-gdm</span><br><span class="line">drwx------. 2 root root 4096 Jul  2  2015 pulse-oCBy0hGD1JT6</span><br><span class="line">drwx------. 2 gdm  gdm  4096 Sep 25 14:59 pulse-q5sECpImz7Ju</span><br><span class="line">-rw-rw-r--. 1 tom  tom     0 Sep 25 16:10 rhel6tomfile</span><br><span class="line">-rw-rw-r--. 1 tom  tom     0 Sep 25 16:07 rhel7tomfile</span><br></pre></td></tr></table></figure><p>两个新文件在客户端均显示属于nobody，而在服务器端显示属于tom用户，并且会发现在客户端由tom用户创建出来的文件也没有办法删除。</p><p>这是由于当前服务器版本比客户端低的缘故。</p><p>如果将rhel7作为服务端，rhel6作为客户端，就不会出现上述问题了。如下所示：</p><table><thead><tr><th align="left">主机名</th><th align="left">ip地址</th><th align="left">软件</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">rhel6</td><td align="left">172.25.0.11</td><td align="left">rpcbind nfs-utils</td><td align="left">客户端</td></tr><tr><td align="left">rhel7</td><td align="left">172.25.0.10</td><td align="left">rpcbind nfs-utils</td><td align="left">服务端</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端rhel7</span></span><br><span class="line">[root@rhel7 ~]# vim /etc/exports</span><br><span class="line">[root@rhel7 ~]# systemctl stop firewalld</span><br><span class="line">[root@rhel7 ~]# systemctl start rpcbind</span><br><span class="line">[root@rhel7 ~]# systemctl start nfs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端rhel6</span></span><br><span class="line">[root@rhel6 tmp]# mount 172.25.0.10:/tmp /mnt</span><br><span class="line">[root@rhel6 tmp]# cd /mnt</span><br><span class="line">[tom@rhel6 mnt]$ touch rhel6tomfile</span><br><span class="line">[tom@rhel6 mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 tom  tom   0 Sep 25 16:22 rhel6tomfile</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端rhel7</span></span><br><span class="line">[tom@rhel7 tmp]$ touch rhel7tomfile</span><br><span class="line">[tom@rhel7 tmp]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 tom  tom   0 Sep 25 04:22 rhel6tomfile</span><br><span class="line">-rw-rw-r--. 1 tom  tom   0 Sep 25 04:24 rhel7tomfile</span><br><span class="line">drwx------. 3 root root 16 Sep 25 02:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 02:58 systemd-private-jFcaMN</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端rhel6</span></span><br><span class="line">[tom@rhel6 mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 tom  tom   0 Sep 25 16:22 rhel6tomfile</span><br><span class="line">-rw-rw-r--. 1 tom  tom   0 Sep 25 16:24 rhel7tomfile</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br><span class="line">[tom@rhel6 mnt]$ rm -rf rhel6tomfile</span><br><span class="line">[tom@rhel6 mnt]$ rm -rf rhel7tomfile</span><br><span class="line">[tom@rhel6 mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br></pre></td></tr></table></figure><p><strong>文件所属者和所属组是根据uid和gid来匹配的。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器rhel7</span></span><br><span class="line">[root@rhel7 ~]# useradd -u 1003 batman</span><br><span class="line">[root@rhel7 ~]# echo uplooking|passwd --stdin batman</span><br><span class="line">Changing password for user batman.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@rhel7 ~]# id batman</span><br><span class="line">uid=1003(batman) gid=1003(batman) groups=1003(batman)</span><br><span class="line">[root@rhel7 ~]# su batman</span><br><span class="line">[batman@rhel7 root]$ cd /tmp</span><br><span class="line">[batman@rhel7 tmp]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwx------. 3 root root 16 Sep 25 02:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 02:58 systemd-private-jFcaMN</span><br><span class="line">[batman@rhel7 tmp]$ touch rhel7batmanfile</span><br><span class="line">[batman@rhel7 tmp]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 batman batman  0 Sep 25 04:27 rhel7batmanfile</span><br><span class="line">drwx------. 3 root   root   16 Sep 25 02:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root   root   16 Sep 25 02:58 systemd-private-jFcaMN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rhel6 mnt]# ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 1003 1003  0 Sep 25 16:27 rhel7batmanfile</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br><span class="line">[root@rhel6 mnt]# useradd -u 1003 superman</span><br><span class="line">[root@rhel6 mnt]# echo uplooking|passwd --stdin superman</span><br><span class="line">Changing password for user superman.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@rhel6 mnt]# ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 superman superman  0 Sep 25 16:27 rhel7batmanfile</span><br><span class="line">drwx------. 3 root     root     16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root     root     16 Sep 25 14:58 systemd-private-jFcaMN</span><br><span class="line">[root@rhel6 mnt]# su  superman</span><br><span class="line">[superman@rhel6 mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 superman superman  0 Sep 25 16:27 rhel7batmanfile</span><br><span class="line">drwx------. 3 root     root     16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root     root     16 Sep 25 14:58 systemd-private-jFcaMN</span><br><span class="line">[superman@rhel6 mnt]$ rm -rf rhel7batmanfile</span><br><span class="line">[superman@rhel6 mnt]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br></pre></td></tr></table></figure><p>在服务器上以 batman 用户创建的文件被映射成客户端的 superman 用户 , 因为在服务器上 batman 的 id 与 superman 的 id 相同</p><blockquote><p>为什么不建议使用(rw,no_root_squash)</p></blockquote><p><strong>面试题</strong></p><ol><li>客户说为什么我是root，却不能删除root的文件呢（前提是该文件是nfs服务挂接使用的）？</li></ol><ul><li>1）考虑到安全，当前我们nfs的配置中就设置为本地的root用户是没有权限删除服务器端的root用户文件的。</li><li>2）如果客户你一定要去有这个权限，那么你可以修改配置，添加一个no_root_squash；不建议这么做。</li></ul><ol start="2"><li>客户电话咨询说服务器出故障了，</li></ol><ul><li>1）挂接目录执行任何操作就卡死了，然后我重启，就卡在哪里了，/mnt</li><li>2）前一天还正常，今天上班开不了机了</li><li>3）mount查看当前挂接目录，卡在哪里，杀掉进程，再mount还是卡在那里</li></ul><p>以上都有可能是nfs服务器连接出现问题了，应该去检查一下nfs服务器的运行情况。再排错。</p><h3 id="配置文件详解"><a href="#配置文件详解" class="headerlink" title="配置文件详解"></a>配置文件详解</h3><h4 id="主配置文件-etc-exports"><a href="#主配置文件-etc-exports" class="headerlink" title="主配置文件/etc/exports"></a>主配置文件/etc/exports</h4><p>关于exports的写法，我们可以通过  <code>man 5 exports</code> 来查看 <code>EXAMPLES</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sample /etc/exports file</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      共享目录             客户端列表（权限）</span></span><br><span class="line">       /               master(rw) trusty(rw,no_root_squash)</span><br><span class="line">       /projects       proj*.local.domain(rw)</span><br><span class="line">       /usr            *.local.domain(ro) @trusted(rw)</span><br><span class="line">       /home/joe       pc001(rw,all_squash,anonuid=150,anongid=100)</span><br><span class="line">       /pub            *(ro,insecure,all_squash)</span><br><span class="line">       /srv/www        -sync,rw server @trusted @external(ro)</span><br><span class="line">       /foo            2001:db8:9:e54::/64(rw) 192.0.2.0/24(rw)</span><br><span class="line">       /build          buildhost[0-9].local.domain(rw)</span><br></pre></td></tr></table></figure><p>详细参数解释如下表所示：</p><table><thead><tr><th align="left">参数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">rw</td><td align="left">可读可写</td></tr><tr><td align="left">ro</td><td align="left">只读</td></tr><tr><td align="left">sync</td><td align="left">数据同步写入内存缓冲区与磁盘中，虽然这样做效率较低，但可以保证数据的一致性（适合于小文件传输）</td></tr><tr><td align="left">async</td><td align="left">数据先暂时放于内存，而非直接写入硬盘，等到必要时才写入磁盘（适合于大文件传输）</td></tr><tr><td align="left">no_root_squash</td><td align="left">使用nfs时，如果用户是root，不进行权限压缩，即root用户在nfs上创建的文件   属组和属主仍然是root（不安全，不建议使用）</td></tr><tr><td align="left">root_squash</td><td align="left">使用nfs时，如果用户是root，则进行权限压缩，即把root用户在nfs上创建的文件   属组和属主修改为nfsnobody</td></tr><tr><td align="left">all_squash</td><td align="left">所有的普通用户使用nfs都将使用权限压缩，即：将远程访问的所有普通用户及所属用户组都映射为匿名用户或者用户组（一般均为nfsnobody）</td></tr><tr><td align="left">no_all_squash</td><td align="left">所有的普通用户使用nfs都不使用权限压缩，即：不将远程访问的所有普通用户及所属用户组都映射为匿名用户或者用户组（默认设置）</td></tr><tr><td align="left">anonuid=XXX</td><td align="left">anon即anonymous(匿名者)，前面关于*_squash提到的匿名用户的uid的设置值，通常为nobody或者nfsnobody，使用这个参数可以自行设定这个uid值，这个uid必须存在 于/etc/passwd</td></tr><tr><td align="left">anongid=XXX</td><td align="left">将远程访问的所有用户组都映身为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户（GID=XXX）</td></tr><tr><td align="left">insecure</td><td align="left">允许客户端从大于1024的TCP/IP端口连NFS服务器</td></tr><tr><td align="left">secure</td><td align="left">限制客户端只能从小于1024的TCP/IP端口连接NFS服务器(默认设置)</td></tr><tr><td align="left">wdelay</td><td align="left">检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可提高效率(默认设置)</td></tr><tr><td align="left">no_wdelay</td><td align="left">若有写操作则立即执行（应与sync配置）</td></tr><tr><td align="left">subtree_check</td><td align="left">若输出目录是一个子目录，则NFSW:务器将检查其父目录的权限(默认设置)</td></tr><tr><td align="left">no_subtree_check</td><td align="left">即使输出目录是一个子目录，NFS服务器也不检查其父目录的权限，这样做可提高效率</td></tr></tbody></table><p><strong>设置实例</strong></p><p><code>/tmp *(rw,no_root_squash)</code></p><p>在所有的IP（主机）上登录的用户都可对NFS服务器上的共享目录/tmp拥有rw操作权限，同时如果是root用户访问该共享目录，那么不将root用户及所属用户组都映射为匿名用户或用户组（*表示所有的主机或者IP）</p><p><code>/tmp *(rw)</code></p><p>在所有的IP（主机）登录的用户都可对NFS服务器上的共享目录/tmp拥有rw操作权限</p><p><code>/home/public 192.168.0.*(rw)   *(ro)</code>  或者 <code>/home/public 192.168.0.0/24(rw) *(ro)</code></p><p>除了在<code>192. 168. 0.0/24</code>这个网段内的主机上登录的用户，可对NFS服务器共享目录<code>/home/public</code>进行<code>rw</code>操作权限，而其它网段的主机上登录的用户，对NFS服务器共享目录<code>/home/public</code>只能进行<code>r</code>操作</p><p><code>/home/test 192.168.0.100(rw)</code></p><p>只对<code>192.168.0.100</code>该台主机设置权限，即：使在该台主机登录的用户都可对NFS服务器上的共享目录<code>/home/test</code>拥有读与写的操作</p><p><code>/home/linux *.linux.org(rw,all_squash,anonuid=40,anongid=40)</code></p><p>当<code>*.linux.org</code>（加入域<code>linux.org</code>的所有主机） 登陆此NFS主机，并且在<code>/home/linux</code>下面写入档案时，该档案的所有人与所有组，就会变成NFS服务器上的<code>/etc/passwd</code>文件里面对应的<code>UID</code>为40的那个身份的使用者了（因为指定了参数：<code>all_squash，anonuid=40，anongid=40</code>）</p><hr><h3 id="项目实践2：自动挂接NFS"><a href="#项目实践2：自动挂接NFS" class="headerlink" title="项目实践2：自动挂接NFS"></a>项目实践2：自动挂接NFS</h3><p>要求分别通过下面三种方法实现自动挂接<br>    *    /etc/fstab（容易出问题）<br>    * /etc/bashrc<br>    * autofs服务</p><h4 id="etc-fstab"><a href="#etc-fstab" class="headerlink" title="/etc/fstab"></a>/etc/fstab</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/fstab</span><br><span class="line">172.25.0.10:/tmp        /mnt                    nfs     defaults        0 0</span><br><span class="line">[root@rhel6 ~]# mount -a</span><br><span class="line">[root@rhel6 ~]# mount |tail -n 1</span><br><span class="line">172.25.0.10:/tmp on /mnt type nfs (rw,vers=4,addr=172.25.0.10,clientaddr=172.25.0.11)</span><br></pre></td></tr></table></figure><p>如果nfs服务器出现问题，导致客户端无法挂接，此时就会出现开机启动失败的情况。因此不建议这么做。</p><h4 id="etc-bashrc"><a href="#etc-bashrc" class="headerlink" title="/etc/bashrc"></a>/etc/bashrc</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# vim /etc/bashrc</span><br><span class="line">[root@rhel6 ~]# grep mount /etc/bashrc</span><br><span class="line">mount 172.25.0.10:/tmp /mnt</span><br><span class="line">[root@rhel6 ~]# reboot</span><br><span class="line"></span><br><span class="line">Broadcast message from root@rhel6</span><br><span class="line">(/dev/pts/0) at 16:53 ...</span><br><span class="line"></span><br><span class="line">The system is going down for reboot NOW!</span><br><span class="line">[root@rhel6 ~]# Connection to 172.25.0.11 closed by remote host.</span><br><span class="line">Connection to 172.25.0.11 closed.</span><br><span class="line">[root@foundation0 ~]# ssh root@172.25.0.11</span><br><span class="line">Last login: Sun Sep 25 16:52:03 2016 from 172.25.0.250</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mount.nfs: Connection timed out</span><br></pre></td></tr></table></figure><p>如果将挂接的命令放在开机启动后的终端启动脚本中，那么只会有一个报错而已。</p><h4 id="autofs-自动挂接服务"><a href="#autofs-自动挂接服务" class="headerlink" title="autofs 自动挂接服务"></a>autofs 自动挂接服务</h4><p>使用的时候挂接，不使用等待5分钟后卸载，而等待的时间时可以调整的，在<code>/etc/sysconfig/autofs</code>配置文件中通过<code>TIMEOUT</code>参数调整，例如<code>TIMEOUT=300</code>。</p><ol><li><p>软件        autofs</p></li><li><p>service        autofs</p></li><li><p>daemon        automount        </p></li><li><p>配置文件</p><ul><li>/etc/auto.master    父挂接点</li><li>/etc/auto.booboo    子挂接点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.25.0.10:&#x2F;tmp &#x2F;mnt&#x2F;share</span><br><span class="line">&#x2F;mnt父挂接点</span><br><span class="line">share子挂接点</span><br></pre></td></tr></table></figure></li></ul></li><li><p>配置文件格式</p></li></ol><p>可以通过<code>man 5 autofs</code>查看配置文件的格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;auto.master</span><br><span class="line">&#x2F;mnt&#x2F;etc&#x2F;auto.booboo</span><br><span class="line"></span><br><span class="line">&#x2F;etc&#x2F;auto.booboo</span><br><span class="line">share-rw172.25.0.10:&#x2F;tmp</span><br></pre></td></tr></table></figure><p><strong>自动挂接autofs场景</strong></p><p>rhel7 作为nfs网络共享文件系统服务；rhel6作为nfs的客户端现在想自动挂接rhel7的/tmp目录使用，可以通过autofs。</p><table><thead><tr><th align="left">主机名</th><th align="left">ip地址</th><th align="left">软件</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">rhel6</td><td align="left">172.25.0.11</td><td align="left">rpcbind nfs-utils</td><td align="left">nfs客户端；autofs服务端</td></tr><tr><td align="left">rhel7</td><td align="left">172.25.0.10</td><td align="left">rpcbind nfs-utils</td><td align="left">nfs服务端</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# yum install -y autofs</span><br><span class="line">Loaded plugins: product-id, refresh-packagekit, security, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">Setting up Install Process</span><br><span class="line">Package 1:autofs-5.0.5-88.el6.x86_64 already installed and latest version</span><br><span class="line">Nothing to do</span><br><span class="line">[root@rhel6 ~]# rpm -ql autofs</span><br><span class="line">/etc/auto.master</span><br><span class="line">/etc/auto.misc</span><br><span class="line">/etc/auto.net</span><br><span class="line">/etc/auto.smb</span><br><span class="line">/etc/autofs_ldap_auth.conf</span><br><span class="line">/etc/rc.d/init.d/autofs</span><br><span class="line">/etc/sysconfig/autofs</span><br><span class="line">/misc</span><br><span class="line">/net</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# vim /etc/auto.master</span><br><span class="line">/mnt    /etc/auto.booboo</span><br><span class="line">[root@rhel6 ~]# vim /etc/auto.booboo</span><br><span class="line">share   -rw     172.25.0.10:/tmp</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# mkdir /mnt/share</span><br><span class="line">[root@rhel6 ~]# service autofs start</span><br><span class="line">Starting automount:                                        [  OK  ]</span><br><span class="line">[root@rhel6 ~]# ll /mnt/share</span><br><span class="line">total 0</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:59 systemd-private-hPL7GQ</span><br><span class="line">drwx------. 3 root root 16 Sep 25 14:58 systemd-private-jFcaMN</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="pic/06.png" alt="06"></p><p><img src="pic/07.png" alt="07"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;NFS是什么&quot;&gt;&lt;a href=&quot;#NFS是什么&quot; class=&quot;headerlink&quot; title=&quot;NFS是什么&quot;&gt;&lt;/a&gt;NFS是什么&lt;/h3&gt;&lt;p&gt;NFS（Network File System）即网络文件系统，SUN公司开发的,是FreeBSD支持的文件
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>DNS域名解析服务</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/01_dns/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/01_dns/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.694Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>课程要求</p></blockquote><ol><li>在企业内部搭建一台域名解析服务器DNS正反解析</li><li>在企业内部搭建两台域名解析服务器做DNS主辅同步</li></ol><h3 id="DNS服务"><a href="#DNS服务" class="headerlink" title="DNS服务"></a>DNS服务</h3><p>全称是domain name server域名解析服务。</p><p>我们知道每个联网的计算机都有一个ip地址吧？Ip地址是用来做什么的呢？Ip地址是用来和互联网上别的机器进行通讯的。但是ip地址很难记吧？一两个ip地址可能还好，但是，我们每天要访问的网页不仅仅只有一两个吧？</p><p>我们记得都是什么呢？<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>. <a href="http://www.sina.com。我们记住的其实都是字符，都是域名。就像我们的电话号码，很难记，于是我们把电话号码存到手机里，给他起个昵称或者直接输入人名对吧，把电话号码对应成人名吧？然后打电话的时候就直接找到这个人名就好了。">www.sina.com。我们记住的其实都是字符，都是域名。就像我们的电话号码，很难记，于是我们把电话号码存到手机里，给他起个昵称或者直接输入人名对吧，把电话号码对应成人名吧？然后打电话的时候就直接找到这个人名就好了。</a></p><p>所以我们系统也是一样，会把ip地址对应成一个主机名。在我们系统里有这么一个文件，就是专门用来做对应关系的，这个文件叫<code>/etc/hosts/</code>，我们可以打开来看一下，一条记录一行，行里面就是主机名和ip地址，当然一个ip地址可以对应多个主机名，就像人有很多的昵称一样。</p><p>那么这样是不是就解决问题了，当我们想要访问一个网站的时候，我们就不用输入ip地址，而是可以直接输入主机名就行了，机器会帮我们做一个解析，把主机名对应成ip地址进行通信。早期这样做的确没问题，但是随着互联网愈发的壮大，这个文件就不那么实用了。我们要在机器上配置大量的对应关系，是非常耗时，非常麻烦的，而且要配置的机器可不止一台。比如说我是百度，我希望世界上所有的人都要来访问我的网页，那么，我是不是需要让世界上所有的人都去添加我的ip地址和主机名的对应关系。这个是非常难做到的事情，工作量太大。于是我们就引入了一种新的机制。</p><h3 id="DNS的实现原理"><a href="#DNS的实现原理" class="headerlink" title="DNS的实现原理"></a>DNS的实现原理</h3><p>这种机制的作用和hosts文件一样，但是实现方法却不一样，这个机制就叫DNS (Domain name server)。通过dns，我们可以解决这个大批量域名解析的问题。那具体是怎么实现的呢？这就是dns的结构方面的问题了。</p><p>我们之前说我们的系统是一个什么样的结构，是不是一个分层式的结构，这个结构的体现方式就是目录吧？对不对。Dns也是如此，它也采用了分层市管理的方式。</p><p>不过不同于目录，我们的目录是一个逻辑上的概念，用来帮助我们理解文件系统的一种方式。而dns，他是实实在在的一种管理结构。</p><p>那我们来看，目录的至高点是什么。是根吧，对不对，那么对于我们dns来说，既然是分层式管理结构，它也需要有一个至高点吧。这个至高点是什么呢？</p><p>我们把它称作根域，以点代表根域。全世界总共有13台根域，是处于至高无上的位置的，只有13台机器。</p><p>那么根域下面就是顶级域了，通常我们看到的顶级域有这个com。有org，有cn还有edu等等，这些都是顶级域。顶级域下面管理二级域，以此类推。</p><p>FQDN：主机名加上域名，被称作完全合格的域名，fqdn。其实com后面应该有个点的，代表根域。只不过我们现在习惯性的将其省略了。就好像国家管理省，省管理市，市管理县等等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">完整的域名www.baidu.com.</span><br><span class="line">.根域全球一共13个根域</span><br><span class="line">.com超级域，一级域</span><br><span class="line">.baidu二级域</span><br><span class="line">www主机名</span><br></pre></td></tr></table></figure><blockquote><blockquote><p>举例：寻找新浪的方式。</p></blockquote></blockquote><ol><li>先看本地<code>/etc/hosts</code>有没有记录。</li><li>找另外一个人问，–&gt;找DNS服务器去问。 在<code>/etc/resolv.conf</code>文件中指定了找谁去问。</li></ol><p>当然，这先后顺序也是由某个文件决定的。这个文件是<code>/etc/nsswitch.conf</code>.</p><p>Windows上面也有</p><p>网上邻居&gt;属性&gt;本地连接。</p><p><strong>DNS的两种查询方式</strong> 对于DNS服务器，他可能知道也可能不知道，</p><p>知道的情况有两种：</p><ol><li>本地有这个域，能够解析到</li><li>本地有缓存，其他人已经来问过sina是谁，那么DNS服务器可以将该结果直接返回给客户。</li></ol><p>不知道的话就会去找自己的上级域，然后通过等待上级域的反馈，将反馈信息返回给客户端。这种方式叫做递归查询。</p><p>那么还有一种情况就是，DNS去询问上级域，然后上级域将对应的同级DNS服务器反馈回来，由客户端去询问新的DNS服务器来找寻网””址对应的IP地址。这种叫做迭代查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">www.sina.com.</span><br><span class="line">1)找根域.</span><br><span class="line">2)找超级域.com</span><br><span class="line">3)找二级域.sina</span><br><span class="line">4)成功找到www</span><br></pre></td></tr></table></figure><h3 id="实战项目1-在企业内部搭建一台域名解析服务器DNS正反解析"><a href="#实战项目1-在企业内部搭建一台域名解析服务器DNS正反解析" class="headerlink" title="实战项目1:在企业内部搭建一台域名解析服务器DNS正反解析"></a>实战项目1:在企业内部搭建一台域名解析服务器DNS正反解析</h3><blockquote><p>1)在rhel6上配置dns域名解析服务，解析uplooking.com域名，要求如下：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        NS      @</span><br><span class="line">        A       172.25.0.11</span><br><span class="line">www     A       172.25.0.10</span><br><span class="line">        MX 5    mail</span><br><span class="line">mail    A       172.25.0.10</span><br><span class="line">ftp     A       172.25.0.10</span><br><span class="line">bbsCNAMEftp</span><br></pre></td></tr></table></figure><blockquote><p>2)配置反向解析172.25.0.10和172.25.0.11；</p></blockquote><blockquote><p>3)要求rhel6和rhel7这两台服务器的域名解析服务器为172.25.0.11这台服务器。</p></blockquote><h4 id="实验准备阶段"><a href="#实验准备阶段" class="headerlink" title="实验准备阶段"></a>实验准备阶段</h4><ol><li>画出网络拓扑图</li><li>规划不同服务器需要安装的软件(os–soft版本)</li><li>开始安装</li><li>配置服务</li><li>启动服务</li><li>测试排错</li></ol><blockquote><p>详细步骤概览</p></blockquote><table><thead><tr><th align="left">num</th><th align="left">step</th><th align="left">man</th></tr></thead><tbody><tr><td align="left">1)</td><td align="left">安装软件</td><td align="left">bind bind-chroot</td></tr><tr><td align="left">2)</td><td align="left">查看软件架构</td><td align="left">rpm -ql</td></tr><tr><td align="left"></td><td align="left">日志</td><td align="left">/var/log/named.log</td></tr><tr><td align="left"></td><td align="left">数据</td><td align="left">/var/named/</td></tr><tr><td align="left"></td><td align="left">配置</td><td align="left">/etc/named.conf</td></tr><tr><td align="left"></td><td align="left"></td><td align="left">/etc/named.rfc1912.zones</td></tr><tr><td align="left">3)</td><td align="left">修改配置文件</td><td align="left"></td></tr><tr><td align="left">4)</td><td align="left">启动服务</td><td align="left"></td></tr><tr><td align="left"></td><td align="left">service</td><td align="left">named</td></tr><tr><td align="left"></td><td align="left">daemon</td><td align="left">named</td></tr><tr><td align="left">4.1）</td><td align="left">排除错误</td><td align="left">看日志</td></tr><tr><td align="left">5)</td><td align="left">测试</td><td align="left">nslookup</td></tr><tr><td align="left">5.1）</td><td align="left">排错</td><td align="left">看日志</td></tr></tbody></table><blockquote><p>网络拓扑图</p></blockquote><p><img src="pic/12.png" alt="12"></p><blockquote><p>规划服务器软件</p></blockquote><p><img src="pic/11.png" alt="11"></p><blockquote><p>开始安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# yum install -y bind bind-chroot</span><br><span class="line">Loaded plugins: product-id, refresh-packagekit, security, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line">server                                                   | 3.9 kB     00:00     </span><br><span class="line">Setting up Install Process</span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Running transaction check</span></span><br><span class="line"><span class="meta">---&gt;</span><span class="bash"> Package bind.x86_64 32:9.8.2-0.17.rc1.el6_4.6 will be installed</span></span><br><span class="line"><span class="meta">---&gt;</span><span class="bash"> Package <span class="built_in">bind</span>-chroot.x86_64 32:9.8.2-0.17.rc1.el6_4.6 will be installed</span></span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> Finished Dependency Resolution</span></span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line"> Package          Arch        Version                         Repository   Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> bind             x86_64      32:9.8.2-0.17.rc1.el6_4.6       server      4.0 M</span><br><span class="line"> bind-chroot      x86_64      32:9.8.2-0.17.rc1.el6_4.6       server       71 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install       2 Package(s)</span><br><span class="line"></span><br><span class="line">Total download size: 4.0 M</span><br><span class="line">Installed size: 7.3 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/2): bind-9.8.2-0.17.rc1.el6_4.6.x86_64.rpm            | 4.0 MB     00:00     </span><br><span class="line">(2/2): bind-chroot-9.8.2-0.17.rc1.el6_4.6.x86_64.rpm     |  71 kB     00:00     </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                            23 MB/s | 4.0 MB     00:00     </span><br><span class="line">Running rpm_check_debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line">  Installing : 32:bind-9.8.2-0.17.rc1.el6_4.6.x86_64                        1/2</span><br><span class="line">  Installing : 32:bind-chroot-9.8.2-0.17.rc1.el6_4.6.x86_64                 2/2</span><br><span class="line">  Verifying  : 32:bind-9.8.2-0.17.rc1.el6_4.6.x86_64                        1/2</span><br><span class="line">  Verifying  : 32:bind-chroot-9.8.2-0.17.rc1.el6_4.6.x86_64                 2/2</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  bind.x86_64 32:9.8.2-0.17.rc1.el6_4.6                                         </span><br><span class="line">  bind-chroot.x86_64 32:9.8.2-0.17.rc1.el6_4.6                                  </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@rhel6 ~]# rpm -ql bind</span><br><span class="line">/etc/NetworkManager/dispatcher.d/13-named</span><br><span class="line">/etc/logrotate.d/named</span><br><span class="line">/etc/named</span><br><span class="line">/etc/named.conf</span><br><span class="line">/etc/named.iscdlv.key</span><br><span class="line">/etc/named.rfc1912.zones</span><br><span class="line">/etc/named.root.key</span><br><span class="line">/etc/portreserve/named</span><br><span class="line">/etc/rc.d/init.d/named</span><br><span class="line">/etc/rndc.conf</span><br><span class="line">/etc/rndc.key</span><br><span class="line">/etc/sysconfig/named</span><br><span class="line">/usr/lib64/bind</span><br><span class="line">/usr/sbin/arpaname</span><br><span class="line">/usr/sbin/ddns-confgen</span><br><span class="line">/usr/sbin/dnssec-dsfromkey</span><br><span class="line">/usr/sbin/dnssec-keyfromlabel</span><br><span class="line">/usr/sbin/dnssec-keygen</span><br><span class="line">/usr/sbin/dnssec-revoke</span><br><span class="line">/usr/sbin/dnssec-settime</span><br><span class="line">/usr/sbin/dnssec-signzone</span><br><span class="line">/usr/sbin/genrandom</span><br><span class="line">/usr/sbin/isc-hmac-fixup</span><br><span class="line">/usr/sbin/lwresd</span><br><span class="line">/usr/sbin/named</span><br><span class="line">/usr/sbin/named-checkconf</span><br><span class="line">/usr/sbin/named-checkzone</span><br><span class="line">/usr/sbin/named-compilezone</span><br><span class="line">/usr/sbin/named-journalprint</span><br><span class="line">/usr/sbin/nsec3hash</span><br><span class="line">/usr/sbin/rndc</span><br><span class="line">/usr/sbin/rndc-confgen</span><br><span class="line">/usr/share/doc/bind-9.8.2</span><br><span class="line">... ...</span><br><span class="line">/var/log/named.log</span><br><span class="line">/var/named</span><br><span class="line">/var/named/data</span><br><span class="line">/var/named/dynamic</span><br><span class="line">/var/named/named.ca</span><br><span class="line">/var/named/named.empty</span><br><span class="line">/var/named/named.localhost</span><br><span class="line">/var/named/named.loopback</span><br><span class="line">/var/named/slaves</span><br><span class="line">/var/run/named</span><br><span class="line">[root@rhel6 ~]# rpm -ql bind-chroot</span><br><span class="line">/var/named/chroot</span><br><span class="line">/var/named/chroot/dev</span><br><span class="line">/var/named/chroot/dev/null</span><br><span class="line">/var/named/chroot/dev/random</span><br><span class="line">/var/named/chroot/dev/zero</span><br></pre></td></tr></table></figure><blockquote><p>配置文件</p></blockquote><blockquote><blockquote><p>/etc/named.conf</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen-on port 53 &#123; any; &#125;;</span><br><span class="line">listen-on-v6 port 53 &#123; any; &#125;;</span><br><span class="line">directory "/var/named";</span><br><span class="line">dump-file "/var/named/data/cache_dump.db";</span><br><span class="line">       statistics-file "/var/named/data/named_stats.txt";</span><br><span class="line">       memstatistics-file "/var/named/data/named_mem_stats.txt";</span><br><span class="line">allow-query     &#123; any; &#125;;</span><br></pre></td></tr></table></figure><blockquote><blockquote><p>/etc/named.rfc1912.zones</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 正解析</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 域名--&gt;ip</span></span><br><span class="line">zone "uplooking.com" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.uplooking";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 反解析</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ip---&gt;域名</span></span><br><span class="line">zone "0.25.172.in-addr.arpa" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.arpa.uplooking";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><blockquote><p>/var/named/named.uplooking</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                       3H )    ; minimum</span><br><span class="line">主机名主要记录ip</span><br><span class="line">        NS      @</span><br><span class="line">        A       172.25.0.11</span><br><span class="line">www     A       172.25.0.10</span><br><span class="line">        MX 5    mail</span><br><span class="line">mail    A       172.25.0.10</span><br><span class="line">ftp     A       172.25.0.10</span><br><span class="line">bbsCNAMEftp</span><br></pre></td></tr></table></figure><p><strong>注意</strong> 文件的所属者和所属组以及文件的ugo权限</p><blockquote><blockquote><p>named.arpa.uplooking</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      uplooking.com.</span><br><span class="line">11      PTR     uplooking.com.</span><br><span class="line">10      PTR     www.uplooking.com.</span><br><span class="line">10      PTR     mail.uplooking.com.</span><br><span class="line">10      PTR     ftp.uplooking.com.</span><br><span class="line">10      PTR     bbs.uplooking.com.</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>    NS后面此时一定要将@换成域名uplooking.com.域名必须写完整的域名，带根域的</p><blockquote><p>服务的启动</p></blockquote><ul><li>rhel6    <code>service named start</code></li><li>rhel7    <code>systemctl start named</code></li></ul><blockquote><p>防火墙的关闭</p></blockquote><ul><li>rhel6    <code>service iptables stop</code></li><li>rhel7    <code>systemctl stop firewalld</code></li></ul><p><strong>如果服务启动不了</strong> 那么尝试执行以下语句<code>rndc-confgen -a -r /etc/named.conf</code></p><blockquote><p>测试</p></blockquote><ol><li><code>/etc/hosts</code>        系统管理员手动写</li><li><code>/etc/resolv.conf</code>—-》指定找哪个域名解析服务器<code>nameserver 172.25.0.11</code></li><li>通过<code>nslookup</code>命令</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@rhel6 named]# nslookup</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> www.uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">Name:www.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> mail.uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">Name:mail.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ftp.uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">Name:ftp.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">Name:uplooking.com</span><br><span class="line">Address: 172.25.0.11</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> bbs.uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">bbs.uplooking.comcanonical name = ftp.uplooking.com.</span><br><span class="line">Name:ftp.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.10</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">10.0.25.172.in-addr.arpaname = bbs.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = www.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = mail.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = ftp.uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.11</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">11.0.25.172.in-addr.arpaname = uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure><hr><h3 id="实战项目2-在企业内部搭建两台域名解析服务器做DNS主辅同步"><a href="#实战项目2-在企业内部搭建两台域名解析服务器做DNS主辅同步" class="headerlink" title="实战项目2:在企业内部搭建两台域名解析服务器做DNS主辅同步"></a>实战项目2:在企业内部搭建两台域名解析服务器做DNS主辅同步</h3><p>主辅同步：如果有数万台客户机在同一时间来访问DNS服务器，会导致服务器承受很大的压力，这时候我可能需要另外一个人来帮我分担压力，或者说如果主服务器遇到什么问题，我能有另外一个人直接顶上我的工作，这时候就可以用到一个辅助服务器了。</p><p>那么很显然，辅助服务器需要和主服务器用一样的配置，配置里写的数据也基本相同。对于我们DNS服务器来说，其实它的数据文件并不固定，对应的IP和主机名都可能会经常发生变化，那么当那个时候，我希望能够修改主机上的某一个文件的时候，从机上的文件也能够被自动被修改，保持两台机器完全同步一致。</p><p>这时候就有了一种配置方法，叫做主辅同步。</p><h4 id="实验准备阶段-1"><a href="#实验准备阶段-1" class="headerlink" title="实验准备阶段"></a>实验准备阶段</h4><ol><li>网络拓扑图</li><li>规划软件安装bind bind-chroot</li><li>修改配置文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#主服务器&#x2F;etc&#x2F;named.rfc1912.zones允许传输给从机</span><br><span class="line">&#x2F;var&#x2F;named&#x2F;named.uplooking序列号从0改成日期</span><br><span class="line">&#x2F;var&#x2F;named&#x2F;named.arpa.uplooking 序列号从0改成日期</span><br><span class="line">#从服务器&#x2F;etc&#x2F;named.confany</span><br><span class="line">&#x2F;etc&#x2F;named.rfc1912.zonesslave;masters;file</span><br></pre></td></tr></table></figure></li><li>启动从机服务</li><li>查看从机缓冲/var/named/slaves/</li><li>注意防火墙关闭</li><li>客户端测试服务        </li></ol><h4 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h4><blockquote><p>网络拓扑图</p></blockquote><p><img src="pic/14.png" alt="14"></p><blockquote><p>规划软件安装</p></blockquote><p><img src="pic/13.png" alt="13"></p><blockquote><p>主服务器：</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 named]# vim /etc/named.rfc1912.zones</span><br><span class="line">zone "uplooking.com" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.uplooking";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">        allow-transfer &#123; 172.25.0.10; &#125;;    ===&gt;允许从机172.25.0.10来读取</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "0.25.172.in-addr.arpa" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.arpa.uplooking";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">        allow-transfer &#123; 172.25.0.10; &#125;;===&gt;允许从机172.25.0.10来读取</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[root@rhel6 named]# pwd</span><br><span class="line">/var/named</span><br><span class="line">[root@rhel6 named]# ll</span><br><span class="line">total 40</span><br><span class="line">drwxr-x---. 6 root  named 4096 Aug  2 10:30 chroot</span><br><span class="line">drwxrwx---. 2 named named 4096 Aug  2 11:03 data</span><br><span class="line">drwxrwx---. 2 named named 4096 Aug  2 15:06 dynamic</span><br><span class="line">-rw-r-----. 1 root  named  271 Aug  2 13:59 named.arpa.uplooking</span><br><span class="line">-rw-r-----. 1 root  named 1892 Feb 18  2008 named.ca</span><br><span class="line">-rw-r-----. 1 root  named  152 Dec 15  2009 named.empty</span><br><span class="line">-rw-r-----. 1 root  named  152 Jun 21  2007 named.localhost</span><br><span class="line">-rw-r-----. 1 root  named  168 Dec 15  2009 named.loopback</span><br><span class="line">-rw-r-----. 1 root  named  224 Aug  2 11:34 named.uplooking</span><br><span class="line">drwxrwx---. 2 named named 4096 Aug 14  2013 slaves</span><br><span class="line">[root@rhel6 named]# vim named.uplooking</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        20160802        ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      @</span><br><span class="line">        A       172.25.0.11</span><br><span class="line">www     A       172.25.0.10</span><br><span class="line">        MX 5    mail</span><br><span class="line">mail    A       172.25.0.10</span><br><span class="line">ftp     A       172.25.0.10</span><br><span class="line">bbs     CNAME   ftp</span><br><span class="line">~                        </span><br><span class="line"></span><br><span class="line">[root@rhel6 named]# vim named.arpa.uplooking</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        20160802        ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      uplooking.com.</span><br><span class="line">11      PTR     uplooking.com.</span><br><span class="line">10      PTR     www.uplooking.com.</span><br><span class="line">10      PTR     mail.uplooking.com.</span><br><span class="line">10      PTR     ftp.uplooking.com.</span><br><span class="line">10      PTR     bbs.uplooking.com.</span><br><span class="line"></span><br><span class="line">[root@rhel6 named]# service named restart</span><br><span class="line">Stopping named: .                                          [  OK  ]</span><br><span class="line">Starting named:                                            [  OK  ]</span><br><span class="line">[root@rhel6 named]# service iptables stop</span><br><span class="line">iptables: Firewall is not running.</span><br><span class="line">[root@rhel6 named]# getenforce</span><br><span class="line">Enforcing</span><br></pre></td></tr></table></figure><blockquote><p>从服务器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# cat /etc/resolv.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by NetworkManager</span></span><br><span class="line">domain example.com</span><br><span class="line">search example.com</span><br><span class="line">nameserver 172.25.254.254</span><br><span class="line">[root@rhel7 ~]# yum install -y bind*</span><br><span class="line">[root@rhel7 ~]# vim /etc/named.conf</span><br><span class="line">[root@rhel7 ~]# vim /etc/named.rfc1912.zones</span><br><span class="line">zone "uplooking.com" IN &#123;</span><br><span class="line">        type slave;&lt;== 定义类型为奴隶 slave</span><br><span class="line">        masters &#123; 172.25.0.11; &#125;;&lt;== 告诉计算机我的主人 master 是谁</span><br><span class="line">        file "slaves/uploooking.com.zone";&lt;== 告诉计算机 zone 数据库地址在哪里,奴隶有专门的目录</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "0.25.172.in-addr.arpa" IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        masters &#123; 172.25.0.11; &#125;;</span><br><span class="line">        file "slaves/arpa.uplooking.zone";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>服务启动与关闭</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# systemctl stop firewalld</span><br><span class="line">[root@rhel7 ~]# getenforce</span><br><span class="line">Enforcing</span><br><span class="line">[root@rhel7 ~]# systemctl start named</span><br><span class="line">[root@rhel7 ~]# ll /var/named/slaves</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 381 Aug  2 03:54 arpa.uplooking.zone</span><br><span class="line">-rw-r--r--. 1 named named 463 Aug  2 03:54 uploooking.com.zone</span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><p>客户端 rhel7</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# vim /etc/resolv.conf</span><br><span class="line">nameserver 172.25.0.11</span><br><span class="line">[root@rhel7 ~]# nslookup</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> www.uplooking.com</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">Name:www.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.10</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">10.0.25.172.in-addr.arpaname = www.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = mail.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = ftp.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = bbs.uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.11</span></span><br><span class="line">Server:172.25.0.11</span><br><span class="line">Address:172.25.0.11#53</span><br><span class="line"></span><br><span class="line">11.0.25.172.in-addr.arpaname = uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# vim /etc/resolv.conf</span><br><span class="line">nameserver 172.25.0.10</span><br><span class="line">[root@rhel7 ~]# nslookup</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> www.uplooking.com</span></span><br><span class="line">Server:172.25.0.10</span><br><span class="line">Address:172.25.0.10#53</span><br><span class="line"></span><br><span class="line">Name:www.uplooking.com</span><br><span class="line">Address: 172.25.0.10</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.11</span></span><br><span class="line">Server:172.25.0.10</span><br><span class="line">Address:172.25.0.10#53</span><br><span class="line"></span><br><span class="line">11.0.25.172.in-addr.arpaname = uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 172.25.0.10</span></span><br><span class="line">Server:172.25.0.10</span><br><span class="line">Address:172.25.0.10#53</span><br><span class="line"></span><br><span class="line">10.0.25.172.in-addr.arpaname = bbs.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = www.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = ftp.uplooking.com.</span><br><span class="line">10.0.25.172.in-addr.arpaname = mail.uplooking.com.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure><h3 id="排错记录"><a href="#排错记录" class="headerlink" title="排错记录"></a>排错记录</h3><h4 id="服务启动不了"><a href="#服务启动不了" class="headerlink" title="服务启动不了"></a>服务启动不了</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# systemctl start named</span><br><span class="line">Job for named.service failed. See 'systemctl status named.service' and 'journalctl -xn' for details.</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# systemctl status named.service</span><br><span class="line">named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled)</span><br><span class="line">   Active: failed (Result: exit-code) since Tue 2016-08-02 04:19:20 EDT; 23s ago</span><br><span class="line">  Process: 2297 ExecStartPre=/usr/sbin/named-checkconf -z /etc/named.conf (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Aug 02 04:19:20 rhel7 systemd[1]: Starting Berkeley Internet Name Domain (DNS)...</span><br><span class="line">Aug 02 04:19:20 rhel7 named-checkconf[2297]: /etc/named.rfc1912.zones:51: missing ';' before '&#125;'</span><br><span class="line">Aug 02 04:19:20 rhel7 systemd[1]: named.service: control process exited, code=exited status=1</span><br><span class="line">Aug 02 04:19:20 rhel7 systemd[1]: Failed to start Berkeley Internet Name Domain (DNS).</span><br><span class="line">Aug 02 04:19:20 rhel7 systemd[1]: Unit named.service entered failed state.</span><br></pre></td></tr></table></figure><p>ps：当服务启动不了的时候，报错内容中说我们可以通过以下两个命令来查看，<code>systemctl status named.service</code> 或者 <code>journalctl -xn</code>此时我们可以去执行以下上面命令中的任何一个，都可以看到详细的报错信息。</p><p><code>Aug 02 04:19:20 rhel7 named-checkconf[2297]: /etc/named.rfc1912.zones:51: missing &#39;;&#39; before &#39;}&#39;</code></p><p>这条日志告诉我们，在配置文件<code>/etc/named.rfc1912.zones</code>的第51行中，<code>&#39;}&#39;</code>前少了一个<code>&#39;;&#39;</code>。因此我们根据日志中的提示去修改配置文件即可。</p><h4 id="服务启动不了-1"><a href="#服务启动不了-1" class="headerlink" title="服务启动不了"></a>服务启动不了</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# systemctl status named</span><br><span class="line">named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled)</span><br><span class="line">   Active: failed (Result: exit-code) since Tue 2016-08-02 04:50:39 EDT; 1min 42s ago</span><br><span class="line">  Process: 6541 ExecStartPre=/usr/sbin/named-checkconf -z /etc/named.conf (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0...al 0</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone 1.0.0.127.in-addr.arpa/IN: loaded serial 0</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone 0.in-addr.arpa/IN: loaded serial 0</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone uplooking.com/IN: loaded serial 20160802</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone 19.25.172.in-addr.arpa/IN: loading from master file nam...ound</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: zone 19.25.172.in-addr.arpa/IN: not loaded due to errors.</span><br><span class="line">Aug 02 04:50:39 rhel7 named-checkconf[6541]: _default/19.25.172.in-addr.arpa/IN: file not found</span><br><span class="line">Aug 02 04:50:39 rhel7 systemd[1]: named.service: control process exited, code=exited status=1</span><br><span class="line">Aug 02 04:50:39 rhel7 systemd[1]: Failed to start Berkeley Internet Name Domain (DNS).</span><br><span class="line">Aug 02 04:50:39 rhel7 systemd[1]: Unit named.service entered failed state.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# tail -n 15 /etc/named.rfc1912.zones</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  "uplooking.com" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.uplooking";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">allow-transfer &#123; 172.25.19.10;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "19.25.172.in-addr.arpa" IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "named.uplooking.arpa";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">allow-transfer &#123; 172.25.19.10; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# ll /var/named/named*</span><br><span class="line">-rw-r-----. 1 root named  330 Aug  2 04:50 /var/named/named.arpa.uplooking</span><br><span class="line">-rw-r-----. 1 root named 2076 Jan 28  2013 /var/named/named.ca</span><br><span class="line">-rw-r-----. 1 root named  152 Dec 15  2009 /var/named/named.empty</span><br><span class="line">-rw-r-----. 1 root named  152 Jun 21  2007 /var/named/named.localhost</span><br><span class="line">-rw-r-----. 1 root named  168 Dec 15  2009 /var/named/named.loopback</span><br><span class="line">-rw-r-----. 1 root named  295 Aug  2 04:50 /var/named/named.uplooking</span><br></pre></td></tr></table></figure><p>ps:问题出在数据文件名和配置文件中指定的数据文件名不一致。</p><p><code>file &quot;named.uplooking.arpa&quot;;</code></p><p><code>/var/named/named.arpa.uplooking</code></p><h4 id="主辅同步缓冲文件只有一个"><a href="#主辅同步缓冲文件只有一个" class="headerlink" title="主辅同步缓冲文件只有一个"></a>主辅同步缓冲文件只有一个</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# ll /var/named/slaves/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 named named 386 Jan  1 02:46 uplooking123.zoo</span><br></pre></td></tr></table></figure><p>ps:原因是<code>/etc/named.rfc1912.zones</code>中的配置有问题，指定缓冲的目录写少了一个<code>s</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zone \"uplooking.com\" IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        masters &#123; 172.25.33.11; &#125;;</span><br><span class="line">        file \"slave/uplooking.zone\";</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">      &#125;;</span><br></pre></td></tr></table></figure><h4 id="主辅同步将从机的数据文件指定位置放在非slaves目录"><a href="#主辅同步将从机的数据文件指定位置放在非slaves目录" class="headerlink" title="主辅同步将从机的数据文件指定位置放在非slaves目录"></a>主辅同步将从机的数据文件指定位置放在非slaves目录</h4><p>从服务器的配置文件放置的位置不在slaves目录下，而在其他目录下，则同步不成功。<br>原因从三处排查</p><ul><li>配置文件</li><li>UGO权限</li><li>selinux权限</li></ul><p>此处是由于selinux的问题，我们安装一个工具<code>setroubleshoot</code>帮助我们分析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Yum search setroubleshoot</span><br><span class="line">Yum -y install setroubleshoot</span><br><span class="line">Sealert -a audit.log</span><br></pre></td></tr></table></figure><p>看到关于布尔值的信息和关于安全上下文的信息:</p><ul><li>1）设置布尔值setsebool -P named_write_master_zones 1</li><li>2）设置安全上下文，通过man named_selinux或者看一下slaves目录的安全上下文是什么<br>根据slaves的安全上下文去改。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Chcon -t named_zone_t test</span><br><span class="line">Chcon -u system_u  -r object_r  test</span><br></pre></td></tr></table></figure>然后将selinux打开，将test下的目录的同步过来的文件给删除，重启服务，看是否被同步过来。</li></ul><p>同步成功。</p><h4 id="如果启动服务时候太慢"><a href="#如果启动服务时候太慢" class="headerlink" title="如果启动服务时候太慢"></a>如果启动服务时候太慢</h4><p>可以使用<code>/usr/sbin/rndc-confgen -a -r /etc/named.conf</code></p><p>这是一个秘钥加密产生的bug</p><h4 id="有顺序的批量配置的写法：（简单了解一下）"><a href="#有顺序的批量配置的写法：（简单了解一下）" class="headerlink" title="有顺序的批量配置的写法：（简单了解一下）"></a>有顺序的批量配置的写法：（简单了解一下）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">GENERATE 1-100 stu$   A   172.25.0.$</span></span><br><span class="line"><span class="meta">$</span><span class="bash">GENERATE 1-200 $ PTR foundation$.ilt.example.com</span></span><br></pre></td></tr></table></figure><h4 id="从机数据文件的查看"><a href="#从机数据文件的查看" class="headerlink" title="从机数据文件的查看"></a>从机数据文件的查看</h4><p><strong>7版本上无法查看</strong>：因为从机在slaves目录下生成的配置文件是data类型的。<br><strong>6版本上可以查看</strong>：老版本是可以查看的。</p><hr><h3 id="配置文件详细解析"><a href="#配置文件详细解析" class="headerlink" title="配置文件详细解析"></a>配置文件详细解析</h3><h4 id="主配置文件-etc-named-conf"><a href="#主配置文件-etc-named-conf" class="headerlink" title="主配置文件/etc/named.conf"></a>主配置文件/etc/named.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Options 全局的配置行   </span><br><span class="line">options &#123; //服务器的全局配置选项及一些默认设置</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; //监听端口默认监听53号端口，也可写为 &#123; 127.0.0.1; 192.168.139.46; &#125;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;; //对ip6支持</span><br><span class="line">        directory       "/var/named";  //区域文件存储目录</span><br><span class="line">        dump-file       "/var/named/data/cache_dump.db"; //缓存的目录directory</span><br><span class="line">        statistics-file "/var/named/data/named_stats.txt";  // 状态信息文件</span><br><span class="line">        memstatistics-file "/var/named/data/named_mem_stats.txt";   //内存信息文件</span><br><span class="line">        pid-file        "/var/run/named/named.pid"; //存着named的pid</span><br><span class="line">        forwarders     &#123; 168.95.1.1; 139.175.10.20; &#125;; // 如果域名服务器无法解析时，将请求交由168.95.1.1; 139.175.10.20来解析</span><br><span class="line">        allow-query    &#123; any; &#125;;   //指定允许进行查询的主机，当然是要所有的电脑都可以查啦</span><br><span class="line">        allow-transfer &#123; none; &#125;; //指定允许接受区域传送请求的主机，说明白一点就是辅dns定义，比如辅dns的ip是192.168.139.5，那么可以这样定义&#123; 192.168.139.5; &#125;，要不然主辅dns不能同步，当然，&#123;&#125;里的也可以用下面提到的acl。</span><br><span class="line">        // those options should be used carefully because they disable port</span><br><span class="line">        // randomization</span><br><span class="line">        // query-source    port 53;     </span><br><span class="line">        // query-source-v6 port 53;</span><br><span class="line">Dnssec开头的是一些加密文件</span><br><span class="line">Xxxx.key是一些秘钥文件</span><br><span class="line">&#125;;</span><br><span class="line">logging &#123; //指定服务器日志记录的内容和日志信息来源</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "data/named.run";</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone "." IN &#123; //在这个文件中是用zone关键字来定义域区的，一个zone关键字定义一个域区 </span><br><span class="line">type hint; </span><br><span class="line">/*在这里type类型有三种，它们分别是master,slave和hint它们的含义分别是： </span><br><span class="line">master:表示定义的是主域名服务器 </span><br><span class="line">slave :表示定义的是辅助域名服务器 </span><br><span class="line">hint:表示是互联网中根域名服务器 </span><br><span class="line">*/ </span><br><span class="line">Include  "/etc/named.rfc1912.conf"</span><br><span class="line">Include  "/etc/named.root.key"  //两个include字段代表读取本配置文件时候同时读取/etc/named.rfc1912.conf和/etc/named.root.key文件，这里主要关注第一个文件，该文件是专门用于定义域的文件。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>allow-query-cache</code>主辅同步时:</strong></p><ul><li>6版本上必须加上 不然会报错</li><li>7版本不用</li></ul><p><strong><code>recursion</code>主辅同步时</strong> 必须是yes，关掉之后会阻止新纪录进入到缓冲。</p><h4 id="named-rfc1912-conf"><a href="#named-rfc1912-conf" class="headerlink" title="named.rfc1912.conf"></a>named.rfc1912.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Zone "域名 "IN &#123;</span><br><span class="line">File ;域对应的数据文件</span><br><span class="line">Allow-update ;是否需要更新</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><ol><li>所有语句结束后都需要一个分号代表结束符</li><li>括号必须成对出现</li><li>file指向的数据文件写的是相对路径，相对于主配置文件的dirctory配置字段，即相对于/var/named目录。</li></ol><p><strong>主辅同步中slave需要的配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Zone "域名" IN &#123;</span><br><span class="line">Type slave;</span><br><span class="line">Masters &#123; 172.25.0.11;&#125; ;</span><br><span class="line">File "slaves/test.com.zone";</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="数据文件-var-named-named-localhost"><a href="#数据文件-var-named-named-localhost" class="headerlink" title="数据文件/var/named/named.localhost"></a>数据文件/var/named/named.localhost</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">TTL //代表周期，缓存时间，DNS会自己做缓存，1D就代表一天，缓存时间为一天。</span><br><span class="line">SOA //记录  --&gt;起始授权记录  @代表继承域名  </span><br><span class="line">IN  SOA @ 用户名.域名  &#123;</span><br><span class="line">     0;serial    //序列号；一般写修改当天日期，从服务器根据该序列号来判定文件是否修改过。</span><br><span class="line">     1D；refresh  // 多久做一次同步</span><br><span class="line">     1H；retry    //重置时间，同步不成功时，间隔多久重新做一次同步</span><br><span class="line">     1W；expire   //当重复同步不成功时，多久不再做同步。</span><br><span class="line"> 3H；minimun  //最小缓存时间，一般是错误缓存。假设有一个人，一直问我一个错误的域名，那我就会将该错误的域名缓存下来，</span><br><span class="line">当人再来问我时，我就不再搜寻，而将该结果反馈给他。</span><br><span class="line"></span><br><span class="line">这里将serial一列改为当前日期。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NS代表的是正向记录  ，解析还分成正向解析和反向解析，正向解析就是知道主机名，想要搜寻IP地址。这里先来看正向解析</span><br><span class="line"></span><br><span class="line">@代表继承域名</span><br><span class="line">   NS    @</span><br><span class="line">   A    127.0.0.1    </span><br><span class="line">这句话代表，我的域名是localhost，localhost指向的是127.0.0.1</span><br><span class="line">如果不写@而写成域名，就应该写成test.com.   Com后面必须有个点，代表根域的意思。</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>掌握实践项目<br><img src="pic/02.png" alt="02"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;课程要求&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;在企业内部搭建一台域名解析服务器DNS正反解析&lt;/li&gt;
&lt;li&gt;在企业内部搭建两台域名解析服务器做DNS主辅同步&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;DNS服务&quot;&gt;&lt;a href=
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>SAMBA文件共享服务</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/04_samba/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/04_samba/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.702Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Samba的历史及原理"><a href="#Samba的历史及原理" class="headerlink" title="Samba的历史及原理"></a>Samba的历史及原理</h3><p>在早期的网络世界中，文件数据在不同主机之间的传输大多是使用FTP这个好用的服务器软件进行的。不过，使用FTP传输文件却有个小小的问题，那就是您无法直接修改主机上面的文件数据。也就是说，您想要更改Linux主机上面的某个文件时，必须要由服务器端将该文件下载到您工作的客户端后才能修改，因此该文件在服务器端和客户端都会存在。这时，如果有一天您修改了某个文件，却忘记将数据上传回主机，那么等过了一阵子之后，您如何知道哪既然有这样的问题，那好吧，我可不可以在客户端的机器上面直接取用服务器上面的文件？如果可以在客户端直接进行服务器端文件的访问，那么我在客户端就不需要存在该文件数据了，也就是说，我只要有服务器上面的文件数据存在就可以了。有没有这样的文件系统（File System）呢？前面我们提到过的Network File System（NFS）就是这样的文件系统之一。只要在客户端将服务器端所提供的共享目录挂载进来，那么在我的客户端就可以直接取用服务器上的文件数据，而且，该数据就像是客户端上的分区一样，非常好用！而除了可以让Unix Like的机器互相分享文件的NFS服务器之外，在微软（Microsoft）上面也有类似的文件系统，那就是Common Internet File System（CIFS）。CIFS最简单的用途就是目前常见的“网上邻居”。Windows系统的计算机可以通过桌面上的“网上邻居”来访问别人所提供的文件数据。不过，NFS仅能让Unix机器沟通，CIFS只能让Windows机器沟通。那么有没有让Windows与Unix Like这两个不同的平台相互分享文件数据的文件系统呢？个文件才是最新的？</p><p>在1991年，一个名叫Andrew Tridgwell的大学生就有这样的困扰，他手上有三台机器，分别是运行DOS的个人计算机、DEC公司的Digital Unix系统以及Sun的Unix系统。在当时，DEC 公司开发出一套称为PATHWORKS的软件，这套软件可以用来分享DEC的Unix与个人计算机的DOS这两个操作系统的文件数据，可惜让Tridgwell觉得较困扰的是Sun的Unix无法通过这个软件来达到文件共享的目的。这个时候Tridgwell就想：“咦！既然这两台系统可以共享，没道理Sun就必须这么苦命吧？可不可以将这两个系统的工作原理找出来，然后让Sun机器也能够共享文件数据呢？”，为了解决这样的的问题，Tridgwell就自行编写了一个程序去检测当DOS与DEC的Unix系统在进行文件分享传输时所使用到的通信协议信息，然后获取这些重要的信息，并且基于上述所找到的通信协议而开发出Server Message Block（SMB）这个文件系统，而就是这套SMB软件就能够让Unix与DOS互相共享文件。</p><p>既然写成了软件，总需要注册商标，因此Tridgwell就申请SMB Server作为该软件的商标。可惜因为SMB是没有意义的文字，没有办法达成注册。既然如此，能不能在字典里面找到相关的字词可以作为商标来注册呢？翻了老半天，发现SAMBA刚好含有SMB，又是热情有劲的拉丁舞蹈的名称，不然就用这个名字来作为商标好了。这成为我们今天所使用的SAMBA的名称的由来。</p><h3 id="Samba的作用"><a href="#Samba的作用" class="headerlink" title="Samba的作用"></a>Samba的作用</h3><p>作用：windows和类unix系统文件共享服务</p><h3 id="Samba的软件结构"><a href="#Samba的软件结构" class="headerlink" title="Samba的软件结构"></a>Samba的软件结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端linux</span></span><br><span class="line"></span><br><span class="line">软件samba samba-common</span><br><span class="line">servicenmbsmb</span><br><span class="line">daemonnmbdsmbd</span><br><span class="line">端口137 138|139 445</span><br><span class="line">配置文件/etc/samba/smb.conf</span><br><span class="line">数据文件/var/lib/samba</span><br><span class="line">日志文件/var/log/samba</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端linux</span></span><br><span class="line">软件samba-client</span><br><span class="line">命令smbclient</span><br><span class="line">smbclient -L ip -U username</span><br><span class="line">smbpasswd -a username</span><br><span class="line">smbpasswd username</span><br><span class="line">smbclient //172.25.0.11/共享名</span><br><span class="line">smbclient //172.25.0.11/共享名 -U student</span><br><span class="line">mount -t cifs //172.25.15.11/共享名 /mnt -o guest</span><br><span class="line">mount -t cifs //172.25.15.11/共享名 /mnt -o username=student</span><br></pre></td></tr></table></figure><h3 id="项目实践1：配置samba共享"><a href="#项目实践1：配置samba共享" class="headerlink" title="项目实践1：配置samba共享"></a>项目实践1：配置samba共享</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">系统用户</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">服务器端rhel6</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">[root@rhel6 ~]# yum install -y samba samba-common</span><br><span class="line">[root@rhel6 ~]# service iptables stop</span><br><span class="line">iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span><br><span class="line">iptables: Flushing firewall rules:                         [  OK  ]</span><br><span class="line">iptables: Unloading modules:                               [  OK  ]</span><br><span class="line">[root@rhel6 ~]#</span><br><span class="line">[root@rhel6 ~]# service smb start</span><br><span class="line">Starting SMB services:                                     [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service nmb start</span><br><span class="line">Starting NMB services:                                     [  OK  ]</span><br><span class="line">[root@rhel6 ~]# id student</span><br><span class="line">uid=500(student) gid=500(student) groups=500(student)</span><br><span class="line">[root@rhel6 ~]# which smbpasswd</span><br><span class="line">/usr/bin/smbpasswd</span><br><span class="line">[root@rhel6 ~]# smbpasswd -a student</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user student.</span><br><span class="line">[root@rhel6 ~]# getsebool -a|grep samba</span><br><span class="line">samba_create_home_dirs --&gt; off</span><br><span class="line">samba_domain_controller --&gt; off</span><br><span class="line">samba_enable_home_dirs --&gt; off</span><br><span class="line">samba_export_all_ro --&gt; off</span><br><span class="line">samba_export_all_rw --&gt; off</span><br><span class="line">samba_portmapper --&gt; off</span><br><span class="line">samba_run_unconfined --&gt; off</span><br><span class="line">samba_share_fusefs --&gt; off</span><br><span class="line">samba_share_nfs --&gt; off</span><br><span class="line">sanlock_use_samba --&gt; off</span><br><span class="line">use_samba_home_dirs --&gt; off</span><br><span class="line">virt_use_samba --&gt; off</span><br><span class="line">[root@rhel6 ~]# setsebool -P samba_enable_home_dirs 1</span><br><span class="line">[root@rhel6 ~]# getsebool -a|grep samba</span><br><span class="line">samba_create_home_dirs --&gt; off</span><br><span class="line">samba_domain_controller --&gt; off</span><br><span class="line">samba_enable_home_dirs --&gt; on</span><br><span class="line">samba_export_all_ro --&gt; off</span><br><span class="line">samba_export_all_rw --&gt; off</span><br><span class="line">samba_portmapper --&gt; off</span><br><span class="line">samba_run_unconfined --&gt; off</span><br><span class="line">samba_share_fusefs --&gt; off</span><br><span class="line">samba_share_nfs --&gt; off</span><br><span class="line">sanlock_use_samba --&gt; off</span><br><span class="line">use_samba_home_dirs --&gt; off</span><br><span class="line">virt_use_samba --&gt; off</span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端linux——类似ftp的方式访问</span></span><br><span class="line">[root@rhel7 ~]# systemctl stop firewalld</span><br><span class="line">[root@rhel7 ~]# yum install -y samba-client</span><br><span class="line">[root@rhel7 ~]# smbclient -L 172.25.0.11</span><br><span class="line">Enter root\'s password:</span><br><span class="line">Anonymous login successful</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Sharename       Type      Comment</span><br><span class="line">---------       ----      -------</span><br><span class="line"><span class="meta">IPC$</span><span class="bash">            IPC       IPC Service (Samba Server Version 3.6.9-164.el6)</span></span><br><span class="line">Anonymous login successful</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Server               Comment</span><br><span class="line">---------            -------</span><br><span class="line">RHEL6                Samba Server Version 3.6.9-164.el6</span><br><span class="line"></span><br><span class="line">Workgroup            Master</span><br><span class="line">---------            -------</span><br><span class="line">MYGROUP              RHEL6</span><br><span class="line">[root@rhel7 ~]# smbclient -L 172.25.0.11 -U student</span><br><span class="line">Enter student\'s password:</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Sharename       Type      Comment</span><br><span class="line">---------       ----      -------</span><br><span class="line"><span class="meta">IPC$</span><span class="bash">            IPC       IPC Service (Samba Server Version 3.6.9-164.el6)</span></span><br><span class="line">student         Disk      Home Directories</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Server               Comment</span><br><span class="line">---------            -------</span><br><span class="line">RHEL6                Samba Server Version 3.6.9-164.el6</span><br><span class="line"></span><br><span class="line">Workgroup            Master</span><br><span class="line">---------            -------</span><br><span class="line">MYGROUP              RHEL6</span><br><span class="line">[root@rhel7 ~]# smbclient //172.25.0.11/student -U student</span><br><span class="line">Enter student\'s password:</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line">smb: \&gt;</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">NT_STATUS_ACCESS_DENIED listing \*</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Thu Jul  2 04:01:16 2015</span><br><span class="line">  ..                                  D        0  Thu Jul  2 03:57:29 2015</span><br><span class="line">  .ssh                               DH        0  Thu Jul  2 04:01:07 2015</span><br><span class="line">  .bashrc                             H      124  Tue Jul  9 09:24:50 2013</span><br><span class="line">  .bash_logout                        H       18  Tue Jul  9 09:24:50 2013</span><br><span class="line">  .mozilla                           DH        0  Thu Jul  2 03:36:20 2015</span><br><span class="line">  .bash_history                       H        5  Thu Jul  2 04:01:16 2015</span><br><span class="line">  .gnome2                            DH        0  Wed Jul 14 11:55:40 2010</span><br><span class="line">  .bash_profile                       H      176  Tue Jul  9 09:24:50 2013</span><br><span class="line"></span><br><span class="line">49584 blocks of size 8192. 45708 blocks available</span><br><span class="line">smb: \&gt; exit</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端windows</span></span><br><span class="line">打开浏览器输入\\172.25.0.11\</span><br><span class="line">输入student和uplooking密码后就可以进入服务器中的用户家目录，创建目录aa，以及文件aa下的dd.txt</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端linux</span></span><br><span class="line">[root@rhel7 ~]# smbclient //172.25.0.11/student -U student</span><br><span class="line">Enter student\'s password:</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Thu Aug  4 04:30:31 2016</span><br><span class="line">  ..                                  D        0  Thu Jul  2 03:57:30 2015</span><br><span class="line">  .ssh                               DH        0  Thu Jul  2 04:01:07 2015</span><br><span class="line">  aa                                  D        0  Thu Aug  4 04:30:28 2016</span><br><span class="line">  .bashrc                             H      124  Tue Jul  9 09:24:50 2013</span><br><span class="line">  .bash_logout                        H       18  Tue Jul  9 09:24:50 2013</span><br><span class="line">  .mozilla                           DH        0  Thu Jul  2 03:36:20 2015</span><br><span class="line">  .bash_history                       H        5  Thu Jul  2 04:01:16 2015</span><br><span class="line">  .gnome2                            DH        0  Wed Jul 14 11:55:40 2010</span><br><span class="line">  .bash_profile                       H      176  Tue Jul  9 09:24:50 2013</span><br><span class="line"></span><br><span class="line">49584 blocks of size 8192. 45707 blocks available</span><br><span class="line">smb: \&gt; get aa</span><br><span class="line">NT_STATUS_FILE_IS_A_DIRECTORY opening remote file \aa</span><br><span class="line">smb: \&gt; cd aa</span><br><span class="line">smb: \aa\&gt; ls</span><br><span class="line">  .                                   D        0  Thu Aug  4 04:30:28 2016</span><br><span class="line">  ..                                  D        0  Thu Aug  4 04:30:31 2016</span><br><span class="line">  dd.txt                              A        2  Thu Aug  4 04:31:01 2016</span><br><span class="line"></span><br><span class="line">49584 blocks of size 8192. 45707 blocks available</span><br><span class="line">smb: \aa\&gt; get dd.txt</span><br><span class="line">getting file \aa\dd.txt of size 2 as dd.txt (1.0 KiloBytes/sec) (average 1.0 KiloBytes/sec)</span><br><span class="line">可以查看到了。</span><br><span class="line"></span><br><span class="line">********************************************************************</span><br><span class="line">=====================================================================</span><br><span class="line">匿名用户</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">服务器端rhel6</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line"></span><br><span class="line">1.创建共享目录/var/lib/samba/share</span><br><span class="line">[root@rhel6 ~]# mkdir /var/lib/samba/share</span><br><span class="line">2.修改配置文件</span><br><span class="line">[root@rhel6 ~]# vim /etc/samba/smb.conf</span><br><span class="line">[public]</span><br><span class="line">       comment = Public Stuff</span><br><span class="line">       path = /var/lib/samba/share</span><br><span class="line">       public = yes</span><br><span class="line">       writable = yes</span><br><span class="line">3.重启服务</span><br><span class="line">[root@rhel6 ~]# service smb restart</span><br><span class="line">Shutting down SMB services:                                [  OK  ]</span><br><span class="line">Starting SMB services:                                     [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service nmb restart</span><br><span class="line">Shutting down NMB services:                                [  OK  ]</span><br><span class="line">Starting NMB services:                                     [  OK  ]</span><br><span class="line">4.修改共享目录的UGO权限</span><br><span class="line">[root@rhel6 ~]# ll -d /var/lib/samba/share</span><br><span class="line">drwxr-xr-x. 2 root root 4096 Aug  5 10:27 /var/lib/samba/share</span><br><span class="line">[root@rhel6 ~]# grep nobody /etc/passwd</span><br><span class="line">nobody:x:99:99:Nobody:/:/sbin/nologin</span><br><span class="line">nfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin</span><br><span class="line">[root@rhel6 ~]# chown nobody. /var/lib/samba/share</span><br><span class="line">[root@rhel6 ~]# ll -d /var/lib/samba/share</span><br><span class="line">drwxr-xr-x. 2 nobody nobody 4096 Aug  5 10:27 /var/lib/samba/share</span><br><span class="line">[root@rhel6 ~]# touch /var/lib/samba/share</span><br><span class="line">[root@rhel6 ~]# touch /var/lib/samba/share/smb-file&#123;1..5&#125;</span><br><span class="line">[root@rhel6 ~]# chown nobody. /var/lib/samba/share -R</span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# service smb stop</span><br><span class="line">Shutting down SMB services:                                [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service smb start</span><br><span class="line">Starting SMB services:                                     [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">客户端rhel7</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">[root@rhel7 ~]# smbclient -L 172.25.0.11</span><br><span class="line">Enter root\'s password:</span><br><span class="line">Anonymous login successful</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Sharename       Type      Comment</span><br><span class="line">---------       ----      -------</span><br><span class="line">public          Disk      Public Stuff</span><br><span class="line"><span class="meta">IPC$</span><span class="bash">            IPC       IPC Service (Samba Server Version 3.6.9-164.el6)</span></span><br><span class="line">Anonymous login successful</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line"></span><br><span class="line">Server               Comment</span><br><span class="line">---------            -------</span><br><span class="line">RHEL6                Samba Server Version 3.6.9-164.el6</span><br><span class="line"></span><br><span class="line">Workgroup            Master</span><br><span class="line">---------            -------</span><br><span class="line">MYGROUP              RHEL6</span><br><span class="line">[root@rhel7 ~]# smbclient //172.25.0.11/public</span><br><span class="line">Enter root\'s password:</span><br><span class="line">Anonymous login successful</span><br><span class="line">Domain=[MYGROUP] OS=[Unix] Server=[Samba 3.6.9-164.el6]</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  ..                                  D        0  Thu Aug  4 22:30:52 2016</span><br><span class="line">  smb-file4                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file2                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file5                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file1                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file3                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line"></span><br><span class="line">34505 blocks of size 524288. 26941 blocks available</span><br><span class="line">smb: \&gt; get smb-file1</span><br><span class="line">getting file \smb-file1 of size 0 as smb-file1 (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)</span><br><span class="line">smb: \&gt; put rhel7</span><br><span class="line">putting file rhel7 as \rhel7 (0.0 kb/s) (average 0.0 kb/s)</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Thu Aug  4 22:34:46 2016</span><br><span class="line">  ..                                  D        0  Thu Aug  4 22:30:52 2016</span><br><span class="line">  smb-file4                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  rhel7                               A        0  Thu Aug  4 22:34:46 2016</span><br><span class="line">  smb-file2                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file5                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file1                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line">  smb-file3                           N        0  Thu Aug  4 22:32:12 2016</span><br><span class="line"></span><br><span class="line">34505 blocks of size 524288. 26941 blocks available</span><br><span class="line">smb: \&gt; exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">客户端windows</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########</span></span></span><br><span class="line">打开浏览器输入\\172.25.0.11\</span><br><span class="line">就能看到public了</span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line">～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～</span><br><span class="line">以类似nfs挂接的方式来共享samba</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line">客户端</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line">mount -t cifs //172.25.0.11/student /mnt -o username=student</span><br><span class="line">uplooking</span><br><span class="line"></span><br><span class="line">1.安装软件cifs-utils</span><br><span class="line">[root@rhel7 ~]# yum install -y cifs-utils</span><br><span class="line">2.mount挂载</span><br><span class="line">[root@rhel7 ~]# mount -t cifs //172.25.0.11/student /mnt -o username=student</span><br><span class="line">Password for student@//172.25.0.11/student:  *********</span><br><span class="line">[root@rhel7 ~]# mount|tail -n 1</span><br><span class="line">//172.25.0.11/student on /mnt type cifs (rw,relatime,vers=1.0,cache=strict,username=student,domain=RHEL6,uid=0,noforceuid,gid=0,noforcegid,addr=172.25.0.11,unix,posixpaths,serverino,acl,rsize=1048576,wsize=65536,actimeo=1)</span><br><span class="line">[root@rhel7 ~]# cd /mnt</span><br><span class="line">[root@rhel7 mnt]# ll</span><br><span class="line">total 1024</span><br><span class="line">-rwxrw-r--. 1 500 500 8 Aug  4 22:15 file-student.txt</span><br><span class="line">drwxr-xr-x. 2 500 500 0 Aug  4 22:19 windows</span><br><span class="line"></span><br><span class="line">3.可以设置开机自动挂载，/etc/bashrc或者/etc/profile中</span><br></pre></td></tr></table></figure><h3 id="Samba的主配置文件-etc-samba-smb-conf详细解析"><a href="#Samba的主配置文件-etc-samba-smb-conf详细解析" class="headerlink" title="Samba的主配置文件/etc/samba/smb.conf详细解析"></a>Samba的主配置文件/etc/samba/smb.conf详细解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">首先是全局配置</span><br><span class="line">【global】</span><br><span class="line">        workgroup = MYGROUP     --&gt;工作组，工作组是windows上的概念</span><br><span class="line">        server string = Samba Server Version %v   --&gt;关于samba的说明</span><br><span class="line"></span><br><span class="line">        netbios name = MYSERVER   --&gt;网络名称</span><br><span class="line"></span><br><span class="line">;       interfaces = lo eth0 192.168.12.2/24 192.168.13.2/24   --&gt;接口网段信息</span><br><span class="line">;       hosts allow = 127. 192.168.12. 192.168.13.    --&gt;允许哪些机器来访问共享</span><br><span class="line"></span><br><span class="line">;       max protocol = SMB2</span><br><span class="line">【logging options】  关于日志的配置</span><br><span class="line"> log file = /var/log/samba/log.%m    日志存放的位置，%m代表日期</span><br><span class="line"> max log size = 50日志的大小限制为50K</span><br><span class="line">【 Standalone Server Options 】 关于安全级别的相关配置</span><br><span class="line">        security = user    --&gt; user代表需要用户名和密码，密码与下面的passdb backend有关，share代表任何来都可以直接访问，server指的是使用外部的密码，需要提供password server = IP的设置值才行。</span><br><span class="line">        passdb backend = tdbsam   --&gt;数据库格式，默认的格式是tdbsam，文职被放置到/var/lib/samba/private/passwd.tdb</span><br><span class="line"></span><br><span class="line">【 Share Definitions 】</span><br><span class="line">[homes]    --&gt;默认情况用户家目录的共享信息</span><br><span class="line">        comment = Home Directories</span><br><span class="line">        browseable = no</span><br><span class="line">        writable = yes</span><br><span class="line">;       valid users = %S</span><br><span class="line">;       valid users = MYDOMAIN\%S</span><br><span class="line">[printers]  --&gt;关于打印机的配置，这是一些例子。下面跟上了一些选项。</span><br><span class="line">        path = /var/spool/samba</span><br><span class="line">        browseable = no</span><br><span class="line">        guest ok = no</span><br><span class="line">        writable = no</span><br><span class="line">        printable = yes</span><br><span class="line">[sharesmb]        --&gt;共享目录名</span><br><span class="line">        comment = 说明</span><br><span class="line">        path = /test    --&gt;共享路径</span><br><span class="line">        public = yes    --&gt;是否所有人都能够访问</span><br><span class="line">        writable = yes  --&gt;是否可以写</span><br><span class="line">        printable = no  --&gt;是否打印，默认是no，写了yes会直接被传递到打印机，可以省略该行</span><br><span class="line">        write list = +staff  --&gt;可写用户列表。我们这里先把这行删掉。</span><br><span class="line">        browsable=no    --&gt;是否可浏览，如果是yes则默认隐藏。</span><br><span class="line">       hosts allow= 用来限制主机和网段。谁可以访问。</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Samba的历史及原理&quot;&gt;&lt;a href=&quot;#Samba的历史及原理&quot; class=&quot;headerlink&quot; title=&quot;Samba的历史及原理&quot;&gt;&lt;/a&gt;Samba的历史及原理&lt;/h3&gt;&lt;p&gt;在早期的网络世界中，文件数据在不同主机之间的传输大多是使用FTP这个
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>APACHE WEB服务</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/05_apache/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/05_apache/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.712Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Web基础"><a href="#Web基础" class="headerlink" title="Web基础"></a>Web基础</h3><p>我们平时上网的时候，输入网址的时候都会输入什么，<a href="http://www.baidu.com，对不对，那么这个www是什么呢？这个www代表的是world">www.baidu.com，对不对，那么这个www是什么呢？这个www代表的是world</a> wide web，WWW可以让Web客户端（常用浏览器）访问浏览Web服务器上的页面。 它是一个由许多互相链接的超文本组成的系统，通过互联网访问，在这个系统中，每个有用的事物，称为一样“资源”；并且由一个全局“统一资源标识符”（URL）标识；这些资源通过超文本传输协议（Hypertext Transfer Protocol）传送给用户，而后者通过点击链接来获得资源。</p><p>HTTP是Hypertext Transfer Protocol的缩写，即超文本传输协议。 顾名思义，HTTP提供了访问超文本信息的功能，是WWW浏览器和WWW服务器之间的应用层通信协议。HTTP协议是用于分布式协作超文本信息系统的、通用的、面向对象的协议。通过扩展命令，它可用于类似的任务，如域名服务或分布式面向对象系统。WWW使用HTTP协议传输各种超文本页面和数据。</p><p>网页文件是用HTML（标准通用标记语言下的一个应用）编写的，可在WWW上传输，能被浏览器识别显示的文本文件。其扩展名是.htm和.html。</p><p>Web的服务器最常见的有windows上的IIS，还有linux上的apache。另外还有例如nginx等的轻量级服务器。都是比较常用的一些服务器。我们基础课主要简单介绍一些apache的一个简单搭建。</p><h3 id="Apache的简介"><a href="#Apache的简介" class="headerlink" title="Apache的简介"></a>Apache的简介</h3><ul><li>HTTP (Web) server、开源、1995年</li><li>官网： <a href="http://httpd.apache.org/" target="_blank" rel="noopener">http://httpd.apache.org/</a></li></ul><p>Apache 起初由 Illinois 大学 Urbana-Champaign 的国家高级计算程序中心开发。此后，Apache 被开放源代码团体的成员不断的发展和加强。Apache 服务器拥有牢靠可信的美誉，已用在超过半数的因特网站中－特别是几乎所有最热门和访问量最大的网站。</p><p>开始，Apache只是Netscape网页服务器（现在是Sun ONE）的之外的开放源代码选择。渐渐的，它开始在功能和速度。超越其他的基于Unix的HTTP服务器。1996年4月以来，Apache一直是Internet上最流行的HTTP服务器: 1999年5月它在 57% 的网页服务器上运行；到了2005年7月这个比例上升到了69%。</p><p>作者宣称因为这个名字好记才在最初选择它，但是流传最广的解释是（也是最显而易见的）:这个名字来自这么一个事实:当Apache在1995年初开发的时候，它是由当时最流行的HTTP服务器NCSA HTTPd 1.3 的代码修改而成的，因此是“一个修补的（a patchy）”服务器。然而在服务器官方网站的FAQ中是这么解释的:“‘Apache’这个名字是为了纪念名为Apache(印地语)的美洲印第安人土著的一支，众所周知他们拥有高超的作战策略和无穷的耐性”。</p><p>Apache的软件名称就叫做httpd，这里要注意一下，这里我们以el6作为服务器，el7作为客户端。</p><h3 id="Apache的软件结构"><a href="#Apache的软件结构" class="headerlink" title="Apache的软件结构"></a>Apache的软件结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apache</span><br><span class="line">软件 httpd</span><br><span class="line">rhel6httpd-2.2.15-29.el6_4.x86_64</span><br><span class="line">rhel7httpd-2.4.6-17.el7.x86_64</span><br><span class="line">servicehttpd</span><br><span class="line">daemonhttpd</span><br><span class="line">端口80</span><br><span class="line">配置文件/etc/httpd/conf/httpd.conf</span><br><span class="line">/etc/httpd/conf.d/*.conf</span><br><span class="line">数据文件/var/www/</span><br><span class="line">/var/www/uplooking/www.uplooking.com----网站根目录</span><br><span class="line">日志文件/var/log/httpd</span><br></pre></td></tr></table></figure><h3 id="Apache虚拟主机方案"><a href="#Apache虚拟主机方案" class="headerlink" title="Apache虚拟主机方案"></a>Apache虚拟主机方案</h3><ol><li>基于端口的虚拟主机<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www.uplooking.com:80----&gt;/var/www/uplooking.com/</span><br><span class="line">www.uplooking.com:8080----&gt;/var/www/abc.com/</span><br></pre></td></tr></table></figure></li><li>基于名称的虚拟主机<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www.uplooking.com----/var/www/uplooking.com/</span><br><span class="line">www.abc.com----/var/www/abc.com/</span><br></pre></td></tr></table></figure><h3 id="Apache实践"><a href="#Apache实践" class="headerlink" title="Apache实践"></a>Apache实践</h3></li></ol><h4 id="项目实践1：配置基于端口的虚拟主机"><a href="#项目实践1：配置基于端口的虚拟主机" class="headerlink" title="项目实践1：配置基于端口的虚拟主机"></a>项目实践1：配置基于端口的虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">8080---&gt;</span><span class="bash">/var/www/8080.com/</span></span><br><span class="line">*******************************************</span><br><span class="line">1)修改主配置文件，打开要监听的端口号</span><br><span class="line">[root@rhel6 ~]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">Listen 80</span><br><span class="line">Listen 8080</span><br><span class="line">2)为不同的虚拟主机创建配置文件</span><br><span class="line">[root@rhel6 conf.d]# pwd</span><br><span class="line">/etc/httpd/conf.d</span><br><span class="line">[root@rhel6 conf.d]# vim 8080.conf</span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerAdmin booboo@8080.com</span><br><span class="line">    DocumentRoot /var/www/8080.com</span><br><span class="line">    ServerName www.8080.com</span><br><span class="line">    ErrorLog logs/8080.com-error_log</span><br><span class="line">    CustomLog logs/8080.com-access_log common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">3.创建网站根目录，并创建网站默认首页</span><br><span class="line">[root@rhel6 conf.d]# mkdir /var/www/8080.com</span><br><span class="line">[root@rhel6 conf.d]# echo 8080.com &gt; /var/www/8080.com/index.html</span><br><span class="line">4.重启服务</span><br><span class="line">[root@rhel6 conf.d]# service httpd start</span><br></pre></td></tr></table></figure><p>拓展8081和8082端口</p><ol><li>关闭selinux</li><li>配置selinux安全上下文，允许httpd监听8081和8082端口<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 conf.d]# semanage port -l|grep http</span><br><span class="line">http_cache_port_t              tcp      3128, 8080, 8118, 8123, 10001-10010</span><br><span class="line">http_cache_port_t              udp      3130</span><br><span class="line">http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000</span><br><span class="line">pegasus_http_port_t            tcp      5988</span><br><span class="line">pegasus_https_port_t           tcp      5989</span><br><span class="line"></span><br><span class="line">[root@rhel6 conf.d]# semanage port -a -t http_port_t -p tcp 8081</span><br><span class="line">[root@rhel6 conf.d]# semanage port -a -t http_port_t -p tcp 8082</span><br></pre></td></tr></table></figure></li></ol><h4 id="项目实践2：配置基于名称的虚拟主机"><a href="#项目实践2：配置基于名称的虚拟主机" class="headerlink" title="项目实践2：配置基于名称的虚拟主机"></a>项目实践2：配置基于名称的虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">www.taobao.com/var/www/taobao.com/</span><br><span class="line">www.abc.com/var/www/abc.com/</span><br><span class="line">*******************************************************</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">服务端</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">1.修改主配置文件</span><br><span class="line">[root@rhel6 conf.d]# vim /etc/httpd/conf/httpd.conf</span><br><span class="line">NameVirtualHost *:80</span><br><span class="line">2.创建拓展配置文件</span><br><span class="line">[root@rhel6 conf.d]# vim taobao.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin booboo@taobao.com</span><br><span class="line">    DocumentRoot /var/www/taobao.com</span><br><span class="line">    ServerName www.taobao.com</span><br><span class="line">    ErrorLog logs/taobao.com-error_log</span><br><span class="line">    CustomLog logs/taobao.com-access_log common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory "/var/www/taobao.com/"&gt;</span><br><span class="line">    Options Indexes ==&gt;如果没有对应的index文件，就将该目录下的其他文件罗列出来。</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">[root@rhel6 conf.d]# vim abc.conf</span><br><span class="line">[root@rhel6 conf.d]# cat abc.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin booboo@abc.com</span><br><span class="line">    DocumentRoot /var/www/abc.com</span><br><span class="line">    ServerName www.abc.com</span><br><span class="line">    ErrorLog logs/abc.com-error_log</span><br><span class="line">    CustomLog logs/abc.com-access_log common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory "/var/www/abc.com/"&gt;</span><br><span class="line">    Options Indexes</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">[root@rhel6 conf.d]# mkdir /var/www/taobao.com</span><br><span class="line">[root@rhel6 conf.d]# mkdir /var/www/abc.com</span><br><span class="line">[root@rhel6 conf.d]# echo www.taobao.com &gt; /var/www/taobao.com/index.html</span><br><span class="line">[root@rhel6 conf.d]# echo www.abc.com &gt; /var/www/abc.com/index.html</span><br><span class="line">[root@rhel6 conf.d]# service httpd restart</span><br><span class="line">==================================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">客户端</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">1.安装elinks软件，bash下的一个网站浏览软件</span><br><span class="line">[root@rhel7 mnt]# yum install -y elinks</span><br><span class="line">2.添加域名解析</span><br><span class="line">[root@rhel7 mnt]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">172.25.0.11www.taobao.com</span><br><span class="line">172.25.0.11www.abc.com</span><br><span class="line">3.通过links命令访问www.taobao.com和www.abc.com</span><br><span class="line">[root@rhel7 mnt]# links www.taobao.com</span><br><span class="line">[root@rhel7 mnt]# links www.abc.com</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">-X 带图形化界面的远程登录</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####</span></span></span><br><span class="line">[kiosk@foundation0 Desktop]$ ssh root@172.25.0.10 -X</span><br><span class="line">Last login: Fri Aug  5 03:14:10 2016</span><br><span class="line">/usr/bin/xauth:  file /root/.Xauthority does not exist</span><br><span class="line">[root@rhel7 ~]# firefox</span><br></pre></td></tr></table></figure><h4 id="项目实践3：配置基于名称的虚拟主机针对某一个目录做限制"><a href="#项目实践3：配置基于名称的虚拟主机针对某一个目录做限制" class="headerlink" title="项目实践3：配置基于名称的虚拟主机针对某一个目录做限制"></a>项目实践3：配置基于名称的虚拟主机针对某一个目录做限制</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Directory是针对某一个目录做限制的意思。</span><br><span class="line">Options</span><br><span class="line">Indexes的意思代表如果没有对应的index文件，就将该目录下的其他文件罗列出来。</span><br><span class="line">Multiview代表的是多视图</span><br><span class="line">Follow sysmlink代表允许连接到其他目录。</span><br><span class="line">AllowOverride None</span><br><span class="line">最常用的是：</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow from All</span><br><span class="line">deny from 172.25.0.10==&gt;该目录允许所有人，除了172.25.0.11</span><br><span class="line">或者</span><br><span class="line">Order deny,allow</span><br><span class="line">deny from All</span><br><span class="line">allow from 172.25.0.10==&gt;该目录不允许所有人，除了172.25.0.11</span><br></pre></td></tr></table></figure><h4 id="项目实践4：配置基于名称的虚拟主机-别名"><a href="#项目实践4：配置基于名称的虚拟主机-别名" class="headerlink" title="项目实践4：配置基于名称的虚拟主机_别名"></a>项目实践4：配置基于名称的虚拟主机_别名</h4><ul><li>别名        alias<ul><li>作用在访问该目录的时候,无论之前的虚拟主机站点名是什么,会统一转到某一个指定的目录。</li></ul></li></ul><p><code>Alias /download/ /&quot;var/www/soft/&quot;</code></p><p>访问 download 目录时,无论站点名是什么,都会交给 var/www/soft/ 去处理,注意:代表目录时,最后一个 / 不能省略</p><h4 id="项目实践4：配置基于名称的虚拟主机-用户名和密码访问"><a href="#项目实践4：配置基于名称的虚拟主机-用户名和密码访问" class="headerlink" title="项目实践4：配置基于名称的虚拟主机_用户名和密码访问"></a>项目实践4：配置基于名称的虚拟主机_用户名和密码访问</h4><ul><li>1）配置文件中添加认证    AllowOverride AuthConfig<ul><li>2）创建认证文件和用户密码    htpasswd -cmb /etc/httpd/test booboo uplooking</li><li>3）新增用户和密码        htpasswd -bm /etc/httpd/test tom uplooking</li><li>4）删除用户        htpasswd -D /etc/httpd/test jack</li><li>5）修改密码        先删除再创建</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">设置用户和密码</span><br><span class="line">&lt;Directory "/var/www/booboo.com/football/"&gt;</span><br><span class="line">Options Indexes MultiViews FollowSymLinks</span><br><span class="line">AllowOverride AuthConfig</span><br><span class="line"><span class="meta">#</span><span class="bash">仅有网页认证 ( 账号密码 ) 可覆写 ;</span></span><br><span class="line">AuthName "student"</span><br><span class="line"><span class="meta">#</span><span class="bash">在要你输入账号与密码的对话窗口中 , 出现的『提示字符』</span></span><br><span class="line">AuthType basic</span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证的类型</span></span><br><span class="line">AuthUserFile "/etc/httpd/test"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个目录所使用的账号密码配置文件</span></span><br><span class="line">Require valid-user</span><br><span class="line"><span class="meta">#</span><span class="bash"> 后面接可以使用的账号 , 此处是让该密码文件内的用户都能够登入</span></span><br><span class="line">Order allow,deny</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过htpasswd添加用户和密码</span></span><br><span class="line">[root@rhel6 conf.d]# htpasswd -cmb /etc/httpd/test booboo uplooking</span><br><span class="line">Adding password for user student</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再添加一个用户和密码</span></span><br><span class="line">[root@rhel6 www]# htpasswd -bm /etc/httpd/test tom uplooking</span><br><span class="line">Adding password for user tom</span><br><span class="line">[root@rhel6 www]# htpasswd -bm /etc/httpd/test jack uplooking</span><br><span class="line">Adding password for user jack</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看保存apache用户名和密码的文件内容</span></span><br><span class="line">[root@rhel6 www]# cat /etc/httpd/test</span><br><span class="line">booboo:$apr1$y6g/XYrn$eEOR4WeAPfONSLExj7x2D1</span><br><span class="line">tom:$apr1$epxVgzER$Or7.R0.5s3z8FbPKrOS1e1</span><br><span class="line">jack:$apr1$Alo3.7mf$3CmcCG9mXp7eEALUsa3YY1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除用户</span></span><br><span class="line">[root@rhel6 www]# htpasswd -D /etc/httpd/test jack</span><br><span class="line">Deleting password for user jack</span><br><span class="line">[root@rhel6 www]# cat /etc/httpd/test</span><br><span class="line">booboo:$apr1$y6g/XYrn$eEOR4WeAPfONSLExj7x2D1</span><br><span class="line">tom:$apr1$epxVgzER$Or7.R0.5s3z8FbPKrOS1e1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改用户密码只能先删除再创建</span></span><br><span class="line">[root@rhel6 abc.com]# htpasswd --help</span><br><span class="line">Usage:</span><br><span class="line">htpasswd [-cmdpsD] passwordfile username</span><br><span class="line">htpasswd -b[cmdpsD] passwordfile username password</span><br><span class="line"></span><br><span class="line">htpasswd -n[mdps] username</span><br><span class="line">htpasswd -nb[mdps] username password</span><br><span class="line"> -c  Create a new file.</span><br><span class="line"> -n  Don\'t update file; display results on stdout.</span><br><span class="line"> -m  Force MD5 encryption of the password.</span><br><span class="line"> -d  Force CRYPT encryption of the password (default).</span><br><span class="line"> -p  Do not encrypt the password (plaintext).</span><br><span class="line"> -s  Force SHA encryption of the password.</span><br><span class="line"> -b  Use the password from the command line rather than prompting for it.</span><br><span class="line"> -D  Delete the specified user.</span><br><span class="line">On Windows, NetWare and TPF systems the '-m' flag is used by default.</span><br><span class="line">On all other systems, the '-p' flag will probably not work.</span><br></pre></td></tr></table></figure><h4 id="项目实践5：在rhel7中搭建apahce，实现以下功能"><a href="#项目实践5：在rhel7中搭建apahce，实现以下功能" class="headerlink" title="项目实践5：在rhel7中搭建apahce，实现以下功能"></a>项目实践5：在rhel7中搭建apahce，实现以下功能</h4><ul><li><p>配置基于名称的虚拟主机 <a href="http://www.abc.com" target="_blank" rel="noopener">www.abc.com</a> 和 <a href="http://www.uplooking.com" target="_blank" rel="noopener">www.uplooking.com</a></p></li><li><p>只允许rhel6 172.25.0.11 能够访问 <a href="http://www.uplooking.com" target="_blank" rel="noopener">www.uplooking.com</a> </p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">rhel6rhel7</span><br><span class="line">2.22.4</span><br><span class="line">orderrequire</span><br><span class="line"></span><br><span class="line">》eg1:所有请求都被拒绝</span><br><span class="line">order deny,allow //先拒绝，后允许</span><br><span class="line">deny from all//拒绝所有</span><br><span class="line">------------------------------</span><br><span class="line">require all denied //拒绝所有</span><br><span class="line"></span><br><span class="line">》eg2：所有请求都允许</span><br><span class="line">order allow，deny //先允许，后拒绝</span><br><span class="line">allow from all</span><br><span class="line">------------------------------------</span><br><span class="line">require all granted</span><br><span class="line"></span><br><span class="line">》拒绝172.25.0.10/test.uplooking.com 的请求</span><br><span class="line">order allow，deny //先允许，后拒绝</span><br><span class="line">allow from all</span><br><span class="line">deny from 172.25.0.10</span><br><span class="line">-------------------------------------</span><br><span class="line">require  all granted</span><br><span class="line">require no ip 172.25.0.10</span><br><span class="line">require no host test.uplooking.com</span><br><span class="line"></span><br><span class="line">》只允许172.25.3.10和172.25.0.0/24 uplooking.com 的请求</span><br><span class="line">order deny，allow //先决绝，后允许</span><br><span class="line">deny from all</span><br><span class="line">allow from 172.25.3.10</span><br><span class="line">allow from 172.25.0.0/24</span><br><span class="line">-------------------------------------</span><br><span class="line">require all denied</span><br><span class="line">require ip 172.25.3.10 172.25.0</span><br><span class="line">require host  uplooking.com</span><br></pre></td></tr></table></figure><hr><h3 id="Apache配置文件-etc-httpd-conf-httpd-conf"><a href="#Apache配置文件-etc-httpd-conf-httpd-conf" class="headerlink" title="Apache配置文件/etc/httpd/conf/httpd.conf"></a>Apache配置文件/etc/httpd/conf/httpd.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">1）</span><br><span class="line"><span class="meta">#</span><span class="bash"> ServerRoot “/etc/httpd“</span></span><br><span class="line">ServerRoot用于指定守护进程httpd的运行目录，httpd在启动之后将自动将进程的当前目录改变为这个目录，因此如果设置文件中指定的文件或目录是相对路径，那么真实路径就位于这个ServerR oot定义的路径之下。</span><br><span class="line"></span><br><span class="line">2）</span><br><span class="line">hhhidFile /var/run/httpd.pid</span><br><span class="line">PidFile指定的文件将记录httpd守护进程的进程号，由于httpd能自动复制其自身，因此系统中有多个httpd进程，但只有一个进程为最初启动的进程，它为其他进程的父进程，对这个进程发送信号将影响所有的httpd进程。PidFILE定义的文件中就记录httpd父进程的进程号。</span><br><span class="line">　　</span><br><span class="line"><span class="meta">#</span><span class="bash"> Timeout 300</span></span><br><span class="line">Timeout定义客户程序和服务器连接的超时间隔，超过这个时间间隔（秒）后服务器将断开与客户机的连接。</span><br><span class="line"><span class="meta">#</span><span class="bash"> KeepAlive On</span></span><br><span class="line">在HTTP 1.0中，一次连接只能作传输一次HTTP请求，而KeepAlive参数用于支持HTTP 1.1版本的一次连接、多次传输功能，这样就可以在一次连接中传递多个HTTP请求。不过只有较新的浏览器才支持这个功能</span><br><span class="line"><span class="meta">#</span><span class="bash"> MaxKeepAliveRequests 100</span></span><br><span class="line">MaxKeepAliveRequests为一次连接可以进行的HTTP请求的最大请求次数。将其值设为0将支持在一次连接内进行无限次的传输请求。事实上没有客户程序在一次连接中请求太多的页面，通常达不到这个上限就完成连接了。</span><br><span class="line"><span class="meta">#</span><span class="bash"> KeepAliveTimeout 15</span></span><br><span class="line">KeepAliveTimeout测试一次连接中的多次请求传输之间的时间，如果服务器已经完成了一次请求，但一直没有接收到客户程序的下一次请求，在间隔超过了这个参数设置的值之后，服务器就断开连接。</span><br><span class="line"><span class="meta">#</span><span class="bash"> ThreadsPerChild 50</span></span><br><span class="line">设置服务器使用进程的数目。这是以服务器的响应速度为准的, 数目太大则会变慢</span><br><span class="line"><span class="meta">#</span><span class="bash"> MaxRequestsPerChild 30</span></span><br><span class="line">使用子进程的方式提供服务的Web服务，常用的方式是一个子进程为一次连接服务，这样造成的问题就是每次连接都需要生成、退出子进程的系统操作，使得这些额外的处理过程占据了计算机的大量处理能力。因此最好的方式是一个子进程可以为多次连接请求服务，这样就不需要这些生成、退出进程的系统消耗，Apache就采用了这样的方式，一次连接结束后，子进程并不退出，而是停留在系统中等待下一次服务请求，这样就极大的提高了性能。但由于在处理过程中子进程要不断的申请和释放内存，次数多了就会造成一些内存垃圾，就会影响系统的稳定性，并且影响系统资源的有效利用。因此在一个副本处理过一定次数的请求之后，就可以让这个子进程副本退出，再从原始的htt pd进程中重新复制一个干净的副本，这样就能提高系统的稳定性。这样，每个子进程处理服务请求次数由MaxRe questPerChild定义。 缺省的设置值为30，这个值对于具备高稳定性特点的FreeBSD系统来讲是过于保守的设置，可以设置为1000甚至更高，设置为0支持每个副本进行无限次的服务处理。　　　　</span><br><span class="line"><span class="meta">#</span><span class="bash"> ServerAdmin root@localhost</span></span><br><span class="line">配置文件中应该改变的也许只有ServerAdmin， 这一项用于配置WWW服务器的管理员的email地址，这将在HTTP服务出现错误的条件下返回给浏览器，以便让Web使用者和管理员联系，报告错误。习惯上使用服务器上的webmaster作为WWW服务器的管理员，通过邮件服务器的别名机制，将发送到webmaster 的电子邮件发送给真正的Web管理员。</span><br><span class="line"><span class="meta">#</span><span class="bash"> ServerName localhost</span></span><br><span class="line">缺省情况下，并不需要指定这个ServerName参数，服务器将自动通过名字解析过程来获得自己的名字，但如果服务器的名字解析有问题（通常为反向解析不正确），或者没有正式的DNS名字，也可以在这里指定I P地址。当ServerName设置不正确的时候，服务器不能正常启动。</span><br><span class="line">通常一个Web服务器可以具有多个名字，客户浏览器可以使用所有这些名字或IP地址来访问这台服务器，但在没有定义虚拟主机的情况下，服务器总是以自己的正式名字回应浏览器。ServerName就定义了Web服务器自己承认的正式名字，例如一台服务器名字（在DNS中定义了A类型）为freebsd.exmaple.org.cn，同时为了方便记忆还定义了一个别名（CNAME记录）为www.exmaple.org.cn，那么Apache自动解析得到的名字就为freebsd.example.org.cn，这样不管客户浏览器使用哪个名字发送请求，服务器总是告诉客户程序自己为freebsd.example.org.cn。虽然这一般并不会造成什么问题，但是考虑到某一天服务器可能迁移到其他计算机上，而只想通过更改DNS中的www别名配置就完成迁移任务，所以不想让客户在其书签中使用 freebsd记录下这个服务器的地址，就必须使用ServerName来重新指定服务器的正式名字。</span><br><span class="line">　　</span><br><span class="line">3）</span><br><span class="line"><span class="meta">#</span><span class="bash"> DocumentRoot “/var/www/html“</span></span><br><span class="line">DocumentRoot定义这个服务器对外发布的超文本文档存放的路径，客户程序请求的UR L就被映射为这个目录下的网页文件。这个目录下的子目录，以及使用符号连接指出的文件和目录都能被浏览器访问，只是要在URL上使用同样的相对目录名。注意，符号连接虽然逻辑上位于根文档目录之下，但实际上可以位于计算机上的任意目录中，因此可以使客户程序能访问那些根文档目录之外的目录，这在增加了灵活性的同时但减少了安全性。Apache在目录的访问控制中提供了FollowSymLinks选项来打开或关闭支持符号连接的特性。</span><br><span class="line">4）</span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;Directory /&gt;</span></span><br><span class="line">　　 Options FollowSymLinks</span><br><span class="line">　　 AllowOverride None</span><br><span class="line">　　&lt;/Directory&gt;</span><br><span class="line">Apache服务器可以针对目录进行文档的访问控制，然而访问控制可以通过两种方式来实现，一个是在设置文件 httpd.conf（或access.conf）中针对每个目录进行设置，另一个方法是在每个目录下设置访问控制文件，通常访问控制文件名字为.htaccess。虽然使用这两个方式都能用于控制浏览器的访问，然而使用配置文件的方法要求每次改动后重新启动httpd守护进程，比较不灵活，因此主要用于配置服务器系统的整体安全控制策略，而使用每个目录下的.htaccess文件设置具体目录的访问控制更为灵活方便.</span><br><span class="line">　由于Apache对一个目录的访问控制设置是能够被下一级目录继承的，因此对根目录的设置将影响到它的下级目录。注意由于AllowOverride None的设置，使得Apache服务器不需要查看根目录下的访问控制文件，也不需要查看以下各级目录下的访问控制文件，直至httpd.conf（或access.conf ）中为某个目录指定了允许Alloworride，即允许查看访问控制文件。由于Apache对目录访问控制是采用的继承方式，如果从根目录就允许查看访问控制文件，那么Apache就必须一级一级的查看访问控制文件，对系统性能会造成影响。而缺省关闭了根目录的这个特性，就使得Apache从httpd.conf中具体指定的目录向下搜寻，减少了搜寻的级数，增加了系统性能。因此对于系统根目录设置AllowOverride None不但对于系统安全有帮助，也有益于系统性能。</span><br><span class="line">　　&lt;Directory /&gt;</span><br><span class="line">   Options Indexes FollowSymLinks</span><br><span class="line">　　 AllowOverride None</span><br><span class="line">　　 Order allow,deny</span><br><span class="line">　　 Allow from all</span><br><span class="line">　　&lt;/Directory&gt;</span><br><span class="line">这里定义的是系统对外发布文档的目录的访问设置，设置不同的AllowOverride选项，以定义配置文件中的目录设置和用户目录下的安全控制文件的关系，而Options选项用于定义该目录的特性。</span><br><span class="line"><span class="meta">#</span><span class="bash">  ErrorLog /var/<span class="built_in">log</span>/httpd-error.log</span></span><br><span class="line">　　LogLevel warn</span><br><span class="line">　　LogFormat “%h %l %u %t \“%r\“ %&gt;s %b \“%&#123;Referer&#125;i\“ \“%&#123;User-Agent&#125;i\““ combined</span><br><span class="line">　　LogFormat “%h %l %u %t \“%r\“ %&gt;s %b“ common</span><br><span class="line">　　LogFormat “%&#123;Referer&#125;i -&gt; %U“ referer</span><br><span class="line">　　LogFormat “%&#123;User-agent&#125;i“ agent</span><br><span class="line"><span class="meta">　　#</span><span class="bash">CustomLog /var/<span class="built_in">log</span>/httpd-access.log common</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash">CustomLog /var/<span class="built_in">log</span>/httpd-referer.log referer</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash">CustomLog /var/<span class="built_in">log</span>/httpd-agent.log agent</span></span><br><span class="line">　　CustomLog /var/log/httpd-access.log combined</span><br><span class="line">这里定义了系统日志的形式，对于服务器错误记录，由ErrorLog、LogLevel 来定义不同的错误日志文件及其记录内容。 这是通过在 CustomLog中指定不同的记录类型来完成的。common表示普通的对单页面请求访问记录，referer表示每个页面的引用记录，可以看出一个页面中包含的请求数，agent表示对客户机的类型记录，显然可以将现有的combined 定义的设置行注释掉，并使用common、referer和agent作为CustomLog的参数，来为不同种类的日志分别指定日志记录文件。显然，LogFormat是用于定义不同类型的日志进行记录时使用的格式， 这里使用了以%开头的宏定义，以记录不同的内容。</span><br><span class="line">如果这些参数指定的文件使用的是相对路径，那么就是相对于ServerRoot的路径。</span><br><span class="line"><span class="meta">#</span><span class="bash"> Alias /icons/ “/usr/<span class="built_in">local</span>/www/icons/“</span></span><br><span class="line">　　 Options Indexes MultiViews</span><br><span class="line">　　 AllowOverride None</span><br><span class="line">　　 Order allow,deny</span><br><span class="line">　　 Allow from all</span><br><span class="line">Alias参数用于将URL与服务器文件系统中的真实位置进行直接映射，一般的文档将在DocumentRoot 中进行查询，然而使用Alias定义的路径将直接映射到相应目录下，而不再到DocumentRoot 下面进行查询。因此Alias可以用来映射一些公用文件的路径，例如保存了各种常用图标的icons路径。这样使得除了使用符号连接之外，文档根目录（DocumentRoot）外的目录也可以通过使用了Alias映射，提供给浏览器访问。</span><br><span class="line">定义好映射的路径之后，应该需要使用Directory语句设置访问限制。</span><br><span class="line"><span class="meta">　　#</span><span class="bash">NameVirtualHost 12.34.56.78:80</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash">NameVirtualHost 12.34.56.78</span></span><br><span class="line"><span class="meta">　　#</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash"> ServerAdmin webmaster@host.some_domain.com</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash"> DocumentRoot /www/docs/host.some_domain.com</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash"> ServerName host.some_domain.com</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash"> ErrorLog logs/host.some_domain.com-error_log</span></span><br><span class="line"><span class="meta">　　#</span><span class="bash"> CustomLog logs/host.some_domain.com-access_log common</span></span><br><span class="line"><span class="meta">　　#</span></span><br><span class="line">这个字段是虚拟主机的相关内容，虚拟主机是在一台Web服务器上，可以为多个单独域名提供Web服务，并且每个域名都完全独立，包括具有完全独立的文档目录结构及设置，这样域名之间完全独立，不但使用每个域名访问到的内容完全独立，并且使用另一个域名无法访问其他域名提供的网页内容。</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Web基础&quot;&gt;&lt;a href=&quot;#Web基础&quot; class=&quot;headerlink&quot; title=&quot;Web基础&quot;&gt;&lt;/a&gt;Web基础&lt;/h3&gt;&lt;p&gt;我们平时上网的时候，输入网址的时候都会输入什么，&lt;a href=&quot;http://www.baidu.com，对不对，
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>时间同步服务NTP和Chony</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/06_ntp_chrony/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/06_ntp_chrony/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.706Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th align="left">服务</th><th align="left">域名解析服务</th><th align="left">文件共享服务</th><th align="left"></th><th align="left"></th><th align="left">web服务</th></tr></thead><tbody><tr><td align="left"></td><td align="left">DNS</td><td align="left">FTP</td><td align="left">NFS</td><td align="left">SAMBA</td><td align="left">APACHE</td></tr><tr><td align="left">软件</td><td align="left">bind    bind-chroot</td><td align="left">vsftpd</td><td align="left">rpcbind nfs-utils</td><td align="left">samba    samba-common</td><td align="left">httpd</td></tr><tr><td align="left">服务</td><td align="left">named</td><td align="left">vsftpd</td><td align="left">rpcbind nfs</td><td align="left">smb nmb</td><td align="left">httpd</td></tr><tr><td align="left">daemon</td><td align="left">named</td><td align="left">vsftpd</td><td align="left">rpcbind nfs</td><td align="left">smbd nmbd</td><td align="left">httpd</td></tr><tr><td align="left">端口号</td><td align="left">53</td><td align="left">21</td><td align="left">111 2049</td><td align="left">137 138 139 445</td><td align="left">80 8080</td></tr><tr><td align="left">配置文件</td><td align="left">/etc/named.conf /etc/named.rfc1912.zones</td><td align="left">/etc/vsftpd/vsftpd.conf</td><td align="left">/etc/exports</td><td align="left">/etc/samba/smb.conf</td><td align="left">/etc/httpd/conf/httpd.conf</td></tr><tr><td align="left">数据文件</td><td align="left">/var/named/</td><td align="left">/var/ftp/</td><td align="left"></td><td align="left">/var/lib/samba</td><td align="left">/var/www</td></tr><tr><td align="left">客户端</td><td align="left"></td><td align="left">lftp</td><td align="left">rpcbind</td><td align="left">samba-client</td><td align="left">elinks</td></tr><tr><td align="left">命令</td><td align="left">nslookup</td><td align="left">lftp</td><td align="left">nfs-utils mount</td><td align="left">smbclient</td><td align="left">links</td></tr></tbody></table><h3 id="Ntp服务的作用"><a href="#Ntp服务的作用" class="headerlink" title="Ntp服务的作用"></a>Ntp服务的作用</h3><p>大家设想一下，如果我们的主机时间不准，可以怎么做？有将硬件时间和软件时间同步的办法，也可以使用<code>date -s</code>去设置一个时间，但是你怎么知道你设置的时间就一定准了，或者说你能确定硬件时间一定准么？不能保证吧？那这时候我们就可以找天文台或者一些网络上的时间服务器去做同步，那这时候怎么去做呢？</p><p>这里就用到一种服务了，这种服务叫做ntp服务，它是一种针对时间同步的服务。</p><h3 id="Ntp服务的原理"><a href="#Ntp服务的原理" class="headerlink" title="Ntp服务的原理"></a>Ntp服务的原理</h3><p>其实更细化来说，NTP服务器（Network Time Protocol）是用来使计算机时间同步化的一种协议，它可以使计算机对其服务器或时钟源（如石英钟，GPS等等)做同步化，它可以提供高精准度的时间校正（LAN上与标准间差小于1毫秒，WAN上几十毫秒），且可介由加密确认的方式来防止恶毒的协议攻击。时间按NTP服务器的等级传播。按照离外部UTC源的远近把所有服务器归入不同的Stratum（层）中。</p><p>Stratum层也是一个分层式的结构，下一层找上一层做同步，上一层还有上一层。以此类推。</p><h3 id="时间同步服务配置"><a href="#时间同步服务配置" class="headerlink" title="时间同步服务配置"></a>时间同步服务配置</h3><p>服务端</p><table><thead><tr><th align="left"></th><th align="left">rhel6</th><th align="left">rhel7</th></tr></thead><tbody><tr><td align="left">软件</td><td align="left">ntp</td><td align="left">chrony</td></tr><tr><td align="left">service</td><td align="left">ntpd</td><td align="left">chronyd</td></tr><tr><td align="left">daemon</td><td align="left">ntpd</td><td align="left">chronyd</td></tr><tr><td align="left">配置文件</td><td align="left">/etc/ntp.conf</td><td align="left">/etc/chrony.conf</td></tr><tr><td align="left">数据文件</td><td align="left">/var/lib/ntp</td><td align="left">/var/lib/chrony</td></tr><tr><td align="left">日志文件</td><td align="left">/var/log/ntpstats</td><td align="left">/var/log/chrony</td></tr></tbody></table><p>客户端</p><table><thead><tr><th align="left">命令</th><th align="left">ntpdate</th><th align="left">timedatectl</th></tr></thead><tbody><tr><td align="left"></td><td align="left">ntpdate 172.25.0.11</td><td align="left">timedatectl set-ntp 1</td></tr></tbody></table><h3 id="项目实践1：配置ntp时间同步服务器"><a href="#项目实践1：配置ntp时间同步服务器" class="headerlink" title="项目实践1：配置ntp时间同步服务器"></a>项目实践1：配置ntp时间同步服务器</h3><p>rhel6 软件</p><p>ntp-4.2.6p5-1.el6.x86_64</p><h4 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h4><p>NTP安全设置(restrict)</p><p>运行一个NTP Server不需要占用很多的系统资源,所以也不用专门配置独立的服务器,就可以给许多client提供时间同步服务, 但是一些基本的安全设置还是很有必要的那么这里一个很简单的思路就是第一我们只允许局域网内一部分的用户连接到我们的服务器. 第二个就是这些client不能修改我们服务器上的时间</p><p>driftfile /var/lib/ntp/drift  #侦测BIOS时钟与Linux系统时间的差异写入次文件。</p><p>利用restrict 来管理权限控制</p><p>Restrict [IP]  mask [netmask_IP] [parameter]</p><p>Parameter 的参数主要如下：</p><ul><li>ignore :拒绝所有类型的NTP联机。</li><li>nomodify: 客户端不能使用ntpc 与ntpq 这两个程序来修改服务器的时间参数，但客户端可透过这部主机来进行网络校时；</li><li>noquery:客户端不能够使用ntpc 与ntpq 等指令来查询时间服务器，不提供NTP的网络校时。</li><li>notrap:不提供trap 这个运程事件登入的功能。</li><li>notrust:拒绝没有认证的客户端。</li><li>Kod:kod技术可以阻止“Kiss of Death “包对服务器的破坏。拒绝服务攻击</li><li>Nopeer:不与其他同一层的NTP服务器进行时间同步。</li></ul><p>利用server 设定上层NTP服务器，格式如下：</p><p>server [IP or hostname] [prefer]</p><ul><li><p>perfer:表示优先级最高</p></li><li><p>burst ：当一个运程NTP服务器可用时，向它发送一系列的并发包进行检测。</p></li><li><p>iburst ：当一个运程NTP服务器不可用时，向它发送一系列的并发包进行检测。</p><p>注：默认情况小15分钟后才会与上层NTP服务器进行时间校对。</p></li></ul><blockquote><p>谁能来同步我的时间？</p></blockquote><p>首先我们对于默认的client拒绝所有的操作</p><p>代码:<br><code>restrict default kod nomodify notrap nopeer noquery</code></p><p>然后允许本机地址一切的操作</p><p>代码:<br><code>restrict 127.0.0.1</code></p><p>最后我们允许局域网内所有client连接到这台服务器同步时间.但是拒绝让他们修改服务器上的时间</p><p>代码:<br><code>restrict 172.25.0.0 mask 255.255.255.0 nomodify</code></p><blockquote><p>我去同步谁的时间？</p></blockquote><p>server     时间同步服务器    层数比我高的，及数字比我小的</p><p>代码:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server  127.127.1.0     # local clock</span><br><span class="line">fudge   127.127.1.0 stratum 10</span><br></pre></td></tr></table></figure><p>####　详细步骤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器端</span></span><br><span class="line"></span><br><span class="line">[root@rhel6 ~]# yum install -y ntp</span><br><span class="line">[root@rhel6 ~]# vim /etc/ntp.conf</span><br><span class="line">[root@rhel6 ~]# grep -v "^#" /etc/ntp.conf|grep -v "^$"</span><br><span class="line">driftfile /var/lib/ntp/drift</span><br><span class="line">restrict default kod nomodify notrap nopeer noquery</span><br><span class="line">restrict -6 default kod nomodify notrap nopeer noquery</span><br><span class="line">restrict 127.0.0.1</span><br><span class="line">restrict -6 ::1</span><br><span class="line">restrict 172.25.0.0 mask 255.255.255.0 nomodify</span><br><span class="line">server 172.25.0.11</span><br><span class="line">server  127.127.1.0     </span><br><span class="line">fudge   127.127.1.0 stratum 10</span><br><span class="line">includefile /etc/ntp/crypto/pw</span><br><span class="line">keys /etc/ntp/keys</span><br><span class="line">[root@rhel6 ~]# service ntpd start</span><br><span class="line">Starting ntpd:                                             [  OK  ]</span><br><span class="line">[root@rhel6 ~]# service iptables stop</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端</span></span><br><span class="line">[root@rhel7 ~]# which ntpdate</span><br><span class="line">/usr/sbin/ntpdate</span><br><span class="line">[root@rhel7 ~]# rpm -qf /usr/sbin/ntpdate</span><br><span class="line">ntpdate-4.2.6p5-18.el7.x86_64</span><br><span class="line">[root@rhel7 ~]# systemctl stop firewalld</span><br><span class="line">[root@rhel7 ~]# ntpdate 172.25.0.11</span><br><span class="line"> 2 Aug 06:36:51 ntpdate[8128]: step time server 172.25.0.11 offset -0.691491 sec</span><br><span class="line">[root@rhel7 ~]# date -s "2016-08-01"</span><br><span class="line">Mon Aug  1 00:00:00 EDT 2016</span><br><span class="line">[root@rhel7 ~]# date</span><br><span class="line">Mon Aug  1 00:00:01 EDT 2016</span><br><span class="line">[root@rhel7 ~]# ntpdate 172.25.0.11</span><br><span class="line"> 2 Aug 06:37:35 ntpdate[8140]: step time server 172.25.0.11 offset 110240.425235 sec</span><br><span class="line">[root@rhel7 ~]# date</span><br><span class="line">Tue Aug  2 06:37:37 EDT 2016</span><br></pre></td></tr></table></figure><h4 id="一些补充和拾遗（挺重要）"><a href="#一些补充和拾遗（挺重要）" class="headerlink" title="一些补充和拾遗（挺重要）"></a>一些补充和拾遗（挺重要）</h4><ol><li><p>配置文件中的driftfile是什么?<br>我们每一个system clock的频率都有小小的误差,这个就是为什么机器运行一段时间后会不精确.NTP会自动来监测我们时钟的误差值并予以调整.但问题是这是一个冗长的过程,所以它会把记录下来的误差先写入driftfile.这样即使你重新开机以后之前的计算结果也就不会丢失了</p></li><li><p>如何同步硬件时钟?<br>NTP一般只会同步system clock. 但是如果我们也要同步RTC(hwclock)的话那么只需要把下面的选项打开就可以了</p></li></ol><p>代码:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/ntpd</span></span><br><span class="line">SYNC_HWCLOCK=yes</span><br></pre></td></tr></table></figure><ol start="3"><li>让rhel6运行ntpdate更新时间时，rhel6同步失败，会提示端口被占用：如下<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 ~]# ntpdate 172.25.0.11</span><br><span class="line"> 2 Aug 18:39:16 ntpdate[4831]: the NTP socket is in use, exiting</span><br></pre></td></tr></table></figure></li><li>利用crontab让rhel7 NTP定时更新时间<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 8 * * * /usr/sbin/ntpdate 172.25.0.11</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="chrony"><a href="#chrony" class="headerlink" title="chrony"></a>chrony</h3><p>chrony-1.29.1-1.el7.x86_64</p><p>RHEL从7.0开始改用chrony同步时间，原ntp同步方式也可以使用，但要安装ntp服务。</p><p>chronyd是一个在系统后台运行的守护进程。他根据网络上其他时间服务器时间来测量本机时间的偏移量从而调整系统时钟。对于孤立系统，用户可以手动周期性的输入正确时间（通过chronyc）。在这两种情况下，chronyd决定计算机快慢的比例，并加以纠正。chronyd实现了NTP协议并且可以作为服务器或客户端。</p><h4 id="项目实践2：配置chrony时间同步服务器"><a href="#项目实践2：配置chrony时间同步服务器" class="headerlink" title="项目实践2：配置chrony时间同步服务器"></a>项目实践2：配置chrony时间同步服务器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# yum install -y chrony</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# vim /etc/chrony.conf</span><br><span class="line">[root@rhel7 ~]# grep -v "^#" /etc/chrony.conf |grep -v "^$"</span><br><span class="line">server 172.25.0.10</span><br><span class="line">allow 172.25.0.0/24</span><br><span class="line">stratumweight 0</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">rtcsync</span><br><span class="line">makestep 10 3</span><br><span class="line">bindcmdaddress 127.0.0.1</span><br><span class="line">bindcmdaddress ::1</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">commandkey 1</span><br><span class="line">generatecommandkey</span><br><span class="line">noclientlog</span><br><span class="line">logchange 0.5</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">[root@rhel7 ~]# timedatectl</span><br><span class="line">      Local time: Tue 2016-08-02 07:24:15 EDT</span><br><span class="line">  Universal time: Tue 2016-08-02 11:24:15 UTC</span><br><span class="line">        RTC time: Tue 2016-08-02 11:24:15</span><br><span class="line">        Timezone: America/New_York (EDT, -0400)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: no</span><br><span class="line">      DST active: yes</span><br><span class="line"> Last DST change: DST began at</span><br><span class="line">                  Sun 2016-03-13 01:59:59 EST</span><br><span class="line">                  Sun 2016-03-13 03:00:00 EDT</span><br><span class="line"> Next DST change: DST ends (the clock jumps one hour backwards) at</span><br><span class="line">                  Sun 2016-11-06 01:59:59 EDT</span><br><span class="line">                  Sun 2016-11-06 01:00:00 EST</span><br></pre></td></tr></table></figure><h3 id="项目汇总"><a href="#项目汇总" class="headerlink" title="项目汇总"></a>项目汇总</h3><p><img src="sides/ntp-lab_Page_1.jpg" alt="ntp-lab_Page_1"></p><p><img src="sides/ntp-lab_Page_2.jpg" alt="ntp-lab_Page_2"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;left&quot;&gt;服务&lt;/th&gt;
&lt;th align=&quot;left&quot;&gt;域名解析服务&lt;/th&gt;
&lt;th align=&quot;left&quot;&gt;文件共享服务&lt;/th&gt;
&lt;th align=&quot;left&quot;&gt;&lt;/th&gt;
&lt;th align=&quot;le
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>防火墙 iptables</title>
    <link href="http://www.toberoot.com/2016/12/23/booboo_easy_service/07_iptables_firewalld/"/>
    <id>http://www.toberoot.com/2016/12/23/booboo_easy_service/07_iptables_firewalld/</id>
    <published>2016-12-22T21:06:27.000Z</published>
    <updated>2020-03-24T05:02:31.697Z</updated>
    
    <content type="html"><![CDATA[<h3 id="防火墙的作用"><a href="#防火墙的作用" class="headerlink" title="防火墙的作用"></a>防火墙的作用</h3><p>防火墙是一个组件，工作在网络边缘（主机边缘），对进出网络数据包基于一定的规则检查，并在匹配某规则时由规则定义的处理进行处理的一组功能的组件。</p><h3 id="防火墙类型"><a href="#防火墙类型" class="headerlink" title="防火墙类型"></a>防火墙类型</h3><p>根据工作的层次的不同来划分，常见的防火墙工作在OSI第三层，即网络层防火墙，工作在OSI第七层的称为应用层防火墙，或者代理服务器（代理网关）。</p><p>网络层防火墙又称包过滤防火墙，在网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议状态等因素来确定是否允许该数据包的通过，以及数据包的流向等。</p><p>还可以分为硬件防火墙和软件防火墙</p><h3 id="软件防火墙"><a href="#软件防火墙" class="headerlink" title="软件防火墙"></a>软件防火墙</h3><ul><li>EL6上的防火墙叫做iptables。</li><li>EL7上的防火墙叫做firewalld。</li></ul><h3 id="iptables语法"><a href="#iptables语法" class="headerlink" title="iptables语法"></a>iptables语法</h3><p>iptables -t table CMD chain rule-matcher -j target</p><pre><code>表      动作 链    规则匹配       执行操作</code></pre><h4 id="表table"><a href="#表table" class="headerlink" title="表table"></a>表table</h4><p>使用 -t 来指定表,如果省略,则代表对 filter 表进行操作</p><ul><li>filter 表:用于过滤数据包</li><li>nat 表:用于修改数据包的来源和目的地</li><li>mangle 表:用户修改数据包的生存周期等等</li><li>raw 表:跟踪机制</li></ul><h4 id="CMD动作"><a href="#CMD动作" class="headerlink" title="CMD动作"></a>CMD动作</h4><ul><li>A 追加</li><li>I 插入</li><li>D 删除</li><li>L 罗列</li><li>F 清空</li></ul><h4 id="表当中包含链chain"><a href="#表当中包含链chain" class="headerlink" title="表当中包含链chain"></a>表当中包含链chain</h4><p>链是用来区分数据包的流向状态</p><ul><li>INPUT 入站的数据包</li><li>OUTPUT 出站的数据包</li><li>PREROUTING 路由判断之前的数据包</li><li>POSTROUTING 路由判断之后的数据包</li><li>FORWARD 第一次路由判断之后,到最后一词路由判断之前</li></ul><h4 id="规则rule"><a href="#规则rule" class="headerlink" title="规则rule"></a>规则rule</h4><p>是用来判断数据包的具体情况</p><ul><li>-p 协议</li><li>-s 来源</li><li>-d 目的地</li><li>–sport 来源端口</li><li>–dport 目的端口</li><li>-i 入站网络接口</li><li>-o 出站网络接口</li><li>! 取反</li></ul><h4 id="执行操作target"><a href="#执行操作target" class="headerlink" title="执行操作target"></a>执行操作target</h4><ul><li>ACCEPT 接受</li><li>DROP 丢弃</li><li>REJECT 拒绝</li><li>DNAT 目标地址转换</li><li>SNAT 源地址转换</li></ul><h3 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h3><ol start="0"><li>查看规则    <code>iptables -L</code></li><li>规则清空    <code>iptables -F</code></li><li>预选策略    <code>iptables -P INPUT ACCEPT</code></li><li>保存策略    <code>service iptables save</code> or <code>iptables-save &gt; /etc/sysconfig/iptables</code></li><li>开机后重新导入    <code>iptables-restore &lt; /etc/sysconfig/iptables</code></li></ol><blockquote><p>只允许172.25.0.250和你自己的服务器能够访问ftp服务（rhel6）</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.25.0.250 -p tcp --dport 21 -j  ACCEPT</span><br><span class="line">iptables -A INPUT -s 172.25.0.11 -p tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j DROP</span><br></pre></td></tr></table></figure><blockquote><p>禁止ping包</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp -j DROP</span><br></pre></td></tr></table></figure><blockquote><p>仅允许172.25.0.0/24网段和172.25.15.0/24网段用户能够访问我的邮件服务器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.25.0.0/24 -p tcp --dport 25 -j ACCEPT</span><br><span class="line">iptables -A INPUT -s 172.25.15.0/24 -p tcp --dport 25 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 25 -j DROP</span><br></pre></td></tr></table></figure><h3 id="课堂练习题目"><a href="#课堂练习题目" class="headerlink" title="课堂练习题目"></a>课堂练习题目</h3><p>rhel6 172.25.x.11</p><ol><li><p>清空规则</p></li><li><p>预设filter表INPUT是ACCEPT</p></li><li><p>仅允许172.25.254.250和172.25.254.X 能够ssh到我的服务器（rhel6 172.25.X.11）上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.25.254.250 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -s 172.25.254.16 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>仅允许172.25.254.0/24和172.25.X.0/24能够ping我的服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.25.254.0/24 -p icmp -j ACCEPT</span><br><span class="line">iptables -A INPUT -s 172.25.16.0/24 -p icmp -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icpm -j DROP</span><br></pre></td></tr></table></figure></li><li><p>不允许172.25.254.254访问我的邮件服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.25.254.254 -p tcp --dport 25 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>保存规则</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rhel6</span><br><span class="line">servcie iptables save</span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure></li><li><p>查看规则</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L</span><br></pre></td></tr></table></figure></li><li><p>关机重启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure></li></ol><h3 id="Firewalld的用法"><a href="#Firewalld的用法" class="headerlink" title="Firewalld的用法"></a>Firewalld的用法</h3><p>Firewalld是el7默认的防火墙，和iptables冲突，如果要使用其中之一，需要关闭另外一个</p><p>运行、停止、禁用firewalld:</p><ul><li>启动：<code>systemctl start  firewalld</code></li><li>查看状态：<code>systemctl status firewalld</code> 或者 <code>firewall-cmd --state</code></li><li>停止：<code>systemctl disable firewalld</code></li><li>禁用：<code>systemctl stop firewalld</code></li></ul><p>可以通过</p><ol><li>firewall-config图形化工具 来控制</li><li>firewall-cmd  命令行工具</li></ol><h4 id="Firewall-config"><a href="#Firewall-config" class="headerlink" title="Firewall-config"></a>Firewall-config</h4><ol><li>Configuration    runtime和permanent  分别是运行时和永久</li><li>zone 默认区域配置</li></ol><ul><li>Trusted：允许所有传入数据包</li><li>drop：默认丢弃所有包</li><li>block：拒绝所有外部连接，允许内部发起的连接</li><li>public：指定外部连接可以进入</li><li>external：这个不太明白，功能上和上面相同，允许指定的外部连接</li><li>dmz：和硬件防火墙一样，受限制的公共连接可以进入</li><li>work：工作区，概念和workgoup一样，也是指定的外部连接允许</li><li>home：类似家庭组</li><li>internal：信任所有连接</li></ul><ol start="3"><li>富规则：可用于表达基本的允许和拒绝规则。<br>Configuration  permenent</li></ol><p><img src="pic/21.png" alt="21"></p><p>左上角：Option  reloade firewall<br>Ssh就无法登陆了</p><h4 id="firewall-cmd"><a href="#firewall-cmd" class="headerlink" title="firewall-cmd"></a>firewall-cmd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-rich-rule=\'rule family=ipv4 service name="ssh" source address=192.168.137.11 log prefix="ssh" level="notice" limit value="3/m" reject\'</span><br></pre></td></tr></table></figure><p>将来自于192.168.137.11的ssh拒绝掉，并且将notice以上的日志写入到ssh日志当中，限制每分钟最多三条记录。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;防火墙的作用&quot;&gt;&lt;a href=&quot;#防火墙的作用&quot; class=&quot;headerlink&quot; title=&quot;防火墙的作用&quot;&gt;&lt;/a&gt;防火墙的作用&lt;/h3&gt;&lt;p&gt;防火墙是一个组件，工作在网络边缘（主机边缘），对进出网络数据包基于一定的规则检查，并在匹配某规则时由规则定义
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux简易服务教程" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%AE%80%E6%98%93%E6%9C%8D%E5%8A%A1%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux基础服务" scheme="http://www.toberoot.com/tags/Linux%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
</feed>
