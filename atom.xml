<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Amy and Booboo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.toberoot.com/"/>
  <updated>2020-03-22T14:23:51.136Z</updated>
  <id>http://www.toberoot.com/</id>
  
  <author>
    <name>BoobooWei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://www.toberoot.com/2020/03/22/hello-world/"/>
    <id>http://www.toberoot.com/2020/03/22/hello-world/</id>
    <published>2020-03-22T14:23:51.136Z</published>
    <updated>2020-03-22T14:23:51.136Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="Hexo" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/Hexo/"/>
    
    
      <category term="hexo" scheme="http://www.toberoot.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>国庆前学洗手</title>
    <link href="http://www.toberoot.com/2018/09/30/%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/"/>
    <id>http://www.toberoot.com/2018/09/30/%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/</id>
    <published>2018-09-30T10:43:53.000Z</published>
    <updated>2020-03-22T08:31:38.472Z</updated>
    
    <content type="html"><![CDATA[<p>今天人少，我们坐小月亮，然后给他们每人用了免洗洗手液，洗小手，国庆节出去不要忘记带哦</p><a id="more"></a><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0NDI5Ng==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p><p><img src="%E5%9B%BD%E5%BA%86%E5%89%8D%E5%AD%A6%E6%B4%97%E6%89%8B/01.jpg" alt=""></p><p>君君老师:<br>他们让我发给你们😂</p><p>小慈的晚托班制作五星红旗</p><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0OTg4MA==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天人少，我们坐小月亮，然后给他们每人用了免洗洗手液，洗小手，国庆节出去不要忘记带哦&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>宝宝们上班啦</title>
    <link href="http://www.toberoot.com/2018/09/29/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/"/>
    <id>http://www.toberoot.com/2018/09/29/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/</id>
    <published>2018-09-29T10:43:41.000Z</published>
    <updated>2020-03-22T08:31:38.457Z</updated>
    
    <content type="html"><![CDATA[<p>君君老师:<br>最近我们孩子的角色游戏慢慢进入状态了，但也有几个孩子沉迷于积木游戏无法自拔，我们希望家长们在家里也可以和孩子们一起玩角色扮演游戏，和孩子多互动，也可以拓宽思路，可以做现实生活中不能做的，比如仙女啊，公主啊，小士兵等等</p><a id="more"></a><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/01.jpg" alt=""></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/02.jpg" alt="02"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/03.jpg" alt="03"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/04.jpg" alt="04"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/05.jpg" alt="05"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/06.jpg" alt="06"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/07.jpg" alt="07"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/08.jpg" alt="08"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/09.jpg" alt="09"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/10.jpg" alt="10"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/11.jpg" alt="11"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/12.jpg" alt="12"></p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E4%B8%8A%E7%8F%AD%E5%95%A6/13.jpg" alt="13"></p><p>君君老师:<br>今天我们还认识了五星红旗，知道自己是一个中国人，我告诉他们过几天要给祖国妈妈过生日了，要休息七天，有孩子还反驳说不行，休息三天就够了，哈哈我还告诉他们祖国妈妈会请他们吃生日蛋糕的</p><p>午餐前还额外学了一首歌，送给我们的祖国妈妈</p><p><a href="https://music.163.com/#/song?id=498555737&market=baiduqk" target="_blank" rel="noopener">儿歌-祖国祖国我爱你</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;君君老师:&lt;br&gt;最近我们孩子的角色游戏慢慢进入状态了，但也有几个孩子沉迷于积木游戏无法自拔，我们希望家长们在家里也可以和孩子们一起玩角色扮演游戏，和孩子多互动，也可以拓宽思路，可以做现实生活中不能做的，比如仙女啊，公主啊，小士兵等等&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>月饼烘培和小小搬运工</title>
    <link href="http://www.toberoot.com/2018/09/21/%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/"/>
    <id>http://www.toberoot.com/2018/09/21/%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/</id>
    <published>2018-09-21T12:25:51.000Z</published>
    <updated>2020-03-22T08:31:38.460Z</updated>
    
    <content type="html"><![CDATA[<p>中秋节快到了，老师带宝宝们一起做了月饼，拿去烤了，宝宝们还帮老师一起搬桌子，虽然结局差强人意，但是孩子们都很开心呢！</p><a id="more"></a><p align="center"><embed src='http://player.youku.com/player.php/sid/XMzg0Mzk0NDg5Ng==/v.swf' allowFullScreen='true' quality='high' width='480' height='400' align='middle' allowScriptAccess='always' type='application/x-shockwave-flash'></embed></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/01.jpg" alt=""></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/02.jpg" alt="02"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/03.jpg" alt="03"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/04.jpg" alt="04"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/05.jpg" alt="05"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/06.jpg" alt="06"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/07.jpg" alt="07"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/08.jpg" alt="08"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/09.jpg" alt="09"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/20.jpg" alt="20"></p><p><img src="%E6%9C%88%E9%A5%BC%E7%83%98%E5%9F%B9%E5%92%8C%E5%B0%8F%E5%B0%8F%E6%90%AC%E8%BF%90%E5%B7%A5/00.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;中秋节快到了，老师带宝宝们一起做了月饼，拿去烤了，宝宝们还帮老师一起搬桌子，虽然结局差强人意，但是孩子们都很开心呢！&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>宝宝们开始漱口了</title>
    <link href="http://www.toberoot.com/2018/09/20/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/"/>
    <id>http://www.toberoot.com/2018/09/20/%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/</id>
    <published>2018-09-20T12:08:51.000Z</published>
    <updated>2020-03-22T08:31:38.469Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～</p><a id="more"></a><p>君君老师语录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">各位亲们，通过昨天的家长会，我们看到了家长回去的努力，今天午饭明显进步的宝宝有：@张瑾安妈妈 @操梓桐妈妈 @但颐宸妈妈 @何晟睿妈妈 @张恬觅妈妈 @严魏慈妈妈 @王晟宁妈妈 ，其他宝宝们继续加油哦～</span><br><span class="line"></span><br><span class="line">吃饭我们是和孩子们说：小汽车装装满，转弯送到山洞里，滑滑梯滑到肚子里，因为很多宝宝勺子不对着嘴巴，所以饭宝宝掉在桌子上都哭了。</span><br><span class="line"></span><br><span class="line">另外，今天我们练习了宝宝们排队走楼梯，大多数已经像模像样的了，上下楼梯靠右走了，今天的运动量有点大，所以估计宝贝们今晚又要早早睡觉了.</span><br></pre></td></tr></table></figure><p>今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～</p><p><img src="%E5%AE%9D%E5%AE%9D%E4%BB%AC%E5%BC%80%E5%A7%8B%E6%BC%B1%E5%8F%A3%E4%BA%86/01.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：今天开始我们让宝宝们开始漱口了，所以回家也要继续保持这个好习惯哦～&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>家长会</title>
    <link href="http://www.toberoot.com/2018/09/19/%E5%AE%B6%E9%95%BF%E4%BC%9A/"/>
    <id>http://www.toberoot.com/2018/09/19/%E5%AE%B6%E9%95%BF%E4%BC%9A/</id>
    <published>2018-09-19T11:40:55.000Z</published>
    <updated>2020-03-22T08:31:38.466Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：幼儿园开学第10天，宝宝们逐渐稳定，融入这个大家庭，今天老师和我们分享宝宝们的幼儿园日常生活，以及我们对我们家长的一些建议，非常地用心。</p><a id="more"></a><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/001.jpg" alt=""></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/002.jpg" alt="002"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/003.jpg" alt="003"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/004.jpg" alt="004"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/005.jpg" alt="005"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/006.jpg" alt="006"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/007.jpg" alt="007"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/008.jpg" alt="008"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/010.jpg" alt="010"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/011.jpg" alt="011"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/012.jpg" alt="012"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/013.jpg" alt="013"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/014.jpg" alt="014"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/015.jpg" alt="015"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/016.jpg" alt="016"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/017.jpg" alt="017"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/018.jpg" alt="018"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/019.jpg" alt="019"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/020.jpg" alt="020"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/021.jpg" alt="021"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/022.jpg" alt="022"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/023.jpg" alt="023"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/024.jpg" alt="024"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/025.jpg" alt="025"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/026.jpg" alt="026"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/027.jpg" alt="027"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/028.jpg" alt="028"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/029.jpg" alt="029"></p><p><img src="%E5%AE%B6%E9%95%BF%E4%BC%9A/030.jpg" alt="030"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：幼儿园开学第10天，宝宝们逐渐稳定，融入这个大家庭，今天老师和我们分享宝宝们的幼儿园日常生活，以及我们对我们家长的一些建议，非常地用心。&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>向月亮说晚安</title>
    <link href="http://www.toberoot.com/2018/09/10/%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/"/>
    <id>http://www.toberoot.com/2018/09/10/%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/</id>
    <published>2018-09-10T11:26:39.000Z</published>
    <updated>2020-03-22T08:31:38.463Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：今天中午讲了一个关于「晚安，月亮」的睡前故事，最后猫头鹰对月亮说了晚安，大家今天睡前还可以和宝宝说哦，再加一些其他的动物宝宝</p><a id="more"></a><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/01.jpg" alt=""></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/02.jpg" alt="02"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/03.jpg" alt="03"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/04.jpg" alt="04"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/05.jpg" alt="05"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/06.jpg" alt="06"></p><p><img src="%E5%90%91%E6%9C%88%E4%BA%AE%E8%AF%B4%E6%99%9A%E5%AE%89/07.jpg" alt="07"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：今天中午讲了一个关于「晚安，月亮」的睡前故事，最后猫头鹰对月亮说了晚安，大家今天睡前还可以和宝宝说哦，再加一些其他的动物宝宝&lt;/p&gt;
    
    </summary>
    
    
      <category term="往昔追忆" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/"/>
    
      <category term="小二班" scheme="http://www.toberoot.com/categories/%E5%BE%80%E6%98%94%E8%BF%BD%E5%BF%86/%E5%B0%8F%E4%BA%8C%E7%8F%AD/"/>
    
    
      <category term="宝宝成长" scheme="http://www.toberoot.com/tags/%E5%AE%9D%E5%AE%9D%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>突破阿里限制实现&quot;RDS For MySQL 5.7到自建MySQL主从&quot;</title>
    <link href="http://www.toberoot.com/2018/08/22/rds-for-mysql-5-7%E5%88%B0%E8%87%AA%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E4%B9%8B%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3user%E8%A1%A8%E5%AE%9E%E7%8E%B0%E4%BB%8E%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%9B%B4%E6%94%B9%E5%8A%9F%E8%83%BD/"/>
    <id>http://www.toberoot.com/2018/08/22/rds-for-mysql-5-7%E5%88%B0%E8%87%AA%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E4%B9%8B%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3user%E8%A1%A8%E5%AE%9E%E7%8E%B0%E4%BB%8E%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%9B%B4%E6%94%B9%E5%8A%9F%E8%83%BD/</id>
    <published>2018-08-22T10:41:15.000Z</published>
    <updated>2020-03-22T08:32:42.581Z</updated>
    
    <content type="html"><![CDATA[<p>摘要: 阿里云的RDS For MySQL 5.7 到线下IDC机房的主从搭建相信看官方文档就可以完成，但是搭建之后却发现无法在本地进行认证权限的管理，这是为何？而阿里官方推荐使用DTS同步工具去实现，这个费用着实不少，又是否能够破解呢？本文详解如何暴力破解user表实现从库用户权限更改功能</p><a id="more"></a><h1 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h1><h2 id="数据库明细"><a href="#数据库明细" class="headerlink" title="数据库明细"></a>数据库明细</h2><p>说在前面：</p><ul><li>云上数据库： RDS For MySQL 5.7.20 普通用户权限</li><li>IDC数据库: MySQL 5.7.20 </li></ul><h2 id="故事情节"><a href="#故事情节" class="headerlink" title="故事情节"></a>故事情节</h2><p>现需要搭建RDS For MySQL 到线下IDC机房的主从，问题如下：</p><h3 id="同步系统表失败"><a href="#同步系统表失败" class="headerlink" title="同步系统表失败"></a>同步系统表失败</h3><h4 id="故障原因"><a href="#故障原因" class="headerlink" title="故障原因"></a>故障原因</h4><ul><li>RDS For MySQL 5.7.20 到自建MySQL 5.7.20主从同步异常的原因为RDS与MySQL官方版本使用的系统库不同</li><li>自建MySQL 5.7.20 无法同步主库RDS的系统表</li><li>自建MySQL 5.7.20 恢复RDS的全备份数据后无法执行授权语句,报错如下：</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1785 (HY000): Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.</span><br></pre></td></tr></table></figure><ul><li>自建MySQL 5.7.20 恢复RDS的全备份数据后无法对系统表执行更新操作，报错如下：</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1064 (42000): Unknown trigger has an error in its body: 'Unknown system variable 'maintain_user_list''</span><br></pre></td></tr></table></figure><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><ul><li>跳过系统表的同步</li></ul><hr><h3 id="从库添加认证授权失败"><a href="#从库添加认证授权失败" class="headerlink" title="从库添加认证授权失败"></a>从库添加认证授权失败</h3><p>RDS For MySQL 5.7.20 到自建MySQL 5.7.20 搭建主从同步架构:</p><ul><li>配置从库不同步RDS主库的系统表</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># skip rep</span><br><span class="line">replicate_wild_ignore_table&#x3D;mysql.%</span><br><span class="line">replicate_wild_ignore_table&#x3D;sys.%</span><br><span class="line">replicate_wild_ignore_table&#x3D;information_schema.%</span><br></pre></td></tr></table></figure><ul><li><strong>非系统库数据同步正常</strong></li><li>从库无法执行grant命令，即无法添加授权信息</li><li>从库无法对系统表mysql.user表执行insert操作</li><li>从库无法对系统表mysql.user表执行updat操作</li></ul><p>报错如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1064 (42000): Unknown trigger has an error in its body: 'Unknown system variable 'maintain_user_list''</span><br></pre></td></tr></table></figure><h4 id="失败原因"><a href="#失败原因" class="headerlink" title="失败原因"></a>失败原因</h4><p><strong>阿里工单答复</strong>：RDS 目前已经不支持 MYISAM 引擎创建了。所以如果是通过自建的replication 同步 就会有这个问题的，RDS 统一INNOB 引擎。<br>如果需求是从RDS 到自建数据库的同步关系，建议您使用DTS 做业务数据的同步。</p><h4 id="探索解决方法"><a href="#探索解决方法" class="headerlink" title="探索解决方法"></a>探索解决方法</h4><h5 id="从库尝试使用MySQL8-0-11"><a href="#从库尝试使用MySQL8-0-11" class="headerlink" title="从库尝试使用MySQL8.0.11"></a>从库尝试使用<code>MySQL8.0.11</code></h5><p>RDS For MySQL 5.7的备份文件 到线下自建MYSQL 8.0.11 无法恢复数据。因此该方法不可行。</p><h5 id="尝试临时关闭GTID模式"><a href="#尝试临时关闭GTID模式" class="headerlink" title="尝试临时关闭GTID模式"></a>尝试临时关闭GTID模式</h5><ol><li>临时停止slave同步</li><li>修改配置关闭gtid模式</li><li>重启服务</li></ol><p>对系统表mysql.user测试明细：</p><table><thead><tr><th>No.</th><th>测试项目</th><th>结果</th></tr></thead><tbody><tr><td>1</td><td>是否能够执行grant命令</td><td>×</td></tr><tr><td>2</td><td>是否能够执行update命令</td><td>×</td></tr><tr><td>3</td><td>是否能够执行insert命令</td><td>×</td></tr></tbody></table><p>该方法同样无法解决。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 权限相关的一些表：</span></span><br><span class="line">SCHEMA_PRIVILEGES：提供了数据库的相关权限，这个表是内存表是从mysql.db中拉去出来的。</span><br><span class="line">TABLE_PRIVILEGES:提供的是表权限相关信息，信息是从 mysql.tables_priv 表中加载的</span><br><span class="line">COLUMN_PRIVILEGES ：这个表可以清楚就能看到表授权的用户的对象，那张表那个库以及授予的是什么权限，如果授权的时候加上with grant option的话，我们可以看得到PRIVILEGE_TYPE这个值必须是YES。</span><br><span class="line">USER_PRIVILEGES:提供的是表权限相关信息，信息是从 mysql.user 表中加载的</span><br><span class="line">通过表我们可以很清晰看得到MySQL授权的层次，SCHEMA，TABLE，COLUMN级别，当然这些都是基于用户来授予的</span><br></pre></td></tr></table></figure><p>从数据库用户权限管理的原理可以了解到管理用户的是<code>user</code>表，如果要更细致的权限还需要<code>db</code>表和<code>tables_priv</code>表。<em>（本文只从user表着手）</em></p><h3 id="步骤概览"><a href="#步骤概览" class="headerlink" title="步骤概览"></a>步骤概览</h3><ol><li>创建新的user_1表</li><li>对user_1表添加新的用户</li><li>停服务</li><li>将user_1替换user表</li><li>启动该服务</li><li>可以通过update、insert、delete操作user表来添加权限（grant无法操作）</li></ol><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">root@MySQL-01 10:35:  [mysql]&gt; create table user_1 like user;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select * from user_1;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like user;</span><br><span class="line">ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'user' at line 1</span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like 'user_1';</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| Name   | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation | Checksum | Create_options | Comment                     |</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| user_1 | MyISAM |      10 | Dynamic    |    0 |              0 |           0 | 281474976710655 |         1024 |         0 |           NULL | 2019-01-04 10:36:00 | 2019-01-04 10:36:00 | NULL       | utf8_bin  |     NULL |                | Users and global privileges |</span><br><span class="line">+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; show table status like 'user';</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time          | Collation | Checksum | Create_options | Comment                     |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">| user | MyISAM |      10 | Dynamic    |    3 |             53 |         160 | 281474976710655 |         2048 |         0 |           NULL | 2015-05-22 15:24:42 | 2019-01-04 09:27:49 | 2015-05-22 15:33:22 | utf8_bin  |     NULL |                | Users and global privileges |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+---------------------+-----------+----------+----------------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; insert into user_1 select * from user;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select * from user_1;</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">| Host      | User | Password | Select_priv | Insert_priv | Update_priv | Delete_priv | Create_priv | Drop_priv | Reload_priv | Shutdown_priv | Process_priv | File_priv | Grant_priv | References_priv | Index_priv | Alter_priv | Show_db_priv | Super_priv | Create_tmp_table_priv | Lock_tables_priv | Execute_priv | Repl_slave_priv | Repl_client_priv | Create_view_priv | Show_view_priv | Create_routine_priv | Alter_routine_priv | Create_user_priv | Event_priv | Trigger_priv | Create_tablespace_priv | ssl_type | ssl_cipher | x509_issuer | x509_subject | max_questions | max_updates | max_connections | max_user_connections | plugin | authentication_string |</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">| localhost | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">| 127.0.0.1 | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">| ::1       | root |          | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |</span><br><span class="line">+-----------+------+----------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; select user,host,authentication_string from user_1;</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">| user | host      | authentication_string |</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">| root | localhost |                       |</span><br><span class="line">| root | 127.0.0.1 |                       |</span><br><span class="line">| root | ::1       |                       |</span><br><span class="line">+------+-----------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:36:  [mysql]&gt; update user_1 set authentication_string=password('(Uploo00king)') where user='root';</span><br><span class="line">Query OK, 3 rows affected, 1 warning (0.01 sec)</span><br><span class="line">Rows matched: 3  Changed: 3  Warnings: 1</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:37:  [mysql]&gt; select user,host,authentication_string from user_1;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:37:  [mysql]&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@sh_02 data]# /etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@sh_02 mysql]# ll user_1*</span><br><span class="line">-rw-r-----. 1 mysql mysql 10630 Jan  4 10:36 user_1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql   328 Jan  4 10:37 user_1.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  2048 Jan  4 10:37 user_1.MYI</span><br><span class="line">[root@sh_02 mysql]# mv user_1.frm user.frm</span><br><span class="line">[root@sh_02 mysql]# mv user_1.MYD user.MYD</span><br><span class="line">[root@sh_02 mysql]# mv user_1.MYI user.MYI</span><br><span class="line">[root@sh_02 mysql]# ll user*</span><br><span class="line">-rw-r-----. 1 mysql mysql 10630 Jan  4 10:36 user.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql   328 Jan  4 10:37 user.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  2048 Jan  4 10:37 user.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql  3989 Aug 14 09:14 user_view.frm</span><br><span class="line">[root@sh_02 mysql]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@sh_02 mysql]# mysql -uroot -p'(Uploo00king)'</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| db1                |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [(none)]&gt; use mysql</span><br><span class="line">Database changed</span><br><span class="line">root@MySQL-01 10:39:  [mysql]&gt; select user,host from mysql.user;</span><br><span class="line">+------+-----------+</span><br><span class="line">| user | host      |</span><br><span class="line">+------+-----------+</span><br><span class="line">| root | 127.0.0.1 |</span><br><span class="line">| root | ::1       |</span><br><span class="line">| root | localhost |</span><br><span class="line">+------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 10:39:  [mysql]&gt; grant all on *.* to booboo@'%' identified by '(Uploo00king)';</span><br><span class="line">ERROR 1785 (HY000): Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 11:39:  [mysql]&gt; update mysql.user_1 set user='aliyun_root' where host='127.0.0.1';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 11:40:  [mysql]&gt; select user,host from mysql.user_1;</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| user        | host      |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| aliyun_root | 127.0.0.1 |</span><br><span class="line">| root        | ::1       |</span><br><span class="line">| root        | localhost |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">aliyun_root@MySQL-01 11:51:  [mysql]&gt; insert into mysql.user values ('%','jowing', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('Joowing@2017'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">aliyun_root@MySQL-01 11:51:  [mysql]&gt; select user,host from  mysql.user;</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| user        | host      |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">| jowing      | %         |</span><br><span class="line">| aliyun_root | 127.0.0.1 |</span><br><span class="line">| root        | ::1       |</span><br><span class="line">| root        | localhost |</span><br><span class="line">+-------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h3><h4 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h4><p>目标：IDC机房从库支持通过insert、update、delete命令来修改用户权限，权限比较简单，分为只读和写。</p><p>需要设置以下权限：权限作用于所有的库多有的表</p><table><thead><tr><th align="left">用户名</th><th align="left">密码</th><th align="left">权限</th></tr></thead><tbody><tr><td align="left">root</td><td align="left">123</td><td align="left">读写</td></tr><tr><td align="left">joowingbuz</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">ottersync</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">syncdw</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">datasis</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">joowingv</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">datadev</td><td align="left">123</td><td align="left">只读</td></tr><tr><td align="left">readonly</td><td align="left">123</td><td align="left">只读</td></tr></tbody></table><h4 id="步骤概览-1"><a href="#步骤概览-1" class="headerlink" title="步骤概览"></a>步骤概览</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 登陆数据库后操作如下：</span></span><br><span class="line">use mysql;</span><br><span class="line">create table user_1 like user;</span><br><span class="line">insert into user_1 select * from user;</span><br><span class="line">delete from mysql.user_1 where user='root';</span><br><span class="line">insert into mysql.user_1 values ('%','root', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','joowingbuz', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','ottersync', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','syncdw', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','datasis', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','joowingv', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','datadev', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">insert into mysql.user_1 values ('%','readonly', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 退出数据库并停止服务</span></span><br><span class="line">/data/mysql/support-files/mysql.server stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 将user_1表的物理文件覆盖user表</span></span><br><span class="line">cd /data/xtrabackup_data/mysql/</span><br><span class="line">mv user.frm user.ibd user.MYD user.MYI user.TRG /tmp</span><br><span class="line">mv user_1.frm user.frm</span><br><span class="line">mv user_1.MYI user.MYI</span><br><span class="line">mv user_1.MYD user.MYD</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动数据库</span></span><br><span class="line">/data/mysql/support-files/mysql.server start</span><br></pre></td></tr></table></figure><h4 id="操作明细"><a href="#操作明细" class="headerlink" title="操作明细"></a>操作明细</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">root@MySQL-01 15:42:  [(none)]&gt; use mysql</span><br><span class="line">Database changed</span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; create table user_1 like user;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; insert into user_1 select * from user;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; select user,host,authentication_string from mysql.user;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; select user,host,authentication_string from mysql.user_1;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:42:  [mysql]&gt; desc mysql.user_1;</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">| Field                  | Type                              | Null | Key | Default | Extra |</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">| Host                   | char(60)                          | NO   | PRI |         |       |</span><br><span class="line">| User                   | char(16)                          | NO   | PRI |         |       |</span><br><span class="line">| Password               | char(41)                          | NO   |     |         |       |</span><br><span class="line">| Select_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Insert_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Update_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Delete_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Drop_priv              | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Reload_priv            | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Shutdown_priv          | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Process_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| File_priv              | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Grant_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| References_priv        | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Index_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Alter_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Show_db_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Super_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_tmp_table_priv  | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Lock_tables_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Execute_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Repl_slave_priv        | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Repl_client_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_view_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Show_view_priv         | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_routine_priv    | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Alter_routine_priv     | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_user_priv       | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Event_priv             | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Trigger_priv           | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| Create_tablespace_priv | enum('N','Y')                     | NO   |     | N       |       |</span><br><span class="line">| ssl_type               | enum('','ANY','X509','SPECIFIED') | NO   |     |         |       |</span><br><span class="line">| ssl_cipher             | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| x509_issuer            | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| x509_subject           | blob                              | NO   |     | NULL    |       |</span><br><span class="line">| max_questions          | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_updates            | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_connections        | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| max_user_connections   | int(11) unsigned                  | NO   |     | 0       |       |</span><br><span class="line">| plugin                 | char(64)                          | YES  |     |         |       |</span><br><span class="line">| authentication_string  | text                              | YES  |     | NULL    |       |</span><br><span class="line">+------------------------+-----------------------------------+------+-----+---------+-------+</span><br><span class="line">42 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:47:  [mysql]&gt; delete from mysql.user_1 where user='root';</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:51:  [mysql]&gt; insert into mysql.user_1 values ('%','root', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','joowingbuz', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','ottersync', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','syncdw', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','datasis', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','joowingv', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','datadev', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; insert into mysql.user_1 values ('%','readonly', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('123'));</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; select user,host,authentication_string from mysql.user;</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| user | host      | authentication_string                     |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">| root | localhost | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | 127.0.0.1 | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">| root | ::1       | *D4DF57DFB7019B3D8C4294CC413AF1D650A275E4 |</span><br><span class="line">+------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:52:  [mysql]&gt; select user,host,authentication_string from mysql.user_1;</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">| user       | host | authentication_string                     |</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">| ottersync  | %    | *9443FA914A2D69FE8832F8294E7422CC1B02A492 |</span><br><span class="line">| joowingbuz | %    | *DFFDA1CA6135E355EF468AB13A465BB5D4FE2B11 |</span><br><span class="line">| root       | %    | *89BE852E4EECFD217F0C5463FB30AD25BD0751E0 |</span><br><span class="line">| syncdw     | %    | *3DD7B4B4F6EE968FF3452B607BDEE6294B6A425A |</span><br><span class="line">| datasis    | %    | *011D511C71990F832C531A0F9CFB34CF7BB4E485 |</span><br><span class="line">| joowingv   | %    | *56B364074270DF7F6D670A6B4F5A4AD13322397A |</span><br><span class="line">| datadev    | %    | *D3D73E0F6BFC3159B024EF31484B6F9CC2963C5B |</span><br><span class="line">| readonly   | %    | *E2BA196C0C7F409990FDB3FAB5F9C7CE95F7C449 |</span><br><span class="line">+------------+------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@joowing-server-06:~# /data/mysql/support-files/mysql.server stop</span><br><span class="line">Shutting down MySQL</span><br><span class="line">...... * </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@joowing-server-06:~# cd /data/xtrabackup_data/</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data# cd mysql</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user_1.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user_1.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user_1.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月   9 20:14 user.frm</span><br><span class="line">-rw-r----- 1 mysql mysql 98304 8月   9 20:14 user.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   328 8月   9 20:14 user.MYD</span><br><span class="line">-rw-r--r-- 1 mysql mysql  2048 8月   9 20:14 user.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3569 8月   9 20:14 user.TRG</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user.frm user.ibd user.MYD user.MYI user.TRG /data</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user_1.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user_1.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user_1.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.frm user.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.MYI user.MYI</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mv user_1.MYD user.MYD</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# ll user*</span><br><span class="line">-rw-r----- 1 mysql mysql 10630 8月  14 15:42 user.frm</span><br><span class="line">-rw-r----- 1 mysql mysql   744 8月  14 15:52 user.MYD</span><br><span class="line">-rw-r----- 1 mysql mysql  2048 8月  14 15:53 user.MYI</span><br><span class="line">-rw-r----- 1 mysql mysql  3982 8月   9 20:14 user_view.frm</span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# /data/mysql/support-files/mysql.server start</span><br><span class="line">Starting MySQL</span><br><span class="line">...... * </span><br><span class="line"></span><br><span class="line">root@joowing-server-06:/data/xtrabackup_data/mysql# mysql -uroot -p'123'</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@MySQL-01 15:55:  [(none)]&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: rm-uf6f05k2rg95s23bp.mysql.rds.aliyuncs.com</span><br><span class="line">                  Master_User: idc_slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.001641</span><br><span class="line">          Read_Master_Log_Pos: 447207506</span><br><span class="line">               Relay_Log_File: joowing-server-06-relay-bin.000225</span><br><span class="line">                Relay_Log_Pos: 35529076</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.001641</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: mysql.%,sys.%,information_schema.%</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 447207506</span><br><span class="line">              Relay_Log_Space: 35529295</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1095052097</span><br><span class="line">                  Master_UUID: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc:97478646-97483368</span><br><span class="line">            Executed_Gtid_Set: b3e1de69-5daa-11e8-bed2-7cd30ab8a9fc:1-97483368,</span><br><span class="line">c39ecf19-5daa-11e8-aa9c-7cd30ac4764a:1-178658794,</span><br><span class="line">c69289d7-9bc9-11e8-b922-44a842431b62:1-12</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证只读账号</span></span><br><span class="line">mysql -uroot-p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -ujoowingbuz -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -uottersync -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -usyncdw -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -udatasis -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -ujoowingv -p'123'  -e "create database dbzyadmin;"</span><br><span class="line">mysql -udatadev -p'123' -e "create database dbzyadmin;"</span><br><span class="line">mysql -ureadonly -p'123'  -e "create database dbzyadmin;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 只读账号无法执行写操作，验证成功</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1044 (42000) at line 1: Access denied for user 'readonly'@'%' to database 'dbzyadmin'</span><br></pre></td></tr></table></figure><h4 id="后续用户权限变更操作指南"><a href="#后续用户权限变更操作指南" class="headerlink" title="后续用户权限变更操作指南"></a>后续用户权限变更操作指南</h4><blockquote><p>后续新增用户、删除用户、更改密码命令如下：</p></blockquote><h5 id="新增读写用户"><a href="#新增读写用户" class="headerlink" title="新增读写用户"></a>新增读写用户</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql.user_1 values ('%','【用户名】', '', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', 'Y', '', '', '', '', 0, 0, 0, 0, '', password('【密码】'));</span><br></pre></td></tr></table></figure><h5 id="新增只读用户"><a href="#新增只读用户" class="headerlink" title="新增只读用户"></a>新增只读用户</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql.user_1 values ('%','【用户名】', '', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', 0, 0, 0, 0, '', password('【密码】'));</span><br></pre></td></tr></table></figure><h5 id="删除用户命令"><a href="#删除用户命令" class="headerlink" title="删除用户命令"></a>删除用户命令</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from mysql.user where user='【用户名】';</span><br></pre></td></tr></table></figure><h5 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update mysql.user set authentication_string=password('【密码】') where user='【用户名】';</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>RDS目前使用MySQL版本和官方在系统库上差异还是很大的，若需要搭建RDS到线下自建MySQL5.7的主从时，可以通过此法去实现。</p><p>本文中对user表的破解，同样适适用于<code>mysql.db</code> 、<code>mysql.tables_priv</code>表，都破解则可以将权限从用户拓展到库表列。读者可自行实验测试。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要: 阿里云的RDS For MySQL 5.7 到线下IDC机房的主从搭建相信看官方文档就可以完成，但是搭建之后却发现无法在本地进行认证权限的管理，这是为何？而阿里官方推荐使用DTS同步工具去实现，这个费用着实不少，又是否能够破解呢？本文详解如何暴力破解user表实现从库用户权限更改功能&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="RDS" scheme="http://www.toberoot.com/tags/RDS/"/>
    
      <category term="主从同步" scheme="http://www.toberoot.com/tags/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5/"/>
    
  </entry>
  
  <entry>
    <title>利用split工具解决一次MongoDB日志异常问题</title>
    <link href="http://www.toberoot.com/2018/08/03/%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/"/>
    <id>http://www.toberoot.com/2018/08/03/%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/</id>
    <published>2018-08-03T12:25:24.000Z</published>
    <updated>2020-03-22T08:32:42.584Z</updated>
    
    <content type="html"><![CDATA[<p>摘要： </p><ul><li>某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？</li><li>进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？</li><li>第二天到公司，由于客户环境我们也是第一次接手，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！</li></ul><a id="more"></a><h2 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h2><h3 id="数据库明细"><a href="#数据库明细" class="headerlink" title="数据库明细"></a>数据库明细</h3><p>说在前面：</p><ul><li>数据库：MongoDB集群 4个分片节点</li><li>分片节点规格：16核 / 32G CentOS 7.4 64位</li><li>数据目录所在磁盘: 300G   49G  252G  17% /data</li></ul><h3 id="故事情节"><a href="#故事情节" class="headerlink" title="故事情节"></a>故事情节</h3><ul><li>某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？</li><li>进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？</li><li>第二天到公司，由于客户环境我们也是第一次接受，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！</li></ul><h2 id="复现与剖析"><a href="#复现与剖析" class="headerlink" title="复现与剖析"></a>复现与剖析</h2><h3 id="拉取日志异常"><a href="#拉取日志异常" class="headerlink" title="拉取日志异常"></a>拉取日志异常</h3><p><strong>使用mlogfilter过滤文件时报错说文件非mongodb的日志文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 booboo]# mlogfilter shard.log.2018-08-01 --from 2018-08-01T15:00:00.000+0800 --to "+1h" --slow 1000 &gt; /alidata/booboo/tf.1</span><br><span class="line">报错:非mongodb日志格式</span><br></pre></td></tr></table></figure><p>回到客户服务器检查日志文件格式，明细如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@MONGO-SHARD-18 logs]# file *</span><br><span class="line">shard.log:            PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-25: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01: PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure><p>mongodb的日志正常应该为：<code>ASCII text, with very long lines</code>，但是现在却变成了<code>PCX ver. 2.5 image data</code>。需要弄清楚原因。</p><h3 id="日志异常分析"><a href="#日志异常分析" class="headerlink" title="日志异常分析"></a>日志异常分析</h3><ul><li>为什么客户每天的日志量达到22个G，并且每天的日志量都是大于等于前一天？很显然，日志截断有问题。</li><li>这个是近7天的日志，而日志格式变成了PCX图片格式是为何？</li><li>怀疑每次日志轮询时都没有真正截断日志！</li></ul><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/01.png" alt=""></p><h3 id="分析原日志切割明细"><a href="#分析原日志切割明细" class="headerlink" title="分析原日志切割明细"></a>分析原日志切割明细</h3><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/03.png" alt=""></p><p>怀疑与<code>echo &gt;</code>有关，进行验证。</p><h3 id="验证echo-gt-与PCX图片头部0a一致"><a href="#验证echo-gt-与PCX图片头部0a一致" class="headerlink" title="验证echo &gt;与PCX图片头部0a一致"></a>验证<code>echo &gt;</code>与<code>PCX图片头部0a一致</code></h3><ol><li>建一个空文档<code>log</code>；执行<code>echo &gt; log</code>；通过<code>cat -A log</code>查看文件中插入了一个符号即换行符<code>\n</code></li><li>通过<code>hexdump -c log</code> 查看测试文件头部显示为ASCII字符 <code>\n</code></li><li>通过<code>hexdump -d log</code> 查看测试文件头部显示为16进制<code>00010</code> 即<code>0a</code></li><li>通过<code>vim</code> 用16进制查看文档<code>log</code>可以看到log的文件头部为<code>0a</code>，正是PCX图片的头部</li><li>生产环境查看客户有问题的mongodb系统日志文件格式为<code>PCX</code>图片格式</li><li>通过<code>hexdump -c log</code> 显示为ASCII字符，生产日志文件头部与测试的log一致，都是<code>\n</code></li><li>通过<code>hexdump -d log</code>显示为16进制，生产日志文件头部与测试的log一致<code>00010</code> 即 <code>0a</code></li></ol><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/02.png" alt=""></p><p><strong>到此验证成功:通过<code>echo &gt; log</code>的方式会往文件头部新增’0a’</strong></p><hr><h3 id="复现MongoDB日志从ASCII-text转变为PCX-格式"><a href="#复现MongoDB日志从ASCII-text转变为PCX-格式" class="headerlink" title="复现MongoDB日志从ASCII text转变为PCX 格式"></a>复现MongoDB日志从ASCII text转变为PCX 格式</h3><p>在测试环境中复现日志从<code>ASCII text</code>变成<code>PCX ver. 2.5 image data</code></p><ol><li>通过mongo登陆数据库执行大量的插入操作</li><li>通过echo &gt; mongod27017.log  命令尝试清空mongod27017.log</li><li>查看截断后的日志文件格式，变成了very short file (no magic)</li><li>等文档插入完毕</li><li>通过<code>tail -f</code> 查看日志明细，看到确实有日志写入</li><li>查看日志格式，发现变成了<code>PCX ver. 2.5 image data</code></li></ol><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/05.png" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 ~]# mongo</span><br><span class="line">MongoDB shell version: 3.2.16</span><br><span class="line">connecting to: test</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.auth(<span class="string">'test_dev'</span>,<span class="string">'uplooking'</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.t1.find()</span></span><br><span class="line">&#123; "_id" : ObjectId("5b5ebb6796b8b74a73ee30f6"), "a" : 1, "b" : 2 &#125;</span><br><span class="line">&#123; "_id" : ObjectId("5b5ebb6996b8b74a73ee30f7"), "a" : 1, "b" : 1 &#125;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">for</span> (i=1;i&lt;200000;i++)&#123;</span></span><br><span class="line">... db.t1.insert(&#123;id:i&#125;)&#125;</span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line"></span><br><span class="line">[root@sh_01 ~]# cd /alidata/mongodb/logs</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">-rw-r--r-- 1 root root 2182 Aug  3 10:28 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root    1 Aug  3 10:29 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# tail -f mongod27017.log</span><br><span class="line"></span><br><span class="line">2018-08-03T10:30:21.936+0800 I NETWORK  [initandlisten] connection accepted from 127.0.0.1:43720 #2 (2 connections now open)</span><br><span class="line"></span><br><span class="line">[root@sh_01 log]# ll -h</span><br><span class="line">total 12K</span><br><span class="line">-rw-r--r-- 1 root root 2.8K Aug  3 10:30 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3.1K Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1.5K Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一边不断产生日志，一边多次执行<span class="built_in">echo</span>&gt; </span></span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# echo &gt; mongod27017.log</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# ll -h</span><br><span class="line">total 16K</span><br><span class="line">-rw-r--r-- 1 root root    1 Aug  3 11:28 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3.1K Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1.5K Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">-rw-r--r-- 1 root root 2.9K Aug  3 11:05 mongod27017.log.2018-08-03T03-09-08</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     very short file (no magic)</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     PCX ver. 2.5 image data</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br><span class="line">[root@sh_01 log]# hexdump -c mongod27017.log</span><br><span class="line">0000000  \n  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000010  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">*</span><br><span class="line">0000850  \0  \0  \0  \0  \0  \0  \0   2   0   1   8   -   0   8   -   0</span><br><span class="line">0000860   3   T   1   1   :   2   9   :   0   6   .   7   2   9   +   0</span><br><span class="line">0000870   8   0   0       I       A   C   C   E   S   S               [</span><br><span class="line">0000880   c   o   n   n   3   ]       U   n   a   u   t   h   o   r   i</span><br><span class="line">0000890   z   e   d   :       n   o   t       a   u   t   h   o   r   i</span><br><span class="line">00008a0   z   e   d       o   n       t   e   s   t       t   o       e</span><br><span class="line">00008b0   x   e   c   u   t   e       c   o   m   m   a   n   d       &#123;</span><br><span class="line">00008c0       f   i   n   d   :       "   t   1   "   ,       f   i   l</span><br><span class="line">00008d0   t   e   r   :       &#123;   &#125;       &#125;  \n</span><br></pre></td></tr></table></figure><p>成功复现了客户的情况：</p><ol><li><p>第一次<code>echo &gt; log</code>，文件头部新增<code>\n</code></p></li><li><p>多次<code>echo &gt; log</code>,文件头部如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000  \n  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000010  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">*</span><br></pre></td></tr></table></figure></li></ol><p>确实是mongodb日志轮询出了问题：</p><ol><li><code>echo &gt; log</code>会往文件头部插入<code>\n</code>即16进制的<code>0a</code></li><li>在数据库正常运行中，对log文件是加了锁的，强制执行<code>echo &gt; log</code>是无法进行覆盖的，会将所有的数据全部置为<code>0</code></li><li>强制覆盖后，文件头部变成了无数的空白</li></ol><h3 id="待解决问题"><a href="#待解决问题" class="headerlink" title="待解决问题"></a>待解决问题</h3><ul><li>MongoDB日志轮询方法调整为<strong>kill -SIGUSER1 [mongodpid]</strong></li><li>修复目前已经变为图片格式的日志，并拉取15点到16点的日志</li></ul><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h3 id="MongoDB日志轮询"><a href="#MongoDB日志轮询" class="headerlink" title="MongoDB日志轮询"></a>MongoDB日志轮询</h3><h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 log]# pidof mongod</span><br><span class="line">1828</span><br><span class="line">[root@sh_01 log]# kill -SIGUSER1 1828</span><br><span class="line">-bash: kill: SIGUSER1: invalid signal specification</span><br><span class="line">[root@sh_01 log]# kill -SIGUSR1 1828</span><br><span class="line">[root@sh_01 log]# ll</span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  3 11:09 mongod27017.log</span><br><span class="line">-rw-r--r-- 1 root root 3100 Aug  2 14:19 mongod27017.log.2018-08-02T07-18-27</span><br><span class="line">-rw-r--r-- 1 root root 1526 Aug  2 15:18 mongod27017.log.2018-08-02T07-18-54</span><br><span class="line">-rw-r--r-- 1 root root 2942 Aug  3 11:05 mongod27017.log.2018-08-03T03-09-08</span><br><span class="line">[root@sh_01 log]# file *</span><br><span class="line">mongod27017.log:                     ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-27: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-02T07-18-54: ASCII text, with very long lines</span><br><span class="line">mongod27017.log.2018-08-03T03-09-08: PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/04.png" alt=""></p><p>修改日志轮询脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@MONGO-SHARD-18 logs]# cat /etc/init.d/mongo_logspit.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2018/08/02 Apple</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Rotate the MongoDB logs to prevent a single logfile from consuming too much disk space.</span></span><br><span class="line"></span><br><span class="line">cmd=mongod</span><br><span class="line">mongodpath=/opt/mongodb/bin</span><br><span class="line">pidarray=`pidof $&#123;mongodpath&#125;/$cmd`</span><br><span class="line">LOGPATH_SHARD=/data/mongodb/shard1/logs</span><br><span class="line"></span><br><span class="line">for pid in $pidarray;do</span><br><span class="line">if [ $pid ]</span><br><span class="line">then</span><br><span class="line">    kill -SIGUSR1 $pid</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash">clear logfile more than 7 days</span></span><br><span class="line">cd $LOGPATH_SHARD</span><br><span class="line">find ./ -xdev -mtime +7 -name "shard.log.*" -exec rm -f &#123;&#125;  \;</span><br></pre></td></tr></table></figure><p>所有的分片都去执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -SIGUSR1 pidof mongod</span><br></pre></td></tr></table></figure><p>分片15操作如下：其他分片同样</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[zyadmin@MONGO-SHARD-15 ~]$ sudo -i</span><br><span class="line">[root@MONGO-SHARD-15 ~]# cd /data/mongodb/shard1/logs/</span><br><span class="line">[root@MONGO-SHARD-15 logs]# ll -h</span><br><span class="line">total 1.7G</span><br><span class="line">-rw-r--r-- 1 root root 20G Aug  2 15:27 shard.log</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 25 23:50 shard.log.2018-07-25</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 26 23:50 shard.log.2018-07-26</span><br><span class="line">-rw-r--r-- 1 root root 19G Jul 27 23:50 shard.log.2018-07-27</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 28 23:50 shard.log.2018-07-28</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 29 23:50 shard.log.2018-07-29</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 30 23:50 shard.log.2018-07-30</span><br><span class="line">-rw-r--r-- 1 root root 20G Jul 31 23:50 shard.log.2018-07-31</span><br><span class="line">-rw-r--r-- 1 root root 20G Aug  1 23:50 shard.log.2018-08-01</span><br><span class="line">[root@MONGO-SHARD-15 logs]# file *</span><br><span class="line">shard.log:            PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-25: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31: PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01: PCX ver. 2.5 image data</span><br><span class="line">[root@MONGO-SHARD-15 logs]# kill -SIGUSR1 `pidof mongod`</span><br><span class="line">[root@MONGO-SHARD-15 logs]# file *</span><br><span class="line">shard.log:                     ASCII text, with very long lines</span><br><span class="line">shard.log.2018-07-25:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-26:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-27:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-28:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-29:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-30:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-07-31:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-01:          PCX ver. 2.5 image data</span><br><span class="line">shard.log.2018-08-02T07-27-29: PCX ver. 2.5 image data</span><br><span class="line">[root@MONGO-SHARD-15 logs]# ll -h</span><br><span class="line">total 1.7G</span><br><span class="line">-rw-r--r-- 1 root root 2.0K Aug  2 15:27 shard.log</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 25 23:50 shard.log.2018-07-25</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 26 23:50 shard.log.2018-07-26</span><br><span class="line">-rw-r--r-- 1 root root  19G Jul 27 23:50 shard.log.2018-07-27</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 28 23:50 shard.log.2018-07-28</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 29 23:50 shard.log.2018-07-29</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 30 23:50 shard.log.2018-07-30</span><br><span class="line">-rw-r--r-- 1 root root  20G Jul 31 23:50 shard.log.2018-07-31</span><br><span class="line">-rw-r--r-- 1 root root  20G Aug  1 23:50 shard.log.2018-08-01</span><br><span class="line">-rw-r--r-- 1 root root  20G Aug  2 15:27 shard.log.2018-08-02T07-27-29</span><br></pre></td></tr></table></figure><h3 id="修复异常日志"><a href="#修复异常日志" class="headerlink" title="修复异常日志"></a>修复异常日志</h3><h4 id="修复思路"><a href="#修复思路" class="headerlink" title="修复思路"></a>修复思路</h4><p>弄清楚日志变更的原因以及复现过程后，不难发现，日志因为头部变化从而导致文件格式变更。因此推测异常日志的组成如下：</p><ol><li>头部为<code>0a</code></li><li>中间全部都是<code>0</code></li><li>最后是正常的字符串记录着mongodb的日志信息，类似于<code>2018-08-03T10:30:21.936+0800 I NETWORK  [initandlisten] connection accepted from 127.0.0.1:43720 #2 (2 connections now open)</code>由日志和日志明细组成</li></ol><p>因此修复的思路如下：</p><ul><li>23G的日志，首先按照大小6G做切分<code>split -b 6G log</code>，切分成4个文件</li><li>查看切分后的日志格式，如果最后一个日志为<code>ASCII text</code>则不再切分否则，将最后一个日志继续切分</li><li>循环上一步，直到最后一个文件切分出来没有<code>ASCII text</code>为止</li></ul><h4 id="操作明细"><a href="#操作明细" class="headerlink" title="操作明细"></a>操作明细</h4><blockquote><p>日志轮询的部署距离现在大概4个月</p></blockquote><ol><li><p>第一次将23G的文件以6G切分成4个文件：xaa\xab\xac\xad，查看4个文件的属性为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xaa:               PCX ver. 2.5 image data</span><br><span class="line">xab:               PCX ver. 2.5 image data</span><br><span class="line">xac:               PCX ver. 2.5 image data</span><br><span class="line">xad:                PCX ver. 2.5 image data</span><br></pre></td></tr></table></figure></li><li><p>重命名xad为x1第二次切分x1 5G，按照1G切分成5份，查看文件属性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xaa:               PCX ver. 2.5 image data</span><br><span class="line">xab:               PCX ver. 2.5 image data</span><br><span class="line">xac:               PCX ver. 2.5 image data</span><br><span class="line">xad:                PCX ver. 2.5 image data</span><br><span class="line">xae:                ASCII text, with very long lines</span><br></pre></td></tr></table></figure></li><li><p>重名xad 为 x2 按照15M的大小切分，查看文件的属性如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xaa:      PCX ver. 2.5 image data</span><br><span class="line">此处省略。。。</span><br><span class="line">xdo:               PCX ver. 2.5 image data</span><br><span class="line">xdp:               ASCII text, with very long lines</span><br><span class="line">xdq:               ASCII text, with very long lines</span><br><span class="line">xdr:               ASCII text, with very long lines</span><br><span class="line">xds:               ASCII text, with very long lines</span><br><span class="line">xdt:               ASCII text, with very long lines</span><br><span class="line">xdu:               ASCII text, with very long lines</span><br><span class="line">xdv:               UTF-8 Unicode text, with very long lines</span><br><span class="line">xdw:               ASCII text, with very long lines</span><br><span class="line">xdx:               ASCII text, with very long lines</span><br><span class="line">xdy:               ASCII text, with very long lines</span><br></pre></td></tr></table></figure></li><li><p>切分后文件类型为<code>ASCII text</code>的文件中找到15点~16点的文档</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 mongolog_20180801]# head -n 2 xdv</span><br><span class="line">re: "x86_64", version: "Kernel 3.10.0-693.2.2.el7.x86_64" &#125; &#125;</span><br><span class="line">2018-08-01T16:13:44.958+0800 I ACCESS   [conn4972925] Successfully authenticated as principal __system on local</span><br><span class="line">[root@sh_01 mongolog_20180801]# head -n 2 xdu</span><br><span class="line">38422 #4967772 (445 connections now open)</span><br><span class="line">2018-08-01T14:00:10.575+0800 I NETWORK  [thread1] connection accepted from 172.16.0.44:38430 #4967773 (446 connections now open)</span><br></pre></td></tr></table></figure></li></ol><ul><li><code>xdv</code> 的头部是<code>2018-08-01T16:13:44.958+0800</code>,因此可以确定15~16的日志在xdu中</li><li><code>xdu</code>记录的日志时间段为<code>2018-08-01T14:00:10.575+0800</code>~<code>2018-08-01T16:13:44.958+0800</code></li><li>重命名<code>xdu</code>为<code>mongolog.18.14_16</code></li></ul><h3 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h3><h4 id="分析命令"><a href="#分析命令" class="headerlink" title="分析命令"></a>分析命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取08月01号下午3点开始到4点执行时间超过5秒的查询</span></span><br><span class="line">mlogfilter mongolog.18.14_16 --from 2018-08-01T15 --to "+1h" --slow 5000 &gt; slowlog.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取08月01号下午3点开始到4点语句的执行次数、用时等统计信息</span></span><br><span class="line">mloginfo slowlog.txt  --queries &gt; an_slowlog.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过mplotqueries进行慢查询散点分布图绘制，且只返回前10个</span></span><br><span class="line">mplotqueries slowlog.txt --output-file 01.png --logscale --group-limit 10</span><br></pre></td></tr></table></figure><h4 id="慢查询散点分布图"><a href="#慢查询散点分布图" class="headerlink" title="慢查询散点分布图"></a>慢查询散点分布图</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@sh_01 booboo]# mplotqueries slowlog.txt --output-file 01.png --logscale --group-limit 10</span><br><span class="line">                                                                                          </span><br><span class="line">SCATTER plot</span><br><span class="line">   id   #points  group</span><br><span class="line">    1       692  order.order</span><br><span class="line">    2       615  omdmain.item_region_erp</span><br><span class="line">    3         1  omdmain.customer</span><br><span class="line">()</span><br></pre></td></tr></table></figure><p><img src="%E5%88%A9%E7%94%A8split%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E4%B8%80%E6%AC%A1MongoDB%E6%97%A5%E5%BF%97%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/10.png" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="mongodb日志轮询的问题"><a href="#mongodb日志轮询的问题" class="headerlink" title="mongodb日志轮询的问题"></a>mongodb日志轮询的问题</h3><ol><li><code>echo &gt; log</code>会往文件头部插入<code>\n</code>即16进制的<code>0a</code></li><li>在数据库正常运行中，对log文件是加了锁的，强制执行<code>echo &gt; log</code>是无法进行覆盖的，会将所有的数据全部置为<code>0</code></li><li>强制覆盖后，文件头部变成了无数的空白</li></ol><h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><ul><li>MongoDB日志轮询方法调整为<strong>kill -SIGUSER1 [mongodpid]</strong></li><li>修复目前已经变为图片格式的日志，并拉取15点到16点的日志</li></ul><p>该case花了一整天，从怀疑被攻击到确认是日志轮询引起文件格式变更是一个关键转折点；</p><p>另外PCX格式是第一次碰到，疑惑了半天~最后是@培尧发现了<code>echo</code>的端倪，@衾袭@大宝去验证最终确认了问题的根源。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要： &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;某天晚上刚到家不久，就接到杭州同事的电话，客户MongoDB集群中的某个分片节点CPU飙高，初步判断是慢查询，现在需要拉取CPU飙高时间段的慢查询。心想拉取慢查询应该很快，不就是个系统日志吗？而且还做了日志切割一天一个，按道理很快搞定的，谁知当天晚上搞了接近三个小时也没搞定。究竟发生了什么？&lt;/li&gt;
&lt;li&gt;进入到日志目录一看，目前保留近7天的日志，每天的日志量在23G~24G，我当时就想这个客户数据量这么大！后续发现日志格式本该为普通文本文件确变成了图片格式，究竟为何会文件格式会转变？能否从图片格式中拉取指定时间段的日志呢？&lt;/li&gt;
&lt;li&gt;第二天到公司，由于客户环境我们也是第一次接手，因此咱们技术专家团队搞了一个3人的”专家会诊”，经过了一番折腾总算把原因找到了，具体过程请看下文！&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MongoDB" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MongoDB/"/>
    
    
      <category term="数据救援" scheme="http://www.toberoot.com/tags/%E6%95%B0%E6%8D%AE%E6%95%91%E6%8F%B4/"/>
    
  </entry>
  
  <entry>
    <title>Oracle数据库SQL优化_索引缺失</title>
    <link href="http://www.toberoot.com/2018/05/29/oracle%E6%95%B0%E6%8D%AE%E5%BA%93SQL%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1/"/>
    <id>http://www.toberoot.com/2018/05/29/oracle%E6%95%B0%E6%8D%AE%E5%BA%93SQL%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1/</id>
    <published>2018-05-28T18:09:32.000Z</published>
    <updated>2020-03-22T08:32:42.573Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：Oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒，如何进行复杂查询的SQL优化，本文提供通用的一个思路。</p><a id="more"></a><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；</p><p>老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒。</p><table><thead><tr><th>库</th><th>原查询时间</th><th>优化后的查询时间</th></tr></thead><tbody><tr><td>老库</td><td>11秒</td><td>1.4秒 缓存后 0.4秒</td></tr><tr><td>新库RAC</td><td>360秒</td><td>1.4秒 缓存后0.4秒排查思路</td></tr></tbody></table><h2 id="待优化SQL"><a href="#待优化SQL" class="headerlink" title="待优化SQL"></a>待优化SQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">prj.PROVINCE_AD_NAME,</span><br><span class="line">prj.CITY_AD_NAME,</span><br><span class="line">prj.AD_NAME,</span><br><span class="line">prj.CHANNEL_SYS_CAT,</span><br><span class="line">prj.EXCUTE_EL,</span><br><span class="line">prj.PRJ_CODE AS PRJ_CODE,</span><br><span class="line">prj.PRJ_NAME AS PRJ_NAME,</span><br><span class="line">prj.POS_CODE AS POS_CODE,</span><br><span class="line">prj.POS_NAME AS POS_NAME,</span><br><span class="line">prj.CUST_CHANNEL_CODE,</span><br><span class="line">prj.CUST_CHANNEL_NAME,</span><br><span class="line">prj.EMP_CODE AS EMP_CODE,</span><br><span class="line">prj.NAME AS EMP_NAME,</span><br><span class="line">prj.ATT_DATE AS APPLY_DATE,</span><br><span class="line">prj.EMP_PK AS EMP_PK,</span><br><span class="line">prj.ATT_START_TIME AS START_TIME,</span><br><span class="line">prj.ATT_END_TIME AS END_TIME,</span><br><span class="line">prj.ATT_ISWORK AS ISWORK,</span><br><span class="line">prj.ATT_UNWORK AS ATTTYPE,</span><br><span class="line">prj.START_XPOS AS ON_WORK_POSITION_LON,</span><br><span class="line">prj.START_YPOS AS ON_WORK_POSITION_LAT,</span><br><span class="line">prj.START_ISEXCEP AS ON_WORK_POSITION_STAUS,</span><br><span class="line">prj.END_XPOS AS OFF_WORK_POSITION_LAT,</span><br><span class="line">prj.END_YPOS AS OFF_WORK_POSITION_LON,</span><br><span class="line">prj.END_ISEXCEP AS OFF_WORK_POSITION_STAUS,</span><br><span class="line">ifcl1Staus.COMPARE_TYPE AS FACE_ATT_TYPE,</span><br><span class="line">ifcl1.STATUS AS FACE_ATT_STATUS,</span><br><span class="line">NVL( ifaceCount.faceCount, 0 ) AS FACE_ATT_COUNT,</span><br><span class="line">NVL( levLeave.LEAVECount, 0 ) AS LEAVE_WORK_COUNT,</span><br><span class="line">NVL( levRtn.RETURNCount, 0 ) AS RETURN_WORK_COUNT,</span><br><span class="line">wq.STATUS AS PRJ_QUESTION_TYPE,</span><br><span class="line">iface2.FACE_ATT_IMG AS FACE_ATT_IMG,</span><br><span class="line">prj.SA_TYPE</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">dpsi.ID AS ID,</span><br><span class="line">P.ID AS PRJ_ID,</span><br><span class="line">mad.AD_CODE,</span><br><span class="line">mad.PROVINCE_AD_NAME,</span><br><span class="line">mad.CITY_AD_NAME,</span><br><span class="line">mad.AD_NAME,</span><br><span class="line">mpk.POS_KIND_CODE,</span><br><span class="line">mpk.POS_KIND_NAME,</span><br><span class="line">P.CODE AS PRJ_CODE,</span><br><span class="line">P.NAME AS PRJ_NAME,</span><br><span class="line">P.START_DATE,</span><br><span class="line">p.END_DATE,</span><br><span class="line">dpsi.CUST_CHANNEL,</span><br><span class="line">dpsi.CUST_SYS,</span><br><span class="line">dpsi.CUST_CHANNEL_CODE,</span><br><span class="line">dpsi.CUST_CHANNEL_NAME,</span><br><span class="line">dcs.CHANNEL_SYS_CAT,</span><br><span class="line">dcs.CHANNEL_CAT_CODE,</span><br><span class="line">dcs.CHANNEL_AD_CODE,</span><br><span class="line">dcs.CHANNEL_PROVINCE_AD_CODE,</span><br><span class="line">dcs.CHANNEL_CITY_AD_CODE,</span><br><span class="line">dcs.ID AS POS_ID,</span><br><span class="line">dcs.CHANNEL_CODE AS POS_CODE,</span><br><span class="line">dcs.CHANNEL_NAME AS POS_NAME,</span><br><span class="line">dcs.LONGITUDE AS LONGITUDE,</span><br><span class="line">dcs.LATITUDE AS LATITUDE,</span><br><span class="line">dss.id AS SALES_ID,</span><br><span class="line">TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' ) AS sc_schedule_date,</span><br><span class="line">wor.SW_BEGIN_TIME AS SALES_WORK_START,</span><br><span class="line">wor.SW_END_TIME AS SALES_WORK_END,</span><br><span class="line">dss.SALES_EAT_START,</span><br><span class="line">dss.SALES_EAT_END,</span><br><span class="line">memp.EMP_PK,</span><br><span class="line">memp.EMP_CODE,</span><br><span class="line">dss.SALES_NAME AS NAME,</span><br><span class="line">dss.SALES_PHONE AS TEL,</span><br><span class="line">dss.SALES_CARD_ID AS ID_CARD,</span><br><span class="line">spp.PRJ_ATT_CHECK_TYPE,</span><br><span class="line">spp.ALLOW_LEAVE_TIME,</span><br><span class="line">e1.EMP_CODE AS EXCUTE_CODE,</span><br><span class="line">e1.emp_name AS EXCUTE_EL,</span><br><span class="line">e2.EMP_CODE AS CITY_CODE,</span><br><span class="line">e2.emp_name AS CITY_EL,</span><br><span class="line">e3.EMP_CODE AS AREA_CODE,</span><br><span class="line">e3.EMP_NAME AS AREA_NAME,</span><br><span class="line">dpsi.SCHEDULE_TYPE,</span><br><span class="line">sac.ATT_START_TIME,</span><br><span class="line">sac.ATT_END_TIME,</span><br><span class="line">sac.ATT_ISWORK,</span><br><span class="line">sac.ATT_UNWORK,</span><br><span class="line">sac.START_XPOS,</span><br><span class="line">sac.START_YPOS,</span><br><span class="line">DECODE( sac.START_ISEXCEP, 0, 2201, 1, 2202, 2, 2203, 3, 2204, 4, 2205, 2206 ) AS START_ISEXCEP,</span><br><span class="line">sac.END_XPOS,</span><br><span class="line">sac.END_YPOS,</span><br><span class="line">sac.END_ISEXCEP,</span><br><span class="line">sac.ATT_SCH_PK,</span><br><span class="line">sac.ATT_DATE,</span><br><span class="line">CASE</span><br><span class="line">WHEN sac.ATT_START_TIME IS NOT NULL</span><br><span class="line">AND sac.ATT_END_TIME IS NOT NULL THEN '1'</span><br><span class="line">WHEN sac.ATT_START_TIME IS NOT NULL</span><br><span class="line">OR sac.ATT_END_TIME IS NOT NULL THEN '2'</span><br><span class="line">ELSE '2'</span><br><span class="line">END AS SA_TYPE</span><br><span class="line">FROM</span><br><span class="line">DM_PROJECT_SELLIN_INFO dpsi</span><br><span class="line">LEFT JOIN MD_EMP e1 ON</span><br><span class="line">dpsi.EMP_CODE = e1.EMP_CODE</span><br><span class="line">LEFT JOIN MD_EMP e2 ON</span><br><span class="line">dpsi.CITY_EMP_CODE = e2.EMP_CODE</span><br><span class="line">LEFT JOIN MD_EMP e3 ON</span><br><span class="line">dpsi.AREA_MANAGER_CODE = e3.EMP_CODE,</span><br><span class="line">DM_PROJECT P,</span><br><span class="line">DM_PROJECT_SELLIN_SALES dss,</span><br><span class="line">DM_CHANNEL_SYNC dcs,</span><br><span class="line">MD_EMP memp,</span><br><span class="line">SP_PRJ_PARM spp,</span><br><span class="line">Md_Admin_Div mad,</span><br><span class="line">MD_POS_KIND mpk,</span><br><span class="line">dm_sales_schedule_calendar cal,</span><br><span class="line">dm_sales_schedule_work wor,</span><br><span class="line">SP_ATT_SCH sac</span><br><span class="line">WHERE</span><br><span class="line">dpsi.PROJECT_ID = P.ID</span><br><span class="line">AND dss.id = cal.sales_id</span><br><span class="line">AND cal.schedule_work_id = wor.id</span><br><span class="line">AND dcs.CHANNEL_CAT_CODE = mpk.POS_KIND_CODE</span><br><span class="line">AND dss.PROJECT_SELLIN_INFO_ID = dpsi.ID</span><br><span class="line">AND dss.DELETE_FLAG = '0'</span><br><span class="line">AND dpsi.CHANNEL_SYNC_ID = dcs.ID</span><br><span class="line">AND LOWER( memp.EMP_S_CODE )= LOWER( dss.SALES_CARD_ID )</span><br><span class="line">AND P.IS_DELETE IS NULL</span><br><span class="line">AND memp.IS_DEL = '0'</span><br><span class="line">AND spp.PRJ_CODE = P.CODE</span><br><span class="line">AND mad.AD_ID = dcs.CHANNEL_ADMIN_DIV_ID</span><br><span class="line">AND mad.IS_DEL = '0'</span><br><span class="line">AND memp.EMP_TYPE = '1001'</span><br><span class="line">AND TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )&gt;='2018-04-01'</span><br><span class="line">AND TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )&lt;='2018-04-30'</span><br><span class="line">AND sac.PRJ_CODE = p.CODE</span><br><span class="line">AND sac.POS_CODE = dcs.CHANNEL_CODE</span><br><span class="line">AND sac.EMP_PK = memp.EMP_PK</span><br><span class="line">AND sac.ATT_DATE = TO_CHAR( cal.sc_schedule_date, 'yyyy-mm-dd' )</span><br><span class="line">AND TO_CHAR( sac.CRT_DATE, 'yyyy-mm-dd' )&gt;='2018-04-01'</span><br><span class="line">AND TO_CHAR( sac.CRT_DATE, 'yyyy-mm-dd' )&lt;='2018-04-30'</span><br><span class="line">) prj,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">ifcl.STATUS</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifcl</span><br><span class="line">WHERE</span><br><span class="line">ifcl.HANDLE_TYPE = 0</span><br><span class="line">AND ifcl.DELETE_FLAG = '0'</span><br><span class="line">AND ifcl.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND ifcl.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifcl.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">GROUP BY</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">ifcl.STATUS</span><br><span class="line">HAVING</span><br><span class="line">AVG( STATUS )&lt; 1</span><br><span class="line">) ifcl1,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">*</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">EMP_PK,</span><br><span class="line">COMPARE_DATE,</span><br><span class="line">COMPARE_TYPE,</span><br><span class="line">ROW_NUMBER() OVER(</span><br><span class="line">PARTITION BY EMP_PK,</span><br><span class="line">COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">CREATED DESC</span><br><span class="line">) rn</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG</span><br><span class="line">WHERE</span><br><span class="line">COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">) t</span><br><span class="line">WHERE</span><br><span class="line">t.rn &lt;= 1</span><br><span class="line">) ifcl1Staus,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK,</span><br><span class="line">COUNT(*) AS LEAVECount</span><br><span class="line">FROM</span><br><span class="line">SP_LEV_RPT</span><br><span class="line">WHERE</span><br><span class="line">SP_LEV_RPT.START_TIME IS NOT NULL</span><br><span class="line">GROUP BY</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK</span><br><span class="line">) levLeave,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK,</span><br><span class="line">COUNT(*) AS RETURNCount</span><br><span class="line">FROM</span><br><span class="line">SP_LEV_RPT</span><br><span class="line">WHERE</span><br><span class="line">SP_LEV_RPT.END_TIME IS NOT NULL</span><br><span class="line">GROUP BY</span><br><span class="line">SP_LEV_RPT.ATT_SCH_PK</span><br><span class="line">) levRtn,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">WX_QUESTION.PRJ_ID,</span><br><span class="line">DM_PROJECT.CODE,</span><br><span class="line">'Y' AS STATUS</span><br><span class="line">FROM</span><br><span class="line">WX_QUESTION,</span><br><span class="line">DM_PROJECT</span><br><span class="line">WHERE</span><br><span class="line">DM_PROJECT.ID = WX_QUESTION.PRJ_ID</span><br><span class="line">AND WX_QUESTION.IS_DEL = '0'</span><br><span class="line">AND WX_QUESTION.STATUS = '0'</span><br><span class="line">GROUP BY</span><br><span class="line">WX_QUESTION.PRJ_ID,</span><br><span class="line">DM_PROJECT.CODE</span><br><span class="line">) wq,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE,</span><br><span class="line">COUNT(*) AS faceCount</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifcl</span><br><span class="line">WHERE</span><br><span class="line">ifcl.HANDLE_TYPE = 0</span><br><span class="line">AND ifcl.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND ifcl.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifcl.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">GROUP BY</span><br><span class="line">ifcl.EMP_PK,</span><br><span class="line">ifcl.COMPARE_DATE</span><br><span class="line">) ifaceCount,</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE,</span><br><span class="line">wm_concat(</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">NVL( TRIM( T.PAR_VALUE ), TRIM( T.OLD_PAR_VALUE ))</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'OLD_PIC_PATH'</span><br><span class="line">) AS OLD_PAR_VALUE,</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'ATT_COS_PATH'</span><br><span class="line">) T</span><br><span class="line">)|| REPLACE( SUBSTR( iface.COMPARE_MSG, INSTR( iface.COMPARE_MSG, 'compare', 1, 1 )), ']', '' )</span><br><span class="line">) AS FACE_ATT_IMG</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE,</span><br><span class="line">ifa.COMPARE_MSG,</span><br><span class="line">RANK() OVER(</span><br><span class="line">PARTITION BY ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">ifa.created DESC</span><br><span class="line">) rankno</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifa</span><br><span class="line">WHERE</span><br><span class="line">ifa.HANDLE_TYPE = 0</span><br><span class="line">AND ifa.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND INSTR( ifa.COMPARE_MSG, 'compare' )&gt; 0</span><br><span class="line">AND ifa.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifa.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">) iface</span><br><span class="line">WHERE</span><br><span class="line">iface.rankno &lt;= 3</span><br><span class="line">GROUP BY</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE</span><br><span class="line">) iface2</span><br><span class="line">WHERE</span><br><span class="line">prj.PRJ_NAME ='(2013)行政项目'</span><br><span class="line">AND prj.ATT_DATE &gt;='2018-04-01'</span><br><span class="line">AND prj.ATT_DATE &lt;='2018-04-30'</span><br><span class="line">AND prj.EMP_PK = ifcl1.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifcl1.COMPARE_DATE(+)</span><br><span class="line">AND prj.EMP_PK = ifcl1Staus.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifcl1Staus.COMPARE_DATE(+)</span><br><span class="line">AND prj.ATT_SCH_PK = levLeave.ATT_SCH_PK(+)</span><br><span class="line">AND prj.ATT_SCH_PK = levRtn.ATT_SCH_PK(+)</span><br><span class="line">AND prj.PRJ_CODE = wq.CODE(+)</span><br><span class="line">AND prj.EMP_PK = ifaceCount.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.ATT_DATE, 'yyyy-mm-dd' ), 'yyyymmdd' )= ifaceCount.COMPARE_DATE(+)</span><br><span class="line">AND prj.EMP_PK = iface2.EMP_PK(+)</span><br><span class="line">AND TO_CHAR( TO_DATE( prj.sc_schedule_date, 'yyyy-mm-dd' ), 'yyyymmdd' )= iface2.COMPARE_DATE(+)</span><br><span class="line">ORDER BY</span><br><span class="line">APPLY_DATE DESC,</span><br><span class="line">ATTTYPE DESC</span><br></pre></td></tr></table></figure><h2 id="SQL优化思路"><a href="#SQL优化思路" class="headerlink" title="SQL优化思路"></a>SQL优化思路</h2><p>SQL语句较复杂，8个子查询的left outer join，每个子查询中又有连接。思路如下：</p><ol><li>从外往内拆分子查询</li><li>老旧对比子查询执行计划和执行效率</li><li>子查询连接从1到2到3一直到8个联查对比，寻找瓶颈</li></ol><h3 id="拆分子查询"><a href="#拆分子查询" class="headerlink" title="拆分子查询"></a>拆分子查询</h3><table><thead><tr><th>子查询</th><th>老库 （秒）</th><th>新库（秒）</th></tr></thead><tbody><tr><td>prj</td><td>1.182</td><td>0.318</td></tr><tr><td>ifcl1</td><td>14.229</td><td>13.168</td></tr><tr><td>ifclStatus</td><td>15.739</td><td>16.769</td></tr><tr><td>levLeave</td><td>10.147</td><td>9.813</td></tr><tr><td>levRtn</td><td>9.148</td><td>8.3</td></tr><tr><td>wq</td><td>0.141</td><td>0.165</td></tr><tr><td>ifcl1Count</td><td>3.498</td><td>1.966</td></tr><tr><td>iface2</td><td>49.255</td><td>50.897</td></tr></tbody></table><h3 id="寻找瓶颈"><a href="#寻找瓶颈" class="headerlink" title="寻找瓶颈"></a>寻找瓶颈</h3><table><thead><tr><th>连接</th><th>老库（秒）</th><th>新库（秒）</th></tr></thead><tbody><tr><td>prj+ifcl1</td><td>1.522</td><td>1.129</td></tr><tr><td>+ifclStatus</td><td>2.343</td><td>1.957</td></tr><tr><td>+levLeave</td><td>2.525</td><td>1.955</td></tr><tr><td>+levRtn</td><td>2.658</td><td>1.653</td></tr><tr><td>+wq</td><td>2.561</td><td>1.999</td></tr><tr><td>+ifcl1Count</td><td>3.498</td><td>1.966</td></tr><tr><td>+iface2</td><td>11.124</td><td>383</td></tr></tbody></table><p>发现瓶颈出现在<code>iface2</code></p><h2 id="优化iface2"><a href="#优化iface2" class="headerlink" title="优化iface2"></a>优化iface2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE,</span><br><span class="line">wm_concat(</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">NVL( TRIM( T.PAR_VALUE ), TRIM( T.OLD_PAR_VALUE ))</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'OLD_PIC_PATH'</span><br><span class="line">) AS OLD_PAR_VALUE,</span><br><span class="line">PAR_VALUE</span><br><span class="line">FROM</span><br><span class="line">MD_SYS_PARM</span><br><span class="line">WHERE</span><br><span class="line">PAR_CODE = 'ATT_COS_PATH'</span><br><span class="line">) T</span><br><span class="line">)|| REPLACE( SUBSTR( iface.COMPARE_MSG, INSTR( iface.COMPARE_MSG, 'compare', 1, 1 )), ']', '' )</span><br><span class="line">) AS FACE_ATT_IMG</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE,</span><br><span class="line">ifa.COMPARE_MSG,</span><br><span class="line">RANK() OVER(</span><br><span class="line">PARTITION BY ifa.EMP_PK,</span><br><span class="line">ifa.COMPARE_DATE</span><br><span class="line">ORDER BY</span><br><span class="line">ifa.created DESC</span><br><span class="line">) rankno</span><br><span class="line">FROM</span><br><span class="line">IPG_FACE_COMPARE_LOG ifa</span><br><span class="line">WHERE</span><br><span class="line">ifa.HANDLE_TYPE = 0</span><br><span class="line">AND ifa.COMPARE_TYPE IN(</span><br><span class="line">'1',</span><br><span class="line">'3',</span><br><span class="line">'5'</span><br><span class="line">)</span><br><span class="line">AND INSTR( ifa.COMPARE_MSG, 'compare' )&gt; 0</span><br><span class="line">AND ifa.COMPARE_DATE &gt;= TO_CHAR( TO_DATE('2018-04-01', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">AND ifa.COMPARE_DATE &lt;= TO_CHAR( TO_DATE('2018-04-30', 'yyyy-mm-dd' ), 'yyyymmdd' )</span><br><span class="line">) iface</span><br><span class="line">WHERE</span><br><span class="line">iface.rankno &lt;= 3</span><br><span class="line">GROUP BY</span><br><span class="line">iface.EMP_PK,</span><br><span class="line">iface.COMPARE_DATE</span><br></pre></td></tr></table></figure><p><code>IPG_FACE_COMPARE_LOG</code>表中<code>COMPARE_DATE列</code>需要新增索引。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>oracle小版本不同引起优化器无法获取相同的执行计划</li><li>索引缺失是本次的慢查询的主要原因</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：Oracle数据库做了迁移，从原来的DG迁移到新库RAC，小版本不同；老库中相同的SQL执行只需要11秒，而新库需要360秒甚至800多秒，如何进行复杂查询的SQL优化，本文提供通用的一个思路。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="Oracle" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/Oracle/"/>
    
    
      <category term="SQL优化" scheme="http://www.toberoot.com/tags/SQL%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>MySQL一次惊心动魄地数据强制恢复</title>
    <link href="http://www.toberoot.com/2018/05/17/MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/"/>
    <id>http://www.toberoot.com/2018/05/17/MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/</id>
    <published>2018-05-16T19:58:02.000Z</published>
    <updated>2020-03-22T08:32:42.588Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：Cash恢复的正确方式是：<strong>备份文件（逻辑或物理）+ binlog</strong>进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效</p><p>在本次案例中，某客户数据库因存储空间不够导致数据库服务宕掉，而客户在数据库宕机后，只拷贝了单个<code>cy</code>库所属的目录进行了文件层面的备份，就将其他文件全部清空，当他想重新启动数据库时发现数据库服务启动。MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的<code>.frm</code>和<code>.ibd</code>文件。</p><a id="more"></a><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>Cash恢复的正确方式是：<strong>备份文件（逻辑或物理）+ binlog</strong>进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效</p><p>在本次案例中，某客户只对单个<code>cy</code>库所属的目录进行了文件层面的备份，MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的<code>.frm</code>和<code>.ibd</code>文件。</p><h2 id="强制还原步骤"><a href="#强制还原步骤" class="headerlink" title="强制还原步骤"></a>强制还原步骤</h2><table><thead><tr><th>步骤</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td><strong>创建同版本的MySQL服务实例一枚</strong></td><td></td></tr><tr><td>2</td><td><strong>获取表的列数</strong></td><td>如果有ddl备份直接导入，可惜都是没有的，哭。。。</td></tr><tr><td>2.1</td><td>创建同名表，结构无所谓</td><td>数据库的世界也需要身份证，先造个人拿上身份证，至于人长得啥样几条胳膊都无所谓，名字最重要</td></tr><tr><td>2.2</td><td>停服务；使用备份的frm文件覆盖当前的frm</td><td>偷梁换柱</td></tr><tr><td>2.3</td><td>配置文件添加强制恢复innodb的参数；启动服务</td><td>蒙蔽她的双眼</td></tr><tr><td>2.4</td><td>查看表结构</td><td>数据库会拿着身份证和面前的人（frm文件）做对比</td></tr><tr><td>2.5</td><td>查看错误日志中关于该表的报错</td><td>数据库发现身份证上的人只有1条胳膊，而被检查的人有10条胳膊，明显对不上啊</td></tr><tr><td>2.6</td><td>成功获取表的真实列数；删除这些表</td><td>通过警告可以知道应该造一个有10条胳膊的人</td></tr><tr><td>3</td><td><strong>获取表的结构</strong></td><td></td></tr><tr><td>3.1</td><td>创建同名表，列数一致，列名无所谓</td><td>这一次造人的时候，造一个有10条胳膊的，每条胳膊的名字无所谓，关键是身份证上面的人名和10条胳膊</td></tr><tr><td>3.2</td><td>停服务；使用备份的frm文件覆盖当前的frm</td><td>偷梁换柱</td></tr><tr><td>3.3</td><td>配置文件添加强制恢复innodb的参数；启动服务</td><td>蒙蔽她的双眼</td></tr><tr><td>3.4</td><td>查看表结构</td><td>数据库会拿着新的身份证和面前的人（frm文件）做对比</td></tr><tr><td>3.5</td><td>成功获取表结构</td><td>数据库发现身份证上信息和被检查的人信息一致，名字，胳膊的数量，对上了就认可啦！（数据库只检查表名和列的个数）</td></tr><tr><td>4</td><td><strong>强制恢复表数据</strong></td><td></td></tr><tr><td>4.1</td><td>丢弃当前表的数据</td><td>把这个人的五脏六腑都挖出来</td></tr><tr><td>4.2</td><td>将备份的ibd放到对应路径</td><td>将之前备份的吃了肉的五脏六腑放进去</td></tr><tr><td>4.3</td><td>导入新的数据，如果数据库加载成功则可以看到数据；否则加载失败。</td><td>跟大脑汇报一下新的五脏六腑已经就位可以开始使用了；如果使用得没问题就成功；如果器官已经损坏那么手术失败。</td></tr></tbody></table><h2 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h2><h3 id="数据量"><a href="#数据量" class="headerlink" title="数据量"></a>数据量</h3><table><thead><tr><th>明细</th><th>大小</th><th>备注</th></tr></thead><tbody><tr><td>物理文件</td><td>174M</td><td></td></tr><tr><td>数据库</td><td>1个</td><td>cy</td></tr><tr><td>表</td><td>57张</td><td></td></tr></tbody></table><h3 id="恢复结果"><a href="#恢复结果" class="headerlink" title="恢复结果"></a>恢复结果</h3><blockquote><p>在客户服务器上面结果如下：</p></blockquote><table><thead><tr><th>明细</th><th>成功</th><th>失败</th><th>恢复率</th></tr></thead><tbody><tr><td>表结构</td><td>58</td><td>0</td><td>100%</td></tr><tr><td>表数据</td><td>56</td><td>2</td><td>96%</td></tr></tbody></table><blockquote><p>在我的服务器上面结果如下：</p></blockquote><table><thead><tr><th>明细</th><th>成功</th><th>失败</th><th>恢复率</th></tr></thead><tbody><tr><td>表结构</td><td>58</td><td>0</td><td>100%</td></tr><tr><td>表数据</td><td>58</td><td>0</td><td>100%</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot mysql]# /alidata/mysql/bin/mysqld --initialize-insecure --datadir=/alidata/mysql/data/  --user=mysql</span><br><span class="line">[root@toberoot mysql]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot mysql]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.17, for linux-glibc2.5 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">[root@toberoot mysql]# cd ~/home/cy02/</span><br><span class="line">[root@toberoot cy02]# ll</span><br><span class="line">total 178140</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9022 Aug 14  2017 base_dict.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar 14 15:00 base_dict.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8822 Mar  2 11:14 biz_advise.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 14 14:39 biz_advise.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8850 Mar  2 11:14 biz_bank.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar  2 11:14 biz_bank.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9580 Mar  2 11:14 biz.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9286 Mar  2 11:14 biz_gift.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Apr 24 14:08 biz_gift.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8890 Mar  2 11:14 biz_gprs_bind.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8745 Mar  2 11:14 biz_gprs_bind_his.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   180224 May 15 09:40 biz_gprs_bind_his.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   180224 May 15 09:42 biz_gprs_bind.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 14:33 biz.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8845 Aug 14  2017 biz_msg_template.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 biz_msg_template.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8881 Aug 14  2017 biz_take_bank.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 13 19:26 biz_take_bank.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9411 Nov 24 13:22 biz_take.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   196608 May 15 15:22 biz_take.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8862 Aug 14  2017 biz_take_wwlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 15:22 biz_take_wwlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8854 Aug 14  2017 biz_take_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 11:52 biz_take_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8925 Aug 14  2017 biz_vip.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Mar 16 09:31 biz_vip.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8852 Aug 14  2017 biz_wlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 18:30 biz_wlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8926 Aug 14  2017 biz_wx_focus.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 10 16:24 biz_wx_focus.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9339 Nov 24 13:25 biz_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 10 16:24 biz_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8874 Aug 14  2017 biz_wx_walt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 biz_wx_walt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8776 Aug 14  2017 cfg_area.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   311296 Aug 14  2017 cfg_area.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8721 Aug 14  2017 cfg_id_gen.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 18:41 cfg_id_gen.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql       61 Aug 14  2017 db.opt</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9053 Aug 14  2017 gprs_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   212992 May 15 18:47 gprs_model.ibd</span><br><span class="line">-r--r--r-- 1 mysql mysql 79691776 May 16 14:04 ibdata1</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8801 Dec 19 15:00 mbr_coin_chged.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  2097152 May 15 17:27 mbr_coin_chged.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8766 Dec 19 14:53 mbr_coin.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 19:12 mbr_coin.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9155 May 14 11:55 mbr.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   212992 May 15 20:58 mbr.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8876 Aug 14  2017 mbr_oauth.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   475136 May 15 19:37 mbr_oauth.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9011 Aug 14  2017 mbr_pay.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 mbr_pay.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8740 Aug 14  2017 mbr_prizen.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 mbr_prizen.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9147 Dec 19 14:56 mbr_recharge.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   294912 May 15 19:11 mbr_recharge.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8801 Aug 14  2017 mbr_wallet_chged.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 17:27 mbr_wallet_chged.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8845 Aug 14  2017 mbr_wallet.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   262144 May 15 19:12 mbr_wallet.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    10100 Dec 19 15:47 ord.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql 31457280 May 15 18:41 ord.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8940 Aug 14  2017 ord_item.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_item.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8917 Aug 14  2017 ord_pay_ali.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_pay_ali.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8924 Dec 19 15:55 ord_pay_coin.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   475136 May 15 17:27 ord_pay_coin.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8926 Aug 14  2017 ord_pay_return.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 ord_pay_return.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8966 Dec 20 16:50 ord_pay_wlt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 17:27 ord_pay_wlt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9036 Aug 14  2017 ord_pay_wx.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql 32505856 May 15 18:41 ord_pay_wx.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9098 Aug 14  2017 prod_base_args.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_base_args.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8790 Aug 14  2017 prod_bug_rpt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_bug_rpt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8887 Aug 14  2017 prod_cmd.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_cmd.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8984 Aug 14  2017 prod_cmd_invoke.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_cmd_invoke.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9058 Aug 14  2017 prod_coin_rpt.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9437184 May 15 14:24 prod_coin_rpt.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8798 Aug 14  2017 prod_coin_rpt_log.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 15 14:24 prod_coin_rpt_log.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9834 Dec 13 14:12 prod.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8835 Aug 14  2017 prod_gprs_bind.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8793 Aug 14  2017 prod_gprs_bind_his.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   196608 May 15 09:42 prod_gprs_bind_his.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_gprs_bind.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql   425984 May 15 09:42 prod.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8851 Aug 14  2017 prod_instl_imgs.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_instl_imgs.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9388 Dec 13 14:13 prod_instl_pos.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   147456 May 15 16:25 prod_instl_pos.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9384 Dec 13 14:14 prod_instl_pos_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   131072 May 15 16:24 prod_instl_pos_model.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8892 Aug 14  2017 prod_mod_attr.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_attr.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8873 Aug 14  2017 prod_mod_attr_val.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_attr_val.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9642 Dec 13 14:11 prod_model.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 11 11:58 prod_model.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8815 Aug 14  2017 prod_mod_sku.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_mod_sku.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9050 Aug 14  2017 prod_onl_log.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   163840 May 15 18:42 prod_onl_log.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9143 Aug 14  2017 prod_sp_args.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_sp_args.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8876 Aug 14  2017 prod_sp_arg_vals.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 prod_sp_arg_vals.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9190 Dec 13 14:14 sys_acct.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 May 14 11:16 sys_acct.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     8776 Aug 14  2017 sys_acct_res.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql   229376 May 11 11:52 sys_acct_res.ibd</span><br><span class="line">-rw-r--r-- 1 mysql mysql     9106 Aug 14  2017 sys_res.frm</span><br><span class="line">-rw-r--r-- 1 mysql mysql    98304 Aug 14  2017 sys_res.ibd</span><br><span class="line"><span class="meta">#</span><span class="bash">获取待恢复表名</span></span><br><span class="line">[root@toberoot cy02]# ll *.frm |awk '&#123;print $9&#125;'|awk -F '.' '&#123;print $1&#125;' &gt; /alidata/cy_table.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> python脚本自动生成建表语句</span></span><br><span class="line">[root@toberoot alidata]# cat py_createtable01.py </span><br><span class="line"><span class="meta">#</span><span class="bash">-*- coding : utf8 -*-</span></span><br><span class="line"></span><br><span class="line">def create_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    create_table_test('/alidata/cy_table.txt','/alidata/cy_sql1.sql')</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# python /alidata/py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql1.sql </span><br><span class="line">create table base_dict</span><br><span class="line"> (id int);create table biz_advise</span><br><span class="line"> (id int);create table biz_bank</span><br><span class="line"> (id int);create table biz</span><br><span class="line"> (id int);create table biz_gift</span><br><span class="line"> (id int);create table biz_gprs_bind</span><br><span class="line"> (id int);create table biz_gprs_bind_his</span><br><span class="line"> (id int);create table biz_msg_template</span><br><span class="line"> (id int);create table biz_take_bank</span><br><span class="line"> (id int);create table biz_take</span><br><span class="line">省略。。。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入测试表结构</span></span><br><span class="line">[root@toberoot alidata]# mysql -e "show databases"</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@toberoot alidata]# mysql -e "create database cy;"</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; /alidata/cy_sql1.sql </span><br><span class="line">[root@toberoot alidata]# mysql -e "desc cy.sys_res"</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11) | YES  |     | NULL    |       |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始获取表结构中列的信息</span></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# yes|cp ~/home/cy02/*.frm /alidata/mysql/data/cy/</span><br><span class="line">cp: overwrite ‘/alidata/mysql/data/cy/base_dict.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_advise.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_bank.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gift.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gprs_bind.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_gprs_bind_his.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_msg_template.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_bank.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_wwlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_take_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_vip.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx_focus.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/biz_wx_walt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/cfg_area.frm’? cp: overwrite ‘/alidata/mysql/data/cy/cfg_id_gen.frm’? cp: overwrite ‘/alidata/mysql/data/cy/gprs_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_coin_chged.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_coin.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_oauth.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_pay.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_prizen.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_recharge.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_wallet_chged.frm’? cp: overwrite ‘/alidata/mysql/data/cy/mbr_wallet.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_item.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_ali.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_coin.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_return.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_wlt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/ord_pay_wx.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_base_args.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_bug_rpt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_cmd.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_cmd_invoke.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_coin_rpt.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_coin_rpt_log.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_gprs_bind.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_gprs_bind_his.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_imgs.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_pos.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_instl_pos_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_attr.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_attr_val.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_model.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_mod_sku.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_onl_log.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_sp_args.frm’? cp: overwrite ‘/alidata/mysql/data/cy/prod_sp_arg_vals.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_acct.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_acct_res.frm’? cp: overwrite ‘/alidata/mysql/data/cy/sys_res.frm’? [root@toberoot alidata]# </span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# cat py_createtable01.py </span><br><span class="line"><span class="meta">#</span><span class="bash">-*- coding : utf8 -*-</span></span><br><span class="line"></span><br><span class="line">def create_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line">   </span><br><span class="line">def desc_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "desc &#123;&#125;;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    #create_table_test('/alidata/cy_table.txt','/alidata/cy_sql1.sql')</span><br><span class="line">    desc_table_test('/alidata/cy_table.txt','/alidata/cy_sql2.sql')</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py</span><br><span class="line">[root@toberoot alidata]# head cy_sql2.sql </span><br><span class="line">desc base_dict</span><br><span class="line">;desc biz_advise</span><br><span class="line">;desc biz_bank</span><br><span class="line">;desc biz</span><br><span class="line">;desc biz_gift</span><br><span class="line">;desc biz_gprs_bind</span><br><span class="line">;desc biz_gprs_bind_his</span><br><span class="line">;desc biz_msg_template</span><br><span class="line">;desc biz_take_bank</span><br><span class="line">;desc biz_take</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 截取包含列名的报错</span></span><br><span class="line">[root@toberoot alidata]# grep contains  mysql/dataerror.log &gt; cy_error1.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 报错格式如下：</span></span><br><span class="line">2018-05-17T07:58:32.926555Z 3 [Warning] InnoDB: Table cy/base_dict contains 1 user defined columns in InnoDB, but 11 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-05-17T07:59:03.555492Z 4 [Warning] InnoDB: Table cy/biz_advise contains 1 user defined columns in InnoDB, but 7 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-05-17T07:59:03.556045Z 4 [Warning] InnoDB: Table cy/biz_bank contains 1 user defined columns in InnoDB, but 7 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将表名和列数存放至文件中</span></span><br><span class="line">[root@toberoot alidata]# awk '&#123;print $6,$15&#125;' cy_error1.log | awk -F '/' '&#123;print $2&#125;' &gt; cy_table_col.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据以上表名和列数生成新的测试表</span></span><br><span class="line">def create_table_col(table_col_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_col_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    # b_list = ['t1 10','t2 20']</span><br><span class="line">    str_list = []</span><br><span class="line">    for table_col_str in b_list:</span><br><span class="line">        table_col_list = table_col_str.split()</span><br><span class="line">table = table_col_list[0]</span><br><span class="line">col = int(table_col_list[1])</span><br><span class="line">        string = "create table &#123;&#125; (".format(table)</span><br><span class="line">        str_list.append(string)</span><br><span class="line">for i in range(1,col+1):</span><br><span class="line">            if i!=col:</span><br><span class="line">                string = 'id&#123;&#125; int,'.format(i)</span><br><span class="line">    else:</span><br><span class="line">                string = 'id&#123;&#125; int);'.format(i)</span><br><span class="line">            str_list.append(string)</span><br><span class="line">    for line in str_list:</span><br><span class="line">        a_file.write(line)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">create_table_col('/alidata/cy_table_col.txt','/alidata/cy_sql3.sql')</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除这些测试表</span></span><br><span class="line">[root@toberoot alidata]# vim py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# ll</span><br><span class="line">total 60</span><br><span class="line">-rw-r--r--  1 root  root  16729 May 17 16:00 cy_error1.log</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 15:12 cy_sql1.sql</span><br><span class="line">-rw-r--r--  1 root  root   1047 May 17 15:56 cy_sql2.sql</span><br><span class="line">-rw-r--r--  1 root  root   6353 May 17 16:15 cy_sql3.sql</span><br><span class="line">-rw-r--r--  1 root  root   1395 May 17 16:17 cy_sql4.sql</span><br><span class="line">-rw-r--r--  1 root  root    837 May 17 16:03 cy_table_col.txt</span><br><span class="line">-rw-r--r--  1 root  root    699 May 17 15:56 cy_table.txt</span><br><span class="line">drwxr-xr-x  3 root  root   4096 May 17 12:12 install</span><br><span class="line">drwxr-xr-x 11 mysql mysql  4096 May 17 15:44 mysql</span><br><span class="line">-rw-r--r--  1 root  root   1798 May 17 16:17 py_createtable01.py</span><br><span class="line"><span class="meta">#</span><span class="bash">python代码如下：</span></span><br><span class="line">def drop_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "drop table &#123;&#125;;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close()</span><br><span class="line"></span><br><span class="line">drop_table_test('/alidata/cy_table.txt','/alidata/cy_sql4.sql')</span><br><span class="line">    </span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql4.sql </span><br><span class="line">drop table base_dict</span><br><span class="line">;drop table biz_advise</span><br><span class="line">;drop table biz_bank</span><br><span class="line">;drop table biz</span><br><span class="line">;drop table biz_gift</span><br><span class="line">;drop table biz_gprs_bind</span><br><span class="line">;drop table biz_gprs_bind_his</span><br><span class="line">;drop table biz_msg_template</span><br><span class="line">;drop table biz_take_bank</span><br><span class="line">;drop table biz_take</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除数据库的时候直接卡死了，原因未知。也没有报错。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">清数据启动服务</span></span><br><span class="line"></span><br><span class="line">ln: failed to create symbolic link ‘/usr/local/mysql/bin/mysqld’: File exists</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot ~]# mysql -e 'create database cy'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始尝试获取表的结构</span></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql3.sql</span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# cp ~/home/cy02/*.frm /alidata/mysql/data/cy/ -p</span><br><span class="line">cp: overwrite ‘/alidata/mysql/data/cy/base_dict.frm’? ^C</span><br><span class="line">[root@toberoot alidata]# yes | cp ~/home/cy02/*.frm /alidata/mysql/data/cy/ -p</span><br><span class="line">[root@toberoot alidata]# ll /alidata/mysql/data/cy/sys_res*</span><br><span class="line">-rw-r--r-- 1 mysql mysql  9106 Aug 14  2017 /alidata/mysql/data/cy/sys_res.frm</span><br><span class="line">-rw-r----- 1 mysql mysql 98304 May 17 16:44 /alidata/mysql/data/cy/sys_res.ibd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_force_recovery=6</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表结构成功获取</span></span><br><span class="line">[root@toberoot alidata]# mysql cy -e 'desc sys_res'</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type         | Null | Key | Default | Extra |</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">| ID     | varchar(64)  | NO   | PRI | NULL    |       |</span><br><span class="line">| NAME   | varchar(32)  | NO   |     | NULL    |       |</span><br><span class="line">| CODE   | varchar(128) | NO   |     | NULL    |       |</span><br><span class="line">| URI    | varchar(128) | NO   |     | NULL    |       |</span><br><span class="line">| LOGO   | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| TYPE   | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| PCODE  | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| SORT   | int(11)      | YES  |     | 0       |       |</span><br><span class="line">| STATE  | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| ADMIN  | int(11)      | YES  |     | 0       |       |</span><br><span class="line">| REMARK | varchar(64)  | YES  |     | NULL    |       |</span><br><span class="line">| CRTIME | datetime     | NO   |     | NULL    |       |</span><br><span class="line">| UPTIME | datetime     | NO   |     | NULL    |       |</span><br><span class="line">+--------+--------------+------+-----+---------+-------+</span><br><span class="line">root@MySQL-01 16:49:  [(none)]&gt; select table_name,table_schema from information_schema.tables where table_schema='cy';</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">| table_name           | table_schema |</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">| base_dict            | cy           |</span><br><span class="line">| biz                  | cy           |</span><br><span class="line">| biz_advise           | cy           |</span><br><span class="line">| biz_bank             | cy           |</span><br><span class="line">| biz_gift             | cy           |</span><br><span class="line">| biz_gprs_bind        | cy           |</span><br><span class="line">| biz_gprs_bind_his    | cy           |</span><br><span class="line">| biz_msg_template     | cy           |</span><br><span class="line">| biz_take             | cy           |</span><br><span class="line">| biz_take_bank        | cy           |</span><br><span class="line">| biz_take_wwlt        | cy           |</span><br><span class="line">| biz_take_wx          | cy           |</span><br><span class="line">| biz_vip              | cy           |</span><br><span class="line">| biz_wlt              | cy           |</span><br><span class="line">| biz_wx               | cy           |</span><br><span class="line">| biz_wx_focus         | cy           |</span><br><span class="line">| biz_wx_walt          | cy           |</span><br><span class="line">| cfg_area             | cy           |</span><br><span class="line">| cfg_id_gen           | cy           |</span><br><span class="line">| gprs_model           | cy           |</span><br><span class="line">| mbr                  | cy           |</span><br><span class="line">| mbr_coin             | cy           |</span><br><span class="line">| mbr_coin_chged       | cy           |</span><br><span class="line">| mbr_oauth            | cy           |</span><br><span class="line">| mbr_pay              | cy           |</span><br><span class="line">| mbr_prizen           | cy           |</span><br><span class="line">| mbr_recharge         | cy           |</span><br><span class="line">| mbr_wallet           | cy           |</span><br><span class="line">| mbr_wallet_chged     | cy           |</span><br><span class="line">| ord                  | cy           |</span><br><span class="line">| ord_item             | cy           |</span><br><span class="line">| ord_pay_ali          | cy           |</span><br><span class="line">| ord_pay_coin         | cy           |</span><br><span class="line">| ord_pay_return       | cy           |</span><br><span class="line">| ord_pay_wlt          | cy           |</span><br><span class="line">| ord_pay_wx           | cy           |</span><br><span class="line">| prod                 | cy           |</span><br><span class="line">| prod_base_args       | cy           |</span><br><span class="line">| prod_bug_rpt         | cy           |</span><br><span class="line">| prod_cmd             | cy           |</span><br><span class="line">| prod_cmd_invoke      | cy           |</span><br><span class="line">| prod_coin_rpt        | cy           |</span><br><span class="line">| prod_coin_rpt_log    | cy           |</span><br><span class="line">| prod_gprs_bind       | cy           |</span><br><span class="line">| prod_gprs_bind_his   | cy           |</span><br><span class="line">| prod_instl_imgs      | cy           |</span><br><span class="line">| prod_instl_pos       | cy           |</span><br><span class="line">| prod_instl_pos_model | cy           |</span><br><span class="line">| prod_mod_attr        | cy           |</span><br><span class="line">| prod_mod_attr_val    | cy           |</span><br><span class="line">| prod_mod_sku         | cy           |</span><br><span class="line">| prod_model           | cy           |</span><br><span class="line">| prod_onl_log         | cy           |</span><br><span class="line">| prod_sp_arg_vals     | cy           |</span><br><span class="line">| prod_sp_args         | cy           |</span><br><span class="line">| sys_acct             | cy           |</span><br><span class="line">| sys_acct_res         | cy           |</span><br><span class="line">| sys_res              | cy           |</span><br><span class="line">+----------------------+--------------+</span><br><span class="line">58 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 58张表dump备份出来</span></span><br><span class="line">[root@toberoot alidata]# mysqldump -B cy -d &gt; /alidata/new_yc_ddl.sql</span><br><span class="line">[root@toberoot alidata]# tail -n 30 /alidata/new_yc_ddl.sql </span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `sys_res` (</span><br><span class="line">  `ID` varchar(64) NOT NULL COMMENT 'ID',</span><br><span class="line">  `NAME` varchar(32) NOT NULL COMMENT '菜单名称',</span><br><span class="line">  `CODE` varchar(128) NOT NULL COMMENT '菜单编码',</span><br><span class="line">  `URI` varchar(128) NOT NULL COMMENT 'URI',</span><br><span class="line">  `LOGO` varchar(64) DEFAULT NULL COMMENT '图标',</span><br><span class="line">  `TYPE` int(11) NOT NULL COMMENT '@菜单类型（1菜单；2按钮）',</span><br><span class="line">  `PCODE` varchar(64) DEFAULT NULL COMMENT '父菜单',</span><br><span class="line">  `SORT` int(11) DEFAULT '0' COMMENT '排序',</span><br><span class="line">  `STATE` int(11) NOT NULL COMMENT '@@状态（0 无效；1 正常）',</span><br><span class="line">  `ADMIN` int(11) DEFAULT '0' COMMENT '是否管理员菜单（默认0否）',</span><br><span class="line">  `REMARK` varchar(64) DEFAULT NULL COMMENT '备注',</span><br><span class="line">  `CRTIME` datetime NOT NULL COMMENT 'CRTIME',</span><br><span class="line">  `UPTIME` datetime NOT NULL COMMENT 'UPTIME',</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='权限_系统资源';</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2018-05-17 16:52:28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> discard和import命令</span></span><br><span class="line">def discard_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "alter table &#123;&#125; discard tablespace;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def import_table_test(table_file,sql_file):</span><br><span class="line">    a_file = open(sql_file,'w')</span><br><span class="line">    b_file = open(table_file)</span><br><span class="line">    b_list = b_file.readlines()</span><br><span class="line">    for table in b_list:</span><br><span class="line">        string = "alter table &#123;&#125; import tablespace;".format(table)</span><br><span class="line">        a_file.write(string)</span><br><span class="line">    a_file.close() </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">discard_table_test('/alidata/cy_table.txt','/alidata/cy_sql5.sql')</span><br><span class="line">import_table_test('/alidata/cy_table.txt','/alidata/cy_sql6.sql')</span><br><span class="line">   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成sql</span></span><br><span class="line">[root@toberoot alidata]# python py_createtable01.py </span><br><span class="line">[root@toberoot alidata]# ll</span><br><span class="line">total 124</span><br><span class="line">-rw-r--r--  1 root  root  16729 May 17 16:00 cy_error1.log</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 15:12 cy_sql1.sql</span><br><span class="line">-rw-r--r--  1 root  root   1047 May 17 15:56 cy_sql2.sql</span><br><span class="line">-rw-r--r--  1 root  root   6353 May 17 16:15 cy_sql3.sql</span><br><span class="line">-rw-r--r--  1 root  root   1395 May 17 16:17 cy_sql4.sql</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 16:55 cy_sql5.sql</span><br><span class="line">-rw-r--r--  1 root  root   2033 May 17 16:55 cy_sql6.sql</span><br><span class="line">-rw-r--r--  1 root  root    837 May 17 16:03 cy_table_col.txt</span><br><span class="line">-rw-r--r--  1 root  root    699 May 17 15:56 cy_table.txt</span><br><span class="line">drwxr-xr-x  3 root  root   4096 May 17 16:41 install</span><br><span class="line">drwxr-xr-x 11 mysql mysql  4096 May 17 16:47 mysql</span><br><span class="line">-rw-r--r--  1 root  root  57068 May 17 16:52 new_yc_ddl.sql</span><br><span class="line">-rw-r--r--  1 root  root   2489 May 17 16:55 py_createtable01.py</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql5.sql </span><br><span class="line">alter table base_dict</span><br><span class="line"> discard tablespace;alter table biz_advise</span><br><span class="line"> discard tablespace;alter table biz_bank</span><br><span class="line"> discard tablespace;alter table biz</span><br><span class="line"> discard tablespace;alter table biz_gift</span><br><span class="line"> discard tablespace;alter table biz_gprs_bind</span><br><span class="line"> discard tablespace;alter table biz_gprs_bind_his</span><br><span class="line"> discard tablespace;alter table biz_msg_template</span><br><span class="line"> discard tablespace;alter table biz_take_bank</span><br><span class="line"> discard tablespace;alter table biz_take</span><br><span class="line">[root@toberoot alidata]# head /alidata/cy_sql6.sql </span><br><span class="line">alter table base_dict</span><br><span class="line"> import tablespace;alter table biz_advise</span><br><span class="line"> import tablespace;alter table biz_bank</span><br><span class="line"> import tablespace;alter table biz</span><br><span class="line"> import tablespace;alter table biz_gift</span><br><span class="line"> import tablespace;alter table biz_gprs_bind</span><br><span class="line"> import tablespace;alter table biz_gprs_bind_his</span><br><span class="line"> import tablespace;alter table biz_msg_template</span><br><span class="line"> import tablespace;alter table biz_take_bank</span><br><span class="line"> import tablespace;alter table biz_take</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld restart</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# cp /root/home/cy02/*.ibd /alidata/mysql/data/cy/ -rp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 2013 (HY000) at line 1: Lost connection to MySQL server during query</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# service mysqld restart</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br><span class="line">[root@toberoot alidata]# service mysqld stop</span><br><span class="line">Shutting down MySQL..                                      [  OK  ]</span><br><span class="line">[root@toberoot alidata]# rm -rf /alidata/mysql/data/*</span><br><span class="line"></span><br><span class="line">[root@toberoot alidata]# service mysqld start</span><br><span class="line">Starting MySQL.                                            [  OK  ]</span><br><span class="line">[root@toberoot alidata]# mysql &lt; new_yc_ddl.sql </span><br><span class="line">[root@toberoot alidata]# mysql -e 'use cy;select * from sys_res'</span><br><span class="line"></span><br><span class="line">开启强制恢复参数</span><br><span class="line">[root@toberoot alidata]# vim /etc/my.cnf</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql</span><br><span class="line">cy_sql1.sql  cy_sql2.sql  cy_sql3.sql  cy_sql4.sql  cy_sql5.sql  cy_sql6.sql  </span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql </span><br><span class="line">[root@toberoot alidata]# cp /root/home/cy02/*.ibd /alidata/mysql/data/cy/ -rp</span><br><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 全备份数据</span></span><br><span class="line">[root@toberoot alidata]# mysqldump -B cy &gt; new_cy_all.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看备份的数据量</span></span><br><span class="line">-rw-r--r--  1 root  root   26M May 17 17:13 new_cy_all.sql</span><br></pre></td></tr></table></figure><h2 id="报错汇总"><a href="#报错汇总" class="headerlink" title="报错汇总"></a>报错汇总</h2><h3 id="ERROR-1036-（HY00）"><a href="#ERROR-1036-（HY00）" class="headerlink" title="ERROR 1036 （HY00）"></a>ERROR 1036 （HY00）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql5.sql</span><br><span class="line">ERROR 1036 (HY000) at line 1: Table 'base_dict' is read only</span><br></pre></td></tr></table></figure><p>解决方法：</p><ol><li>检查是否配置文件中存在innodb_force_recovery参数</li><li>如果存在去除或注释掉，重启服务即可</li><li>还不行就清空数据库导入结构后再继续</li></ol><h3 id="ERROR-2013-HY000"><a href="#ERROR-2013-HY000" class="headerlink" title="ERROR 2013 (HY000)"></a>ERROR 2013 (HY000)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@toberoot alidata]# mysql cy &lt; cy_sql6.sql</span><br><span class="line">ERROR 2013 (HY000) at line 1: Lost connection to MySQL server during query</span><br></pre></td></tr></table></figure><p>解决方法：</p><ol><li><p>sql脚本中执行import tablespace的操作需要开启recovery的参数</p></li><li><p>重启服务 </p><p>在客户服务上，执行以上操作还是报错无法连接，尝试多次都不行。</p></li></ol><p><img src="MySQL%E4%B8%80%E6%AC%A1%E6%83%8A%E5%BF%83%E5%8A%A8%E9%AD%84%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D/04.jpg" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次case的教训就是，备份！一定要有周期性的有效备份！</p><p>欺骗MySQL进程蒙混过关只能是没办法的办法，而且不能保证成功率。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -*- coding : utf8 -*-</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> py_createtable01.py</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> auth： booboowei</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class mysql_tools():</span><br><span class="line">    def __init__(self, in_file):</span><br><span class="line">        self.b_list = open(in_file).readlines()</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">    def create_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "create table &#123;&#125; (id int);".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def desc_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "desc &#123;&#125;;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def create_table_col(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        str_list = []</span><br><span class="line">        for table_col_str in self.b_list:</span><br><span class="line">            table_col_list = table_col_str.split()</span><br><span class="line">            table = table_col_list[0]</span><br><span class="line">            col = int(table_col_list[1])</span><br><span class="line">            string = "create table &#123;&#125; (".format(table)</span><br><span class="line">            str_list.append(string)</span><br><span class="line">            for i in range(1, col + 1):</span><br><span class="line">                if i != col:</span><br><span class="line">                    string = 'id&#123;&#125; int,'.format(i)</span><br><span class="line">                else:</span><br><span class="line">                    string = 'id&#123;&#125; int);'.format(i)</span><br><span class="line">                str_list.append(string)</span><br><span class="line">        for line in str_list:</span><br><span class="line">            a_file.write(line)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def drop_table_test(self,  sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "drop table &#123;&#125;;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def discard_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "alter table &#123;&#125; discard tablespace;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def import_table_test(self, sql_file):</span><br><span class="line">        a_file = open(sql_file, 'w')</span><br><span class="line">        for table in self.b_list:</span><br><span class="line">            string = "alter table &#123;&#125; import tablespace;".format(table)</span><br><span class="line">            a_file.write(string)</span><br><span class="line">        a_file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').create_table_test('/alidata/cy_sql1.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').desc_table_test('/alidata/cy_sql2.sql')</span><br><span class="line">    # 根据以上表名和列数生成新的测试表</span><br><span class="line">    mysql_tools('/alidata/cy_table_col.txt').create_table_col('/alidata/cy_sql3.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').drop_table_test('/alidata/cy_sql4.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').discard_table_test('/alidata/cy_sql5.sql')</span><br><span class="line">    mysql_tools('/alidata/cy_table.txt').import_table_test('/alidata/cy_sql6.sql')</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：Cash恢复的正确方式是：&lt;strong&gt;备份文件（逻辑或物理）+ binlog&lt;/strong&gt;进行恢复；然而并不是所有的运维人员都知道怎么进行正确的备份，甚至连逻辑备份和物理备份的区别是什么都不知道？更不知道备份过程中需要考虑数据的一致性与服务可用性的问题？或者连备份工具都不会使用，所以当你问：有备份吗？回答：没有或者无效&lt;/p&gt;
&lt;p&gt;在本次案例中，某客户数据库因存储空间不够导致数据库服务宕掉，而客户在数据库宕机后，只拷贝了单个&lt;code&gt;cy&lt;/code&gt;库所属的目录进行了文件层面的备份，就将其他文件全部清空，当他想重新启动数据库时发现数据库服务启动。MySQL使用5.7.17版本，使用innodb存储引擎，开启了独立表空间。也就是说当前的救命稻草是：每个表的&lt;code&gt;.frm&lt;/code&gt;和&lt;code&gt;.ibd&lt;/code&gt;文件。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="数据救援" scheme="http://www.toberoot.com/tags/%E6%95%B0%E6%8D%AE%E6%95%91%E6%8F%B4/"/>
    
  </entry>
  
  <entry>
    <title>MySQL的元锁MDL发生场景和解决方法总结</title>
    <link href="http://www.toberoot.com/2017/08/19/MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"/>
    <id>http://www.toberoot.com/2017/08/19/MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/</id>
    <published>2017-08-18T20:06:27.000Z</published>
    <updated>2020-03-22T08:32:42.577Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。</p><p>今天有客户(MySQL 5.6)遇到该问题，最关键的是属于第三种情况，google上根本找不到类似的故障案例，唯一一个非常接近的故障案例中数据库版本却不同（具体看下文慢慢聊），哎，困难重重啊，最终还是解决了哈。</p><p>alter table的语句是很危险的，在操作之前最好确认对要操作的表没有任何进行中的操作、没有未提交事务、也没有显式事务中的报错语句。如果有alter table的维护任务，在无人监管的时候运行，最好通过lock_wait_timeout设置好超时时间，避免长时间的metedata锁等待。</p><a id="more"></a><h2 id="什么是metadata-lock？"><a href="#什么是metadata-lock？" class="headerlink" title="什么是metadata lock？"></a>什么是metadata lock？</h2><p>MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。</p><h3 id="MetaData-Lock的前世今生"><a href="#MetaData-Lock的前世今生" class="headerlink" title="MetaData Lock的前世今生"></a><strong>MetaData Lock的前世今生</strong></h3><p>MDL锁是为了解决一个有名的<a href="https://bugs.mysql.com/bug.php?id=989" target="_blank" rel="noopener">bug#989</a>，所以在5.5.3版本引入了MDL锁。其实5.5也有类似保护元数据的机制，只是没有明确提出MDL概念而已。但是5.5之前版本(比如5.1)与5.5之后版本在保护元数据这块有一个显著的不同点是，5.1对于元数据的保护是语句级别的，5.5对于metadata的保护是事务级别的。所谓语句级别，即语句执行完成后，无论事务是否提交或回滚，其表结构可以被其他会话更新；而事务级别则是在事务结束后才释放MDL。引入MDL锁主要是为了<strong>解决两个问题</strong>：</p><ul><li>事务隔离问题：比如在可重复隔离级别下，会话A在2次查询期间，会话B对表结构做了修改，两次查询结果就会不一致，无法满足可重复读的要求。</li><li>数据复制问题：比如会话A执行了多条更新语句期间，另外一个会话B做了表结构变更并且先提交，就会导致slave在重做时，先重做alter，再重做update时就会出现复制错误的现象。也就是上面提到的<a href="https://bugs.mysql.com/bug.php?id=989" target="_blank" rel="noopener">bug#989</a>。</li></ul><hr><h3 id="DDL操作与MetaData-Lock"><a href="#DDL操作与MetaData-Lock" class="headerlink" title="DDL操作与MetaData Lock"></a>DDL操作与MetaData Lock</h3><ul><li>metadata lock 机制是为了保证数据一致性存在的，在有事务的操作时候，需要首先获得metadata lock ,然后操作，如果这个时候，又来了一个事务也要ddl操作同一个表，就会出现 metadata lock。</li><li>自动提交模式下，单语句就是一个事务，执行完了，事务也就结束了。</li><li>preparestatement  会获得 metalock，一旦prepare 完毕， metalock 就释放了。</li><li>online DDL应该是指在alter table进行的时候， 插入/修改/删除数据的sql语句不会Waiting for table metadata lock。一旦alter table TableA的操作停滞在Waiting for table metadata lock的状态，后续对TableA的任何操作（包括读）都无法进行，也会在Opening tables的阶段进入Waiting for table metadata lock的队列。</li></ul><h2 id="Alter-table-会发生锁的三种场景"><a href="#Alter-table-会发生锁的三种场景" class="headerlink" title="Alter table 会发生锁的三种场景"></a>Alter table 会发生锁的三种场景</h2><h3 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h3><ul><li>会话A对booboo表执行读操作<code>select *,sleep(60) from booboo;</code>，正在进行未提交事务</li><li>会话B对booboo表执行在线DDL操作<code>alter table booboo add q4 int default 0;</code></li><li>会话C对booboo表执行隐式读操作<code>select *,sleep(60) from booboo;</code>,进行等待</li><li>会话D对booboo表执行显示读操作<code>begin;select * from booboo;</code>也会进行等待</li><li>通过<code>show processlist</code>可以看到会话A（对booboo表上正在进行的操作），此时会话B（alter table语句）无法获取到metadata 独占锁，会进行等待，会话C和会话D都会进行等待，且能从processlist表中看到对booboo表的操作</li><li>会话A提交事务后或kill之后，会话C事务结束，会话D<code>select</code>语句执行成功，事务提交则会话B可执行，否则进入场景2</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;</span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |  167 | Waiting for table metadata lock | alter table booboo add q4 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Query   |  155 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">|  9 | root | localhost | uplooking | Query   |  181 | User sleep                      | select *,sleep(60) from booboo          |</span><br><span class="line">| 10 | root | localhost | uplooking | Query   |    7 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> id=9的线程为会话A 虽然是隐式事务，但是没有执行成功，所以为未提交的事务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=6的线程为会话B 在会话A有事务未提交的情况下，执行Alter操作,争抢metadata lock</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=7的线程为会话C 隐式查询事务也会进入等待</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id=10的线程为会话D 显示查询事务同样进入等待</span></span><br></pre></td></tr></table></figure><p>解决方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看metadatalock</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 第一种情况，则定位到长时间未提交的事务kill即可</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询 information_schema.innodb_trx 看到有长时间未完成的事务， 使用 <span class="built_in">kill</span> 命令终止该查询。</span></span><br><span class="line"></span><br><span class="line">select concat('kill ',i.trx_mysql_thread_id,';') from information_schema.innodb_trx i,</span><br><span class="line">  (select </span><br><span class="line">         id, time</span><br><span class="line">     from</span><br><span class="line">         information_schema.processlist</span><br><span class="line">     where</span><br><span class="line">         time = (select </span><br><span class="line">                 max(time)</span><br><span class="line">             from</span><br><span class="line">                 information_schema.processlist</span><br><span class="line">             where</span><br><span class="line">                 state = 'Waiting for table metadata lock'</span><br><span class="line">                     and substring(info, 1, 5) in ('alter' , 'optim', 'repai', 'lock ', 'drop ', 'creat'))) p</span><br><span class="line">  where timestampdiff(second, i.trx_started, now()) &gt; p.time</span><br><span class="line">  and i.trx_mysql_thread_id  not in (connection_id(),p.id);</span><br></pre></td></tr></table></figure><h3 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h3><ul><li>通过<code>show processlist</code>看不到booboo上有任何操作，但实际上存在有未提交的事务，可以在<code>information_schema.innodb_trx</code>中查看到。在事务没有完成之前，booboo的锁不会释放，alter table同样获取不到metadata的独占锁</li><li>会话D提交事务或回滚或kill，则会话B中的Alter可继续执行</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在场景1的基础上，将会话A的事务完成或者<span class="built_in">kill</span>掉，会话C执行成功，但是会话B和会话D继续进入metadata锁的等待。原因是会话D虽然select可以执行，但是事务没有提交，则表上的metadata锁还存在，导致会话B的ddl操作无法执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B和会话D，情况1：知道有未完成的事务D，则结束会话D的事务，会话B正常执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B和会话D，情况2：不知道有未结束的事务D，如何排错呢？</span></span><br><span class="line">=================================</span><br><span class="line"></span><br><span class="line">-- 请根据具体的情景修改查询语句</span><br><span class="line">-- 如果导致阻塞的语句的用户与当前用户不同，请使用导致阻塞的语句的用户登录来终止会话</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 场景2的情况，是在场景1的基础上，还是有metadatalock锁（*一般生产环境不会停服务，因此不停的有新的query发送过来，就会出现场景2*），则手动继续kill掉长事务即可，注意生产环境中，有可能ddl操作需要保留（*例如MDL锁出现在主从同步的从中，从库需要去执行主发送的表变更，当然，也可以先将主从停掉，手动执行alter操作，都可以*）以下方法是在停止对从库的读操作后，将非ddl的连接kill掉</span></span></span><br><span class="line"></span><br><span class="line">select id,State,command from information_schema.processlist where State="Waiting for table metadata lock";</span><br><span class="line">select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id;</span><br><span class="line">show processlist;</span><br><span class="line">select  concat('kill ',trx_mysql_thread_id,';') from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id and State!="Waiting for table metadata lock";</span><br><span class="line"></span><br><span class="line">===============================</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                             </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |  275 | Waiting for table metadata lock | alter table booboo add q6 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Sleep   |  269 |                                 | NULL                                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 10 | root | localhost | uplooking | Sleep   |  249 |                                 | NULL                                    |</span><br><span class="line">| 12 | root | localhost | uplooking | Sleep   |  191 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前进程发现除了Alter之外没有对booboo表的操作</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">| timediff | sysdate()           | trx_started         | id | USER | DB        | COMMAND | STATE                           | trx_state | trx_query                               |</span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">| 00:05:38 | 2017-08-18 20:21:07 | 2017-08-18 20:15:29 |  6 | root | uplooking | Query   | Waiting for table metadata lock | RUNNING   | alter table booboo add q6 int default 0 |</span><br><span class="line">| 00:05:38 | 2017-08-18 20:21:07 | 2017-08-18 20:15:29 | 10 | root | uplooking | Sleep   |                                 | RUNNING   | NULL                                    |</span><br><span class="line">+----------+---------------------+---------------------+----+------+-----------+---------+---------------------------------+-----------+-----------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看innodb_trx表可以看到除了alter之外有未完成的事务，但是看不到具体query，得到线程id为10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就可以<span class="built_in">kill</span> 10来结束事务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后Alter正常操作</span></span><br></pre></td></tr></table></figure><h3 id="场景3"><a href="#场景3" class="headerlink" title="场景3"></a>场景3</h3><blockquote><p>与场景2对比的现象不同于：</p><ul><li>场景2：未完成事务中存在未完成事务</li><li>场景3：未完成事务中不存在未完成事务：确认有错误事务未提交或回滚，找到该事务的session_id然后杀死</li></ul></blockquote><ul><li>通过<code>show processlist</code>看不到<code>booboo</code>表有任何操作，在<code>information_schema.innodb_trx</code>中也没有任何进行中的事务。</li><li>这很可能是因为在一个显式的事务中，对<code>booboo</code>表进行了一个失败的操作（比如查询了一个不存在的字段），这时事务没有开始，但是失败语句获取到的锁依然有效。从<code>performance_schema.events_statements_current</code>表中可以查到失败的语句</li><li>也就是说除了语法错误，其他错误语句获取到的锁在这个事务提交或回滚之前，仍然不会释放掉。<code>because the failed statement is written to the binary log and the locks protect log consistency</code>但是解释这一行为的原因很难理解，因为错误的语句根本不会被记录到二进制日志</li><li>解决方法：确认有错误事务未提交或回滚，找到该事务的sessionid然后杀死（难点）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 场景3的出现和前两种不同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看线程情况，看到alter操作metadata锁，还有其他的select操作有metadata锁</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 第一反应就是有可能是场景1，于是kill掉执行select的线程，再次查看线程情况，就只剩下执行alter线程了</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 接下来查看未完成的事务，如果是场景1，在kill掉冲突的线程后应该出现两种情况（A.alter操作正常执行B.线程中只有alter操作为waiting metadata lock状态；未完成事务中存在未完成事务）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 但是却发现和B情况有所不同的是：未完成事务中不存在未完成事务，总结第三种情况(C.线程中只有alter操作为waiting metadata lock状态；未完成事务中不存在未完成事务）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过搜索资料定位到是场景3，但资料中没有说怎么解决问题，又不能重新启动服务器，只有一个资料里提到了方法（确认有错误事务未提交或回滚，找到该事务的sessionid然后杀死，关键就是如何找到sessionid呢？performance_schema.events_statements_current中的thread_id为线程id并不是sessionid或者说会话id、连接id，如何通过thread_id找到session_id成为了难点？5.7中有个session表可以直接查到，而5.6中必须通过三表才能查到，分别为performance_schema.events_statements_current,performance_schema.threads,information_schema.processlist表。）</span></span><br><span class="line">=====================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">kill</span>掉除了写操作以外的query</span></span><br><span class="line">select concat('kill ',id) from information_schema.processlist where State="Waiting for table metadata lock" and substring(info, 1, 5) not in ('alter' , 'optim', 'repai', 'lock ', 'drop ', 'creat');</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 寻找未提交或未回滚的错误事务，并<span class="built_in">kill</span>即可</span></span><br><span class="line">select t.processlist_id,t.processlist_time,e.sql_text from performance_schema.threads t,performance_schema.events_statements_current e where t.thread_id=e.thread_id and e.SQL_TEXT like '%t1%';</span><br><span class="line"><span class="meta">#</span><span class="bash"> 案例中假设是在t1表上有MDL锁，则，e.sql_text 近似匹配t1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本方法5.5 5.6 5.7 都通用。</span></span><br><span class="line">=============================================================================</span><br></pre></td></tr></table></figure><p>第一步：模拟第三种情况，会话11执行一个显示事务，且query出现列错误，t1表中不存在xx列，不提交。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93%5Cmdl01.png" alt=""></p><p>第二步：会话14中执行alter操作</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl02.png" alt="mdl02"></p><p>第三步：执行一条query</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl03.png" alt="mdl03"></p><p>第四步：会话15执行一个显示事务，查询t1表</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl04.png" alt="mdl04"></p><p>第五步：查看当前的processlist情况，可以看到只要是对t1表的操作都出现了MDL锁等待；尝试通过第一种情况的解决方法找出阻塞的事务会话进行kill，发现不存在阻塞会话；查看当前未提交的事务发现返回空；通过过滤processlist中进行MDL锁等待且不是alter的会话id，进行kill。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl06.png" alt="mdl06"></p><p>第六步：只kill 12，15，留下执行alter的会话14；有人会想为什么都kill掉呢？因为即使现在kill掉了，t1表的MDL锁也不会释放掉，还不如留下会话14的ddl操作，等彻底解决了，自然就能执行这个操作。具体可以看下面的分析。</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl07.png" alt="mdl07"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl08.png" alt="mdl08"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl09.png" alt="mdl09"></p><p>第七步：给大家做个测试，即使将会话14的alter动作kill掉：</p><ul><li>processlist中看不到任何等待MDL锁的会话；</li><li>sys.schema_table_lock_waits中也不存在表锁（5.7才有sys库）；</li><li>performance_schema.metadata_locks中也不存在任何锁记录；</li><li>会话16想再去执行alter操作，又开始了MDL锁等待。</li></ul><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl10.png" alt="mdl10"></p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl11.png" alt="mdl11"></p><p>第八步：此时就一定可以确定当前属于【<strong>有错误事务未提交或回滚导致的MDL锁</strong>】的情况了。我们找出这个错误事务，进行kill</p><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl12.png" alt="mdl12"></p><p>第九步：kill掉会话11后，成功将MDL锁释放。</p><blockquote><p>有人又会问咯：为什么不将数据库重启？</p><p>回答：</p><p>如果说——</p><ol><li><p>业务允许重启</p></li><li><p>不想找到问题的根源</p><p>那么重启吧</p></li></ol><p>如果说—— </p><ol><li><p>数据库上面多个库，关联多个业务，不能重启</p></li><li><p>想找到问题的根源，防止下次再次出现类似的问题</p><p>那么你懂的</p></li></ol><p>那么为什么不直接kill所有会话呢？同样如果你要找出问题的根源那么就排查，不想问为什么就直接kill吧，末尾有kill的脚本</p></blockquote><p><img src="MySQL%E7%9A%84%E5%85%83%E9%94%81MDL%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/mdl13.png" alt="mdl13"></p><p>一步步分析如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                                                                                   </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |   17 | Waiting for table metadata lock | alter table booboo add q9 int default 0 |</span><br><span class="line">|  7 | root | localhost | uplooking | Query   |   11 | Waiting for table metadata lock | select * from booboo                    |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 14 | root | localhost | uplooking | Query   |    5 | Waiting for table metadata lock | select * from booboo where id=3         |</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |   28 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 7 ;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 14;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist;                                                                                                                                                                   </span></span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">| Id | User | Host      | db        | Command | Time | State                           | Info                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">|  6 | root | localhost | uplooking | Query   |   86 | Waiting for table metadata lock | alter table booboo add q9 int default 0 |</span><br><span class="line">|  8 | root | localhost | uplooking | Query   |    0 | starting                        | show processlist                        |</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |   97 |                                 | NULL                                    |</span><br><span class="line">+----+------+-----------+-----------+---------+------+---------------------------------+-----------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx <span class="built_in">where</span> trx_mysql_thread_id=id;</span></span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果符合情况C，需要去查看performance_schema.events_statements_current表中是否有对booboo的错误语句（这里的错误语句是非语法错误的，例如select中写了不存在的列等情况）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从下面的查询结果可以看到，确实存在一个错误语句事件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过该错误语句事件的THREAD_ID，到performance_schema.threads表查到该线程对应的PROCESSLIST_ID，而PROCESSLIST_ID进程id等于processlist中的id</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from performance_schema.events_statements_current <span class="built_in">where</span> SQL_TEXT like <span class="string">'%booboo%'</span>\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              THREAD_ID: 31</span><br><span class="line">               EVENT_ID: 16</span><br><span class="line">           END_EVENT_ID: NULL</span><br><span class="line">             EVENT_NAME: statement/sql/alter_table</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3292336129737000</span><br><span class="line">              TIMER_END: 3521408438190000</span><br><span class="line">             TIMER_WAIT: 229072308453000</span><br><span class="line">              LOCK_TIME: 0</span><br><span class="line">               SQL_TEXT: alter table booboo add q9 int default 0</span><br><span class="line">                 DIGEST: NULL</span><br><span class="line">            DIGEST_TEXT: NULL</span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 0</span><br><span class="line">      RETURNED_SQLSTATE: NULL</span><br><span class="line">           MESSAGE_TEXT: NULL</span><br><span class="line">                 ERRORS: 0</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 0</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 0</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 0</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">              THREAD_ID: 33</span><br><span class="line">               EVENT_ID: 74</span><br><span class="line">           END_EVENT_ID: NULL</span><br><span class="line">             EVENT_NAME: statement/sql/select</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3521408132304000</span><br><span class="line">              TIMER_END: 3521408462141000</span><br><span class="line">             TIMER_WAIT: 329837000</span><br><span class="line">              LOCK_TIME: 184000000</span><br><span class="line">               SQL_TEXT: select * from performance_schema.events_statements_current where SQL_TEXT like '%booboo%'</span><br><span class="line">                 DIGEST: NULL</span><br><span class="line">            DIGEST_TEXT: NULL</span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 0</span><br><span class="line">      RETURNED_SQLSTATE: NULL</span><br><span class="line">           MESSAGE_TEXT: NULL</span><br><span class="line">                 ERRORS: 0</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 1</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 1</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 1</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">              THREAD_ID: 40</span><br><span class="line">               EVENT_ID: 8</span><br><span class="line">           END_EVENT_ID: 8</span><br><span class="line">             EVENT_NAME: statement/sql/select</span><br><span class="line">                 SOURCE: socket_connection.cc:101</span><br><span class="line">            TIMER_START: 3280938133699000</span><br><span class="line">              TIMER_END: 3280938258470000</span><br><span class="line">             TIMER_WAIT: 124771000</span><br><span class="line">              LOCK_TIME: 0</span><br><span class="line">               SQL_TEXT: select abc from booboo</span><br><span class="line">                 DIGEST: 871dd43dfdfb143e81439bbe7bf7b57e</span><br><span class="line">            DIGEST_TEXT: SELECT `abc` FROM `booboo` </span><br><span class="line">         CURRENT_SCHEMA: uplooking</span><br><span class="line">            OBJECT_TYPE: NULL</span><br><span class="line">          OBJECT_SCHEMA: NULL</span><br><span class="line">            OBJECT_NAME: NULL</span><br><span class="line">  OBJECT_INSTANCE_BEGIN: NULL</span><br><span class="line">            MYSQL_ERRNO: 1054</span><br><span class="line">      RETURNED_SQLSTATE: 42S22</span><br><span class="line">           MESSAGE_TEXT: Unknown column 'abc' in 'field list'</span><br><span class="line">                 ERRORS: 1</span><br><span class="line">               WARNINGS: 0</span><br><span class="line">          ROWS_AFFECTED: 0</span><br><span class="line">              ROWS_SENT: 0</span><br><span class="line">          ROWS_EXAMINED: 0</span><br><span class="line">CREATED_TMP_DISK_TABLES: 0</span><br><span class="line">     CREATED_TMP_TABLES: 0</span><br><span class="line">       SELECT_FULL_JOIN: 0</span><br><span class="line"> SELECT_FULL_RANGE_JOIN: 0</span><br><span class="line">           SELECT_RANGE: 0</span><br><span class="line">     SELECT_RANGE_CHECK: 0</span><br><span class="line">            SELECT_SCAN: 0</span><br><span class="line">      SORT_MERGE_PASSES: 0</span><br><span class="line">             SORT_RANGE: 0</span><br><span class="line">              SORT_ROWS: 0</span><br><span class="line">              SORT_SCAN: 0</span><br><span class="line">          NO_INDEX_USED: 0</span><br><span class="line">     NO_GOOD_INDEX_USED: 0</span><br><span class="line">       NESTING_EVENT_ID: NULL</span><br><span class="line">     NESTING_EVENT_TYPE: NULL</span><br><span class="line">    NESTING_EVENT_LEVEL: 0</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select THREAD_ID,DIGEST_TEXT from performance_schema.events_statements_current <span class="built_in">where</span> DIGEST_TEXT=<span class="string">"SELECT `abc` FROM `booboo`"</span>;</span></span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">| THREAD_ID | DIGEST_TEXT                 |</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">|        40 | SELECT `abc` FROM `booboo`  |</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from performance_schema.threads <span class="built_in">where</span> thread_id=40\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">          THREAD_ID: 40</span><br><span class="line">               NAME: thread/sql/one_connection</span><br><span class="line">               TYPE: FOREGROUND</span><br><span class="line">     PROCESSLIST_ID: 15</span><br><span class="line">   PROCESSLIST_USER: root</span><br><span class="line">   PROCESSLIST_HOST: localhost</span><br><span class="line">     PROCESSLIST_DB: uplooking</span><br><span class="line">PROCESSLIST_COMMAND: Sleep</span><br><span class="line">   PROCESSLIST_TIME: 402</span><br><span class="line">  PROCESSLIST_STATE: NULL</span><br><span class="line">   PROCESSLIST_INFO: NULL</span><br><span class="line">   PARENT_THREAD_ID: NULL</span><br><span class="line">               ROLE: NULL</span><br><span class="line">       INSTRUMENTED: YES</span><br><span class="line">            HISTORY: YES</span><br><span class="line">    CONNECTION_TYPE: Socket</span><br><span class="line">       THREAD_OS_ID: 22758</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select PROCESSLIST_ID from performance_schema.threads <span class="built_in">where</span> thread_id=40;</span></span><br><span class="line">+----------------+</span><br><span class="line">| PROCESSLIST_ID |</span><br><span class="line">+----------------+</span><br><span class="line">|             15 |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from information_schema.processlist <span class="built_in">where</span> id=(select PROCESSLIST_ID from performance_schema.threads <span class="built_in">where</span> thread_id=40);</span></span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">| ID | USER | HOST      | DB        | COMMAND | TIME | STATE | INFO |</span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">| 15 | root | localhost | uplooking | Sleep   |  466 |       | NULL |</span><br><span class="line">+----+------+-----------+-----------+---------+------+-------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 15;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会话B</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table booboo add q9 int default 0;</span></span><br><span class="line">Query OK, 0 rows affected (9 min 54.35 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><h2 id="小知识点总结"><a href="#小知识点总结" class="headerlink" title="小知识点总结"></a>小知识点总结</h2><h3 id="三张表的关系"><a href="#三张表的关系" class="headerlink" title="三张表的关系"></a>三张表的关系</h3><blockquote><p>MySQL 5.6</p></blockquote><ol><li><code>performance_schema</code>库中，<code>events_statements_current</code>表中<code>theard_id</code>与<code>threads</code>表中的<code>thread_id</code>相同</li><li><code>performance_schema</code>库中，threads表中，thread_id和processlist_id为对应关系，<code>thread_id</code>表示一个独特的线程标识符;<code>processlist_id</code>是<code>show processlist</code>显示的<code>id</code>值，连接标识符；而对于后台线程(与用户连接不相关的线程)，<code>PROCESSLIST_ID</code>为空，此值不是唯一的。</li><li><code>information_schema</code>库中,<code>PROCESSLIST</code>表是一个非标准表。<code>id</code>连接标识符，并由CONNECTION_ID()函数返回。</li></ol><table><thead><tr><th>performance_schema</th><th>performance_schema</th><th>performance_schema</th><th>information_schema</th></tr></thead><tbody><tr><td>events_statements_current</td><td>threads</td><td>threads</td><td>processlist</td></tr><tr><td>THREAD_ID</td><td>THREAD_ID</td><td>PROCESSLIST_ID</td><td>ID</td></tr></tbody></table><h3 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h3><ol><li>线程表中保存了所有线程的信息，有前台的有后台运行的；</li><li>如果是由连接产生的线程，一般都是前台线程，会分配一个processlist_id，可以在information_schema.processlist中看到</li></ol><h3 id="资料参考"><a href="#资料参考" class="headerlink" title="资料参考"></a>资料参考</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/threads-table.html" target="_blank" rel="noopener">官网关于threads表的说明</a></p><p><a href="https://dev.mysql.com/doc/refman/5.7/en/show-processlist.html" target="_blank" rel="noopener">官方关于processlist表的说明</a></p><p><a href="http://www.voidcn.com/article/p-hjsjvnlz-bog.html" target="_blank" rel="noopener">MySQL5.7 MetaData Lock 案例分享</a></p><h3 id="不同版本"><a href="#不同版本" class="headerlink" title="不同版本"></a>不同版本</h3><blockquote><p>MySQL 5.7</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.events_statements_current\G</span><br><span class="line">select * from sys.x$session\G</span><br><span class="line">select * from sys.x$processlist\G</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from x$session\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                thd_id: 3904</span><br><span class="line">               conn_id: 3879</span><br><span class="line">                  user: root@localhost</span><br><span class="line">                    db: sys</span><br><span class="line">               command: Query</span><br><span class="line">                 state: Sending data</span><br><span class="line">                  time: 0</span><br><span class="line">     current_statement: select * from x$session</span><br><span class="line">     statement_latency: 1564453000</span><br><span class="line">              progress: NULL</span><br><span class="line">          lock_latency: 847000000</span><br><span class="line">         rows_examined: 0</span><br><span class="line">             rows_sent: 0</span><br><span class="line">         rows_affected: 0</span><br><span class="line">            tmp_tables: 4</span><br><span class="line">       tmp_disk_tables: 1</span><br><span class="line">             full_scan: YES</span><br><span class="line">        last_statement: NULL</span><br><span class="line">last_statement_latency: NULL</span><br><span class="line">        current_memory: 0</span><br><span class="line">             last_wait: NULL</span><br><span class="line">     last_wait_latency: NULL</span><br><span class="line">                source: NULL</span><br><span class="line">           trx_latency: NULL</span><br><span class="line">             trx_state: NULL</span><br><span class="line">        trx_autocommit: NULL</span><br><span class="line">                   pid: 12880</span><br><span class="line">          program_name: mysql</span><br><span class="line">1 row in set (0.05 sec)</span><br><span class="line">mysql&gt; select * from  x$processlist limit 1\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                thd_id: 1</span><br><span class="line">               conn_id: NULL</span><br><span class="line">                  user: sql&#x2F;main</span><br><span class="line">                    db: NULL</span><br><span class="line">               command: NULL</span><br><span class="line">                 state: NULL</span><br><span class="line">                  time: 230927</span><br><span class="line">     current_statement: NULL</span><br><span class="line">     statement_latency: NULL</span><br><span class="line">              progress: NULL</span><br><span class="line">          lock_latency: NULL</span><br><span class="line">         rows_examined: NULL</span><br><span class="line">             rows_sent: NULL</span><br><span class="line">         rows_affected: NULL</span><br><span class="line">            tmp_tables: NULL</span><br><span class="line">       tmp_disk_tables: NULL</span><br><span class="line">             full_scan: NO</span><br><span class="line">        last_statement: NULL</span><br><span class="line">last_statement_latency: NULL</span><br><span class="line">        current_memory: 0</span><br><span class="line">             last_wait: NULL</span><br><span class="line">     last_wait_latency: NULL</span><br><span class="line">                source: NULL</span><br><span class="line">           trx_latency: NULL</span><br><span class="line">             trx_state: NULL</span><br><span class="line">        trx_autocommit: NULL</span><br><span class="line">                   pid: NULL</span><br><span class="line">          program_name: NULL</span><br><span class="line">1 row in set (0.06 sec)</span><br><span class="line">mysql&gt; select * from information_schema.processlist;</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">| ID   | USER | HOST      | DB   | COMMAND | TIME | STATE     | INFO                                         |</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">| 3879 | root | localhost | sys  | Query   |    0 | executing | select * from information_schema.processlist |</span><br><span class="line">+------+------+-----------+------+---------+------+-----------+----------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="MDL故障自愈"><a href="#MDL故障自愈" class="headerlink" title="MDL故障自愈"></a>MDL故障自愈</h2><h3 id="kill所有会话"><a href="#kill所有会话" class="headerlink" title="kill所有会话"></a>kill所有会话</h3><blockquote><p>不想知道故障原因，只想快速解决故障</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">kill</span>掉 所有会话</span></span><br><span class="line">user=xxx</span><br><span class="line">password=xxx</span><br><span class="line">host=xxxx.mysql.rds.aliyuncs.com</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">mysql -u$user -p$password -h$host  -P$port -e "select  concat('KILL ',id,';') from information_schema.processlist;" &gt; tmpfile</span><br><span class="line"></span><br><span class="line">awk '&#123;if (NR != 1) print $0 &#125;' tmpfile | mysql -u$user -p$password -h$host  -P$port</span><br></pre></td></tr></table></figure><h3 id="MDL故障排查和解决"><a href="#MDL故障排查和解决" class="headerlink" title="MDL故障排查和解决"></a>MDL故障排查和解决</h3><p><a href="https://github.com/BoobooWei/DevOps-Database-Troubleshooting/blob/master/fault_self_healing_metadatalock.py" target="_blank" rel="noopener">MDL故障自愈脚本GitHub地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：MetaData Lock即元数据锁，在数据库中元数据即数据字典信息包括db,table,function,procedure,trigger,event等。metadata lock主要为了保证元数据的一致性,用于处理不同线程操作同一数据对象的同步与互斥问题。&lt;/p&gt;
&lt;p&gt;今天有客户(MySQL 5.6)遇到该问题，最关键的是属于第三种情况，google上根本找不到类似的故障案例，唯一一个非常接近的故障案例中数据库版本却不同（具体看下文慢慢聊），哎，困难重重啊，最终还是解决了哈。&lt;/p&gt;
&lt;p&gt;alter table的语句是很危险的，在操作之前最好确认对要操作的表没有任何进行中的操作、没有未提交事务、也没有显式事务中的报错语句。如果有alter table的维护任务，在无人监管的时候运行，最好通过lock_wait_timeout设置好超时时间，避免长时间的metedata锁等待。&lt;/p&gt;
    
    </summary>
    
    
      <category term="技术广角" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/"/>
    
      <category term="MySQL" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%B9%BF%E8%A7%92/MySQL/"/>
    
    
      <category term="锁故障" scheme="http://www.toberoot.com/tags/%E9%94%81%E6%95%85%E9%9A%9C/"/>
    
  </entry>
  
  <entry>
    <title>LINUX HISTORY</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/00-linux_history/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/00-linux_history/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:08:12.861Z</updated>
    
    <content type="html"><![CDATA[<p>如果你喜欢技术，那么Linux的学习会为你打开一个新的世界。</p><p>入门难，但是一旦入门，就简单了，加油！</p><p>开源万岁～</p><h2 id="硬件发展简介"><a href="#硬件发展简介" class="headerlink" title="硬件发展简介"></a>硬件发展简介</h2><h3 id="x86-架构"><a href="#x86-架构" class="headerlink" title="x86 架构"></a>x86 架构</h3><p>1978年6月8日，Intel发布了新款16位微处理器“8086”，也同时开创了一个新时代：x86架构诞生了。X86指令集是美国Intel公司为其第一块16位CPU(i8086)专门开发的，美国IBM公司1981年推出的世<br>界第一台 PC机中的CPU—i8088(i8086简化版)使用的也是X86指令，同时电脑中为提高浮点数据处理能力而增加的X87芯片系列数学协处理器则另外使用X87指令，以后就将X86指令集和X87 指令集统称为<br>X86指令集。虽然随着CPU技术的不断发展，Intel陆续研制出更新型的i80386、i80486直到今天的Pentium 4(以下简为P4)系列，但为了保证电脑能继续运行以往开发的各类应用程序以保护和继承丰富的软件资源， 所以Intel公司所生产的所有CPU仍然继续使用X86指令集，所以它的CPU仍属于X86系列。</p><h3 id="Altair-8800"><a href="#Altair-8800" class="headerlink" title="Altair 8800"></a>Altair 8800</h3><p>世界上的第一台个人电脑–“牵牛星”　　</p><p>爱德·罗伯兹（Ed Roberts）的梦想是做一名儿科医生。但是命运却让他加入了美国空军，做一名工程师。退伍后，他在新墨西哥州的阿伯克基市机场附近的荒漠上创办了一家称为米兹（MITS）的公司，生产各种电子部件和设备。公司有一段时间的经营还算顺利。当市场上的手持计算器卖到395美元时，米兹公司推出了<br>不到100美元的同类产品。但是不久之后，德州仪器等大公司迅速进入手持计算器的市场，产品价格大幅度下降，低到了米兹公司的成本价以下。米兹公司的其他产品销售情况也很糟。到了1974年，米兹公司已濒临破产边缘。　　</p><p>罗伯兹绞尽脑汁思考如何扭转公司的困境。他有了一个想法：能不能创造一种很便宜、能让个人使用的电脑呢？全国已经有很多电脑爱好者，他们都急切希望自己能拥有一台电脑，供个人玩弄，就像很多人在鼓捣自制的无线电收音机一样。市面上现在还没有这样的东西。带着这个想法，他去说服本地银行再给他的公司贷<br>一笔款。米兹公司必须至少再贷将近7万美元才能不致于破产。银行对罗伯兹的想法很怀疑。双方一直谈到深夜。不过，银行面临一个两难的选择：要么不再贷款给米兹公司，让它倒闭，银行以前的投资也就全完了。<br>要么再放一笔贷款，但这笔新贷款很可能又会打水漂。最后，银行再次让罗伯兹确切告诉他们，这种个人电脑什么时候能开发出来，第一年能卖多少套。罗伯兹对什么时候能做出来是有把握的，只要几个月的时间。<br>能卖多少套他就完全没有谱了。于是他说了一个非常乐观的数字：第一年能卖800套，这样销售收入可以有30万美元。拿到贷款后，米兹公司全力开发个人电脑产品。公司必须在最短时间内把产品开发出来并且卖出<br>去，不然破产就难以避免。为了缩短开发时间和降低成本，罗伯兹决定尽量采用现成的部件，做出来产品不是一台现成的计算机，而是一套零部件，需要用户自己装配。所有并非必需的产品特征都被去掉了。产品根<br>本没有今天的微机不可忽缺的键盘、鼠标、显示器、软盘等等设备。产品也没有软件，所有软件(包括所谓的系统软件)都需要用户用设置开关的方式一条指令一条指令地手工输入计算机。<br>　　<br>不管多么简陋，这毕竟是世界上的第一台个人电脑，又称微机。米兹公司的微机产品有两个在当时无可比拟的优点。它很便宜，售价只有不到500美元，而当时一些大公司的实验室也做了类似微机的系统，成本在5<br>万美元左右。另外，米兹的微机设计具有所谓的可扩展能力。用户可以将米兹的微机买回来后，自己再想法配上更多的内存板子和外部设备。有一个用户花了近500美元买了一台微机，再花了3000美元把内存扩展<br>到12KB。《电子科普》（Popular Electronics）杂志听到这个消息后，敏锐地感觉到这是一个历史性的事件，马上决定在1975年1月期作为封面文章报道。但这个个人电脑产品却连名字都还没有。罗伯兹在<br>杂志的责任编辑家里讨论了各种名字。刚好，编辑的家人正在看《星际旅行》的电视节目。那一节刚好讲到了牵牛星座。于是，世界上第一台微机就被命名为“牵牛星”，全称是“牵牛星8800（Altair 8800）”。</p><p>罗伯兹做梦也没想到的是，全美有这么多的电脑爱好者，人人都想拥有一台微机。《电子科普》杂志的报道发表后一个月，米兹公司每天都要收到200多台“牵牛星”电脑的订单。生产线根本来不及满足销售需求。有<br>些用户干脆住到公司外面的荒漠上，等着自己的微机生产出来。大多数用户只是购买基本系统。也有用户愿意出495美元，让米兹公司生产一台已经装配好的系统。　　</p><p>今天，罗伯兹已经离开了电脑界。他回到乔治亚的老家，获得了医学博士学位，为儿童治病。他为自己创造了计算机领域的一个革命而自豪，但一点也不后悔放弃电脑业，放弃了成为大富翁的机会。他觉得为儿童治病更有意义。爱德·罗伯兹是个很幸福的人，他实现了儿时的梦想。</p><h3 id="IBM5150"><a href="#IBM5150" class="headerlink" title="IBM5150"></a>IBM5150</h3><p>IBM推出世界上第一台个人电脑 </p><p>1981年8月12日，总部设在美国纽约州阿蒙克的国际商用机器公司（IBM）推出5150的新款电脑，“个人电脑”这个新生市场随之诞生。IBM5150看起来像个米色的“大盒子”，售价1565美元，只有16K字节的内存，可以使用盒式录音磁带来下载和存储数据，此外也可配备5.25英寸的软件盘驱动器。</p><h3 id="MOS-Technology-6502"><a href="#MOS-Technology-6502" class="headerlink" title="MOS Technology 6502"></a>MOS Technology 6502</h3><p>当一个满脸横肉的怪人将这个微芯片装在电脑上，并启动电脑时，整个宇宙都震惊了。这个怪人就是苹果公司创始人之一——斯蒂芬·沃兹尼克，那台电脑就是Apple I，处理器用的是由摩斯太克公司研发的8位微处理器6502。</p><p>这一处理器同时也是Apple II、the Commodore PET、BBC Micro等经典电脑以及诸如任天堂和Atari等游戏系统的大脑。该处理器的设计者之一Chuck Peddle回忆称，他们是在1975年的一个贸易展示会上推出这款处理器的。他称：“我们用芯片装满了两个玻璃。我和我的妻子就坐在那里卖这些芯片。”摩斯太克公司6502微处理器终于脱颖而出，其原因是，6502的速度并不比它的竞争对手快多少，但是它的价格便宜，每部售价为25美元，而英特尔的8080和摩托罗拉的6800售价大约在200美元。</p><h2 id=""><a href="#" class="headerlink" title=""></a><img src="pic/001.jpg" alt="001"></h2><h2 id="操作系统简介"><a href="#操作系统简介" class="headerlink" title="操作系统简介"></a>操作系统简介</h2><h3 id="Unix"><a href="#Unix" class="headerlink" title="Unix"></a>Unix</h3><h4 id="Unix-简史"><a href="#Unix-简史" class="headerlink" title="Unix 简史"></a>Unix 简史</h4><p>1965年时，贝尔实验室(Bell Labs)加入一项由奇异电子(General Electric)和麻省理工学院(MIT)合作的计划；该计划要建立一套多使用者、多任务、多层次(multi-user、multiprocessor、multi-level)的MULTICS操作系统。直到1969年，因MULTICS计划的工作进度太慢，该计划就被停了下来。当时，Ken Thompson（后被称为Unix之父）已经有一个称为「星际旅行」的程序在GE-635的机器上跑，但是反应非常的慢，正巧也被他发现了一部被闲置的PDP-7(Digital的主机)，Ken Thompson和Dernis Ritchie就将「星际旅行」的程序移植到PDP-7上。而这部PDP-7就此在整个计算机历史上留下了芳名。</p><p>MULTICS 其实是”MULTiplexed Information and Computing System”的缩写，在1970年时，那部PDP-7却只能支持两个使用者，当时，Brian Kernighan 就开玩笑地戏称他们的系统其实是：”UNiplexed Information and Computing System”，缩写为”UNICS”，后来，大家取其谐音，就称其为”Unix”了。1970年可称为是Unix元年。</p><p>1971年，他们申请了一部PDP-11/20，申请的名义是：要发展文书处理系统。该提案被获采纳，他们也发展出了一套文书处理系统 ─ 就是现在Unix操作系统里面文书处理系统(nroff/troff)的前身。有趣的是，没有多久，贝尔实验室的专利部门真的采用了这套系统作为他们处理文件的工具，而贝尔实验室的专利部门也就顺理成章地成为Unix的第一个正式使用者。当时，那部PDP-11／20只有0.5MB磁盘空间。而描述这整个系统的文件被标示为：”First Edition”，版本日期是1970年11月。从此以后，Unix的版本就以系统文件的版别来称呼。</p><h4 id="UNIX家谱"><a href="#UNIX家谱" class="headerlink" title="UNIX家谱"></a>UNIX家谱</h4><p>UNIX的历史开始于1969年ken Thompson，Dennis Ritchie（即著名的K&amp;G，C语言的发明人）与一群人在一部PDP-7上进行的一些工作，后来这个系统变成了UNIX。它主要的几个版本为：</p><ul><li>V1（1971）：第一版的UNIX，以PDP-11/20的汇编语言写成。包括文件系统，fork、roff、ed等软件。</li><li>V4（1973）：以C语言从头写过，这使得UNIX修改容易，可以在几个月内移植到新的硬件平台上。最初C语言是为UNIX设计的，所以C与UNIX间有紧密的关系。</li><li>V6（1975）：第一个在贝尔实验室外（尤其是大学中）广为流传的UNIX版本。这也是UNIX分支的起点与广受欢迎的开始。1.xBSD （PDP-II）就是由这个版本衍生出来的。</li><li>V7（1979）：在许多UNIX玩家的心目中，这是“最后一个真正的UNIX，”这个版本包括一个完整的K&amp;RC编译器，Bourne shell。V7移植到VAX机器后称为32V。</li></ul><p>目前开发UNIX（System V）的公司是Unix System Laboratories (USL)。USL本为AT&amp;T所有，1993年初被Novell收购。Novell于1993年末将UNIX这个注册商标转让给X/Open组织。</p><p>目前为止，UNIX有两大流派：那就是AT&amp;T发布的UNIX操作系统System V与美国加州大学伯克利分校发布的UNIX版BSD（Berkeley Software Distribution）。SVR4是两大流派融合后的产物。1991年底，与System V针锋相对的开放软件基金会(Open Software Foundation)推出了OSF/1。</p><p>现在几种主要的UNIX版本:</p><ul><li>AIX：IBM的UNIX，是根据SVR2（最近已经出到SVR3.2）以及一部分BSD延伸而来，加上各种硬件的支持。具备特有的系统管理（SMIT）。</li><li>386BSD：Jolitz从Net/2 software移植过来的。支持Posix，32位。</li><li>FreeBSD：1.x从386BSD 0.1而来，FreeBSD 2.x版是用4.4BSD lite改写。</li><li>HP-UX（HP）：旧系统是从S III（SVRx）发展面来，现在是由SVR2（4.2BSD）发展而来，目前是10.x版。</li><li>Linux(x86)：遵从POSIX，SYSV及BSD的扩展，这一点从上页表中即可看出。</li><li>OSF/1（DEC）：DEC对OSF/1的移植。</li><li>SCO UNIX（x86）：SVR3.2，目前影响较大的PC UNIX。</li><li>SunOS（680x0，Sparc，i386）：根据4.3BSD，包含许多来自System V的东西。Sun的主要成果在于：NFS，OpenLook GUI标准，后来演变为Solaris 。这也是目前最著名的UNIX版本之一。</li><li>Ultrix(DEC)：根据4.2BSD再加上许多4.3BSD的东西。</li><li>Xenix(x86)：Intel硬件平台上的UNIX，以SVR2为基础，由微软推出。在中国使用较广泛。</li></ul><h4 id="黑暗史"><a href="#黑暗史" class="headerlink" title="黑暗史"></a>黑暗史</h4><p>Unix与Linux，SCO与IBM、微软，他们是怎样纠结在一起，形成一团解不开的乱麻？</p><h5 id="风起Unix"><a href="#风起Unix" class="headerlink" title="风起Unix"></a>风起Unix</h5><p>1969年“阿波罗11号”登月成功。贝尔实验室中一个叫Ken Thompson的年轻人为了一圆翱游太空的梦想，在当时的Multics系统上写了一个叫《星际之旅》的游戏。但当时大型机的机时费很贵，每玩一次公司就要为此支付75美金，于是Thompson打起了小型机PDP-7的主意。但当时的PDP-7只有一个简陋的运行时系统，不支持多用户，为了能双人对战，Thompson找来Dennis Ritchie一起开发新的作系统。他们只花了一个月的时间就用汇编语言写出了作系统的原型。“你写的系统太差劲，干脆就叫Unics算了。”60年代末的一天，贝尔实验室的一位同事对肯·汤普生这样说。同事布莱恩·科尔尼干 Brian W.Kernighan看到后，戏称这个系统为Unics②。Unix这个名字典出于此。</p><p>在英文里，Unics发音与Eunuchs一样，而后者的意思是“太监”。汤普生接下同事的嘲弄，稍作修改，把自己研发的系统叫做Unix。</p><p>1971年，Unix已经能够支持两名用户在PDP-11上玩《星际之旅》了，但因为当时的Unix是用汇编语言写的，无法移植到其他机器上，所以他们决定用高级语言重写Unix，可当时的高级语言无论从运行效率还是功能上都无法满足他们的需要。Thompson先是在BCPL的基础上萃取出了B语言，Ritchie又在B的基础上进行了重新设计，这才有了今天大名鼎鼎的C语言。</p><p>60年代的计算机虽然已不是庞然大物了，但体积仍然不小，而且爱出故障。汤普生回忆：“计算让人着迷，电子也让人着迷，只是不太干净，很脏，因为经常有东西被烧坏。”</p><p>操作这些又慢、又笨的大家伙需要专业的计算机程序员，为了提高效率，急需新系统。在这种背景下，汤普生和丹尼斯·利奇研发了Unix操作系统。此时，乔布斯和盖茨还在中学里搞恶作剧，PC和微软操作系统要在10年后才初露端倪。</p><p>Unix两位创始人和贝尔实验室也没把这套操作系统太当回事，只是在内部使用，后来大学、研究机构也可以免费使用，而且还提供给他们源代码，因此Unix源代码被广为扩散。在这段时间里，它没有像后来的商业软件那样急功近利，留下一堆窟窿和补丁，因此，Unix在诞生后的10年里“养在深闺人未识”，在实验室进行着充分的使用和论证，这也是它后来在要求稳定性、安全性较高的企业级客户中得到推崇的主要原因。</p><p>到了1980年，Unix开始走出实验室，有数以千计的技术高手想把Unix装在家里的机器上。</p><p>此时，后知后觉的贝尔实验室开始认识到Unix的价值，但由于源代码早已外散，无法将其拢起来进行精细的商业开发，于是干脆采取对外授权的模式，研究机构使用免费，企业使用要交授权费，这有些金矿当做铜矿卖的味道。一位贝尔高级主管曾感慨：“Unix是继晶体管以后的第二个最重要发明。”但贝尔实验室错失商业发展机遇。</p><p>“幸运的时机好比市场上的交易，只要你稍有延误，它就掉价了。”培根在《论时机》中这样写到。当时有多家大学、研究机构和公司获得了Unix授权，并由此开始了各自不同的版本演化之路。1993年，拥有贝尔实验室的美国电话电报公司（AT&amp;T）将自己所拥有的Unix权利卖给Novell，后者成为接受Unix衣钵的合法继承人。当然此时的IBM、DEC、HP和Sun因为早年的授权缘故，有权继续进行各自的Unix版本的研发。</p><p>1995年，Novell又将Unix相关资产卖给SCO。和两年前AT&amp;T把Unix卖给Novell一把清的局面有所不同，SCO当时没有足够的现金一次性付清，因此Novell初期只是把Unix源代码交给了SCO，对于Unix著作权的归属协议存在着语焉不详和模棱两可的地方。</p><p>花了钱的SCO宣传自己是Unix正宗传人，Novell当时视Unix为鸡肋，没有异议，而且此时SCO没有对别的获得过Unix授权的厂商置喙，于是大家进入了一段相安无事的时期。</p><h5 id="微软的进进出出"><a href="#微软的进进出出" class="headerlink" title="微软的进进出出"></a>微软的进进出出</h5><p>八十年代末，有人问比尔·盖茨怎么看待Unix与微软构成的竞争，他笑着问道：“哪个Unix？”微软与Unix的关系源远流长，并对SCO的演变起了重要的催化作用。1979年，微软从美国电话电报公司获得授权，为Intel处理器所开发一种Unix操作系统，由于它购买的授权无法直接让该操作系统以“Unix”为名，于是该系统命名为Xenix，可用在个人电脑及微型计算机上使用。微软并不直接把Xenix销售给终端客户，而是以OEM的形式再授权给Intel、Tandy、施乐Altos及SCO公司。</p><p>对于微软来说，由于需要从美国电话电报公司获得授权，因而这是一种自己难以把握其未来发展命运的操作系统，而且当时其他厂商不同的版本在搅浑这个市场，所以，盖茨在寻找机会退出这个领域。当微软和IBM达成开发OS/2操作系统的协议后，盖茨便失去了推广Xenix的兴趣。</p><p>多年后的历史资料揭秘显示，微软当时脚踩多条船，除和IBM联手开发OS/2操作系统外，微软还在紧锣密鼓地进行着Windows 3.0系统的研发。微软不可能在三条线上同时投入精力，于是决定舍弃Xenix操作系统。</p><p>“赛车和做人一样，有时候要停，有时候要冲。”这是电视剧《极速传说》中的一句台词。1987年，微软与SCO达成了一项协议，以持有后者股票25%的条件转让了Xenix的所有权。从微软接盘的SCO，将这种操作系统以最快速度移植到386电脑，成为首款支持Intel386芯片的操作系统，抓住了市场的先机。</p><p>当时的市场格局是这样，小型机加五花八门的Unix操作系统把持了高端的企业级用户市场，其中的代表厂商是IBM、DEC、惠普、SUN、SGI等；Intel芯片加微软操作系统，正在全面控制个人电脑市场，其中的代表厂商包括康柏、AST、佰德等。小型机加Unix操作系统的阵营鄙视Intel芯片加微软操作系统形成的Wintel联盟，前者认为后者简陋，而后者则认为前者是老化顽固。</p><p>SCO此时扮演的角色有点像“蝙蝠”，非鸟非兽，它的运营模式是Intel芯片加Unix操作系统，在两大阵营间翩翩飞。随着装有Intel芯片电脑的攻城略地，SCO也跟着分到一杯羹。80年代末，有媒体称Xenix为“可能是传播最广的UNIX操作系统”。</p><p>SCO进入了其发展史上最辉煌的时期。当然这段时间，Unix的发展也进入了黄金期。1984年9月《财富》杂志称，全球范围内750所大学中80％的计算机领域的教授是Unix用户，因此当时计算机专业毕业的学生都接触过Unix，他们毕业后成为IT领域的骨干。</p><p>盖茨抛弃了Unix，但没打算抛弃这块丰饶的市场，而且SCO的成功也刺激了他：自己扔掉的一块鸡肋竟然成了这个小跟班的肥美牛排。换谁不流口水啊？有句谚语是“别让口馋的人看见你的大碗”。</p><p>Unix有个致命缺陷：从来就没有通用版存在。多年以来，由于早期混乱的授权，五花八门、不同版本的Unix遍地开花，所以为其中一个版本写的应用程序，常常要修改后才能运用到另一个上，这对于专业的程序员来说也许不是太大问题，但对技术实力较弱的用户来说，则平添了许多麻烦。</p><p>从Unix脱身而出的盖茨深知其支离破碎的弱点，他下令微软打造一款“可移植的”的操作系统——“Unix杀手”。这就是微软的Windows NT，包括SCO在内的Unix阵营将感受到它带来的巨大压力。</p><p>歌手鲍勃·迪伦在《时代在转变》一诗中写到：“动笔预言世事的作家与评论家们，张大你们的双眼，机会不会再来第二遍，轮盘还在旋转，先别言之过先，看不出来谁会被选，因为目前的输家未来会领先，因为时代正在改变。”</p><h5 id="强悍对手逆袭"><a href="#强悍对手逆袭" class="headerlink" title="强悍对手逆袭"></a>强悍对手逆袭</h5><p>“我不会用狗屎去污染（NT）”。Windows NT研发负责人大卫·卡特勒这样高声地嚷着，他拒绝允诺新一代的操作系统兼容已有的DOS和Windows。原来，定下“Unix杀手”计划后，盖茨准备组织一个团队来完成这项工作。“我太想要一个可移植的操作系统了，”盖茨说，“问题不在于我们是否应该组成团队，而在于何时能组成团队去开发它。”</p><p>随后机会来了，DEC的核心工程师卡特勒因在公司坐冷板凳而萌生去意。“大多数人学会如何把一件事做得很漂亮以后，便一生一直做这个，”卡特勒一个同事评价他：“卡特勒会从自己的成功中学习。下一次，他会做得更好。所以每次，他都上升到一个新的高度。”</p><p>卡特勒全身心地投入程序开发，而冷落了两任妻子，后来他发誓再也不会结婚，“结婚是一个错误，你只能犯两次错”。卡特勒在程序开发上精益求精，“对可能干扰他的任何人和事，他不仅置之不理，而且还会对其进行攻击和诋毁”，因此，他与DEC公司高管们相处得很不愉快。</p><p>盖茨亲自拜会卡特勒，想让他加盟微软。初次见面，卡特勒就给盖茨一个下马威，直言不讳地称微软的代码写得很“烂”，认为盖茨当时捧在手心里的、深以为傲的DOS，在他的眼里就是一个玩具。卡特勒说只有自己才有能力开发出一个能面向未来进行网络管理、具有高可靠性的操作系统。</p><p>此时的盖茨已走过创业期，拥有海量的财富与强势的权力，耳边吹过的都是“软件神童”的悦耳之音。不过，卡特勒的刺耳之音和轻蔑态度反而坚定了盖茨聘请他的决心，盖茨向对方表示将给予充分的发展空间和自由。励志大师戴尔·肯耐基说：“在世界上，要影响别人的惟一办法就是谈论他们的需要，并告诉他们去如何满足这些需要。”</p><p>卡特勒到微软之后，盖茨尽可能地满足他的要求，有些甚至是打破微软惯例的。譬如卡特勒不要微软原来的工程师参与他的团队，他把自己在DEC工作时的团队带了过来，其中有些是硬件工程师，是卡特勒的好友。盖茨原来不打算要，但卡特勒威胁不让他们来，自己就不来。</p><p>盖茨让步，满足了卡特勒所需要的一切。此前，控制欲极强的盖茨会亲自检查微软的大部分代码，在他刨根揭底地穷问下，程序员有时会露出破绽，这时盖茨会不留情面地痛斥，带有攻击性言语，譬如“这是有史以来最愚蠢的代码”会劈头盖脸地砸过去。但盖茨对卡特勒的项目则放手到几乎“放任自流”的地步。Airbnb联合创始人兼CEO布莱恩·切斯基说过：“你有时候必须靠边站，如果你要插手细节，你会很痛苦。但是你要是站得远一点，你就能看清大局。”</p><p>盖茨识才的眼光和用人不疑的态度，最终得到了丰厚的回报，1993年，Windows NT完美亮相，成为微软撬动Unix市场的一把利器。卡特勒也获得了Windows NT之父的赞誉，在微软发展史上占有一席之地。罗杰•福尔克在《漫谈企业管理》中提到：“一个人只有处在最能发挥其才能的岗位上，他才会干得最好。”盖茨自己在这一时期说过：“对我来说，跟一伙聪明的工程师一起工作，研发出产品，然后你走出去看到人们确实在使用它们，这才是更大的乐趣所在。”</p><p>在包括SCO在内的Unix阵营开足马力贬低Windows NT之时，Windows NT却在高端市场上大步前进，SCO则开始走下坡路。</p><p>“节物风光不相待，桑田碧海须臾改。”在微软与Unix阵营的对手进行车轮战的同时，一股新的力量在生成并变得强大起来，左右了战局的发展方向。这就是Linux。</p><p>起初盖茨认为Linux无足轻重，但大量的用户不这样认为，他们对Linux投去青睐的目光，因为Linux公开授权，允许用户销售、拷贝并且改动程序，只不过要求修改后的代码也免费公开，这些举措成了Linux蔓延的强大推力，并给微软带来了强烈的冲击。</p><p>Linux的存在给了对微软一直心存敌意的对手们一把雪耻的利刃，包括IBM、Oracle、Sun等业界大鳄，纷纷表示扶持Linux，并以各种方式支持Linux，向陷住微软战靴的泥潭灌进去更多的水。微软一度陷入了被动的局面。但随着Linux的发展，战局发生了微妙的变化。</p><p>在一个公开场合，盖茨表示：“受到Linux蚕食的是Unix，而不是Windows。”他说：“我们确实在与Linux竞争，但转换到Linux的Unix市场是相当可观的。Windows和Linux将共同主导市场。”</p><p>市场分析机构Gartner也宣称，Linux和开放源代码会继续发展，但它们所掠夺的是Unix而不是微软的领地。与Unix有着千丝万缕联系的Linux，竟然扮演了Unix终结者的角色？</p><p>这是因为Unix操作系统价格比微软的产品更高，市场份额也更少，受到Linux的冲击也更大，靠着Unix吃饭的SCO对此感同身受。一位Linux厂商技术总监曾放话：“SCO Unix的生命周期已经结束了，系统移植是必然的。”</p><p>与其坐以待毙，不如奋力一击。进入21世纪后，日渐式微的SCO开始策划一出震惊IT业界的大戏。</p><h5 id="车轮诉讼大战"><a href="#车轮诉讼大战" class="headerlink" title="车轮诉讼大战"></a>车轮诉讼大战</h5><p>“在过去的18个月，我们发现IBM把一些极其高端的企业运算技术的源代码公开了。其中部分看上去与我们拥有知识产权的技术非常相似，违反了我们与IBM之间的协议。他们的行为之间破坏了我们之间不公开这部分技术的协议，单方面公开了源代码。我们有证据表明部分代码是逐字的抄袭。”2003年5月，SCO的CEO达尔·麦克布莱德这样说。</p><p>SCO控告IBM的Linux破坏了双方之前签订的软件代码授权协议，声称IBM免费散发有知识产权的代码，把一些Unix的代码改头换面后加入Linux产品中，因此要求蓝色巨人赔偿自己10亿美元。“初寒冻巨海，杀气流大荒。”此举在Linux阵营炸开了锅，他们认为SCO此举为“项庄舞剑，意在沛公”，最终目标是挟制整个Linux阵营。</p><p>随后，微软的动作让这个局面变得混乱起来。起诉IBM后不久，SCO宣布向微软发放Unix技术许可，包括专利权和源代码。就是说，微软以花钱买购买SCO的Unix技术许可权的方式，承认了对方Unix合法传人的地位。</p><p>布鲁斯·佩伦斯称：“对于微软来说，购买SCO的源代码授权几乎没有任何意义。花钱购买SCO公司的授权，只不过是对一种‘行贿’行为的粉饰，顺便还对未来的Linux用户进行恫吓。可谓一石双鸟！很难想象微软的前对手SCO能为比尔·盖茨冲锋陷阵，但是，微软的钱改变了一切。”</p><p>Linux阵营担心的就是这一点，微软此举强化了SCO的Unix“权威地位”，增强了SCO挑战IBM的决心。一旦SCO拿下IBM，就打开了一个收钱口袋，其他推行Linux的厂商只有乖乖纳贡。</p><p>而且使用Linux的广大商业用户也面临着被追索的危机，更多的潜在用户将会对Linux望而生畏，这非常符合微软一直针对Linux实施的心理战战术，让用户在恐惧、不确定、怀疑的状态下对Linux敬而远之。考虑到历史上微软与SCO复杂的关系，人们怀疑二者在密谋，认为SCO在扮演为微软火中取栗的角色。2004年初，麦克布莱德警告：全球一些大公司由于使用了Linux将可能很快面临诉讼，其中包括英国石油、西门子和富士通。就是说，SCO的诉讼风暴即将席卷全球。</p><p>借着SCO对Linux阵营的压力，2004年11月，微软CEO鲍尔默在新加坡举行的一个高级别政府论坛上表示，Linux侵犯了至少228项专利，不过他并没有明确表示侵犯了哪些专利。他说：“对于那些已经加入世界贸易组织的国家而言，使用Linux就意味着有一天会有人过来向你收取专利费。”</p><p>2005年1月，美国法院判决IBM交出20亿行的程序代码给SCO，消息传出后，SCO股价暴涨20%。</p><p>SCO似乎可以动手敛钱了，然而风云又变，半路杀出一个程咬金。Novell公司站了出来，称自己才是Unix版权的合法拥有者，说自己当年没有把Unix版权卖给SCO，SCO也只是个授权使用者，并且要对方把从微软和Sun收到的授权许可费给吐出来。</p><p>于是，SCO又和Novell公司干上了，开始了法庭上的互有胜负的对峙。</p><h5 id="树敌过多后的破产"><a href="#树敌过多后的破产" class="headerlink" title="树敌过多后的破产"></a>树敌过多后的破产</h5><p>“SCO公司在诉讼过程中树敌过多。”业内人士温伯格这样表示。连年诉讼耗尽了SCO资源，公司重点也没有放在业务上，话又说回来，其Unix业务已日薄西山，也没啥好继续开展的了。</p><p>2007年8月，美国犹他州地方法院一名法官裁定，Unix操作系统的版权归属于Novell，而不是SCO。这意味着SCO需要向Novell支付数百万美元的赔偿。</p><p>此举也意味着，SCO在与IBM进行的法律大战中失去胜算。Linux阵营头顶的乌云也随即散去。这年12月27日，SCO正式被纳斯达克摘牌。</p><p>芥川龙之介说过：人生好比一盒火柴，严禁使用是愚蠢的，滥用则是危险的。</p><p><img src="pic/002.jpg" alt="002"></p><h3 id="Minix"><a href="#Minix" class="headerlink" title="Minix"></a>Minix</h3><p>Minix原来是荷兰阿姆斯特丹的Vrije大学计算机科学系的Andrew S. Tanenbaum教授所发展的一个类Unix操作系统。全部的程序码共约12,000行，并置于他的著作Operating Systems: Design andImplementation(ISBN 0-13-637331-3)的附录里作为范例。Minix的系统要求在当时来说非常简单，只要三片磁片就可以启动。Minix原始是设计给1980年代到1990年代的IBM PC和IBM PC/AT兼容电脑上执行。1.5版也有移植到以Motorola 68000系列CPU为基础的电脑上（如Atari ST，Amiga，和早期的Apple Macintosh）和以SPARC为基础的机器（如升阳sun公司的工作站）。2.0版则只有x86架构的版本。</p><p>因为AT&amp;T的政策改变，在Version 7 Unix推出之后，发布新的使用条款，将UNIX源代码私有化，在大学中不再能使用UNIX源代码。塔能鲍姆教授为了能在课堂上教授学生操作系统运作的实务细节，决定在不使用任何AT&amp;T的源代码前提下，自行开发与UNIX兼容的操作系统，以避免版权上的争议。他以小型UNIX（mini-UNIX）之意，将它称为MINIX。</p><p>全套Minix除了起动的部份以汇编语言编写以外，其他大部份都是纯粹用C语言编写。分为：内核、内存管理及档案管理三部份。</p><h4 id="与Linux的关系"><a href="#与Linux的关系" class="headerlink" title="与Linux的关系"></a>与Linux的关系</h4><p>如果想了解类Unix系统的内部工作情况，学生可以在他们自己的电脑上运行Minix。据报道，即使是毫无经验的学生也能在几个月的典型培训课程的学习中获得对整个系统的很好的了解。Minix最有名的学生用户是Linus Torvalds，他在芬兰的赫尔辛基大学用Minix操作平台建立了一个新的操作系统的内核，他把它叫做Linux。</p><p>Linux是其作者受到Minix的影响而作成的（Linus Torvalds不喜欢他的386电脑上的MS-DOS操作系统，安装了Minix，并以它为样本开发了原始的Linux内核）。但在设计哲学上，Linux则和Minix大相迳庭。Minix在内核设计上采用微内核的原则，但Linux则和原始的Unix相同都采用宏内核的概念。在Linux发展之初，双方还于1992年在新闻组上有过一场精彩的理念争论。Minix的作者和支持者认为Linux的单内核构造是“向七十年代的大倒退”，而Linux的支持者认为Minix本身没有实用性。</p><h4 id="授权方式"><a href="#授权方式" class="headerlink" title="授权方式"></a>授权方式</h4><p>在授权方式上，Minix的版权宣告在早期被认为是相当自由的，在作者Andrew S. Tanenbaum希望拿Minix作为一个公开的教材与出版社希望保护程序码著作财产权的平衡下，它只要求一个相当低的授权费。但因为它并不是一个开放源码的授权方案，所以志愿工作者在以GPL方式散布的Linux核心出现后就多转向Linux平台。而Unix也在柏克莱系统与AT&amp;T达成协议后，出现了以BSD 授权散布的FreeBSD开放平台。Minix虽然在2000年改用BSD 授权，但这时其它的操作系统在功能上大幅超越了它，而它失去了发展成一个广泛使用的操作系统的机会，只留下，如它的作者Andrew S. Tanenbaum，原来期望的，作为一个开放的教材的用途。</p><p><img src="pic/003.jpg" alt="003"></p><h3 id="GUN"><a href="#GUN" class="headerlink" title="GUN"></a>GUN</h3><p>GNU计划，又称革奴计划，是由Richard Stallman在1983年9月27日公开发起的。它的目标是创建一套完全自由的操作系统。Richard Stallman最早是在net.unix-wizards新闻组上公布该消息，并附带《GNU宣言》等解释为何发起该计划的文章，其中一个理由就是要“重现当年软件界合作互助的团结精神”。为保证GNU软件可以自由地“使用、复制、修改和发布”，所有GNU软件都有一份在禁止其他人添加任何限制的情况下授权所有权利给任何人的协议条款，GNU通用公共许可证（GNU General PublicLicense，GPL）。即“反版权”（或称Copyleft）概念。</p><h4 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h4><p>1985年Richard Stallman又创立了自由软件基金会（Free Software Foundation）来为GNU计划提供技术、法律以及财政支持。尽管GNU计划大部分时候是由个人自愿无偿贡献，但FSF有时还是会聘请程序员帮助编写。当GNU计划开始逐渐获得成功时，一些商业公司开始介入开发和技术支持。当中最著名的就是之后被Red Hat兼并的Cygnus Solutions。</p><p>到了1990年，GNU计划已经开发出的软件包括了一个功能强大的文字编辑器Emacs[1] 。GCC（GNUCompiler Collection，GNU编译器集合），是一套由 GNU 开发的编程语言编译器。以及大部分UNIX系统GNU操作系统的内核Linux的程序库和工具。唯一依然没有完成的重要组件就是操作系统的内核(称为HURD)。</p><p>1991年Linus Torvalds编写出了与UNIX兼容的Linux操作系统内核并在GPL条款下发布。Linux之后在网上广泛流传，许多程序员参与了开发与修改。1992年Linux与其他GNU软件结合，完全自由的操作系统正式诞生。该操作系统往往被称为“GNU/Linux”或简称Linux。（尽管如此GNU计划自己的内核Hurd依然在开发中，已经发布Beta版本。）</p><p>许多UNIX系统上也安装了GNU软件，因为GNU软件的质量比之前UNIX的软件还要好。GNU工具还被广泛地移植到Windows和Mac OS上。</p><h4 id="协议条款"><a href="#协议条款" class="headerlink" title="协议条款"></a>协议条款</h4><p>GNU 包含3个协议条款:</p><ol><li>GPL：GNU通用公共许可证（GNU General Public License）</li><li>LGPL：GNU较宽松公共许可证 (GNU Lesser General Public License）, ) ，旧称 GNU Library General Public License (GNU 库通用公共许可证)；</li><li>GFDL ： GNU自由文档许可证（GNU Free Documentation License ）的缩写形式。</li></ol><p>这里指的自由，并不是价格免费，这和价格无关而是使用软件对所有的用户来说是自由的。</p><p>通过如下途径实现这一目标：</p><ol><li>它要求软件以源代码的形式发布，并规定任何用户能够以源代码的形式将软件复制或发布给别的用户。</li><li>如果用户的软件使用了受 GPL 保护的任何软件的一部分，那么该软件就继承了 GPL 软件，并因此而成为 GPL 软件，也就是说必须随应用程序一起发布源代码。</li><li>GPL 并不排斥对自由软件进行商业性质的包装和发行，也不限制在自由软件的基础上打包发行其他非自由软件。</li></ol><p>由于GPL很难被商业软件所应用，它要求调用它的库的代码也得GPL，全部开放，并且一同发布，不能直接连接。所以后来GNU推出了LGPL许可证</p><p>在GPL与LGPL许可证保护下发布源代码的结果很相似，对旧代码所做的任何修改对于想知道这些代码的人必须是公开的，唯一真正的不同之处在于私人版权代码是否可以与开放源代码相互连接，LGPL允许实体连接私人代码到开放源代码，并可以在任何形式下发布这些合成的二进制代码。只要这些代码是动态连接的就没有限制。（使用动态链接时，即使是程序在运行中调用函数库中的函数时，应用程序本身和函数库也是不同的实体）</p><h4 id="自由软件"><a href="#自由软件" class="headerlink" title="自由软件"></a>自由软件</h4><p>“自由软件” 是权利问题，不是价格问题。要理解这个概念，自由应该是“言论自由”中的“自由”，而不是“免费啤酒”中的“免费”。</p><p>自由软件关乎使用者运行、复制、发布、研究、修改和改进该软件的自由。 更精确地说，自由软件赋予软件使用者四种自由：</p><ol><li>不论目的为何，有运行该软件的自由（自由之零）。</li><li>有研究该软件如何运行，以及按需改写该软件的自由（自由之一）。取得该软件源代码为达成此目的之前提。</li><li>有重新发布拷贝的自由，这样你可以借此来敦亲睦邻（自由之二）。</li><li>有改进该软件，以及向公众发布改进的自由，这样整个社群都可受惠（自由之三）。取得该软件源码为达成此目的之前提。</li></ol><p><img src="pic/006.jpg" alt="004"></p><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux是一套免费使用和自由传播的类Unix操作系统，是一个基于POSIX和UNIX的多用户、多任务、支持多线程和多CPU的操作系统。它能运行主要的UNIX工具软件、应用程序和网络协议。它支持32位和64位硬件。Linux继承了Unix以网络为核心的设计思想，是一个性能稳定的多用户网络操作系统。Linux操作系统诞生于1991 年10 月5 日（这是第一次正式向外公布时间）。Linux存在着许多不同的Linux版本，但它们都使用了Linux内核。Linux可安装在各种计算机硬件设备中，比如手机、平板电脑、路由器、视频游戏控制台、台式计算机、大型机和超级计算机。</p><p>严格来讲，Linux这个词本身只表示Linux内核，但实际上人们已经习惯了用Linux来形容整个基于Linux内核，并且使用GNU 工程各种工具和数据库的操作系统。</p><h4 id="Linux简史"><a href="#Linux简史" class="headerlink" title="Linux简史"></a>Linux简史</h4><p>Linux 操作系统的诞生、发展和成长过程始终依赖着五个重要支柱：UNIX 操作系统、MINIX 操作系统、GNU计划、POSIX 标准和Internet 网络。</p><p>1981 年IBM公司推出微型计算机IBM PC。</p><p>1991年，GNU计划已经开发出了许多工具软件，最受期盼的GNU C编译器已经出现，GNU的操作系统核心HURD一直处于实验阶段，没有任何可用性，实质上也没能开发出完整的GNU操作系统，但是GNU奠定了Linux用户基础和开发环境。</p><p>1991年初，林纳斯·托瓦兹开始在一台386sx兼容微机上学习minix操作系统。1991年4月，林纳斯·托瓦兹开始酝酿并着手编制自己的操作系统。</p><p>1991 年4 月13 日在comp.os.minix 上发布说自己已经成功地将bash 移植到了minix 上，而且已经爱不释手、不能离开这个shell 软件了。</p><p>1991年7月3日，第一个与Linux有关的消息是在comp.os.minix上发布的（当然此时还不存在Linux这个名称，当时林纳斯·托瓦兹的脑子里想的可能是FREAX，FREAX的英文含义是怪诞的、怪物、异想天开等）。</p><p>1991年的10月5日，林纳斯·托瓦兹在comp.os.minix新闻组上发布消息，正式向外宣布Linux内核的诞生（Freeminix-like kernel sources for 386-AT）。</p><p>1993年，大约有100余名程序员参与了Linux内核代码编写/修改工作，其中核心组由5人组成，此时Linux 0.99的代码大约有十万行，用户大约有10万左右。</p><p>1994年3月，Linux1.0发布，代码量17万行，当时是按照完全自由免费的协议发布，随后正式采用GPL协议。</p><p>1995年1月，Bob Young创办了RedHat（小红帽），以GNU/Linux为核心，集成了400多个源代码开放的程序模块，搞出了一种冠以品牌的Linux，即RedHat Linux,称为Linux”发行版”，在市场上出售。这在经营模式上是一种创举。</p><p>1996年6月，Linux 2.0内核发布，此内核有大约40万行代码，并可以支持多个处理器。此时的Linux已经进入了实用阶段，全球大约有350万人使用。</p><p>1998年2月，以Eric Raymond为首的一批年轻的”老牛羚骨干分子”终于认识到GNU/Linux体系的产业化道路的本质，并非是什么自由哲学，而是市场竞争的驱动，创办了”Open Source Intiative”（开放源代码促进会）”复兴”的大旗，在互联网世界里展开了一场历史性的Linux产业化运动。</p><p>2001年1月，Linux 2.4发布，它进一步地提升了SMP系统的扩展性，同时它也集成了很多用于支持桌面系统的特性：USB，PC卡（PCMCIA）的支持，内置的即插即用，等等功能。</p><p>2003年12月，Linux 2.6版内核发布，相对于2.4版内核2.6在对系统的支持都有很大的变化。</p><p>2004年的第1月，SuSE嫁到了Novell，SCO继续顶着骂名四处强行“化缘”， Asianux，MandrakeSoft也在五年中首次宣布季度赢利。3月，SGI宣布成功实现了Linux操作系统支持256个Itanium 2处理器。</p><p><img src="pic/004.jpg" alt="005"></p><p><img src="pic/005.jpg" alt="006"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;如果你喜欢技术，那么Linux的学习会为你打开一个新的世界。&lt;/p&gt;
&lt;p&gt;入门难，但是一旦入门，就简单了，加油！&lt;/p&gt;
&lt;p&gt;开源万岁～&lt;/p&gt;
&lt;h2 id=&quot;硬件发展简介&quot;&gt;&lt;a href=&quot;#硬件发展简介&quot; class=&quot;headerlink&quot; title=&quot;硬件
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux 基础命令</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/01-Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/01-Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.301Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux基础命令"><a href="#Linux基础命令" class="headerlink" title="Linux基础命令"></a>Linux基础命令</h1><p>[TOC]</p><ul><li><p>在教室物理机包括rhel7和rhel6两台实验虚拟机，上打开虚拟机命令: <em>rht-vmctl start rhel7</em> </p><ul><li>在物理机上远程登陆到虚拟机rhel7 <em>ssh root@rhel7-fN</em> ，<em>N</em> 为你的机器编号， <em>root</em>密码都是<em>uplooking</em>，系统中有一个普通用户<em>student</em>，其密码为<em>student</em>。</li><li>在虚拟机中关闭虚拟机的命令为<em>shutdown -h now</em>，也可以在物理机上执行<em>rht-vmctl poweroff rhel7</em>。</li></ul></li><li><p>在物理机上设置录屏视频，由于Gnome3的bug会有30秒时间限制，修正时间限制的命令如下：</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[kiosk@fundation0 ~]$ gsettings set org.gnome.settings-daemon.plugins.media-keys max-screencast-length "uint32 0"</span><br></pre></td></tr></table></figure><h2 id="命令简介"><a href="#命令简介" class="headerlink" title="命令简介"></a>命令简介</h2><h3 id="命令的构成"><a href="#命令的构成" class="headerlink" title="命令的构成"></a>命令的构成</h3><p>命令字 选项 参数</p><ul><li>命令分:内部命令、外部命令;</li><li>选项: - 单个字符 – 多个字符</li><li>参数:对谁执行这个命令,可以有多个,选项和参数可以互换位置</li></ul><h3 id="命令使用的原因"><a href="#命令使用的原因" class="headerlink" title="命令使用的原因"></a>命令使用的原因</h3><p>Shell是系统的用户界面，提供了用户与内核进行交互操作的一种接口。它接收用户输入的命令并把它送入内核去执行。实际上Shell是一个命令解释器，它解释由用户输入的命令并且把它们送到内核。从这里开始学习Linux命令，本课程让你更清楚地了解和掌握它，在Linux中命令是讲究大小写的。使用命令即快速又能减少机器的性能消耗。</p><h3 id="命令提示符"><a href="#命令提示符" class="headerlink" title="命令提示符"></a>命令提示符</h3><ul><li># root 用户</li><li>$ 一般用户</li><li>[ 用户的身份 @ 主机名 当前位置 ]</li></ul><p>当前位置显示的是目录名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# hostname</span><br><span class="line">www.dabao.com</span><br><span class="line">[root@rhel7 ~]# groupadd tom</span><br><span class="line">[root@rhel7 ~]# useradd -g tom tom</span><br><span class="line">[root@rhel7 ~]# id tom</span><br><span class="line">uid=501(tom) gid=501(tom) groups=501(tom)</span><br><span class="line">[root@rhel7 ~]# su - tom</span><br><span class="line">[tom@rhel7 ~]$ who</span><br><span class="line">root tty1</span><br><span class="line">2016-03-20 23:56 (:0)</span><br><span class="line">root pts/0</span><br><span class="line">2016-03-21 00:39 (:0.0)</span><br></pre></td></tr></table></figure><h2 id="常用的命令"><a href="#常用的命令" class="headerlink" title="常用的命令"></a>常用的命令</h2><h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><table><thead><tr><th align="left">常用参数</th><th align="left">含义及用法</th></tr></thead><tbody><tr><td align="left">-l</td><td align="left">long 的缩写 详细列出当前目录下的所有文件属性     七列 文件名 &lt;=255 个字符</td></tr><tr><td align="left">-d</td><td align="left">directory 的缩写 查看当前目录本身的信息</td></tr><tr><td align="left">-h</td><td align="left">以人性化的方式显示文件大小,录的大小并不代表目录内所有文件的大小 du -sh /etc&lt;== 查看 etc 目录真正的大小</td></tr><tr><td align="left">-a</td><td align="left">查看隐藏文件 以 . 开头的文件</td></tr><tr><td align="left">-R</td><td align="left">查看多层目录</td></tr><tr><td align="left">-b</td><td align="left">特殊字符将以 \ 分割 ls 查看有特殊字符的文件</td></tr></tbody></table><h4 id="ls实验"><a href="#ls实验" class="headerlink" title="ls实验"></a>ls实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 tmp]$ ls -hl</span><br><span class="line">total 68K</span><br><span class="line">srwxr-xr-x. 1 root root 0 Mar 20 23:59 gedit.root.3177893063</span><br><span class="line">drwx------. 2 root root 4.0K Feb 5 18:24 keyring-JL7MKY</span><br><span class="line">[tom@rhel7 tmp]$ ls -ld /tmp</span><br><span class="line">drwxrwxrwt. 22 root root 4096 Mar 21 00:43 /tmp</span><br><span class="line">[tom@rhel7 tmp]$ ls -la /tmp</span><br><span class="line">total 96</span><br><span class="line">drwxrwxrwt. 22 root root 4096 Mar 21 00:43 .</span><br><span class="line">dr-xr-xr-x. 29 root root 4096 Mar 20 23:55 ..</span><br><span class="line">drwx------. 2 root root 4096 Mar 20 23:56 .esd-0</span><br><span class="line">drwx------. 2 cong cong 4096 Jan 1 18:33 .esd-500</span><br><span class="line">[tom@rhel7 tmp]$ ls -bl</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 00:48 a\ b.txt</span><br><span class="line">[tom@rhel7 tmp]$ ls -l</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 00:48 a b.txt</span><br><span class="line">[tom@rhel7 tmp]$ mkdir -p a/b/c</span><br><span class="line">[tom@rhel7 tmp]$ ls -lR a/</span><br><span class="line">a/:</span><br><span class="line">total 4</span><br><span class="line">drwxrwxr-x. 3 tom tom 4096 Mar 21 00:50 b</span><br><span class="line">a/b:</span><br><span class="line">total 4</span><br><span class="line">drwxrwxr-x. 2 tom tom 4096 Mar 21 00:50 c</span><br><span class="line">a/b/c:</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure><h3 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h3><table><thead><tr><th align="left">cd</th><th align="left">change directory 切换工作目录</th></tr></thead><tbody><tr><td align="left">绝对路径</td><td align="left">以根为起始的路径</td></tr><tr><td align="left">相对路径</td><td align="left">~当前用户的家目录 ;. 当前目录 ;.. 上一层用户 ;- 回到上一次所在位置</td></tr></tbody></table><h4 id="cd实验"><a href="#cd实验" class="headerlink" title="cd实验"></a>cd实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 tmp]$ cd /etc/</span><br><span class="line">[tom@rhel7 etc]$ cd ~</span><br><span class="line">[tom@rhel7 ~]$ cd .</span><br><span class="line">[tom@rhel7  ~]$ cd ..</span><br><span class="line">[tom@rhel7  home]$ cd -</span><br><span class="line">/home/tom</span><br></pre></td></tr></table></figure><h3 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h3><p>pwd:print working directory 显示当前所在位置的绝对路径</p><h4 id="pwd实验"><a href="#pwd实验" class="headerlink" title="pwd实验"></a>pwd实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 tmp]$ cd /etc/nginx</span><br><span class="line">[tom@rhel7 nginx]$ cd conf.d</span><br><span class="line">[tom@rhel7 conf.d]$ pwd</span><br><span class="line">/etc/nginx/conf.d</span><br></pre></td></tr></table></figure><h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h2><h3 id="通配符"><a href="#通配符" class="headerlink" title="通配符 *"></a>通配符 *</h3><p>匹配任意多个字符</p><p>例如：a* 包括aa*、ab*、ac* 等等 </p><h3 id="通配符-1"><a href="#通配符-1" class="headerlink" title="通配符 ?"></a>通配符 ?</h3><p>匹配任意单个字符<br>例如： a? 可以是ab、ac、ad、a1、a9、a#等等</p><h4 id="？实验"><a href="#？实验" class="headerlink" title="*？实验"></a>*？实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -f *1</span><br><span class="line">rm -f 1*</span><br><span class="line">rm -f 1*1</span><br><span class="line">rm -f test?</span><br><span class="line">想删除 test 后面有一个字符的文件</span><br></pre></td></tr></table></figure><h3 id="管道"><a href="#管道" class="headerlink" title="| 管道"></a>| 管道</h3><p>output | input</p><p>对某些命令执行的结果去作操作,会用到管道；用于命令与命令之间的连接，前一个命令的输出是后一个命令的输入</p><h4 id="管道实验"><a href="#管道实验" class="headerlink" title="| 管道实验"></a>| 管道实验</h4><p>详细列出 /tmp 目录下的文件,并截取以空格为分割的第三列</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ ls -l /tmp|cut -d" " -f3</span><br><span class="line">tom</span><br><span class="line">tom</span><br><span class="line">root</span><br><span class="line">root</span><br><span class="line">root</span><br><span class="line">详细列出 /tmp 目录下的文件,截取含有关键字 tom 的行,再截取以空格为分割的第一列内容</span><br><span class="line">[tom@rhel7 ~]$ ls -l /tmp|grep tom|cut -d" " -f1</span><br><span class="line">drwxrwxr-x.</span><br><span class="line">-rw-rw-r--.</span><br></pre></td></tr></table></figure><h2 id="针对文件的的基本操作"><a href="#针对文件的的基本操作" class="headerlink" title="针对文件的的基本操作"></a>针对文件的的基本操作</h2><h3 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h3><p>touch [filename] </p><p>创建文件,参数可以跟多个</p><p>如果要创建 50 个有规律的文件,例如 text1-text50</p><p>利用参数扩展</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch test&#123;1..50&#125;</span><br><span class="line">touch test&#123;a..e&#125;</span><br><span class="line">touch test&#123;a..e&#125;_&#123;1..3&#125;---&gt; 会创建 a_1 a_2 a_3...</span><br></pre></td></tr></table></figure><p>上帝之手,本来是用来修改文件时间戳的。文件的三个时间 ctime\mtime\atime</p><p>拓展内容：可以通过“stat”命令查看文件的三个时间</p><p>touch “ “ 可以放一些特殊字符</p><h4 id="touch实验"><a href="#touch实验" class="headerlink" title="touch实验"></a>touch实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ touch test&#123;a..c&#125;_&#123;1..4&#125;</span><br><span class="line">[tom@rhel7 ~]$ ls</span><br><span class="line">testa_1 testa_4 testb_3 testc_2</span><br><span class="line">testa_2 testb_1 testb_4 testc_3</span><br><span class="line">testa_3 testb_2 testc_1 testc_4</span><br><span class="line"></span><br><span class="line">--full-time可以查看mtime的完整时间</span><br><span class="line"></span><br><span class="line">[tom@rhel7 ~]$ ls -l --full-time</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testa_1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testa_2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testa_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testa_4</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testb_1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testb_2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testb_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.853039590 +0800 testb_4</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.854039544 +0800 testc_1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.854039544 +0800 testc_2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.854039544 +0800 testc_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 2016-03-21 01:31:22.854039544 +0800 testc_4</span><br><span class="line"></span><br><span class="line">[tom@rhel7 ~]$ touch "ab cd"</span><br><span class="line"></span><br><span class="line">[tom@rhel7 ~]$ ls -b</span><br><span class="line">ab\ \ \ cd testa_3 testb_2 testc_1 testc_4</span><br><span class="line">testa_1 testa_4 testb_3 testc_2</span><br><span class="line">testa_2 testb_1 testb_4 testc_3</span><br></pre></td></tr></table></figure><h4 id="touch拓展实验"><a href="#touch拓展实验" class="headerlink" title="touch拓展实验"></a>touch拓展实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ touch booboo</span><br><span class="line">[booboo@rhel7 ~]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 booboo booboo 0 Jun 15 23:28 booboo</span><br><span class="line">[booboo@rhel7 ~]$ stat booboo</span><br><span class="line">  File: ‘booboo’</span><br><span class="line">  Size: 0         Blocks: 0          IO Block: 4096   regular empty file</span><br><span class="line">Device: fd01h/64769dInode: 143         Links: 1</span><br><span class="line">Access: (0664/-rw-rw-r--)  Uid: ( 1001/  booboo)   Gid: ( 1001/  booboo)</span><br><span class="line">Context: unconfined_u:object_r:user_home_t:s0</span><br><span class="line">Access: 2016-06-15 23:28:55.041578819 -0400     #atime 文件最近一次被访问的时间</span><br><span class="line">Modify: 2016-06-15 23:28:55.041578819 -0400    #mtime 文件内容最近一次修改的时间</span><br><span class="line">Change: 2016-06-15 23:28:55.041578819 -0400    #ctime 文件属性最近一次修改的时间</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure><p>使用cat去访问booboo文件，可以发现atime被修改了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ cat booboo</span><br><span class="line">[booboo@rhel7 ~]$ stat booboo</span><br><span class="line">  File: ‘booboo’</span><br><span class="line">  Size: 0         Blocks: 0          IO Block: 4096   regular empty file</span><br><span class="line">Device: fd01h/64769dInode: 143         Links: 1</span><br><span class="line">Access: (0664/-rw-rw-r--)  Uid: ( 1001/  booboo)   Gid: ( 1001/  booboo)</span><br><span class="line">Context: unconfined_u:object_r:user_home_t:s0</span><br><span class="line">Access: 2016-06-15 23:32:35.898724748 -0400</span><br><span class="line">Modify: 2016-06-15 23:28:55.041578819 -0400</span><br><span class="line">Change: 2016-06-15 23:28:55.041578819 -0400</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure><p>通过chmod修改文件权限后，会看到ctime时间改变，通过ll命令看到的时间为mtime</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ chmod 777 booboo</span><br><span class="line">[booboo@rhel7 ~]$ ll</span><br><span class="line">total 0</span><br><span class="line">-rwxrwxrwx. 1 booboo booboo 0 Jun 15 23:28 booboo  </span><br><span class="line">[booboo@rhel7 ~]$ stat booboo</span><br><span class="line">  File: ‘booboo’</span><br><span class="line">  Size: 0         Blocks: 0          IO Block: 4096   regular empty file</span><br><span class="line">Device: fd01h/64769dInode: 143         Links: 1</span><br><span class="line">Access: (0777/-rwxrwxrwx)  Uid: ( 1001/  booboo)   Gid: ( 1001/  booboo)</span><br><span class="line">Context: unconfined_u:object_r:user_home_t:s0</span><br><span class="line">Access: 2016-06-15 23:32:35.898724748 -0400</span><br><span class="line">Modify: 2016-06-15 23:28:55.041578819 -0400</span><br><span class="line">Change: 2016-06-15 23:33:49.195445761 -0400</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure><p>通过echo命令向booboo文件追加一些内容，会看到mtime时间变了，并且ctime也变了，思考为什么？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ echo hi &gt;&gt; booboo</span><br><span class="line">[booboo@rhel7 ~]$ ll</span><br><span class="line">total 4</span><br><span class="line">-rwxrwxrwx. 1 booboo booboo 3 Jun 15 23:34 booboo</span><br><span class="line">[booboo@rhel7 ~]$ stat booboo</span><br><span class="line">  File: ‘booboo’</span><br><span class="line">  Size: 3         Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: fd01h/64769dInode: 143         Links: 1</span><br><span class="line">Access: (0777/-rwxrwxrwx)  Uid: ( 1001/  booboo)   Gid: ( 1001/  booboo)</span><br><span class="line">Context: unconfined_u:object_r:user_home_t:s0</span><br><span class="line">Access: 2016-06-15 23:32:35.898724748 -0400</span><br><span class="line">Modify: 2016-06-15 23:34:53.251332183 -0400</span><br><span class="line">Change: 2016-06-15 23:34:53.251332183 -0400</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure><h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h3><table><thead><tr><th align="left">rm</th><th align="left">[filename] remove 删除文件,对 root 用户有提示,普通用户没有提示</th></tr></thead><tbody><tr><td align="left">-f</td><td align="left">force 强制删除, root 无提示</td></tr><tr><td align="left">-i</td><td align="left">普通用户有提示的删除</td></tr><tr><td align="left">-r</td><td align="left">递归删除,慎重使用 -rf</td></tr></tbody></table><h4 id="rm实验"><a href="#rm实验" class="headerlink" title="rm实验"></a>rm实验</h4><p>普通用户 tom</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ rm testa_1</span><br><span class="line">[tom@rhel7 ~]$ rm -i testa_2</span><br><span class="line">rm: remove regular empty file `testa_2'? Y</span><br></pre></td></tr></table></figure><p>root 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# rm a.test</span><br><span class="line">rm: remove regular empty file `a.test'? Y</span><br><span class="line">[root@rhel7 ~]# rm -f b.test</span><br></pre></td></tr></table></figure><p>普通用户 tom</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ mkdir -p a/b/c</span><br><span class="line">[tom@rhel7 ~]$ rm a/</span><br><span class="line">rm: cannot remove `a/': Is a directory</span><br><span class="line">[tom@rhel7 ~]$ rm -r a/</span><br></pre></td></tr></table></figure><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><p>mkdir:make directory 创建目录</p><p><code>mkdir -p /test/test1</code></p><p>递归创建目录</p><p><code>mkdir {a..e}</code></p><p>创建 a-e 的目录</p><p><code>touch {a..e}/file{1..4}</code></p><p> 在 a-e 的目录下新建 file1-file4 文件</p><h4 id="mkdir实验"><a href="#mkdir实验" class="headerlink" title="mkdir实验"></a>mkdir实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ mkdir -p test/test1</span><br><span class="line">[tom@rhel7 ~]$ ls</span><br><span class="line">ab cd testa_3 testb_2 testc_1 testc_4</span><br><span class="line">p        testa_4 testb_3 testc_2</span><br><span class="line">test    testb_1 testb_4 testc_3</span><br><span class="line">[tom@rhel7 ~]$ mkdir &#123;a..f&#125;</span><br><span class="line">[tom@rhel7 ~]$ ls</span><br><span class="line">a d test testb_2 testc_2</span><br><span class="line">ab cd e testa_3 testb_3 testc_3</span><br><span class="line">b f testa_4 testb_4 testc_4 c p testb_1 testc_1</span><br><span class="line">[tom@rhel7 ~]$ touch &#123;a..f&#125;/file&#123;1..4&#125;</span><br><span class="line">[tom@rhel7 ~]$ ls</span><br><span class="line">a d test testb_2 testc_2</span><br><span class="line">ab cd e testa_3 testb_3 testc_3</span><br><span class="line">b f testa_4 testb_4 testc_4 c p testb_1 testc_1</span><br><span class="line">[tom@rhel7 ~]$ ls -rR</span><br><span class="line">.:</span><br><span class="line">testc_4 testb_4 testa_4 f b</span><br><span class="line">testc_3 testb_3 testa_3 e ab cd</span><br><span class="line">testc_2 testb_2 test d a</span><br><span class="line">testc_1 testb_1 p c</span><br><span class="line">./test:</span><br><span class="line">test1</span><br><span class="line">./test/test1:</span><br><span class="line">./p:</span><br><span class="line">./f:</span><br><span class="line">file4 file3 file2 file1</span><br><span class="line">./e:</span><br><span class="line">file4 file3 file2 file1</span><br><span class="line">./d:</span><br><span class="line">file4 file3 file2 file1</span><br><span class="line">./c:</span><br><span class="line">file4 file3 file2 file1</span><br><span class="line">./b:</span><br><span class="line">file4 file3 file2 file1</span><br><span class="line">./a:</span><br><span class="line">file4 file3 file2 file1</span><br></pre></td></tr></table></figure><h3 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h3><p>rmdir:remove directory 删除目录</p><p>只能删除空目录,出于安全性的考虑</p><p><code>rm -rf [d_name]</code></p><p>可以删除非空目录</p><h4 id="rmdir-实验"><a href="#rmdir-实验" class="headerlink" title="rmdir 实验"></a>rmdir 实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ mkdir aa</span><br><span class="line">[booboo@rhel7 ~]$ mkdir -p cc/bb</span><br><span class="line">[booboo@rhel7 ~]$ rmdir aa</span><br><span class="line">[booboo@rhel7 ~]$ ll</span><br><span class="line">total 4</span><br><span class="line">-rwxrwxrwx. 1 booboo booboo  3 Jun 15 23:34 booboo</span><br><span class="line">drwxrwxr-x. 3 booboo booboo 15 Jun 16 00:08 cc</span><br><span class="line">[booboo@rhel7 ~]$ rmdir cc</span><br><span class="line">rmdir: failed to remove ‘cc’: Directory not empty</span><br><span class="line">[booboo@rhel7 ~]$ rm -rf cc</span><br><span class="line">[booboo@rhel7 ~]$ ll</span><br><span class="line">total 4</span><br><span class="line">-rwxrwxrwx. 1 booboo booboo 3 Jun 15 23:34 booboo</span><br></pre></td></tr></table></figure><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><p>cp:copy 复制文件</p><p>cp 源文件 目的地(目录)</p><p>-p 保留文件原属性</p><p>-r 复制目录</p><h4 id="cp实验"><a href="#cp实验" class="headerlink" title="cp实验"></a>cp实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">使用 root 用户,进入 tom 的家目录</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# cd /home/tom</span><br><span class="line"></span><br><span class="line">保留原文件属性复制 testa_3 文件到 /tmp 目录下</span><br><span class="line"></span><br><span class="line">[root@rhel7 tom]# cp -p testa_3 /tmp</span><br><span class="line">[root@rhel7 tom]# ll /tmp/testa_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 /tmp/testa_3</span><br><span class="line">[root@rhel7 tom]# cp testa_4 /tmp</span><br><span class="line">[root@rhel7 tom]# ll /tmp/testa_4</span><br><span class="line">-rw-r--r--. 1 root root 0 Mar 21 01:55 /tmp/testa_4</span><br><span class="line"></span><br><span class="line">拷贝目录 a 到 /tmp 下,必须加上 -r ,因为 a 目录下还有 b/c 目录</span><br><span class="line"></span><br><span class="line">[root@rhel7 tom]# cp a /tmp</span><br><span class="line">cp: omitting directory `a'</span><br><span class="line">[root@rhel7 tom]# cp -r a /tmp</span><br></pre></td></tr></table></figure><h3 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h3><p>mv:move 移动 移动和重命名</p><p>mv 源文件 目的地(目录)</p><h4 id="mv实验"><a href="#mv实验" class="headerlink" title="mv实验"></a>mv实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ mv testa_3 test</span><br><span class="line">[tom@rhel7 ~]$ ls</span><br><span class="line">a</span><br><span class="line">c f testa_4 testb_3 testc_2</span><br><span class="line">ab cd d p testb_1 testb_4 testc_3</span><br><span class="line">b</span><br><span class="line">e test testb_2 testc_1 testc_4</span><br><span class="line">[tom@rhel7 ~]$ mv test??? f/</span><br><span class="line">[tom@rhel7 ~]$ ll -R f</span><br><span class="line">f:</span><br><span class="line">total 0</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:47 file1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:47 file2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:47 file3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:47 file4</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testa_4</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testb_1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testb_2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testb_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testb_4</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testc_1</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testc_2</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testc_3</span><br><span class="line">-rw-rw-r--. 1 tom tom 0 Mar 21 01:31 testc_4</span><br></pre></td></tr></table></figure><h2 id="针对文件内容的基本操作"><a href="#针对文件内容的基本操作" class="headerlink" title="针对文件内容的基本操作"></a>针对文件内容的基本操作</h2><h3 id="文件的查看"><a href="#文件的查看" class="headerlink" title="文件的查看"></a>文件的查看</h3><table><thead><tr><th align="left">文件</th><th align="left">命令</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">小文件</td><td align="left">cat</td><td align="left">以正序查看 调用内存比较多 -n 显示行号</td></tr><tr><td align="left"></td><td align="left">tac</td><td align="left">以倒序查看 调用内存比较多</td></tr><tr><td align="left">大文件</td><td align="left">head</td><td align="left">查看文件首部，默认10行 ，-n 指定行号</td></tr><tr><td align="left"></td><td align="left">tail</td><td align="left">查看文件尾部，默认10行，-n指定行号</td></tr><tr><td align="left"></td><td align="left">more</td><td align="left">按空格 space 下一页 b 向上翻页 enter 下一行</td></tr><tr><td align="left"></td><td align="left">less</td><td align="left">比 more 多了一个搜索功能 /[ 需搜索的子段 ]N 向上查找 n 向下查 q 退出</td></tr></tbody></table><h4 id="文件查看实验"><a href="#文件查看实验" class="headerlink" title="文件查看实验"></a>文件查看实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[tom@rhel7 ~]$ cat -n passwd</span><br><span class="line">1 root:x:0:0:root:/root:/bin/bash</span><br><span class="line">2 bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">3 daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">4 adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">5 lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">6 sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">7 shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">8 halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">9 mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">10 cong:x:500:500:cong:/home/cong:/bin/bash</span><br><span class="line">11 nginx:x:496:491:Nginx web server:/var/lib/nginx:/sbin/nologin</span><br><span class="line">12 tom:x:501:501::/home/tom:/bin/bash</span><br><span class="line">[tom@rhel7 ~]$ tac passwd</span><br><span class="line">tom:x:501:501::/home/tom:/bin/bash</span><br><span class="line">nginx:x:496:491:Nginx web server:/var/lib/nginx:/sbin/nologin</span><br><span class="line">cong:x:500:500:cong:/home/cong:/bin/bash</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure><h3 id="文件的修改"><a href="#文件的修改" class="headerlink" title="文件的修改"></a>文件的修改</h3><table><thead><tr><th align="left">软件</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">LibreOffice</td><td align="left">.odt 结尾 类似于 windows office</td></tr><tr><td align="left">gedit</td><td align="left">类似于 windows 记事本</td></tr><tr><td align="left">vim</td><td align="left">插入模式 后面会专门讲到 vim 编辑器的使用 退出模式 命令模式</td></tr><tr><td align="left">echo</td><td align="left">本身代表回显 echo xxx &gt; file 将 xxx 写入 file 文件,并覆盖原有内容 echo xxx &gt;&gt; file 在 file 文件追加</td></tr></tbody></table><h4 id="echo实验"><a href="#echo实验" class="headerlink" title="echo实验"></a>echo实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ echo hi &gt; file1</span><br><span class="line">[booboo@rhel7 ~]$ cat file1</span><br><span class="line">hi</span><br><span class="line">[booboo@rhel7 ~]$ echo booboo &gt; file1</span><br><span class="line">[booboo@rhel7 ~]$ cat file1</span><br><span class="line">booboo</span><br><span class="line">[booboo@rhel7 ~]$ echo hihihihi &gt;&gt; file1</span><br><span class="line">[booboo@rhel7 ~]$ cat file1</span><br><span class="line">booboo</span><br><span class="line">hihihihi</span><br></pre></td></tr></table></figure><h3 id="文件的过滤"><a href="#文件的过滤" class="headerlink" title="文件的过滤"></a>文件的过滤</h3><p>grep</p><p>截取行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">grep [OPTIONS] PATTERN [FILE...]</span><br><span class="line">过滤带有 [ 字符串 ] 的行</span><br><span class="line">grep [ 字符串 ] [ 文件 ]</span><br><span class="line">过滤以 [ 字符串 ] 为开始的行</span><br><span class="line">grep [^ 字符串 ] [ 文件 ]</span><br><span class="line">过滤以 [ 字符串 ] 为结尾的行</span><br><span class="line">grep [ 字符串 $] [ 文件 ]</span><br><span class="line">过滤反选</span><br><span class="line">grep -v [ 字符串 ] [ 文件 ]</span><br><span class="line"></span><br><span class="line">eg.</span><br><span class="line">过滤以 root 为开始的行</span><br><span class="line"> grep ^root /etc/passwd</span><br><span class="line">过滤以 bash 为结尾的行</span><br><span class="line">grep bash$ /etc/passwd</span><br></pre></td></tr></table></figure><p>cut</p><p>截取列</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cut -d" 分割符 "( 以什么为分隔符 ) -fn( 第几列 ) [ 文件 ]</span><br><span class="line">eg. cut -d":" -f2 /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>wc</p><p>统计</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wc 行数 单词数 字符数 文件名</span><br><span class="line">-l 只显示行数</span><br><span class="line">-w, --words 显示单词数</span><br><span class="line">-c, -m,--bytes 显示字节</span><br><span class="line">eg.</span><br><span class="line">[root@stu15 ~]# wc /etc/resolv.conf 、</span><br><span class="line">4 11 98 /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>sort</p><p>排序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">默认按照首字母 ACII 码</span><br><span class="line">-n 按照数字大小排序</span><br><span class="line">-u 剔除重复的行</span><br><span class="line">-r 降序排列</span><br><span class="line">-k 指定某一列</span><br><span class="line">-t 分隔符</span><br><span class="line">eg.sort -n -k 2 -t : file1 </span><br><span class="line">将 file1 以第二列的数字排序,列以:分割</span><br></pre></td></tr></table></figure><p>uniq</p><p>剔除重复行</p><p><code>uniq [file_name]</code></p><h4 id="文件过滤实验"><a href="#文件过滤实验" class="headerlink" title="文件过滤实验"></a>文件过滤实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">grep</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ grep root passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">[booboo@rhel7 ~]$ grep ^booboo passwd</span><br><span class="line">booboo:x:1001:1001::/home/booboo:/bin/bash</span><br><span class="line">[booboo@rhel7 ~]$ grep ^root passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">[booboo@rhel7 ~]$ grep bash$ passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">student:x:1000:1000:student:/home/student:/bin/bash</span><br><span class="line">booboo:x:1001:1001::/home/booboo:/bin/bash</span><br><span class="line">[booboo@rhel7 ~]$ grep -v nologin passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">student:x:1000:1000:student:/home/student:/bin/bash</span><br><span class="line">booboo:x:1001:1001::/home/booboo:/bin/bash</span><br><span class="line"></span><br><span class="line">cut</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ cut -d":" -f1 passwd</span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line">shutdown</span><br><span class="line">halt</span><br><span class="line">mail</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wc</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ wc passwd</span><br><span class="line">  42   72 2121 passwd</span><br><span class="line">[booboo@rhel7 ~]$ wc -l passwd</span><br><span class="line">42 passwd</span><br><span class="line">[booboo@rhel7 ~]$ wc -w passwd</span><br><span class="line">72 passwd</span><br><span class="line">[booboo@rhel7 ~]$ wc -c passwd</span><br><span class="line">2121 passwd</span><br><span class="line"></span><br><span class="line">sort</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ vi num</span><br><span class="line">[booboo@rhel7 ~]$ cat num</span><br><span class="line">booboo 20 100</span><br><span class="line">tom 21 100</span><br><span class="line">tom 21 100</span><br><span class="line">kevin 19 200</span><br><span class="line">booboo 20 100</span><br><span class="line">mark 20 200</span><br><span class="line">[booboo@rhel7 ~]$ sort num</span><br><span class="line">booboo 20 100</span><br><span class="line">booboo 20 100</span><br><span class="line">kevin 19 200</span><br><span class="line">mark 20 200</span><br><span class="line">tom 21 100</span><br><span class="line">tom 21 100</span><br><span class="line">[booboo@rhel7 ~]$ sort -r num</span><br><span class="line">tom 21 100</span><br><span class="line">tom 21 100</span><br><span class="line">mark 20 200</span><br><span class="line">kevin 19 200</span><br><span class="line">booboo 20 100</span><br><span class="line">booboo 20 100</span><br><span class="line">[booboo@rhel7 ~]$ sort -u num</span><br><span class="line">booboo 20 100</span><br><span class="line">kevin 19 200</span><br><span class="line">mark 20 200</span><br><span class="line">tom 21 100</span><br><span class="line">[booboo@rhel7 ~]$ sort -n -k 2 -t " " num |sort -u</span><br><span class="line">booboo 20 100</span><br><span class="line">kevin 19 200</span><br><span class="line">mark 20 200</span><br><span class="line">tom 21 100</span><br><span class="line"></span><br><span class="line">uniq</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ uniq num</span><br><span class="line">booboo 20 100</span><br><span class="line">tom 21 100</span><br><span class="line">kevin 19 200</span><br><span class="line">booboo 20 100</span><br><span class="line">mark 20 200</span><br></pre></td></tr></table></figure><h2 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h2><table><thead><tr><th align="left">命令</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">type [ 命令 ]</td><td align="left">判断是内部命令 or 外部命令</td></tr><tr><td align="left">–help</td><td align="left">外部命令</td></tr><tr><td align="left">help</td><td align="left">只针对系统内部命令</td></tr><tr><td align="left">man []</td><td align="left">内容清晰、详细,在线文档,支持搜索( /name ) <code>man [ 章节 ] [name]</code></td></tr><tr><td align="left">info []</td><td align="left">太详细</td></tr><tr><td align="left">/usr/share/doc</td><td align="left">存放帮助文档,在与软件同名的目录下有所有软件的使用文档</td></tr></tbody></table><p><strong>man和—help以及help的区别</strong></p><p>man命令</p><p>系统中会有单独的man文件，就是说，如果系统没有安装对应man文件，哪怕命令完全正常，man都没结果（同样，只要安装了man文件，哪怕没命令，也可以得到一大堆东西）。</p><p>–help参数<br>将会显示可执行程序自带的信息，这些信息是嵌入到程序本身的，所以–help信息较简短。</p><p>help命令<br>是选项帮助命令，顾名思义  你可以把单独某个命令的某个选项列出来，方便快捷很多，省去了man当中查找的繁琐，但是help只支持shell的内部命令。内部命令即存储在shell内部可以直接调用的一些简单命令，比如说echo，cd，pwd等。</p><h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>type命令用来显示指定命令的类型，判断给出的指令是内部指令还是外部指令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">type(选项)(参数)</span><br><span class="line">选项</span><br><span class="line">-t：输出“file”、“alias”或者“builtin”，分别表示给定的指令为“外部指令”、“命令别名”或者“内部指令”；</span><br><span class="line">-p：如果给出的指令为外部指令，则显示其绝对路径；</span><br><span class="line">-a：在环境变量“PATH”指定的路径中，显示给定指令的信息，包括命令别名。 参数 指令：要显示类型的指令。</span><br><span class="line">参数</span><br><span class="line">关键字：指定要搜索帮助的关键字</span><br><span class="line">命令类型</span><br><span class="line">alias：别名</span><br><span class="line">keyword：关键字，Shell保留字</span><br><span class="line">function：函数，Shell函数</span><br><span class="line">builtin：内建命令，Shell内建命令</span><br><span class="line">file：文件，磁盘文件，外部命令</span><br><span class="line">unfound：没有找到</span><br><span class="line"></span><br><span class="line">尝试几个命令man,ls,touch,echo,cat</span><br><span class="line"></span><br><span class="line">[booboo@rhel7 ~]$ type man</span><br><span class="line">man is /bin/man</span><br><span class="line">[booboo@rhel7 ~]$ type ls</span><br><span class="line">ls is aliased to `ls –color=auto'</span><br><span class="line">[booboo@rhel7 ~]$ which ls</span><br><span class="line">alias ls='ls --color=auto'</span><br><span class="line">/bin/ls</span><br><span class="line">[booboo@rhel7 ~]$ type touch</span><br><span class="line">touch is hashed (/bin/touch)</span><br><span class="line">[booboo@rhel7 ~]$ type echo</span><br><span class="line">echo is a shell builtin</span><br><span class="line">[booboo@rhel7 ~]$ type cat</span><br><span class="line">cat is hashed (/bin/cat)</span><br></pre></td></tr></table></figure><p>内置命令一般显示为“is a shell builtin ”</p><p>除了内置命令外，其他命令都是通过某个安装包安装生成的可执行文件</p><p>接下来我们一起看看这些命令都是什么软件生成的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ rpm -qf /bin/man</span><br><span class="line">man-db-2.6.3-9.el7.x86_64</span><br><span class="line">[booboo@rhel7 ~]$ rpm -qf /bin/ls</span><br><span class="line">coreutils-8.22-11.el7.x86_64</span><br><span class="line">[booboo@rhel7 ~]$ rpm -qf /bin/touch</span><br><span class="line">coreutils-8.22-11.el7.x86_64</span><br><span class="line">[booboo@rhel7 ~]$ rpm -qf /bin/cat</span><br><span class="line">coreutils-8.22-11.el7.x86_64</span><br><span class="line">[booboo@rhel7 ~]$ type if</span><br><span class="line">if is a shell keyword</span><br></pre></td></tr></table></figure><h3 id="–help-参数"><a href="#–help-参数" class="headerlink" title="–help 参数"></a>–help 参数</h3><p>–help参数是大所数命令自带的选项，用于查看使用帮助。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ ls --help</span><br><span class="line">Usage: ls [OPTION]... [FILE]...</span><br><span class="line">List information about the FILEs (the current directory by default).</span><br><span class="line">Sort entries alphabetically if none of -cftuvSUX nor --sort is specified.</span><br><span class="line"></span><br><span class="line">Mandatory arguments to long options are mandatory for short options too.</span><br><span class="line">  -a, --all                  do not ignore entries starting with .</span><br><span class="line">  -A, --almost-all           do not list implied . and ..</span><br><span class="line">      --author               with -l, print the author of each file</span><br><span class="line">  -b, --escape               print C-style escapes for nongraphic characters</span><br><span class="line">      --block-size=SIZE      scale sizes by SIZE before printing them; e.g.,</span><br><span class="line">                               '--block-size=M' prints sizes in units of</span><br><span class="line">                               1,048,576 bytes; see SIZE format below</span><br><span class="line">  -B, --ignore-backups       do not list implied entries ending with ~</span><br><span class="line">  -c                         with -lt: sort by, and show, ctime (time of last</span><br><span class="line">                               modification of file status information);</span><br><span class="line">                               with -l: show ctime and sort by name;</span><br><span class="line">                               otherwise: sort by ctime, newest first</span><br><span class="line">  -C                         list entries by columns</span><br><span class="line">      --color[=WHEN]         colorize the output; WHEN can be 'never', 'auto',</span><br><span class="line">                               or 'always' (the default); more info below</span><br><span class="line">  -d, --directory            list directories themselves, not their contents</span><br><span class="line">  -D, --dired                generate output designed for Emacs' dired mode</span><br><span class="line">  -f                         do not sort, enable -aU, disable -ls --color</span><br></pre></td></tr></table></figure><h3 id="help"><a href="#help" class="headerlink" title="help"></a>help</h3><p>help只支持shell的内部命令。内部命令即存储在shell内部可以直接调用的一些简单命令,例如cd,echo,help等。</p><p>help(选项)(参数)<br>-s：输出短格式的帮助信息。仅包括命令格式。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ type cd</span><br><span class="line">cd is a shell builtin</span><br><span class="line">[booboo@rhel7 ~]$ help cd</span><br><span class="line">cd: cd [-L|[-P [-e]]] [dir]</span><br><span class="line">    Change the shell working directory.</span><br><span class="line"></span><br><span class="line">    Change the current directory to DIR.  The default DIR is the value of the</span><br><span class="line">    HOME shell variable.</span><br><span class="line"></span><br><span class="line">    The variable CDPATH defines the search path for the directory containing</span><br><span class="line">    DIR.  Alternative directory names in CDPATH are separated by a colon (:).</span><br><span class="line">    A null directory name is the same as the current directory.  If DIR begins</span><br><span class="line">    with a slash (/), then CDPATH is not used.</span><br><span class="line"></span><br><span class="line">    If the directory is not found, and the shell option `cdable_vars' is set,</span><br><span class="line">    the word is assumed to be  a variable name.  If that variable has a value,</span><br><span class="line">    its value is used for DIR.</span><br><span class="line"></span><br><span class="line">    Options:</span><br><span class="line">        -Lforce symbolic links to be followed</span><br><span class="line">        -Puse the physical directory structure without following symbolic</span><br><span class="line">    links</span><br><span class="line">        -eif the -P option is supplied, and the current working directory</span><br><span class="line">    cannot be determined successfully, exit with a non-zero status</span><br><span class="line"></span><br><span class="line">    The default is to follow symbolic links, as if `-L' were specified.</span><br><span class="line"></span><br><span class="line">    Exit Status:</span><br><span class="line">    Returns 0 if the directory is changed, and if $PWD is set successfully when</span><br><span class="line">    -P is used; non-zero otherwise.</span><br><span class="line">[booboo@rhel7 ~]$ type touch</span><br><span class="line">touch is hashed (/bin/touch)</span><br><span class="line">[booboo@rhel7 ~]$ type echo</span><br><span class="line">echo is a shell builtin</span><br><span class="line">[booboo@rhel7 ~]$ help echo</span><br><span class="line">echo: echo [-neE] [arg ...]</span><br></pre></td></tr></table></figure><h3 id="man"><a href="#man" class="headerlink" title="man"></a>man</h3><p>man命令是Linux下的帮助指令，通过man指令可以查看Linux中的指令帮助、配置文件帮助和编程帮助等信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">man(选项)(参数)</span><br><span class="line">选项</span><br><span class="line">-a：在所有的man帮助手册中搜索；</span><br><span class="line">-f：等价于whatis指令，显示给定关键字的简短描述信息；</span><br><span class="line">-P：指定内容时使用分页程序；</span><br><span class="line">-M：指定man手册搜索的路径。</span><br><span class="line">参数</span><br><span class="line">数字：指定从哪本man手册中搜索帮助</span><br><span class="line">关键字：指定要搜索帮助的关键字</span><br></pre></td></tr></table></figure><p>例如输入man ls，它会在左上角显示“ECHO(1)”“ECHO”代表手册名称；“(1)”代表 表示该手册位于第一节章1）”表示该手册位于第一节章，同样，我们输man ifconfig它会在最左上角显示“IFCONFIG（8）”。也可以这样输入命令：“man [章节号] 手册名称”。 man是按照手册的章节号的顺序进行搜索的，比如： man sleep 只会显示sleep命令的手册,如果想查看库函数sleep，就要输入: man 3 sleep</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ man echo|cat</span><br><span class="line">ECHO(1)                         User Commands                         ECHO(1)</span><br><span class="line"><span class="meta">#</span><span class="bash">此处“ECHO”代表手册名称；“（1）”代表 表示该手册位于第一节章</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">       echo - display a line of text</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       echo [SHORT-OPTION]... [STRING]...</span><br><span class="line">       echo LONG-OPTION</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       Echo the STRING(s) to standard output.</span><br><span class="line"></span><br><span class="line">       -n     do not output the trailing newline</span><br><span class="line"></span><br><span class="line">       -e     enable interpretation of backslash escapes</span><br><span class="line"></span><br><span class="line">       -E     disable interpretation of backslash escapes (default)</span><br><span class="line"></span><br><span class="line">       --help display this help and exit</span><br><span class="line"></span><br><span class="line">       --version</span><br><span class="line">              output version information and exit</span><br><span class="line"></span><br><span class="line">       If -e is in effect, the following sequences are recognized:</span><br><span class="line"></span><br><span class="line">       \\     backslash</span><br><span class="line"></span><br><span class="line">       \a     alert (BEL)</span><br><span class="line"></span><br><span class="line">       \b     backspace</span><br><span class="line"></span><br><span class="line">       \c     produce no further output</span><br><span class="line"></span><br><span class="line">       \e     escape</span><br><span class="line"></span><br><span class="line">       \f     form feed</span><br><span class="line"></span><br><span class="line">       \n     new line</span><br><span class="line"></span><br><span class="line">       \r     carriage return</span><br><span class="line"></span><br><span class="line">       \t     horizontal tab</span><br><span class="line"></span><br><span class="line">       \v     vertical tab</span><br><span class="line"></span><br><span class="line">       \0NNN  byte with octal value NNN (1 to 3 digits)</span><br><span class="line"></span><br><span class="line">       \xHH   byte with hexadecimal value HH (1 to 2 digits)</span><br><span class="line"></span><br><span class="line">       NOTE:  your  shell  may  have  its  own version of echo, which usually</span><br><span class="line">       supersedes the version described here.  Please refer to  your  shell's</span><br><span class="line">       documentation for details about the options it supports.</span><br><span class="line"></span><br><span class="line">       GNU  coreutils  online  help: &lt;http://www.gnu.org/software/coreutils/&gt;</span><br><span class="line">       Report echo translation bugs to &lt;http://translationproject.org/team/&gt;</span><br><span class="line">AUTHOR</span><br><span class="line">       Written by Brian Fox and Chet Ramey.</span><br><span class="line">COPYRIGHT</span><br><span class="line">       Copyright © 2013 Free Software Foundation, Inc.  License  GPLv3+:  GNU</span><br><span class="line">       GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;.</span><br><span class="line">       This  is  free  software:  you are free to change and redistribute it.</span><br><span class="line">       There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">SEE ALSO</span><br><span class="line">       The full documentation for echo is maintained as a Texinfo manual.  If</span><br><span class="line">       the  info  and  echo programs are properly installed at your site, the</span><br><span class="line">       command</span><br><span class="line">             info coreutils 'echo invocation'</span><br><span class="line">      should give you access to the complete manual.</span><br><span class="line"></span><br><span class="line">GNU coreutils 8.22               January 2014                         ECHO(1)</span><br></pre></td></tr></table></figure><h3 id="info（作为拓展内容）"><a href="#info（作为拓展内容）" class="headerlink" title="info（作为拓展内容）"></a>info（作为拓展内容）</h3><p>info命令是Linux下info格式的帮助指令。 就内容来说，info页面比man page编写得要更好、更容易理解，也更友好，但man page使用起来确实要更容易得多。一个man page只有一页，而info页面几乎总是将它们的内容组织成多个区段（称为节点），每个区段也可能包含子区段（称为子节点）。理解这个命令的窍门就是不仅要学习如何在单独的Info页面中浏览导航，还要学习如何在节点和子节点之间切换。可能刚开始会一时很难在info页面的节点之间移动和找到你要的东西，真是具有讽刺意味：原本以为对于新手来说，某个东西比man命令会更好些，但实际上学习和使用起来更困难。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">info(选项)(参数)</span><br><span class="line">选项</span><br><span class="line">-d：添加包含info格式帮助文档的目录；</span><br><span class="line"> -f：指定要读取的info格式的帮助文档；</span><br><span class="line">-n：指定首先访问的info帮助文件的节点；</span><br><span class="line"> -o：输出被选择的节点内容到指定文件。</span><br><span class="line">参数</span><br><span class="line"> 帮助主题：指定需要获得帮助的主题，可以是指令、函数以及配置文件。</span><br><span class="line">常用快捷键</span><br><span class="line">?键：它就会显示info的常用快捷键。</span><br><span class="line">N键：显示（相对于本节点的）下一节点的文档内容。</span><br><span class="line">P键：显示（相对于本节点的）前一节点的文档内容。</span><br><span class="line">U键：进入当前命令所在的主题。</span><br><span class="line">M键：敲M键后输入命令的名称就可以查看该命令的帮助文档了。</span><br><span class="line">G键：敲G键后输入主题名称，进入该主题。</span><br><span class="line">L键：回到上一个访问的页面。 SPACE键：向前滚动一页。</span><br><span class="line">BACKUP或DEL键：向后滚动一页。</span><br><span class="line">Q：退出info。</span><br><span class="line">命令</span><br><span class="line">？ 显示帮助窗口</span><br><span class="line">在帮助窗口中：</span><br><span class="line">Ctrl-x 0 关闭帮助窗口</span><br><span class="line">Ctrl-x Ctrl-c 关闭整个 Info</span><br><span class="line">q 退出 info</span><br><span class="line">n 打开与本 Node 关联的下一个 Node</span><br><span class="line">p 打开与本 Node 关联的前一个 Node</span><br><span class="line">u 打开与本 Node 关联的上一个 Node</span><br><span class="line">l 回到上一次访问的 Node</span><br><span class="line">m或g 选择一个菜单项（Node 的名字）</span><br><span class="line">           输入指定菜单的名字后按回车，打开指定菜单项关联的 Node</span><br><span class="line">空格键 下一页（PageDown 也可以，下一页从当前页的最后两行开始算起）</span><br><span class="line">           下一个 Node （若当前页在 Node 文档的末尾）</span><br><span class="line">Del 键 上一页（PageUp 也可以，上一页从当前页的开始两行开始算起）</span><br><span class="line">       上一个 Node （若当前页 Node 文档的开始）</span><br><span class="line">b 或 t 或 Home 文档的开始（b 是 begining 的意思）</span><br><span class="line">e 或 End 文档的末尾（b 是 ending 的意思）</span><br><span class="line">Ctrl-l 刷新当前页，若当前文档显示情况有问题时</span><br><span class="line">Ctrl-g 取消所键入的指令</span><br></pre></td></tr></table></figure><h2 id="关于时间的命令"><a href="#关于时间的命令" class="headerlink" title="关于时间的命令"></a>关于时间的命令</h2><h3 id="date"><a href="#date" class="headerlink" title="date"></a>date</h3><p>date命令是显示或设置系统时间与日期。 很多shell脚本里面需要打印不同格式的时间或日期，以及要根据时间和日期执行操作。延时通常用于脚本执行过程中提供一段等待的时间。日期可以以多种格式去打印，也可以使用命令设置固定的格式。在类UNIX系统中，日期被存储为一个整数，其大小为自世界标准时间（UTC）1970年1月1日0时0分0秒起流逝的秒数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">date(选项)(参数)</span><br><span class="line">选项</span><br><span class="line">-d&lt;字符串&gt;：显示字符串所指的日期与时间。字符串前后必须加上双引号；</span><br><span class="line">-s&lt;字符串&gt;：根据字符串来设置日期与时间。字符串前后必须加上双引号；</span><br><span class="line"> -u：显示GMT；</span><br><span class="line">--help：在线帮助；</span><br><span class="line">--version：显示版本信息。</span><br><span class="line">参数</span><br><span class="line">&lt;+时间日期格式&gt;：指定显示时使用的日期时间格式。</span><br></pre></td></tr></table></figure><p>日期格式字符串列表<br>| 格式    | 说明                              |<br>| :—- | :—————————— |<br>| %H    | 小时，24小时制（00<del>23）                 |<br>| %I    | 小时，12小时制（01</del>12）                 |<br>| %k    | 小时，24小时制（0<del>23）                  |<br>| %l    | 小时，12小时制（1</del>12）                  |<br>| %M    | 分钟（00<del>59）                       |<br>| %p    | 显示出AM或PM                        |<br>| %r    | 显示时间，12小时制（hh:mm:ss %p）         |<br>| %s    | 从1970年1月1日00:00:00到目前经历的秒数      |<br>| %S    | 显示秒（00</del>59）                      |<br>| %T    | 显示时间，24小时制（hh:mm:ss）            |<br>| %X    | 显示时间的格式（%H:%M:%S）               |<br>| %Z    | 显示时区，日期域（CST）                   |<br>| %a    | 星期的简称（Sun<del>Sat）                  |<br>| %A    | 星期的全称（Sunday</del>Saturday）          |<br>| %h,%b | 月的简称（Jan<del>Dec）                   |<br>| %B    | 月的全称（January</del>December）          |<br>| %c    | 日期和时间（Tue Nov 20 14:12:58 2012） |<br>| %d    | 一个月的第几天（01<del>31）                  |<br>| %x,%D | 日期（mm/dd/yy）                    |<br>| %j    | 一年的第几天（001</del>366）                 |<br>| %m    | 月份（01<del>12）                       |<br>| %w    | 一个星期的第几天（0代表星期天）                |<br>| %W    | 一年的第几个星期（00</del>53，星期一为第一天）         |<br>| %y    | 年的最后两个数字（1999则是99）              |<br>| %Y    | 年1999                           |</p><h4 id="date-实验"><a href="#date-实验" class="headerlink" title="date 实验"></a>date 实验</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">格式化输出</span><br><span class="line">[booboo@rhel7 ~]$ date +"%y/%m/%d"</span><br><span class="line">16/06/16</span><br><span class="line">[booboo@rhel7 ~]$ date +"%Y/%m/%d"</span><br><span class="line">2016/06/16</span><br><span class="line">输出昨天或后天的日期</span><br><span class="line">[booboo@rhel7 ~]$ date -d "1 day ago" +"%Y-%m-%d"</span><br><span class="line">2016-06-15</span><br><span class="line">[booboo@rhel7 ~]$ date -d "-1 day" +%Y%m%d</span><br><span class="line">20160615</span><br><span class="line">[booboo@rhel7 ~]$ date -d "+1 day" +%Y%m%d</span><br><span class="line">20160617</span><br><span class="line">输出50秒后的时间</span><br><span class="line">[booboo@rhel7 ~]$ date -d "50 second" +"%Y-%m-%d %H:%M:%S"</span><br><span class="line">2016-06-16 02:52:41</span><br><span class="line">传说中的1234567890秒</span><br><span class="line">[booboo@rhel7 ~]$ date -d "1970-01-01 1234567890 seconds" +"%Y-%m-%d %H:%M:%S"</span><br><span class="line">2009-02-13 23:31:30</span><br><span class="line">2009年2月13日星期五，协调世界时（UTC）晚上11:31:30，UNIX时间将抵达1234567890秒。</span><br><span class="line">UNIX时间是UNIX或类UNIX系统使用的时间表示方式：从协调世界时1970年1月1日0时0分0秒起至现在的总秒数，不包括闰秒。由于大部分UNIX的系统都是32位，因此到2038年时间计数就可能溢出，解决方法是更换为64位模式。Linux内核开发者Alan Cox表示，Linux现在都运行64位时间模式，它可以记录到2900亿年后，因此即使太阳燃料用尽也不会出问题。</span><br><span class="line">普通格式转化</span><br><span class="line">[booboo@rhel7 ~]$ date -d "2016-06-16" +"%Y/%m/%d %H:%M:%S"</span><br><span class="line">2016/06/16 00:00:00</span><br><span class="line">设定时间需要root用户权限，此处用booboo用户模拟，没有真的修改时间</span><br><span class="line">[booboo@rhel7 ~]$ date</span><br><span class="line">Thu Jun 16 03:01:19 EDT 2016</span><br><span class="line">[booboo@rhel7 ~]$ date -s "02:03:08 2018-05-09"</span><br><span class="line">date: cannot set date: Operation not permitted</span><br><span class="line">Wed May  9 02:03:08 EDT 2018</span><br><span class="line">[booboo@rhel7 ~]$ date -s "02:03:08 20180509"</span><br><span class="line">date: cannot set date: Operation not permitted</span><br><span class="line">Wed May  9 02:03:08 EDT 2018</span><br><span class="line">[booboo@rhel7 ~]$ date -s "20180509 15:02:02"</span><br><span class="line">date: cannot set date: Operation not permitted</span><br><span class="line">Wed May  9 15:02:02 EDT 2018</span><br><span class="line">[booboo@rhel7 ~]$ date -s "2018-05-09 15:02:02"</span><br><span class="line">date: cannot set date: Operation not permitted</span><br><span class="line">Wed May  9 15:02:02 EDT 2018</span><br><span class="line">[booboo@rhel7 ~]$ date -s "2019/05/09 15:02:02"</span><br><span class="line">date: cannot set date: Operation not permitted</span><br><span class="line">Thu May  9 15:02:02 EDT 2019</span><br></pre></td></tr></table></figure><h4 id="date-拓展实验"><a href="#date-拓展实验" class="headerlink" title="date 拓展实验"></a>date 拓展实验</h4><p>1) 有时需要检查一组命令花费的时间 比如</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ping执行的时间</span><br><span class="line">[root@rhel7 ~]# vi a.sh</span><br><span class="line">[root@rhel7 ~]# cat a.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">start=$(date +%s)</span><br><span class="line">ping -c 10 172.25.0.11 &amp;&gt; /dev/null</span><br><span class="line">end=$(date +%s)</span><br><span class="line">difference=$(( $end - $start ))</span><br><span class="line">echo $difference seconds.</span><br><span class="line">[root@rhel7 ~]# bash a.sh</span><br><span class="line">9 seconds.</span><br><span class="line">sql脚本运行的是时间</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">start=$(date +%s)</span><br><span class="line"><span class="meta">$</span><span class="bash">mysql&lt; mysql.all.sql &amp;&gt; /dev/null</span></span><br><span class="line">end=$(date +%s)</span><br><span class="line">difference=$(( $end - $start ))</span><br><span class="line">echo $difference seconds.</span><br></pre></td></tr></table></figure><p>2) 创建以当前时间为文件名的目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# mkdir `date +%Y%m%d`</span><br><span class="line">[root@rhel7 ~]# ls</span><br><span class="line">20160616</span><br></pre></td></tr></table></figure><p>3）备份以时间做为文件名的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# tar -cvf `date +%Y%m%d`.tar ./`date +%Y%m%d`</span><br><span class="line">./20160616/</span><br><span class="line">[root@rhel7 ~]# ls</span><br><span class="line">20160616         Documents                         Pictures</span><br><span class="line">20160616.tar</span><br></pre></td></tr></table></figure><p>4）编写shell脚本计算离自己生日还有多少天？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# cat bb.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">read -p "Input your birthday(YYYYmmdd):" date1</span><br><span class="line">m=`date -d "$date1" +%m`    #得到生日的月</span><br><span class="line">d=`date -d "$date1" +%d`    #得到生日的日</span><br><span class="line">date_now=`date +%s`             #得到当前时间的秒值</span><br><span class="line">y=`date +%Y`                    #得到当前时间的年</span><br><span class="line">birth=`date -d "$y$m$d" +%s`      #得到今年的生日日期的秒值</span><br><span class="line">internal=$(($birth-$date_now))        #计算今日到生日日期的间隔时间</span><br><span class="line">if [ "$internal" -lt "0" ]; then             #判断今天的生日是否已过</span><br><span class="line">       birth=`date --date="$(($y+1))$m$d" +%s`      #得到明年的生日日期秒值</span><br><span class="line">       internal=$(($birth-$date_now))               #计算今天到下一个生日的间隔时间</span><br><span class="line">fi</span><br><span class="line">        echo "There is :$(($internal/60/60/24)) days."       #输出结果，秒换算为天</span><br><span class="line">Input your birthday(YYYYmmdd):19960506</span><br><span class="line">There is :323 days.</span><br><span class="line">[root@rhel7 ~]# bash bb.sh</span><br><span class="line">Input your birthday(YYYYmmdd):19960902</span><br><span class="line">There is :77 days.</span><br></pre></td></tr></table></figure><h3 id="hwclock"><a href="#hwclock" class="headerlink" title="hwclock"></a>hwclock</h3><p>hwclock命令是一个硬件时钟访问工具，它可以显示当前时间、设置硬件时钟的时间和设置硬件时钟为系统时间，也可设置系统时间为硬件时钟的时间。 在Linux中有硬件时钟与系统时钟等两种时钟。硬件时钟是指主机板上的时钟设备，也就是通常可在BIOS画面设定的时钟。系统时钟则是指kernel中的时钟。当Linux启动时，系统时钟会去读取硬件时钟的设定，之后系统时钟即独立运作。所有Linux相关指令与函数都是读取系统时钟的设定。</p><p>查看 BIOS 时间</p><p>修改 BIOS 时间</p><p><code>hwclock --systohc</code> 将硬件时间与系统时间同步,以系统为基准</p><p><code>hwclock --hctosys</code> 将系统时间与硬件时间同步,以硬件为基准</p><h3 id="timedatectl"><a href="#timedatectl" class="headerlink" title="timedatectl"></a>timedatectl</h3><p>比 date 多了时区的功能</p><p>rhel6修改时区</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[booboo@rhel7 ~]$ tzselect</span><br><span class="line">Please identify a location so that time zone rules can be set correctly.</span><br><span class="line">Please select a continent or ocean.</span><br><span class="line"> 1) Africa</span><br><span class="line"> 2) Americas</span><br><span class="line"> 3) Antarctica</span><br><span class="line"> 4) Arctic Ocean</span><br><span class="line"> 5) Asia</span><br><span class="line"> 6) Atlantic Ocean</span><br><span class="line"> 7) Australia</span><br><span class="line"> 8) Europe</span><br><span class="line"> 9) Indian Ocean</span><br><span class="line">10) Pacific Ocean</span><br><span class="line">11) none - I want to specify the time zone using the Posix TZ format.</span><br><span class="line">\#? 5</span><br><span class="line">Please select a country.</span><br><span class="line"> 1) Afghanistan  18) Israel    35) Palestine</span><br><span class="line"> 2) Armenia  19) Japan    36) Philippines</span><br><span class="line"> 3) Azerbaijan  20) Jordan    37) Qatar</span><br><span class="line"> 4) Bahrain  21) Kazakhstan    38) Russia</span><br><span class="line"> 5) Bangladesh  22) Korea (North)    39) Saudi Arabia</span><br><span class="line"> 6) Bhutan  23) Korea (South)    40) Singapore</span><br><span class="line"> 7) Brunei  24) Kuwait    41) Sri Lanka</span><br><span class="line"> 8) Cambodia  25) Kyrgyzstan    42) Syria</span><br><span class="line"> 9) China  26) Laos    43) Taiwan</span><br><span class="line">10) Cyprus  27) Lebanon    44) Tajikistan</span><br><span class="line">11) East Timor  28) Macau    45) Thailand</span><br><span class="line">12) Georgia  29) Malaysia    46) Turkmenistan</span><br><span class="line">13) Hong Kong  30) Mongolia    47) United Arab Emirates</span><br><span class="line">14) India  31) Myanmar (Burma)    48) Uzbekistan</span><br><span class="line">15) Indonesia  32) Nepal    49) Vietnam</span><br><span class="line">16) Iran  33) Oman    50) Yemen</span><br><span class="line">17) Iraq  34) Pakistan</span><br><span class="line">\#? 9</span><br><span class="line">Please select one of the following time zone regions.</span><br><span class="line">1) east China - Beijing, Guangdong, Shanghai, etc.</span><br><span class="line">2) Heilongjiang (except Mohe), Jilin</span><br><span class="line">3) central China - Sichuan, Yunnan, Guangxi, Shaanxi, Guizhou, etc.</span><br><span class="line">4) most of Tibet &amp; Xinjiang</span><br><span class="line">5) west Tibet &amp; Xinjiang</span><br><span class="line">\#? 1</span><br><span class="line"></span><br><span class="line">The following information has been given:</span><br><span class="line"></span><br><span class="line">China</span><br><span class="line">east China - Beijing, Guangdong, Shanghai, etc.</span><br><span class="line"></span><br><span class="line">Therefore TZ='Asia/Shanghai' will be used.</span><br><span class="line">Local time is now:Thu Jun 16 15:08:57 CST 2016.</span><br><span class="line">Universal Time is now:Thu Jun 16 07:08:57 UTC 2016.</span><br><span class="line">Is the above information OK?</span><br><span class="line">1) Yes</span><br><span class="line">2) No</span><br><span class="line">\#? 1</span><br><span class="line"></span><br><span class="line">You can make this change permanent for yourself by appending the line</span><br><span class="line">TZ='Asia/Shanghai'; export TZ</span><br><span class="line">to the file '.profile' in your home directory; then log out and log in again.</span><br><span class="line"></span><br><span class="line">Here is that TZ value again, this time on standard output so that you</span><br><span class="line">can use the /bin/tzselect command in shell scripts:</span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure><p>rhel7 版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[kiosk@foundation0 Desktop]$ timedatectl</span><br><span class="line">      Local time: Wed 2016-06-15 16:47:40 CST</span><br><span class="line">  Universal time: Wed 2016-06-15 08:47:40 UTC</span><br><span class="line">        RTC time: Wed 2016-06-15 16:47:40</span><br><span class="line">       Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: yes</span><br><span class="line">      DST active: n/a</span><br></pre></td></tr></table></figure><p>关键词：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">UTC协调世界时 Coordinated Universal Time</span><br><span class="line">又称世界统一时间，世界标准时间，国际协调时间。1972 年1 月1日，UTC（协调世界时）成为新的世界标准时间。</span><br><span class="line">CST时区缩写</span><br><span class="line">CST可以为如下4个不同的时区的缩写：</span><br><span class="line">　　美国中部时间：Central Standard Time (USA) UT-6:00</span><br><span class="line">澳大利亚中部时间：Central Standard Time (Australia) UT+9:30</span><br><span class="line">中国标准时间：China Standard Time UT+8:00 例如，UTC是0点，那么CST中国为早晨8点</span><br><span class="line">古巴标准时间：Cuba Standard Time UT-4:00</span><br><span class="line">RTC Time</span><br><span class="line">硬件时钟时间</span><br><span class="line">set-local-rtc 1 本地时区</span><br><span class="line">set-local-rtc 0UTC</span><br><span class="line">DSTDaylight Saving Time日光节约时间、夏令时</span><br><span class="line">是一种为节约能源而人为规定地方时间的制度，在这一制度实行期间所采用的统一时间称为“夏令时间”。</span><br><span class="line">一般在天亮早的夏季人为将时间提前一小时，可以使人早起早睡，减少照明量，以充分利用光照资源，从而节约照明用电。</span><br><span class="line">各个采纳夏时制的国家具体规定不同。目前全世界有近110个国家每年要实行夏令时。</span><br><span class="line">1986年至1991年，中国在全国范围实行了六年夏令时，1992年4月5日后不再实行。</span><br></pre></td></tr></table></figure><h3 id="cal"><a href="#cal" class="headerlink" title="cal"></a>cal</h3><p>cal命令用于显示当前日历，或者指定日期的日历。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cal [-smjy13] [[[day] month] year]</span><br><span class="line">-1 显示当月日历并将今日标黑</span><br><span class="line">-3 显示上个月、当月、下个月。</span><br><span class="line">-s 周日作为第一列</span><br><span class="line">-m 周一作为第一列</span><br><span class="line">-j 列出今天是一年的第几天</span><br><span class="line">-y 列出今年所有的月</span><br><span class="line">[root@rhel7 ~]# cal</span><br><span class="line">      June 2016     </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">          1  2  3  4</span><br><span class="line"> 5  6  7  8  9 10 11</span><br><span class="line">12 13 14 15 16 17 18</span><br><span class="line">19 20 21 22 23 24 25</span><br><span class="line">26 27 28 29 30</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# cal -3</span><br><span class="line">      May 2016              June 2016             July 2016     </span><br><span class="line">Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa</span><br><span class="line"> 1  2  3  4  5  6  7            1  2  3  4                  1  2</span><br><span class="line"> 8  9 10 11 12 13 14   5  6  7  8  9 10 11   3  4  5  6  7  8  9</span><br><span class="line">15 16 17 18 19 20 21  12 13 14 15 16 17 18  10 11 12 13 14 15 16</span><br><span class="line">22 23 24 25 26 27 28  19 20 21 22 23 24 25  17 18 19 20 21 22 23</span><br><span class="line">29 30 31              26 27 28 29 30        24 25 26 27 28 29 30</span><br><span class="line">                                            31                  </span><br><span class="line">[root@rhel7 ~]# cal -j</span><br><span class="line">         June 2016         </span><br><span class="line">Sun Mon Tue Wed Thu Fri Sat</span><br><span class="line">            153 154 155 156</span><br><span class="line">157 158 159 160 161 162 163</span><br><span class="line">164 165 166 167 168 169 170</span><br><span class="line">171 172 173 174 175 176 177</span><br><span class="line">178 179 180 181 182</span><br></pre></td></tr></table></figure><h2 id="Linux-基础命令作业"><a href="#Linux-基础命令作业" class="headerlink" title="Linux 基础命令作业"></a>Linux 基础命令作业</h2><ol><li>在/tmp 目录下创建 testdir 目录,在该目录下创建 file1 到 file30 的 30 个文件。</li><li>删除所有以 file1 起始的文件。</li><li>删除 file2 后匹配一个字符的所有文件。</li><li>在/home/student 目录下递归创建一个/home/student/a/b/c/d/e 目 录,并且将该 a 目录保留原属性的复制到/tmp 目录下。</li><li>将/tmp 下的 a 目录重命名为 test 目录。</li><li>统计一下/etc/passwd 文件总共有几行。</li><li>在/tmp 下创建一个目录,目录名为 study</li><li>在 study 目录下创建一个文件, 文件名任意, 并向这个文件里写 hello 字段</li><li>往该文件里追加 study 字段。</li><li>查看该文件内容。</li><li>统计一下该文件共有几行,几个单词,几个字节。</li><li>将/etc/passwd 里以 bash 结尾的行过滤出来,并从中截取第一列字<br>段内容。</li><li>统计/boot/下所有文件的属性中含 root 字段的文件共有几个。</li><li>熟悉一下 vim 编辑器,利用 vim 编辑器书写整理一下今天所学的 知识点。</li><li>判断一下 boot 目录下文件的内容类型,并将属于 ASCII 码文件内容 类型的文件名显示到屏幕上</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Linux基础命令&quot;&gt;&lt;a href=&quot;#Linux基础命令&quot; class=&quot;headerlink&quot; title=&quot;Linux基础命令&quot;&gt;&lt;/a&gt;Linux基础命令&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;在教室物理机包括rhel7和rhel6两
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux 用户和组</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/02-Linux%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/02-Linux%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.280Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux用户和组"><a href="#Linux用户和组" class="headerlink" title="Linux用户和组"></a>Linux用户和组</h1><p>[TOC]</p><h2 id="课堂作业"><a href="#课堂作业" class="headerlink" title="课堂作业"></a>课堂作业</h2><ol><li>添加2个组，一个组名为justice，另外一个组名为ninja。</li><li>添加4个新用户，分别为 superman、batman、wonderwoman、greenlantern，密码均为uplooking；其附加组为justice。</li><li>添加4个新用户，分别为 leo、raph、mikey、don ，密码均为uplooking，其附加组为ninja。</li><li>mikey用户总是在系统里搞破坏，root决定封他的号，让他不能登陆。过了几天，再解封。</li><li>leo想加入justice，root同意了，将justice作为附加组添加给leo。</li><li>don整天搞创造，root要求他的密码要更安全，所以将他的密码设置成7天之后要换密码，并且密码过期前3天要提醒他，如果密码过期后2天还没有设置新密码，那么就封锁don账户。</li><li>batman总是喜欢修改密码，没事就在修改密码，而使用该batman账户的人有好几个，比如蝙蝠侠，蝙蝠侠的管家，蝙蝠侠的助手罗宾等等。所以root决定将batman账户的密码的最小存活期改为10天。也就是说10天之内batman账户不能修改密码。</li><li>leo想退出justice,root帮他设置一下。</li><li>superman想把密码改为uplooking123，让他自己改。发现改不了，密码太简单了，自己去想一个复杂的密码。</li><li>让superman能够修改root用户的密码。</li></ol><h2 id="用户和组的相关文件"><a href="#用户和组的相关文件" class="headerlink" title="用户和组的相关文件"></a>用户和组的相关文件</h2><table><thead><tr><th align="left">文件名</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">/etc/passwd</td><td align="left">系统中的账号信息</td></tr><tr><td align="left">etc/shadow</td><td align="left">存放密码及其策略相关信息</td></tr><tr><td align="left">/etc/group</td><td align="left">存放用户组的信息</td></tr><tr><td align="left">/etc/gshadow</td><td align="left">存放用户组的密码及其策略相关信息</td></tr><tr><td align="left">/etc/default/useradd</td><td align="left">创建新用户时默认的配置信息</td></tr><tr><td align="left">/etc/skel/*</td><td align="left">Directory containing default files.</td></tr><tr><td align="left">/etc/login.defs</td><td align="left">用户和组默认的配置信息</td></tr><tr><td align="left">/etc/shells</td><td align="left">该文件记录着合法的 shell 版本</td></tr></tbody></table><h3 id="etc-passwd"><a href="#etc-passwd" class="headerlink" title="/etc/passwd"></a>/etc/passwd</h3><p>每一行都代表一个账号 , 有几行就代表有几个账号在你的系统中</p><p>系统统账号: bin, daemon, adm, nobody</p><p>以“：”作为分隔符,七个字段</p><p><code>root:x:0:0:root:/root:/bin/bash</code> </p><ol><li><p>账号名称 :root</p></li><li><p>密码 :X</p></li><li><p>UID: 使用者标识符<br>rhel6 root_uid=0 sys_uid=1-499 user_uid=500-65535 ( 2^32-1 )<br>rhel7 root_uid=0 sys_uid=201-999 user_uid=1000-65535</p></li><li><p>GID: 用户组标识符 root_guid=0</p></li><li><p>用户信息说明栏 </p></li><li><p>家目录 : 用户的家目录 root 的家目录在 /root, 默认用户的家目录在 /home/yourname</p></li><li><p>Shell: 命令解释器</p><ul><li>系统默认为 /bin/bash</li></ul></li></ol><ul><li>/sbin/nologin 不可通过终端登录系统</li></ul><h3 id="etc-shadow"><a href="#etc-shadow" class="headerlink" title="/etc/shadow"></a>/etc/shadow</h3><p>存放密码及其策略相关信息</p><p>以“：”作为分隔符九个字段</p><p><code>root:$1$/30QpE5e$y9N/D0bh6rAACBEz.hqo00:14126:0:99999:7:::</code></p><ol><li>账号名称 :root</li><li>密码 : 加密后的字符串，以$N$ 开头</li><li>最近变更密码的日期 : 天数,以 1970 年 1 月 1 日作为 1 而累加的日期<br>echo $(($(date –date=”2008/09/04” +%s)/86400+1))<br>14126</li><li>密码不可被更改的天数 :0 : 表示密码随时可以更改， 20 :表示 距最近一次修改密码20 天之内都不能修改密码</li><li>密码需要重新变更的天数 :99999 ( 计算为 273 年 ) 表示密码的变更没有强制性。</li><li>密码需要变更期限前的警告天数 : 在密码到期之前几天提醒</li><li>密码过期后的账号宽限时间 ( 密码失效日 ): 密码过期特性。</li><li>账号失效日期 : 天数，以 1970 年 1 月 1 日作为 1 而累加的日期</li><li>保留 : 保留段</li></ol><h3 id="etc-group"><a href="#etc-group" class="headerlink" title="/etc/group"></a>/etc/group</h3><p>存放用户组的信息</p><p>每一行代表一个群组以“：”作为分隔符四个字段</p><p><code>root:x:0:root</code></p><ol><li>组名 :root</li><li>群组密码 :x 一般不设定,通常是给『群组管理员』使用</li><li>GID: 群组的 ID</li><li>此群组支持的账号名称 : 一个账号可以加入多个群组</li></ol><p>例如,将 dabao 加入 root 群组后 :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:root,dmtsai</span><br></pre></td></tr></table></figure><h3 id="etc-gshadow"><a href="#etc-gshadow" class="headerlink" title="/etc/gshadow"></a>/etc/gshadow</h3><p>存放用户组的密码及其策略相关信息</p><p>每一行代表一个群组 “: ” 作为分隔符四个字段</p><p><code>newgroup:!::redhat</code></p><ol><li>组名 :newgroup</li><li>密码栏 : 开头为 ! 表示无合法密码 , 所以无群组管理员</li><li>群组管理员的账号</li><li>此群组支持的账号名称 : 与 /etc/group 相同</li></ol><h3 id="etc-default-useradd"><a href="#etc-default-useradd" class="headerlink" title="/etc/default/useradd"></a>/etc/default/useradd</h3><p>创建新用户时默认的配置信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GROUP=100 &lt;== 预设的群组，现已不生效，如果创建用户时不指定群组，则使用与用户同名的群组</span><br><span class="line">HOME=/home &lt;== 默认的家目录所在目录</span><br><span class="line">INACTIVE=-1 &lt;== 密码失效日 , 在 shadow 第 7 栏</span><br><span class="line">EXPIRE= &lt;== 账号失效日 , 在 shadow 第 8 栏</span><br><span class="line">SHELL=/bin/bash &lt;== 预设的 shell /sbin/nologin 将无法登陆</span><br><span class="line">SKEL=/etc/skel&lt;== 用户家目录的内容数据参考目录</span><br><span class="line">CREATE_MAIL_SPOOL=yes &lt;== 是否主动帮助使用者建立邮件信箱 (mailbox)</span><br></pre></td></tr></table></figure><h3 id="etc-skel"><a href="#etc-skel" class="headerlink" title="/etc/skel/"></a>/etc/skel/</h3><p>Directory containing default files.</p><p>.bash_logout .bash_profile .bashrc .gnome2 .mozilla</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 skel]# ll -a /etc/skel</span><br><span class="line">total 40</span><br><span class="line">drwxr-xr-x. 4 root root 4096 Jan 2 01:58 .</span><br><span class="line">drwxr-xr-x. 125 root root 12288 Mar 21 03:09 ..</span><br><span class="line">-rw-r--r--. 1 root root 18 Jul 9 2013 .bash_logout</span><br><span class="line">-rw-r--r--. 1 root root 176 Jul 9 2013 .bash_profile</span><br><span class="line">-rw-r--r--. 1 root root 124 Jul 9 2013 .bashrc</span><br><span class="line">-rw-r--r--. 1 root root 500 May 7 2013 .emacs</span><br><span class="line">drwxr-xr-x. 2 root root 4096 Jul 14 2010 .gnome2</span><br><span class="line">drwxr-xr-x. 4 root root 4096 Jan 2 01:52 .mozilla</span><br></pre></td></tr></table></figure><h3 id="etc-login-defs"><a href="#etc-login-defs" class="headerlink" title="/etc/login.defs"></a>/etc/login.defs</h3><p>默认的配置信息 rhel6 下的信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MAIL_DIR           /var/spool/mail 用户默认邮件信箱放置目录</span><br><span class="line">PASS_MAX_DAYS      99999 /etc/shadow 第 5 栏 , 密码需要重新变更的天数</span><br><span class="line">PASS_MIN_DAYS      0 /etc/shadow 第 4 栏 , 密码不可被更动的天数</span><br><span class="line">PASS_MIN_LEN       5 密码最短的字符长度 , 已被 pam 模块取代 , 失去效用 !</span><br><span class="line">PASS_WARN_AGE      7 /etc/shadow 第 6 栏 , 过期前会警告天数</span><br><span class="line">UID_MIN            500 使用者最小的 UID 不能 &lt;500</span><br><span class="line">UID_MAX            60000  使用者最大的 UID 不能 &gt;60000</span><br><span class="line">GID_MIN            500  自定义组最小的 UID 不能 &lt;500</span><br><span class="line">GID_MAX            60000  自定义组最大的 UID 不能 &gt;60000</span><br><span class="line">CREATE_HOME     yes  在 username 命令不加 -M 及 -m 时 , 是否主动建立用户家目录</span><br><span class="line">UMASK        077  用户家目录建立的 umask , 因此权限会是 700 『 drwx------ 』</span><br><span class="line">USERGROUPS_ENAB  yes  使用 userdel 时 , 是否会删除初始群组(如果使用 userdel 去删除一个账号时 , 该账号所属的初始群组已经没有人隶属于该群组了 , 那举就删掉该群组)</span><br><span class="line">ENCRYPT_METHOD    SHA512  经过 SHA512 进行加密处理</span><br></pre></td></tr></table></figure><h3 id="etc-shells"><a href="#etc-shells" class="headerlink" title="/etc/shells"></a>/etc/shells</h3><p>该文件记录着合法的 shell 版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 skel]# cat /etc/shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/bin/dash</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br></pre></td></tr></table></figure><h2 id="用户和组的相关命令"><a href="#用户和组的相关命令" class="headerlink" title="用户和组的相关命令"></a>用户和组的相关命令</h2><table><thead><tr><th align="left">用户和组</th><th align="left"></th></tr></thead><tbody><tr><td align="left">新建组</td><td align="left">groupadd</td></tr><tr><td align="left">新建用户</td><td align="left">useradd</td></tr><tr><td align="left">修改密码</td><td align="left">passwd 密码 &gt;8 位字符、小写 / 大写 / 数字 / 特殊符号之间任选 3 位</td></tr><tr><td align="left">修改用户属性</td><td align="left">usermod</td></tr><tr><td align="left">修改组属性</td><td align="left">groupmod</td></tr><tr><td align="left">修改密码属性</td><td align="left">chage</td></tr><tr><td align="left">修改 shell</td><td align="left">chsh</td></tr><tr><td align="left">删除用户</td><td align="left">userdel</td></tr><tr><td align="left">删除组</td><td align="left">groupdel</td></tr><tr><td align="left">查看已存在用户的基本信息</td><td align="left">id</td></tr><tr><td align="left">查看当前用户支持的群组信息</td><td align="left">groups</td></tr></tbody></table><p>通过文件查看</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd</span><br><span class="line">/etc/shadow</span><br><span class="line">/etc/group</span><br><span class="line">/etc/gshadow</span><br></pre></td></tr></table></figure><h3 id="新建用户和组"><a href="#新建用户和组" class="headerlink" title="新建用户和组"></a>新建用户和组</h3><h4 id="groupadd"><a href="#groupadd" class="headerlink" title="groupadd"></a>groupadd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">groupadd 创建组</span><br><span class="line">-g, --gid GID</span><br><span class="line">-r, --system  Create a system group</span><br><span class="line"></span><br><span class="line"> 新建组 test 制定 gid 为 888</span><br><span class="line">[root@rhel7 ~]# groupadd -g 888 test</span><br><span class="line"> 新建一个系统组 baby</span><br><span class="line">[root@rhel7 ~]# groupadd -r baby</span><br><span class="line"> 查看一下刚刚新建的组的信息</span><br><span class="line">[root@rhel7 ~]# tail -n 2 /etc/group</span><br><span class="line">test:x:888:</span><br><span class="line">baby:x:490:</span><br></pre></td></tr></table></figure><h4 id="useradd"><a href="#useradd" class="headerlink" title="useradd"></a>useradd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建新用户</span><br><span class="line">useradd [-u UID] [-g 初始群组 ] [-G 次要群组 ] [-mM] [-c 说明栏 ] [-d 家目录绝对路径 ] [-s shell] 账号名</span><br><span class="line">拓展: -e : 接日期『 YYYY-MM-DD 』 shadow 第八字段账号失效日期</span><br><span class="line"> -f : 接天数 shadow 第七字段密码失效日 0 :立刻失效 -1 :永不失效</span><br><span class="line">失效后可登陆,但是会强制你重新设置密码</span><br><span class="line">[root@rhel7 ~]# useradd -u 888 -g 888 -f 0 -e 2016-03-21 t1</span><br><span class="line">[root@rhel7 ~]# id t1</span><br><span class="line">uid=888(t1) gid=888(test) groups=888(test)</span><br><span class="line">[root@rhel7 ~]# tail -n 1 /etc/passwd</span><br><span class="line">t1:x:888:888::/home/t1:/bin/bash</span><br><span class="line">[root@rhel7 ~]# tail -n 1 /etc/shadow</span><br><span class="line">t1:!!:16880:0:99999:7:0:16881:</span><br></pre></td></tr></table></figure><h4 id="passwd"><a href="#passwd" class="headerlink" title="passwd"></a>passwd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">给用户设置密码</span><br><span class="line">passwd [--sdtin] &lt;&#x3D;&#x3D; 所有人均可使用更改自己的密码</span><br><span class="line">passwd [-l] [-u] [--sdtin] [-S] [-n 日数 ] [-x 日数 ] [-w 日数 ] [-i 日期 ] 账号 &lt;&#x3D;&#x3D;root 功能</span><br><span class="line">选项与参数 :</span><br><span class="line">--stdin : 可以透过来自前一个管线的数据 , 作为密码输入 echo 123 | passwd --stdin dabao</span><br><span class="line">-l : 是 Lock 的缩写 , 会将 &#x2F;etc&#x2F;shadow 第二栏最前面加上 ! 使密码失效</span><br><span class="line">-u : 与 -l 相对 , 是 Unlock 的缩写</span><br><span class="line">-S : 列出密码相关参数 shadow 大部分信息。</span><br><span class="line">-n : 后面接天数 ,shadow 第 4 字段 , 密码不可被更动的天数</span><br><span class="line">-x : 后面接天数 ,shadow 第 5 字段 , 密码需要重新变更的天数</span><br><span class="line">-w : 后面接天数 ,shadow 第 6 字段 , 密码需要变更期限前的警告天数</span><br><span class="line">-i : 后面接天数 ,shadow 第 7 字段 , 密码失效日期</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# passwd t1</span><br><span class="line">Changing password for user t1.</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: it is based on a dictionary word</span><br><span class="line">Retype new password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line"> 设置密码失效日期为 7 天</span><br><span class="line">[root@rhel7 ~]# passwd -i 7 t1</span><br><span class="line">Adjusting aging data for user t1.</span><br><span class="line">passwd: Success</span><br><span class="line"></span><br><span class="line"> 查看记录用户密码属性的文件 /etc/shadow ,截取 t1 用户的那一行</span><br><span class="line">[root@rhel7 ~]# sed -n '/t1/p' /etc/shadow</span><br><span class="line">t1:$6$TDnycU/C$0AmM5AoZmoHZQMex.dQCoroH2JxdSnDhLnBMorcUPlWgshYrlstZJmH.Q.fT</span><br><span class="line">OTV.pECGEuqFqugj8YccRqcdD/:16880:0:99999:7:7:16881:</span><br><span class="line"></span><br><span class="line"> 截取 t1 用户密码属性,以 : 为分割的第 7 字段</span><br><span class="line">[root@rhel7 ~]# sed -n '/t1/p' /etc/shadow|cut -d":" -f 7</span><br><span class="line">7</span><br><span class="line">[root@rhel7 ~]# sed -n '/t1/p' /etc/shadow|awk -F: '&#123;print 7&#125;'</span><br><span class="line">7</span><br></pre></td></tr></table></figure><h3 id="修改用户和组属性"><a href="#修改用户和组属性" class="headerlink" title="修改用户和组属性"></a>修改用户和组属性</h3><h4 id="groupmod"><a href="#groupmod" class="headerlink" title="groupmod"></a>groupmod</h4><p>修改组属性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">groupmod -g gid [gname] 修改 gid</span><br><span class="line">groupmod -n new_gname [gname] 修改组的名字</span><br><span class="line">[root@rhel7 ~]# groupmod -g 999 test</span><br><span class="line">[root@rhel7 ~]# grep test /etc/group</span><br><span class="line">test:x:999:</span><br><span class="line">[root@rhel7 ~]# groupmod -n test1 test</span><br><span class="line">[root@rhel7 ~]# grep test /etc/group</span><br><span class="line">test1:x:999:</span><br></pre></td></tr></table></figure><h4 id="usermod"><a href="#usermod" class="headerlink" title="usermod"></a>usermod</h4><p>修改用户属性</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">usermod [-cdegGlsuLU] username</span><br><span class="line">选项不参数 :</span><br><span class="line">-c : 后面接账号的说明 修改 &#x2F;etc&#x2F;passwd 第 5 字段</span><br><span class="line">-d : 后面接账号的家目录 修改 &#x2F;etc&#x2F;passwd 第 6 字段</span><br><span class="line">-e : 后面接日期 , 格式是 YYYY-MM-DD 修改 shadow 第 8 字段 ( 账号失效日 )</span><br><span class="line">-f : 后面接天数 修改 shadow 第 7 字段 ( 密码失效日期 )</span><br><span class="line">-g : 后面接初始群组 修改 &#x2F;etc&#x2F;passwd 第 4 字段 GID</span><br><span class="line">-G : 后面接次要群组 , 修改这个使用者能够支持的群组 修改 &#x2F;etc&#x2F;group</span><br><span class="line">-aG : 『增加次要群组的支持』而非『设定』</span><br><span class="line">-l : 后面接账号名称 修改账号名称 修改 &#x2F;etc&#x2F;passwd 第 1 字段</span><br><span class="line">-s : 后面接 Shell 的实际档案 , 例如 &#x2F;bin&#x2F;bash &#x2F;bin&#x2F;csh 等等</span><br><span class="line">-u : 后面接 UID 数字啦 ! 卲 &#x2F;etc&#x2F;passwd 第三栏的资料 ;</span><br><span class="line">-L : 暂时将用户的密码冻结 , 让他无法登入。修改 &#x2F;etc&#x2F;shadow 密码栏</span><br><span class="line">-U : 将 &#x2F;etc&#x2F;shadow 密码栏的 ! 拿掉 , 解冻</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# usermod -g test2 -G test3 t1</span><br><span class="line">[root@rhel7 ~]# id t1</span><br><span class="line">uid=888(t1) gid=1000(test2) groups=1000(test2),1001(test3)</span><br><span class="line">[root@rhel7 ~]# usermod -s /sbin/nologin t1</span><br><span class="line">[root@rhel7 ~]# grep t1 /etc/passwd</span><br><span class="line">t1:x:888:1000::/home/t1:/sbin/nologin</span><br><span class="line">[root@rhel7 ~]# su - t1</span><br><span class="line">This account is currently not available.</span><br></pre></td></tr></table></figure><h4 id="chage"><a href="#chage" class="headerlink" title="chage"></a>chage</h4><p>修改用户密码属性</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chage [-ldEImMW] 账号名</span><br><span class="line">选项与参数 :</span><br><span class="line">-l : 列出该账号的详细密码参数 ;</span><br><span class="line">-d : 后面接日期 , 修改 shadow 第 3 字段 ( 最近一次更改密码的日期 ), 格式 YYYY-MM-DD</span><br><span class="line">-m : 后面接天数 , 修改 shadow 第 4 字段 ( 密码不可被更动的天数 )</span><br><span class="line">-M : 后面接天数 , 修改 shadow 第 5 字段 ( 密码需要重新变更的天数 )</span><br><span class="line">-W : 后面接天数 , 修改 shadow 第 6 字段 ( 密码需要变更期限前的警告天数 )</span><br><span class="line">-I : 后面接天数 , 修改 shadow 第 7 字段 ( 密码失效日期 )</span><br><span class="line">-E : 后面接日期 , 修改 shadow 第 8 字段 ( 账号失效日 ), 格式 YYYY-MM-DD</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# chage t1</span><br><span class="line">Changing the aging information for t1</span><br><span class="line">Enter the new value, or press ENTER for the default</span><br><span class="line">Minimum Password Age [0]:</span><br><span class="line">Maximum Password Age [99999]:</span><br><span class="line">Last Password Change (YYYY-MM-DD) [2016-03-20]:</span><br><span class="line">Password Expiration Warning [7]:</span><br><span class="line">Password Inactive [7]:</span><br><span class="line">Account Expiration Date (YYYY-MM-DD) [2016-03-21]:</span><br></pre></td></tr></table></figure><h4 id="chsh"><a href="#chsh" class="headerlink" title="chsh"></a>chsh</h4><p>change shell 的简写</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chsh [-ls]</span><br><span class="line">选项与参数 :</span><br><span class="line">-l : 列出目前系统上面可用的 shell /etc/shells 里内容</span><br><span class="line">-s : 修改自己的 Shell</span><br><span class="line">[root@rhel7 ~]# chsh -s /bin/bash t1</span><br><span class="line">Changing shell for t1.</span><br><span class="line">Shell changed.</span><br><span class="line">[root@rhel7 ~]# grep t1 /etc/passwd</span><br><span class="line">t1:x:888:1000::/home/t1:/bin/bash</span><br></pre></td></tr></table></figure><h3 id="删除用户和组"><a href="#删除用户和组" class="headerlink" title="删除用户和组"></a>删除用户和组</h3><h4 id="groupdel"><a href="#groupdel" class="headerlink" title="groupdel"></a>groupdel</h4><p>删除组</p><p>groupdel groupname</p><h4 id="userdel"><a href="#userdel" class="headerlink" title="userdel"></a>userdel</h4><p>删除用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">userdel [-r] username</span><br><span class="line">选项不参数 :</span><br><span class="line">-r 没有这个选项删除会不彻底,关于用户的目录、文档全部删除</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# tail -3 /etc/group</span><br><span class="line">test:x:999:</span><br><span class="line">test2:x:1000:</span><br><span class="line">test3:x:1001:t1</span><br><span class="line">[root@rhel7 ~]# groupdel test3</span><br><span class="line">[root@rhel7 ~]# tail -3 /etc/group</span><br><span class="line">baby:x:490:</span><br><span class="line">test:x:999:</span><br><span class="line">test2:x:1000:</span><br><span class="line">[root@rhel7 ~]# userdel -r t1</span><br><span class="line">[root@rhel7 ~]# ll /home</span><br><span class="line">total 12</span><br><span class="line">drwx------. 27 cong cong 4096 Jan 1 18:40 cong</span><br><span class="line">drwx------. 4 g2</span><br><span class="line">888 4096 Mar 21 03:56 g2</span><br><span class="line">drwx------. 12 tom tom 4096 Mar 21 02:14 tom</span><br></pre></td></tr></table></figure><h3 id="查看用户和组信息"><a href="#查看用户和组信息" class="headerlink" title="查看用户和组信息"></a>查看用户和组信息</h3><h4 id="id"><a href="#id" class="headerlink" title="id"></a>id</h4><p>查看已存在用户的基本信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# id root</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">[root@rhel7 ~]# id -g root</span><br><span class="line">0</span><br><span class="line">[root@rhel7 ~]# id -u root</span><br><span class="line">0</span><br></pre></td></tr></table></figure><h4 id="groups"><a href="#groups" class="headerlink" title="groups"></a>groups</h4><p>查看当前用户支持的群组信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# groups</span><br><span class="line">root</span><br></pre></td></tr></table></figure><p>思考题: root 和普通用户都可以修改 /etc/passwd 文档,那么这个文档的权限是什么呢?<br>SUID</p><h2 id="用户身份切换-sudo-su"><a href="#用户身份切换-sudo-su" class="headerlink" title="用户身份切换 sudo / su"></a>用户身份切换 sudo / su</h2><h3 id="su"><a href="#su" class="headerlink" title="su"></a>su</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su [-lm] [-c 指令 ] [username]</span><br><span class="line">选项与参数 :</span><br><span class="line">- : 单纯使用 - 如『 su - 』 以 login-shell 变量档案读取方式登入系统 ; 默认切换为 root</span><br><span class="line">-l : 与 - 类似 login-shell</span><br><span class="line">-m :-m 与 -p 一样 , 表示『使用目前的环境设定 , 而不读取新使用者的配置文件』</span><br><span class="line">-c : 接指令</span><br></pre></td></tr></table></figure><p>总结:</p><ol><li>su - username 或 su -l username<br>完整切换成新使用者的环境 用 env 查看环境变量<br>PATH/USER/MAIL</li><li>su - -c “ 指令 “<br>仅想要执行一次 root 的指令</li><li>使用 root 切换成为任何使用者时 , 不需要输入新用户密码</li><li>缺点:当主机多人管理时, su 切换成 root ,那每个人都需要知道 root 密码,不安全。</li></ol><h3 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h3><p>sudo [-u user name | #uid] [command]</p><h4 id="sudo-执行流程"><a href="#sudo-执行流程" class="headerlink" title="sudo 执行流程"></a>sudo 执行流程</h4><ol><li>在 /etc/sudoers 档案中查看 user 是否有 sudo 执行权限</li><li>若有 sudo 执行权限 , 『输入用户的密码』</li><li>密码正确 , 开始执行 sudo 后续接的指令</li><li>root 无需密码,自己切换自己也无需密码</li></ol><h4 id="添加用户-sudo-执行权限的方法"><a href="#添加用户-sudo-执行权限的方法" class="headerlink" title="添加用户 sudo 执行权限的方法"></a>添加用户 sudo 执行权限的方法</h4><p>(如何让用户可以使用 sudo ?)</p><ol><li>visudo 可以让系统检验 /etc/sudoers 的语法是否正确</li><li>修改 /etc/sudoers 中的语法</li></ol><p>1 )单一用户可使用 root 所有指令或某些指令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root ALL=(ALL) ALL &lt;== 找到这一行 ,rh6 在 98 行</span><br><span class="line">username ALL=(ALL) ALL &lt;== 新增这一行</span><br><span class="line">username ALL=(root) /bin/touch&lt;== 新增这一行</span><br></pre></td></tr></table></figure><p>语法解释:</p><p>使用者账号 登入者的来源主机名 =( 可切换的身份 )     可下达的指令</p><p>root             ALL=(ALL)                 ALL &lt;== 这是默认值</p><ol><li>使用者帐号:系统哪个帐号可以使用 sudo</li><li>登入者的来源主机名:信任用户 默认 root 可来自任何一部网络主机</li><li>可切换的身份:该账号可以切换成谁来下命令 , 末日 root 可以切换成任何人</li><li>可下达的指令:可用该身份下达什么指令。必需使用绝对路径 ( 可通过 which\whereis 查询 )</li><li>ALL : 是特殊关键词 , 代表任何身份、任何主机、任何命令</li></ol><p>2 )群组和免密码的功能处理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash">wheel ALL=(ALL) ALL&lt;== 找到这一行 ,rh6 在 105 行</span></span><br><span class="line"><span class="meta">%</span><span class="bash">wheel ALL=(ALL) NOPASSWD: ALL&lt;== 找到这一行 ,rh6 在 108 行</span></span><br></pre></td></tr></table></figure><p>语法解释:</p><ol><li>% 接群组</li><li>wheel 群组内的用户有使用 sudo 的权限,并可以切换成任何人,执行切换后身份的任何命令</li><li>wheel 群组内的用户切换用户时不需要输入自己的密码</li></ol><p>3）有限的权限操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dabao ALL=(root) /usr/bin/passwd &lt;== 有 bug , dabao 能修改 root 密码</span><br><span class="line">dabao ALL=(root) !/usr/bin/passwd, /usr/bin/passwd [A-Za-z]*,!/usr/bin/passwd root&lt;== 可以执</span><br><span class="line">行『 passwd 任意字符』 , 但是『 passwd 』和『 passwd root 』这两个命令不可执行</span><br></pre></td></tr></table></figure><p>4 )别名设置 visudo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User_Alias DABAO=dabao,jerry,tom,g1,g2,g3</span><br><span class="line">Cmnd_Alias DABAOCOM = !/usr/bin/passwd,/usr/bin/passwd [A-Za-z]*,!/usr/bin/passwd root</span><br><span class="line">DABAO ALL=(root) DABAOCOM</span><br></pre></td></tr></table></figure><p>5) sudo 搭配 su 使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(root) /bin/su -</span><br><span class="line">sudo su - &lt;==sudo -u root su -l root</span><br></pre></td></tr></table></figure><p>可以直接切换成 root 用户,而且不需要输入 root 密码</p><p>6 ) 5 分钟内可以不用再输入密码。</p><h2 id="Linux用户和组课后作业"><a href="#Linux用户和组课后作业" class="headerlink" title="Linux用户和组课后作业"></a>Linux用户和组课后作业</h2><ol><li>新建一个用户名为 redhat。密码为 password ，配置以下信息,以达到要求:</li></ol><ul><li>密码的最小存活期为:1 天</li><li>密码的最大存活期为:10 天</li><li>密码过期前 5 天提醒</li><li>密码过期后如 15 天仍未设置新密码,则封锁该帐户。</li></ul><ol><li>创建一个新组 newgroup、将 redhat 以附加组成员的身份加入 到 newgroup 中。</li><li>添加 3 个用户,用户 harry,natasha,tom,和一个组 ,组名为 admin 组 ，<br>要求 ：</li></ol><ul><li>harry,natasha 用户的附加组为 admin 组；</li><li>tom 用户的登陆 shell 为非交互式 shell；</li><li>用户密码都为 uplooking</li></ul><ol><li>使用 harry 用户登陆系统,尝试修改自己的密码,密码自己设 定。</li><li>创建一个叫做 alex 用户,用户 uid 为 1234,不能登陆系统。</li><li>以 root 用户身份给 natasha 用户修改密码,密码修改为 abc12345。</li><li>给 tom 用户追加附加组,追加的附加组为 alex,同时给 tom 用户修改 uid,修改为 2222。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Linux用户和组&quot;&gt;&lt;a href=&quot;#Linux用户和组&quot; class=&quot;headerlink&quot; title=&quot;Linux用户和组&quot;&gt;&lt;/a&gt;Linux用户和组&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;课堂作业&quot;&gt;&lt;a href=&quot;#课堂作业&quot; cl
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件和目录</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/03-Linux%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/03-Linux%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.316Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux-文件和目录"><a href="#Linux-文件和目录" class="headerlink" title="Linux 文件和目录"></a>Linux 文件和目录</h1><p>[TOC]</p><h2 id="Linux-目录"><a href="#Linux-目录" class="headerlink" title="Linux 目录"></a>Linux 目录</h2><h3 id="Linux-目录配置的依据-–FHS"><a href="#Linux-目录配置的依据-–FHS" class="headerlink" title="Linux 目录配置的依据 –FHS"></a>Linux 目录配置的依据 –FHS</h3><p>因为利用 Linux 来开发产品或 distributions 的社区 / 公司或个人实在太多了 , 如果每个人都用自己的想法来配置文件放置的目录 , 那将可能造成很多管理上的困扰。 你能想象 , 你进入一个企业之后 , 所 接触到的 Linux 目录配置方法竟然跟你以前学的完全不同吗 ? 很难想象吧 ~ 所以 , 后来就有所谓的Filesystem Hierarchy Standard (FHS) 标准的出炉了 !</p><p>根据 FHS(<a href="http://www.pathname.com/fhs/" target="_blank" rel="noopener">http://www.pathname.com/fhs/</a>) 的官方文件指出 , 他们的主要目的是希望让使用者可以了解到已安装软件通常放置在哪个目录下 , 所以他们希望独立的软件开发商、操作系统制作者、以及想要维护系统的用户 , 都能够遵循 FHS 的标准。 也就是说 ,FHS 的重点在于规范每个特定的目录下应该存放什么样子的数据而已。</p><p>亊实上 ,FHS 是根据过去的经验一直再持续的改版的 ,FHS 依据文件系统使用的频繁与否允许使用者随意更动 , 而将目录定义成为四种交互作用的形态 , 用表格来说有点像底下这样 ：</p><table><thead><tr><th align="left"></th><th align="left">可分享的 (shareable)</th><th align="left">不可分享的 (unshareable)</th></tr></thead><tbody><tr><td align="left">不变的 (static)</td><td align="left">/usr ( 软件放置处 )</td><td align="left">/etc ( 配置文件 )</td></tr><tr><td align="left"></td><td align="left">/opt ( 第三方协力软件 )</td><td align="left">/boot ( 开机不核心档 )</td></tr><tr><td align="left">可变动的 (variable)</td><td align="left">/var/mail ( 使用者邮件信箱 )</td><td align="left">/var/run ( 程序相关 )</td></tr><tr><td align="left"></td><td align="left">/var/spool/news ( 新闻组 )</td><td align="left">/var/lock ( 程序相关 )</td></tr></tbody></table><p><img src="pic/02.png" alt="02"></p><h3 id="目录树"><a href="#目录树" class="headerlink" title="目录树"></a>目录树</h3><p>在类 Unix 系统中并不存在 C/D/E/F 盘符,一切的文件都是从 “ 根 (/)” 目录开始的并按照文件系统目录标准 FHS 采用树形结构来存放文件并定义了每个区域的用途。</p><p>目录名称严格的区分大小写,例如 root 、 rOOt 、 Root 、 rooT 等等均代表是不同的独立目录,并且名称中不得包含反斜杠 (/) 。</p><p><img src="pic/04.png" alt="04"></p><p>主要常见的目录定义:</p><table><thead><tr><th align="left">目录名称</th><th align="left">应放置文件的内容</th></tr></thead><tbody><tr><td align="left">/boot</td><td align="left">开机所需文件 —— 内核,开机菜单及所需配置文件等</td></tr><tr><td align="left">/dev</td><td align="left">任何设备与接口都以文件形式存放在此目录</td></tr><tr><td align="left">/etc</td><td align="left">配置文件</td></tr><tr><td align="left">/home</td><td align="left">用户主目录</td></tr><tr><td align="left">/bin</td><td align="left">单用户维护模式下还能够被操作的命令</td></tr><tr><td align="left">/lib</td><td align="left">开机时用到的函数库及/bin 与/sbin 下面命令要调用的函数</td></tr><tr><td align="left">/sbin</td><td align="left">开机过程中需要的</td></tr><tr><td align="left">/media</td><td align="left">一般挂载或删除的设备</td></tr><tr><td align="left">/opt</td><td align="left">放置第三方的软件</td></tr><tr><td align="left">/root</td><td align="left">系统管理员的主文件夹</td></tr><tr><td align="left">/srv</td><td align="left">一些网络服务的数据目录</td></tr><tr><td align="left">/tmp</td><td align="left">任何人均可使用的 “ 共享 ” 临时目录</td></tr><tr><td align="left">/proc</td><td align="left">虚拟文件系统,例如系统内核,进程,外部设备及网络状态等</td></tr><tr><td align="left">/usr/local</td><td align="left">用户自行安装的软件</td></tr><tr><td align="left">/usr/sbin</td><td align="left">非系统开机时需要的软件/命令/脚本</td></tr><tr><td align="left">/usr/share</td><td align="left">帮助与说明文件,也可放置共享文件。</td></tr><tr><td align="left">/var</td><td align="left">主要存放经常变化的文件,如日志。</td></tr><tr><td align="left">/lost+found</td><td align="left">当文件系统发生错误时,将一些丢失的文件片段存放在这里1.3 路径</td></tr></tbody></table><p>另外一个重要的概念 “ 路径 ” ,这个路径指的是如何找到某个文件,分为 “ 绝对路径 ” 与 “ 相对路径 ” :</p><ul><li>绝对路径 (absolute): 由根目录 (/) 开始写起的目录或文件名</li><li>相对路径 (relative): 相对于当前路径的写法</li></ul><p>举例来说一个客人想找下厕所,你有两种回答的方法。</p><ul><li>绝对路径:首先坐车来到你家,到了你家后，右手边第一个房间就是厕所。</li><li>相对路径:前面右拐第一个房间。</li></ul><p>如果你说的是绝对路径,那么任何客人都可以按照这个提示找到你家的厕所,但缺点是过于繁琐,如果说的是相对路径,那么这个人并不是在每个路口右转都能找到厕所,缺点是不具备普遍性。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@rhel7 network-scripts]# pwd</span><br><span class="line">/etc/sysconfig/network-scripts</span><br><span class="line">[root@rhel7 network-scripts]# cd ../modules</span><br><span class="line">[root@rhel7 modules]# pwd</span><br><span class="line">/etc/sysconfig/modules</span><br></pre></td></tr></table></figure><h2 id="文件属性"><a href="#文件属性" class="headerlink" title="文件属性"></a>文件属性</h2><p>类 Unix 系统的设计初衷就是为让多用户同时工作,所以也迫使 Linux 系统有了极强的安全性。接下来我们一起来看看 linux 系统示如何实现安全性的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# ll /</span><br><span class="line">total 4148</span><br><span class="line">lrwxrwxrwx.   1 root root        7 May  5 17:28 bin -&gt; usr/bin</span><br><span class="line">dr-xr-xr-x.   4 root root     4096 May  5 17:40 boot</span><br><span class="line">drwxr-xr-x.  15 root root     4096 Aug 19 13:19 content</span><br><span class="line">-rw-------    1 root root  2166784 Aug  8 05:24 core.2052</span><br><span class="line">-rw-------    1 root root 19017728 Aug  8 05:27 core.2488</span><br><span class="line">drwxr-xr-x   19 root root     3380 Oct 26 12:22 dev</span><br><span class="line">drwxr-xr-x. 138 root root    12288 Oct 26 12:22 etc</span><br><span class="line">drwxr-xr-x.   4 root root       31 Aug 23 17:32 home</span><br><span class="line">lrwxrwxrwx.   1 root root        7 May  5 17:28 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root        9 May  5 17:28 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x.   2 root root        6 May 25  2015 media</span><br><span class="line">drwxr-xr-x.   2 root root        6 May 25  2015 mnt</span><br><span class="line">drwxr-xr-x.   4 root root       36 May  6 13:19 opt</span><br><span class="line">dr-xr-xr-x  229 root root        0 Oct 26  2016 proc</span><br><span class="line">dr-xr-x---.  26 root root     4096 Oct 12 14:11 root</span><br><span class="line">drwxr-xr-x   39 root root     1200 Oct 26 12:24 run</span><br><span class="line">lrwxrwxrwx.   1 root root        8 May  5 17:28 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root        6 May 25  2015 srv</span><br><span class="line">dr-xr-xr-x   13 root root        0 Oct 26  2016 sys</span><br><span class="line">drwxrwxrwt.  31 root root     4096 Oct 26 12:42 tmp</span><br><span class="line">drwxr-xr-x.  13 root root     4096 May  5 17:28 usr</span><br><span class="line">drwxr-xr-x.  23 root root     4096 Oct 26  2016 var</span><br></pre></td></tr></table></figure><p>第二字段,文件硬链接数或目录子目录数</p><h3 id="文件的分类"><a href="#文件的分类" class="headerlink" title="文件的分类"></a>文件的分类</h3><table><thead><tr><th align="left">文件</th><th align="left"></th><th align="left">操作</th></tr></thead><tbody><tr><td align="left">普通文件</td><td align="left">纯文本档 (ASCII)</td><td align="left">touch file</td></tr><tr><td align="left"></td><td align="left">二进制文件 (binary)</td><td align="left"></td></tr><tr><td align="left"></td><td align="left">数据格式文件 (data)</td><td align="left"></td></tr><tr><td align="left">目录</td><td align="left">(directory)</td><td align="left">mkdir dire</td></tr><tr><td align="left">连结档</td><td align="left">(link)</td><td align="left">ln file hfile</td></tr><tr><td align="left"></td><td align="left"></td><td align="left">ln -s file sfile</td></tr><tr><td align="left"></td><td align="left"></td><td align="left">ln -s ‘pwd’/file ssfile 绝对路径的软链接文件</td></tr><tr><td align="left">设备与装置文件</td><td align="left">(device)</td><td align="left">mknod bfile b 252 0 块设备</td></tr><tr><td align="left"></td><td align="left"></td><td align="left">mknod cfile c 4 2 字符设备</td></tr><tr><td align="left">数据输送文件</td><td align="left">(FIFO, pipe)</td><td align="left">mkfifo pfile 管道文件</td></tr><tr><td align="left">资料接口文件</td><td align="left">(sockets)</td><td align="left">mksock sfile sock 文件</td></tr></tbody></table><p>-: 普通文件, d: 目录文件, l: 链接文件, b: 块设备文件, c: 字符设备文件, p: 管道文件</p><h3 id="一般权限-UGO"><a href="#一般权限-UGO" class="headerlink" title="一般权限 UGO"></a>一般权限 UGO</h3><p>Linux 系统中一切都是文件,文件和目录的所属与权限 —— 来分别规定所有者、所有组、其余人的读,写,执行权限。</p><p>读 (read) ,写 (write) ,执行 (execute )简写即为 (r,w,x) ,亦可用数字 (4,2,1) 表示</p><table><thead><tr><th align="left">权限</th><th align="left">读</th><th align="left">写</th><th align="left">执行</th><th align="left">读</th><th align="left">写</th><th align="left">执行</th><th align="left">读</th><th align="left">写</th><th align="left">执行</th></tr></thead><tbody><tr><td align="left">字符表示</td><td align="left">r</td><td align="left">w</td><td align="left">x</td><td align="left">r</td><td align="left">w</td><td align="left">x</td><td align="left">r</td><td align="left">w</td><td align="left">x</td></tr><tr><td align="left">数字表示</td><td align="left">4</td><td align="left">2</td><td align="left">1</td><td align="left">4</td><td align="left">2</td><td align="left">1</td><td align="left">4</td><td align="left">2</td><td align="left">1</td></tr><tr><td align="left">权限分配</td><td align="left">文件所有者</td><td align="left"></td><td align="left"></td><td align="left">文件所属组</td><td align="left"></td><td align="left"></td><td align="left">其他用户</td><td align="left"></td><td align="left"></td></tr></tbody></table><p>举例 : 如果某文件权限为 7 则代表可读,可写,可执行 (4+2+1) 。若权限为 6(4+2) 则代表可读,可写。那么权限为 5 与 3 时分别代表了什么?</p><p>答案:权限为 5 代表可读 (4) 和可执行 (1) 。而权限为 3 代表可写 (2) 和可执行 (1) 。</p><hr><p>文件的权限为 rw-r–r– 也就是分别表示所有者 ( 属主 ) 有读写权限,所有组 ( 属组 ) 有读权限,其余人也仅有读权限。</p><p>这个时候发现问题了吗?对于目录文件的读和写权限我们还可以理解,目录要能执行操作?</p><p>普通文件即实际保存数据的地方,其并不具备删除自身的权限:</p><ul><li>r: 可读取文件的实际内容</li><li>w: 可编辑 / 新增 / 修改该文件的实际内容</li><li>x: 可被执行</li></ul><p>目录文件即保存有目录结构和文件权限:</p><ul><li>r: 可读取目录结构和权限</li><li>w: 可更改目录结构列表、新建 / 删除 / 重命名 / 转移子文件 / 目录。</li><li>x: 表示用户可进入到该目录中</li></ul><h3 id="特殊权限-suid-sgid-sticky"><a href="#特殊权限-suid-sgid-sticky" class="headerlink" title="特殊权限 suid\sgid\sticky"></a>特殊权限 suid\sgid\sticky</h3><p>单纯对文件位置的 rwx 权限肯定不能满足我们对安全、便捷工作的需求,所以便有了 SUID 与 SGID 的特殊权限机制。</p><p>SUID</p><ul><li>范围 : 二进制的可执行的文件</li><li>作用 : 临时拥有所有者的权限</li></ul><p>SGID</p><ul><li>范围 : 目录或者拥有可执行权限的文件</li><li>作用 : 继承目录所属组</li></ul><p>SBIT ( STICKY )</p><ul><li>范围 : 目录</li><li>作用 : 只有 root 用户和文件拥有者有权删除目录中的文件。</li></ul><p>SUID</p><p>比如:<br><code>-rwsr-xr-x. 1 root root 27832 Jan 30 2014 /usr/bin/passwd</code></p><p>所有用户都可以执行用于修改用户密码的 passwd 命令,但用户密码保存在 /etc/shadow 文件中,默认权限是 000 即除了超级用户 root 外的所有用户都没有查看或编辑该文件的权限,所以对 passwd 命令加上SUID 权限位,则可让普通用户临时获得程序所有者的身份,即以 root 用户的身份将变更的密码信息写入到 shadow 文件中。</p><p><code>---s--x--x. 1 root root 130712 Sep 1 2015 sudo</code></p><p>SGID:</p><p>功能一:让执行者临时拥有属组的权限(对拥有执行权限的二进制程序设置)</p><p>举例:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-r-xr-sr-x. 1 root tty</span><br><span class="line">-rwxr-sr-x. 1 root tty</span><br><span class="line">15344 Jan 27 2014 wall</span><br><span class="line">19536 Aug 21 2015 write</span><br></pre></td></tr></table></figure><p>功能二:在该目录中创建的文件自动继承此目录的用户组(只可以对目录设置)</p><p>比如:我们将某个部门的工作目录给予了 SGID 权限,这样所有人创建的文件都归相同的工作组,这样方便以后的管理。</p><p>SBIT(Sticky Bit):</p><p>比如:<br><code>drwxrwxrwt. 7 root root 4096 Jun 22 13:20 /tmp</code></p><p>一般老师希望学生可以将作业上传到某个特定目录 —— 但为了避免某些小破坏份子,想限制删除其他人文件的话,那就要设置 SBIT 位了,当然也可以叫做特殊权限位之粘滞位。</p><h3 id="隐藏属性-ATTR"><a href="#隐藏属性-ATTR" class="headerlink" title="隐藏属性 ATTR"></a>隐藏属性 ATTR</h3><p>文件权限除了 UGO 读写执行与 SUID 、 SGID 、 SBIT 外还有一种隐藏权限,例如明明有权限删除某个文件却报错了,或者仅能为某个文件追加内容而不能减少内容,遇到这种很 “ 奇怪 ” 的文件,就要怀疑是文件被设置隐藏权限了。</p><p>chattr 命令用于设置文件的隐藏权限,格式为: “ chattr [ 参数 ] 文件 ” 。</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">i</td><td align="left">将无法对文件进行修改,若对目录设置后则仅能修改子文件而不能新建或删除。</td></tr><tr><td align="left">a</td><td align="left">仅允许补充(追加)内容.无法覆盖/删除(Append Only)。</td></tr><tr><td align="left">S</td><td align="left">文件内容变更后立即同步到硬盘(sync)。</td></tr><tr><td align="left">s</td><td align="left">彻底从硬盘中删除,不可恢复(用 0 填充原文件所在硬盘区域)。</td></tr><tr><td align="left">A</td><td align="left">不再修改这个文件的最后访问时间(atime)。</td></tr><tr><td align="left">b</td><td align="left">不再修改文件或目录的存取时间。</td></tr><tr><td align="left">D</td><td align="left">检查压缩文件中的错误。</td></tr><tr><td align="left">d</td><td align="left">当使用 dump 命令备份时忽略本文件/目录。</td></tr><tr><td align="left">c</td><td align="left">默认将文件或目录进行压缩。</td></tr><tr><td align="left">u</td><td align="left">当删除此文件后依然保留其在硬盘中的数据,方便日后恢复。</td></tr><tr><td align="left">t</td><td align="left">让文件系统支持尾部合并(tail-merging)。</td></tr><tr><td align="left">X</td><td align="left">可以直接访问压缩文件的内容。</td></tr></tbody></table><p>lsattr 命令用于显示文件的隐藏权限,格式为: “ lsattr [ 参数 ] 文件 ” 。</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">a</td><td align="left">显示所有文件和目录。</td></tr><tr><td align="left">l</td><td align="left">显示隐藏属性的全称(默认简写成一个字母)。</td></tr><tr><td align="left">R</td><td align="left">递归处理,将指定目录下的所有文件及子目录一并处理。</td></tr><tr><td align="left">d</td><td align="left">若目标文件为目录,请加此参数。</td></tr></tbody></table><p>具体用法见第三章节</p><h3 id="文件访问控制列表-ACL"><a href="#文件访问控制列表-ACL" class="headerlink" title="文件访问控制列表 ACL"></a>文件访问控制列表 ACL</h3><p>不知大家有没有发现其实上面讲解的 rwx 权限、特殊权限、隐藏权限都是对某一类用户设置的,而如果希望对某个指定的用户进行单独的权限设置,那么就需要用文件的访问控制列表来实现啦。</p><p>我们可以基于普通文件或目录设置进行设置 ACL ,通俗来说 ACL 就是设置指定的特定用户或用户组对某个文件的操作权限。并且如果对某个目录设置了访问控制策略,那么子文件则继承其访问策略,而若对文件设置了访问控制策略则不再继承上级目录的控制策略。</p><p>ACL:Access Control List 缩写 ,UGO 的 rwx 权限以外的细部权限设置。</p><ul><li>setfacl 命令用于增加或者修改 ACL 规则,格式为: ” setfacl [ 参数 ] 文件 ” 。</li><li>getfacl 命令用于显示文件的 ACL 规则,格式为: ” getfacl 文件 ” 。</li></ul><p>详细命令用法请看第三章节。</p><h2 id="文件相关的命令"><a href="#文件相关的命令" class="headerlink" title="文件相关的命令"></a>文件相关的命令</h2><table><thead><tr><th align="left">文件</th><th align="left">命令</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">文件的管理</td><td align="left">ls ,cd, pwd, touch,mkdir, rmdir</td><td align="left">新建、删除</td></tr><tr><td align="left"></td><td align="left">cp, rm, mv</td><td align="left">复制、删除、移动</td></tr><tr><td align="left">文件内容的查看</td><td align="left">cat, tac, nl</td><td align="left">直接查看内容</td></tr><tr><td align="left"></td><td align="left">more, less</td><td align="left">可翻页查看</td></tr><tr><td align="left"></td><td align="left">head, tail</td><td align="left">资料撷取</td></tr><tr><td align="left"></td><td align="left">od</td><td align="left">非纯文本档</td></tr><tr><td align="left">文件的权限</td><td align="left">chmod chown</td><td align="left">文件的拥有者和所属组 ugo 权限</td></tr><tr><td align="left"></td><td align="left">umask</td><td align="left">文件预设</td></tr><tr><td align="left"></td><td align="left">chattr, lsattr</td><td align="left">文件隐藏属性</td></tr><tr><td align="left"></td><td align="left">SUID, SGID, SBIT</td><td align="left">文件特殊权限</td></tr><tr><td align="left">文件类型</td><td align="left">file</td><td align="left">文件类型查看</td></tr><tr><td align="left">文件的搜索</td><td align="left">which</td><td align="left">指令文件的搜索</td></tr><tr><td align="left"></td><td align="left">whereis, locate, find</td><td align="left">文件的搜索</td></tr></tbody></table><h3 id="权限的修改-chmod-chown-chgrp-umask"><a href="#权限的修改-chmod-chown-chgrp-umask" class="headerlink" title="权限的修改 chmod chown chgrp umask"></a>权限的修改 chmod chown chgrp umask</h3><h4 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h4><p>chmod [ u g o a 所有用户 ] [ + - = ] [ rwx] /[ 777]</p><ul><li>w 结合 x 权限可以对目录下的文件进行以下操作 : cd rm touch cp</li><li>r 结合 x 权限可以对目录下的文件进行 ls 操作</li><li>x 决定了能否进入目录</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ root@www tmp]# ll dabao</span><br><span class="line">-rw-r--r--. 1 root root 0 Mar 21 06:09 dabao</span><br><span class="line">[ root@www tmp]# chmod 777 dabao</span><br><span class="line">[ root@www tmp]# ll dabao</span><br><span class="line">-rwxrwxrwx. 1 root root 0 Mar 21 06:09 dabao3.1.2 chown</span><br></pre></td></tr></table></figure><p>chown user:group 目录 / 文件</p><p>-R 针对目录递归修改拥有者</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ root@www tmp]# chown dabao. dabao</span><br><span class="line">[ root@www tmp]# ll dabao</span><br><span class="line">-rwxrwxrwx. 1 dabao dabao 0 Mar 21 06:09 dabao</span><br><span class="line">[ root@www tmp]# chown -R dabao dabao1</span><br><span class="line">[ root@www tmp]# ll -R dabao1</span><br><span class="line">dabao1:</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 3 dabao root 4096 Mar 21 06:11 1</span><br><span class="line">dabao1/1:</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 2 dabao root 4096 Mar 21 06:11 2</span><br><span class="line">dabao1/1/2:</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure><h4 id="chgrp"><a href="#chgrp" class="headerlink" title="chgrp"></a>chgrp</h4><p>修改文件目录的所属组</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ root@www tmp]# chgrp -R dabao dabao1</span><br><span class="line">[ root@www tmp]# ll -R dabao1</span><br><span class="line">dabao1:</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 3 dabao dabao 4096 Mar 21 06:11 1</span><br><span class="line">dabao1/1:</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 2 dabao dabao 4096 Mar 21 06:11 2</span><br><span class="line">dabao1/1/2:</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure><h4 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h4><p>umask 创建文件 / 目录的默认权限</p><p>公式</p><p>最大权限 -umask= 默认权限</p><ul><li>user 文件 666 -002 = 644 rw-rw-r–</li><li>root 文件 666 -022 = 664 rw-r–r–</li><li>user 目录 777 -002 = 755 rwxrwxr-x</li><li>root 目录 777 -022 = 775 rwxr-xr-x</li></ul><p>umask 777 只针对当前环境临时生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ root@www tmp]# umask</span><br><span class="line">0022</span><br></pre></td></tr></table></figure><h4 id="相关文档-etc-profile-bash-profile"><a href="#相关文档-etc-profile-bash-profile" class="headerlink" title="相关文档 /etc/profile ~/.bash_profile"></a>相关文档 /etc/profile ~/.bash_profile</h4><ul><li>/etc/profile 定义了普通用户和 root 用户的 umask 值 , 对所有用户生效</li><li>~/.bash_profile 可以定义当前用户的 umask 值 , 只对当前用户生效 , 需要重新登陆用户后生效。</li></ul><p>默认属性相加减 , 则档案变成 :666-003=663, 是 -rw-rw–wx , 错 !!</p><h3 id="ATTR-权限命令-chattr-lsattr"><a href="#ATTR-权限命令-chattr-lsattr" class="headerlink" title="ATTR 权限命令 chattr lsattr"></a>ATTR 权限命令 chattr lsattr</h3><h4 id="chattr"><a href="#chattr" class="headerlink" title="chattr"></a>chattr</h4><p>配置文件案隐藏属性</p><p>属性设置常见的是 a 和 i 的设定 , 必须要 root 身份</p><p>chattr [ +-= ][ ASacdistu] 文件 / 目录</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">+</td><td align="left">增加</td></tr><tr><td align="left">-</td><td align="left">移除</td></tr><tr><td align="left">=</td><td align="left">设定为</td></tr><tr><td align="left">A</td><td align="left">访问时间 atime 不修改 , 对速度较慢计算机有帮助</td></tr><tr><td align="left">S</td><td align="left">『同步』写入磁盘</td></tr><tr><td align="left">a</td><td align="left">只能增加数据 , 不能删除 / 修改数据 (root)</td></tr><tr><td align="left">c</td><td align="left">自动『压缩』 , 读取时自动解压缩</td></tr><tr><td align="left">d</td><td align="left">不被 dump 备份</td></tr><tr><td align="left">i</td><td align="left">以下操作不可执行 : 『删除、改名、设置连结、写入、新增资料』 ( root )</td></tr><tr><td align="left">s</td><td align="left">彻底删除 , 无法挽回</td></tr><tr><td align="left">u</td><td align="left">与 s 相反 , 删除可挽回</td></tr></tbody></table><h4 id="lsattr"><a href="#lsattr" class="headerlink" title="lsattr"></a>lsattr</h4><p>lsattr [ -adR] 文件 / 目录</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">-a</td><td align="left">显示隐藏文件的属性</td></tr><tr><td align="left">-d</td><td align="left">仅列出目录本身属性</td></tr><tr><td align="left">-R</td><td align="left">连同子目录</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">A 访问时间 atime 不修改</span><br><span class="line">[root@rhel7 tmp]# chattr +A file1</span><br><span class="line">[root@rhel7 tmp]# lsattr file1</span><br><span class="line">-------A-------- file1</span><br><span class="line">[root@rhel7 tmp]# cat file1</span><br><span class="line">hi</span><br><span class="line">[root@rhel7 tmp]# stat file1</span><br><span class="line">File: ‘file1’</span><br><span class="line">Size: 3</span><br><span class="line">Blocks: 8</span><br><span class="line">IO Block: 4096 regular file</span><br><span class="line">Device: fd00h/64768d</span><br><span class="line">Inode: 52973916 Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--) Uid: ( 0/ root) Gid: ( 0/ root)</span><br><span class="line">Context: unconfined_u:object_r:user_tmp_t:s0Access: 2016-06-22 14:49:50.221000000 +0800</span><br><span class="line">Modify: 2016-06-22 14:49:48.025000000 +0800</span><br><span class="line">Change: 2016-06-22 14:50:14.621000000 +0800</span><br><span class="line">Birth: -</span><br><span class="line">[root@rhel7 tmp]# cat file1</span><br><span class="line">hi</span><br><span class="line">[root@rhel7 tmp]# stat file1</span><br><span class="line">File: ‘file1’</span><br><span class="line">Size: 3</span><br><span class="line">Blocks: 8</span><br><span class="line">IO Block: 4096 regular file</span><br><span class="line">Device: fd00h/64768d</span><br><span class="line">Inode: 52973916 Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--) Uid: ( 0/ root) Gid: ( 0/ root)</span><br><span class="line">Context: unconfined_u:object_r:user_tmp_t:s0</span><br><span class="line">Access: 2016-06-22 14:49:50.221000000 +0800</span><br><span class="line">Modify: 2016-06-22 14:49:48.025000000 +0800</span><br><span class="line">Change: 2016-06-22 14:50:14.621000000 +0800</span><br><span class="line">Birth: -</span><br><span class="line">[root@rhel7 tmp]# chattr -A file1</span><br><span class="line">a 只能增加数据 , 不能删除 / 修改数据 (root)</span><br><span class="line">[root@rhel7 tmp]# chattr +a file1</span><br><span class="line">[root@rhel7 tmp]# lsattr file1</span><br><span class="line">-----a---------- file1</span><br><span class="line">[root@rhel7 tmp]# echo 99 &gt; file1</span><br><span class="line">-bash: file1: Operation not permitted</span><br><span class="line">[root@rhel7 tmp]# echo 99 &gt;&gt; file1</span><br><span class="line">[root@rhel7 tmp]# cat file1</span><br><span class="line">hi</span><br><span class="line">99</span><br><span class="line">i 以下操作不可执行 : 『删除、改名、设置连结、写入、新增资料』 ( root )</span><br><span class="line">[root@rhel7 tmp]# chattr +i file1</span><br><span class="line">[root@rhel7 tmp]# rm -rf file1</span><br><span class="line">rm: cannot remove ‘file1’: Operation not permitted</span><br><span class="line">[root@rhel7 tmp]# mv file1 file100</span><br><span class="line">mv: cannot move ‘file1’ to ‘file100’: Operation not permitted</span><br><span class="line">[root@rhel7 tmp]# link file1 file1h</span><br><span class="line">link: cannot create link ‘file1h’ to ‘file1’: Operation not permitted</span><br><span class="line">[root@rhel7 tmp]# echo nini&gt;&gt;file1</span><br><span class="line">-bash: file1: Permission denied</span><br><span class="line">[root@rhel7 tmp]# chattr -i file1</span><br><span class="line">[root@rhel7 tmp]# lsattr file1</span><br><span class="line">---------------- file1</span><br></pre></td></tr></table></figure><h3 id="ACL-权限命令"><a href="#ACL-权限命令" class="headerlink" title="ACL 权限命令"></a>ACL 权限命令</h3><h4 id="ACL-权限概念"><a href="#ACL-权限概念" class="headerlink" title="ACL 权限概念"></a>ACL 权限概念</h4><p>ACL:Access Control List 缩写 ,UGO 的 rwx 权限以外的细部权限设置。</p><p>ACL 可以针对单一用户 , 单一文件 , 单一目录 r,w,x 的权限规范</p><p>针对几个项目 :</p><ol><li>使用者 (user): 可以针对使用者设定权限</li><li>群组 (group): 针对群组为对象设定权限</li><li>默认属性 (mask): 还可以针对在该目录下在建立新档案或目录时 , 规范新数据的默认权限</li></ol><h4 id="getfacl"><a href="#getfacl" class="headerlink" title="getfacl"></a>getfacl</h4><p>取得文件 / 目录的 ACL 设定内容</p><p>getfacl filename</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www tmp]# getfacl dabao</span><br><span class="line"> file: dabao</span><br><span class="line"> owner: dabao</span><br><span class="line"> group: dabao</span><br><span class="line">user::rwx</span><br><span class="line">group::rwx</span><br><span class="line">other::rwx</span><br></pre></td></tr></table></figure><h4 id="setfacl"><a href="#setfacl" class="headerlink" title="setfacl"></a>setfacl</h4><p>设置文件 / 目录的 ACL 规范</p><p>setfacl [-bkRd] [{-m|-x} acl 参数 ] 目标文件名</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">-m</td><td align="left">设置 acl 参数</td></tr><tr><td align="left">-x</td><td align="left">删除 acl 参数</td></tr><tr><td align="left">-b</td><td align="left">删除所有 acl 参数</td></tr><tr><td align="left">-k</td><td align="left">删除预设的 acl 参数</td></tr><tr><td align="left">-R</td><td align="left">递归设置 acl 参数</td></tr><tr><td align="left">-d</td><td align="left">设置『预设 acl 参数』只对目录有效 , 在该目录新建的数据会引用</td></tr></tbody></table><p>命令格式 :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">『 u:[ 使用者账号列表 ]:[ rwx] 』 &lt;= = 针对特定用户</span><br><span class="line">『 g:[ 群组列表 ]:[rwx] 』 &lt;= = 针对特定用户组</span><br><span class="line">『 m:[ rwx] 』 &lt;= = 针对有效权限 mask</span><br><span class="line">『 d:[ ug]: 使用者列表 :[ rwx] 』 针对预设权限 , 属性将继承到次目录</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# setfacl -m u:student:rwx file1</span><br><span class="line">[root@rhel7 tmp]# setfacl -m g:student:rw file1</span><br><span class="line">[root@rhel7 tmp]# getfacl file1</span><br><span class="line"> file: file1</span><br><span class="line"> owner: root</span><br><span class="line"> group: root</span><br><span class="line">user::rw-</span><br><span class="line">user:student:rwx</span><br><span class="line">group::r--</span><br><span class="line">group:student:rw-</span><br><span class="line">mask::rwx</span><br><span class="line">other::r--</span><br><span class="line">-d 针对预设权限 , 属性将继承到次目录</span><br><span class="line">[root@rhel7 tmp]# mkdir dabao</span><br><span class="line">[root@rhel7 tmp]# setfacl -d -m u:student:rwx dabao</span><br><span class="line">[root@rhel7 tmp]# getfacl dabao</span><br><span class="line"> file: dabao</span><br><span class="line"> owner: root</span><br><span class="line"> group: root</span><br><span class="line">user::rwx</span><br><span class="line">group::r-x</span><br><span class="line">other::r-x</span><br><span class="line">default:user::rwx</span><br><span class="line">default:user:student:rwx</span><br><span class="line">default:group::r-x</span><br><span class="line">default:mask::rwx</span><br><span class="line">default:other::r-x</span><br><span class="line">[root@rhel7 tmp]# ll dabao -d</span><br><span class="line">drwxr-xr-x+ 2 root root 6 Jun 22 15:09 dabao</span><br><span class="line">[root@rhel7 tmp]# touch dabao/kk</span><br><span class="line">[root@rhel7 tmp]# ll dabao</span><br><span class="line">total 4</span><br><span class="line">-rw-rw-r--+ 1 root root 0 Jun 22 15:10 kk</span><br><span class="line">[root@rhel7 tmp]# getfacl dabao/kk</span><br><span class="line"> file: dabao/kk</span><br><span class="line"> owner: root</span><br><span class="line"> group: root</span><br><span class="line">user::rw-</span><br><span class="line">user:student:rwx</span><br><span class="line">effective:rw-</span><br><span class="line">group::r-x</span><br><span class="line">effective:r--</span><br><span class="line">mask::rw-</span><br><span class="line">other::r--</span><br><span class="line"> 切换为 student 用户</span><br><span class="line">[student@rhel7 tmp]$ cd dabao</span><br><span class="line">[student@rhel7 dabao]$ ll</span><br><span class="line">total 4</span><br><span class="line">-rw-rw-r--+ 1 root root 0 Jun 22 15:10 kk</span><br><span class="line">[student@rhel7 dabao]$ cat kk</span><br></pre></td></tr></table></figure><h2 id="文件存储结构"><a href="#文件存储结构" class="headerlink" title="文件存储结构"></a>文件存储结构</h2><p>Linux 操作系统的文件权限 (rwx) 与文件属性 ( 拥有者、群组、 时间参数等 ) , 文件系统会将这两部分<br>的数据分别存放在不同的区块 , 权限不属性放置到 inode 中 , 实际数据则放置到 data block 区块中。<br>另外 , 还有一个超级区块 (superblock) 会记录整个 文件系统的整体信息 , 包括 inode 和 block<br>的总量、使用量、剩余量等。</p><p><img src="pic/07.png" alt="07"></p><ul><li>文件的属性和权限数据 –&gt; 放置到 inode 4 号</li><li>文件数据的实际放置点为 2, 7, 13, 15 这四个 block 号码</li></ul><p>对于目录: inode 记录该目录的相关权限与属性 , 并记录分配到的那块 block 号码 ; 而 block 则<br>是记录在该目录下的文件或目录的文件名和对应的 inode 号的数据。如下图所示:</p><p><img src="pic/08.png" alt="08"></p><h2 id="软硬方式链接"><a href="#软硬方式链接" class="headerlink" title="软硬方式链接"></a>软硬方式链接</h2><p>在 Linux 系统中的 ln 命令能够让用户创建出两种不同类型的文件快捷方式,一定要注意区分:</p><p>硬链接 (hard link) 可以被理解为一个 “ 指向原始文件 inode 的指针 ” ,系统不为它分配独立的 inode<br>与文件,所以实际上来讲硬链接文件与原始文件其实是同一个文件,只是名字不同。于是每添加一个硬链接,<br>该文件的 inode 连接数就会增加 1 ,直到该文件的 inode 连接数归 0 才是彻底删除。概括来说因为硬链<br>接实际就是指向原文件 inode 的指针,即便原始文件被删除依然可以通过链接文件访问,但是不能跨文件<br>系统也不能链接目录文件。</p><p>软链接也称为符号链接( symbolic link )即 “ 仅仅包含它索要链接文件的路径名 ” 因此能做目录链接也<br>可以跨越文件系统,但原始文件被删除后链接文件也将失效,如同 WinodwTM 中的 “ 快捷方式 ” 。</p><p>ln 命令用于创建链接文件,格式为: “ ln [ 选项 ] 目标 ” 。</p><ul><li>创建硬链接 :“ln 文件名 链接名 ”</li><li>创建软链接 :“ln -s 文件名 连接名 ”</li></ul><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">-s</td><td align="left">创建”符号链接”(默认是硬链接)</td></tr><tr><td align="left">-f</td><td align="left">强制创建文件或目录的链接</td></tr><tr><td align="left">-i</td><td align="left">覆盖前先询问</td></tr><tr><td align="left">-v</td><td align="left">显示创建链接的过程</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# echo this is a &gt; file</span><br><span class="line">[root@rhel7 tmp]# cat file</span><br><span class="line">this is a</span><br><span class="line">[root@rhel7 tmp]# ll file</span><br><span class="line">-rw-r--r--. 1 root root 10 Jun 22 16:02 file</span><br><span class="line">[root@rhel7 tmp]# ln file fileh</span><br><span class="line">[root@rhel7 tmp]# ll file fileh</span><br><span class="line">[root@rhel7 tmp]# ll file fileh files -i</span><br><span class="line">52973928 -rw-r--r--. 2 root root 10 Jun 22 16:02 file</span><br><span class="line">52973928 -rw-r--r--. 2 root root 10 Jun 22 16:02 fileh</span><br><span class="line">52973930 lrwxrwxrwx. 1 root root 4 Jun 22 16:03 files -&gt; filefile</span><br></pre></td></tr></table></figure><p><img src="pic/09.png" alt="09"></p><h2 id="指令和文件的搜索"><a href="#指令和文件的搜索" class="headerlink" title="指令和文件的搜索"></a>指令和文件的搜索</h2><p>which     whereis         locate     find </p><h3 id="肉眼查找-ls-R"><a href="#肉眼查找-ls-R" class="headerlink" title="肉眼查找 : ls -R"></a>肉眼查找 : ls -R</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[ root@www ~]# ls -R /tmp</span><br><span class="line">/tmp:</span><br><span class="line">dabao</span><br><span class="line">dabao1</span><br><span class="line">/tmp/dabao1:</span><br><span class="line">1</span><br><span class="line">/tmp/dabao1/1:</span><br><span class="line">2</span><br><span class="line">/tmp/dabao1/1/2:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 指令的搜寻 :which</span></span></span><br><span class="line"></span><br><span class="line">which [ -a] command</span><br><span class="line"></span><br><span class="line">选项与参数 :</span><br><span class="line"></span><br><span class="line">-a</span><br><span class="line">- : 将所有由 PATH 目录中可以找到的指令均列出</span><br><span class="line">- : 只显示第一个找到的</span><br><span class="line"></span><br><span class="line">注意 :</span><br><span class="line">1. 系统内建命令找不到 , type 查看</span><br><span class="line">2. alias 命令别名</span><br><span class="line"></span><br><span class="line">​```shell</span><br><span class="line">[ root@www ~]# which cat</span><br><span class="line">/bin/cat</span><br><span class="line">[ root@www ~]# which postfix</span><br><span class="line">/usr/sbin/postfix</span><br></pre></td></tr></table></figure><h3 id="文件名的搜寻-whereis-locate-find"><a href="#文件名的搜寻-whereis-locate-find" class="headerlink" title="文件名的搜寻 :whereis, locate, find"></a>文件名的搜寻 :whereis, locate, find</h3><h4 id="whereis"><a href="#whereis" class="headerlink" title="whereis"></a>whereis</h4><p>whereis [ -bmsu] [ -BMS directory…-f] filename..</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">-b</td><td align="left">只寻找 binary 二进制 格式的文件</td></tr><tr><td align="left">-m</td><td align="left">只寻找在 说明文件 manual 路径下的文件</td></tr><tr><td align="left">-s</td><td align="left">只寻找 source 来源的文件</td></tr><tr><td align="left">-u</td><td align="left">搜寻不在上述三个项目当中的其他特殊文件</td></tr><tr><td align="left">-l</td><td align="left">查看 whereis 可搜寻的路径</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ root@www ~]# whereis /etc/passwd</span><br><span class="line">passwd: /usr/bin/passwd /etc/passwd.OLD /etc/passwd /usr/share/man/man1/passwd.1.gz</span><br><span class="line">/usr/share/man/man5/passwd.5.gz</span><br><span class="line">[ root@www ~]# whereis man</span><br><span class="line">man: /usr/bin/man /etc/man.config /usr/share/man /usr/share/man/man7/man.7.gz</span><br><span class="line">/usr/share/man/man1p/man.1p.gz /usr/share/man/man1/man.1.gz</span><br></pre></td></tr></table></figure><h4 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h4><p>locate [ -ir] keyword</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">-i</td><td align="left">忽略大小写的差异 ;</td></tr><tr><td align="left">-r</td><td align="left">后面可接正规表示法的显示方式</td></tr></tbody></table><ul><li>安装软件 <code>mlocate</code> 之后才会有 <code>updatedb</code> 命令和 <code>locate</code> 命令,最小化安装的 rhel 系统默认不安装。</li><li><code>locate</code> 寻找的数据是由『已建立的数据库 <code>/var/lib/mlocate/mlocate.db</code> 里面的数据所搜<br>寻到 , 所以不用直接在去硬盘中存取数据 , 速度快</li><li><code>updatedb</code>: 根据 <code>/etc/updatedb.conf</code> 的设定去搜寻系统硬盘内的文件名 , 并更新<code>/var/lib/mlocate.mlocate.db</code></li><li><code>PRUNEPATHS = &quot;/afs /media /net /sfs /tmp /udev /var/cache/ccache /var/spool/cups /var/spool/squid /var/tmp&quot;</code> &lt;== 设定了不搜寻的目录</li></ul><h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><p>find [ PATH] [ option] [ action]</p><p>选项与参数 :</p><ol><li>与时间有关 :-atime, -ctime ,-mtime , 以 -mtime 说明</li></ol><ul><li>-mtime n</li><li>-mtime +n</li><li>-mtime -n</li><li>-newer file : 列出比 file 还要新的档案</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if n= 2 now= 2015/12/24</span><br><span class="line">then</span><br><span class="line">-mtime 2:  2015/12/22 当天内容改过的文件</span><br><span class="line">-mtime +2: 2 天之前 , 2015/12/22 之前被容被改过的文件 , 及 21\20\19...</span><br><span class="line">-mtime -2: 2 天以内 , 2015/12/24 和 2015/12/23 号修改过的文件</span><br><span class="line">&lt;--|--|--|--|--|--|--|--|--|--|--|2-|--|--|</span><br><span class="line">&lt;----------------------------+2-&gt;|--|--|--|</span><br><span class="line">&lt;--|--|--|--|--|--|--|--|--|--|--|--|&lt;-2-&gt;|</span><br><span class="line">11 12 13 14 15 16 17 18 19 20 21 22 23 24 现在</span><br></pre></td></tr></table></figure><ol><li>与用户和组有关</li></ol><ul><li>-uid n</li><li>-gid n</li><li>-user name</li><li>-group name</li><li>-nouser</li><li>-nogroup</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ root@www ~]# find /tmp -user dabao</span><br><span class="line">/tmp/dabao</span><br><span class="line">/tmp/dabao1</span><br><span class="line">/tmp/dabao1/1</span><br><span class="line">/tmp/dabao1/1/2</span><br></pre></td></tr></table></figure><ol><li>与档案的权限及名称有关</li></ol><ul><li>-name filename: 搜寻文件名为 filename 的文件 ;</li><li>-size [ +-]SIZE: SIZE 的规格有</li><li>c: 代表 byte</li><li>k: 代表 1024bytes w: 字数 , 占两个字符 M\G</li><li>-type TYPE:f 普通文件 d 目录 l 链接文件</li><li>-perm mode : 文件权限『刚好等于』 mode 的档案 mode 范围 : 7777 ~ 0000</li><li>-perm -mode: 文件权限『必须要全部囊括 mode 权限』</li><li>-perm +mode: 文件权限『包含 mode 权限』的文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ root@www ~]# find /tmp -name "*da*"</span><br><span class="line">/tmp/dabao</span><br><span class="line">/tmp/orbit-root/linc-bd3-0-5dc8fa181da</span><br><span class="line">/tmp/orbit-root/linc-da1-0-76ab0a1c521dd</span><br><span class="line">/tmp/orbit-root/linc-cc4-0-c0fda335ced5</span><br><span class="line">/tmp/dabao1</span><br><span class="line">[ root@www ~]# find /tmp -type f</span><br><span class="line">/tmp/pulse-BzLrQ7uHulwz/pid</span><br><span class="line">/tmp/.X0-lock</span><br><span class="line">/tmp/dabao</span><br><span class="line">/tmp/orbit-root/bonobo-activation-server-23d28d39cfff8983f6cac2ca00000055-ior</span><br><span class="line">/tmp/orbit-root/bonobo-activation-register-23d28d39cfff8983f6cac2ca00000055.lock</span><br><span class="line">/tmp/lurakm9.tmp/luraktg.tmp</span><br><span class="line">/tmp/lurakm9.tmp/lurakt2.tmp</span><br><span class="line">/tmp/lurakm9.tmp/lurakvs.tmp</span><br></pre></td></tr></table></figure><ol><li>额外动作</li></ol><p>-exec [ 命令 ] : 后面可再接额外的命令来处理搜寻到的结果</p><p><code>find / -perm +7000 -exec ls -l {} \;</code><br>&lt;= = 固定格式 : <code>find [ 路径 参数 ] -exec [ 命令 ] {} \;</code></p><p>-ok        格式同-exec，区别ok会带提示（交互式的找到后是否执行该命令）</p><p>-print: 将结果输出屏幕上 , 预设动作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ root@www ~]# find /tmp -name "dabao*" -exec ls -l &#123;&#125; \;</span><br><span class="line">-rwxrwxrwx+ 1 dabao dabao 0 Mar 21 06:09 /tmp/dabao</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 3 dabao dabao 4096 Mar 21 06:11 1</span><br></pre></td></tr></table></figure><h2 id="Linux-文件和目录作业"><a href="#Linux-文件和目录作业" class="headerlink" title="Linux 文件和目录作业"></a>Linux 文件和目录作业</h2><h3 id="UGO-权限作业"><a href="#UGO-权限作业" class="headerlink" title="UGO 权限作业"></a>UGO 权限作业</h3><ol><li>查看 /var/spool/mail 下所有文件 , 并指出其拥有者和所属组分 别是谁 , 其拥有者和所属组对应的<br>权限分别是什么 ?</li><li>在 /tmp/ 目录下创建 7 个目录 , 目录名分别为 test1 到 test7</li></ol><ul><li>1) 将该 7 个目录的拥有者改为 student 用户。</li><li>2) 在这 7 个目录下分别创建 file1 和 file2</li><li>3) 针对这 7 个目录的 student 用户分别设置数字为 1 到 7 的权限。</li><li>4) 分别对这个 7 个目录执行以下命令 :<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls file1</span><br><span class="line">ls -l file1</span><br><span class="line">cd testx</span><br><span class="line">touch file3</span><br><span class="line">rm file2</span><br><span class="line">chmod 777 file1</span><br></pre></td></tr></table></figure>并总结结论。</li></ul><ol><li>新建一个组 , 组名为 group, 要求将 test1 目录的所属组改为 group 组 , 并将 test1 目录下的<br>所有文件的所属组都改为 group 组。</li></ol><h3 id="特殊权限作业"><a href="#特殊权限作业" class="headerlink" title="特殊权限作业"></a>特殊权限作业</h3><ol><li>在 /tmp/ 目录下创建一个 testdir 目录 , 要求任何人在该目录下 创建的文件都只能由自己或者目录<br>拥有者去删除 , 其余人不能够 去删除。</li><li>创建一个文件 , 让任何人执行这个文件时候 , 临时拥有文件拥 有者的权限。</li></ol><h3 id="ATTR-权限作业"><a href="#ATTR-权限作业" class="headerlink" title="ATTR 权限作业"></a>ATTR 权限作业</h3><ol><li>创建一个文件 , 文件名任意 , 要求 , 该文件的访问时间不被 修改 , 同时 , 该文件只能被追加内容 , 不允许被<br>修改和删除。 取消该文件的 Attr 权限。</li></ol><h3 id="ACL-权限作业"><a href="#ACL-权限作业" class="headerlink" title="ACL 权限作业"></a>ACL 权限作业</h3><ol><li>在 /tmp 下创建一个 file 文件 , 要求 student 用户对 file 有完整 的权限 ,kevin 用户对<br>file 有 rw- 的权限 ,carol 用户对 file 有 -wx 的权限 ,natasha 用户对该文件有 r– 的权限。</li><li>清空 file 的 attr 权限。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Linux-文件和目录&quot;&gt;&lt;a href=&quot;#Linux-文件和目录&quot; class=&quot;headerlink&quot; title=&quot;Linux 文件和目录&quot;&gt;&lt;/a&gt;Linux 文件和目录&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;Linux-目录&quot;&gt;&lt;a hre
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux 压缩打包</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/04-Linux%E5%8E%8B%E7%BC%A9%E6%89%93%E5%8C%85/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/04-Linux%E5%8E%8B%E7%BC%A9%E6%89%93%E5%8C%85/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.321Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux压缩打包"><a href="#Linux压缩打包" class="headerlink" title="Linux压缩打包"></a>Linux压缩打包</h1><p>[TOC]</p><h2 id="压缩的意义和原理"><a href="#压缩的意义和原理" class="headerlink" title="压缩的意义和原理"></a>压缩的意义和原理</h2><h3 id="压缩的意义"><a href="#压缩的意义" class="headerlink" title="压缩的意义"></a>压缩的意义</h3><p>你是否遇到过以下情况：</p><ul><li>文件太大, 一个 u 盘无法全部复制? </li><li>备份某些重要数据 , 偏偏这些数据量太大了 , 耗掉了你太多的磁盘空间? </li></ul><p>这个时候，“文件压缩”技术可 就派上用场了 !</p><p>因为这些比较大型的文件透过所谓的文件压缩技术后 , 可以将他的磁盘使用量降低 , 可以达到减低文件容量的效果 , 此外 , 有的压缩程序还可以进行容量限制 , 使一个大型文件可以分割成为数个小型文件 , 以方便 U盘携带呢 !</p><h3 id="压缩的原理"><a href="#压缩的原理" class="headerlink" title="压缩的原理"></a>压缩的原理</h3><p>目前我们使用的计算机系统中都是使 bytes(字节)单位来计量的! 事实上 , 计算机最小的计量单位应该是 bits (比特)。</p><p>1 byte = 8 bits 。</p><p>如果让计算机记录 1 这个数字他会如何记录 ?</p><p>假设一个 byte 可以看成下面的样子 :</p><p>□□□□□□□□</p><p>Tips:</p><p>1 byte = 8 bits , 所以每个 byte 当中会有 8 个空格 , 而每个空格可以是 0, 或者 1 , 这里仅是做为一个粗略的介绍。由于我们记录数字是 1 , 表示成二进制就是 00000001 , 1 会在最右边占据 1 个 bit , 而其他 的 7 个bits 将会被填上 0 ! 有一种压缩技术示这么做的,他是将重复的数据进行统计记录的。</p><p>举个例子说 , 如果你的数据『 111…. 』共有 100 个 1 </p><p>那么压缩技术会记录为『 100 个 1 』而不是真的有 100 个 1 的位存在 ! </p><p>简单的说 , 你可以将他想成 , 其实文件里面有相当多的『空间』存在 , 并不是完全填满的 </p><ul><li>『压缩』 技术就是将这些『空间』填满 , 以让整个文件占用的容量下降 ! </li><li>『压缩过的档案』并无法直接被我们的操作系统所使用 , 因此 , 若要使用这些被压缩过的文件数据 , 则必项将他『还原』回到 未压缩前的模样 ,那就是所谓的『解压缩』啰 ! </li><li>至于压缩前与压缩后的档案所占用的磁盘空间大小 , 就可以被称为是『压缩比』。</li></ul><h3 id="压缩与解压缩的好处"><a href="#压缩与解压缩的好处" class="headerlink" title="压缩与解压缩的好处"></a>压缩与解压缩的好处</h3><p>最大的好处就是压缩过的文件容量变小了 , 所以你的 硬盘容量无形当中就可以容纳更多的资料。此外 , 在一些网络数据的传输中 , 也会由于数据量的降低 , 好让网络带宽可以用来作更多的工作 ! 而并是老是卡在一些大型的文件传输上面呢 ! 目前很多的 WWW 网站也是利用文件压缩的技术来进行数据的传送 , 好让网站带宽的可利用率上升。</p><h2 id="压缩打包命令"><a href="#压缩打包命令" class="headerlink" title="压缩打包命令"></a>压缩打包命令</h2><p>命令概览</p><ul><li><p>compress 是一个相当古老的 unix 档案压缩指令。</p></li><li><p>gzip 是 GNUzip 的缩写,它是一个 GNU( 全称是 GNU’s Not Unix ) 自由软件的文件压缩程序 ; 由于 gzip 可以产生更理想的压缩比例,一般人多已改用 gzip 为档案压缩工具。</p></li><li><p>bzip2 是一个基于 Burrows-Wheeler 变换的无损压缩软件,压缩效果比传统的 LZ77/LZ78 压缩算法来得好 ; 若说 gzip 是为了取代 compress 并提供更好的压缩比而成立的,那么 bzip2 则是为了取代 gzip 并提供更佳的压缩比而来的。 bzip2 这玩意的压缩比竟然比 gzip 还要好。</p></li><li><p>tar 命令最初的设计目的是将文件备份到磁带上 (tape archive) ,因而得名 tar 。</p></li></ul><p><img src="pic/01.png" alt="01"></p><h3 id="zip"><a href="#zip" class="headerlink" title=".zip"></a>.zip</h3><p>.zip 扩展名表示文件是使用许多 zip 归档程序和压缩程序之一(但不是 gzip )创建的。因为这是一种非常流行的压缩格式,算法的详细描述也有很多,所以可以找到用于所有操作系统的有用的移植形式。这包括创建和扩展带有 .zip 文件扩展名的档案的压缩和解压缩实用程序。在 Linux 上有两种这样的工具:</p><p>免费的 Info-ZIP 和以赢利为目的的 PKZIP for Linux 。</p><p>如果您只是偶尔需要创建或打开 zip 文件,使用 Info-ZIP 。如果希望使用在 MS-DOS 或其它系统上使用的相同工具,请选择PKZIP ( PKZIP 可用于许多操作系统)。用于微软 Windows 的 WinZIP 和用于 Mac OS 的Stufflt 这两种实用程序可以创建和打开相互之间兼容的档案。</p><p>Info-ZIP 在无法使用 gzip 或 tar 的情况下可以提供压缩和解压缩的一个不错的选择,这或许是在Linux 、微软 Windows 和 Mac OS 用户之间交换压缩文件的一种最好的形式。有许多不错的 zip 程序(有开放源码的,也有商业的)可用于这些操作系统,它们应该能确保文件的顺利交换(当然,只要是在特定于某个特定工具的特殊功能关闭的情况下)。</p><p>rhel7 默认带有 info-zip 软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 zip-3.0]# which zip</span><br><span class="line">/usr/bin/zip</span><br><span class="line">[root@mastera0 zip-3.0]# rpm -qf /usr/bin/zip</span><br><span class="line">zip-3.0-10.el7.x86_64</span><br><span class="line">[root@mastera0 zip-3.0]# head -n 18 /usr/share/doc/zip-3.0/README</span><br><span class="line">Zip 3.0 is the first Zip update adding large file support. For now Zip 2.3x</span><br><span class="line">remains available and supported, but users should switch to this new release.</span><br><span class="line">Testing for Zip 3.0 has focused mainly on Unix, VMS, Max OS X, and Win32,</span><br><span class="line">and some other ports may not be fully supported yet. If you find your</span><br><span class="line">favorite port is broke, send us the details or, better, send bug fixes. It's</span><br><span class="line">possible that support for some older ports may be dropped in the future.</span><br><span class="line">Copyright (c) 1990-2008 Info-ZIP. All rights reserved.</span><br><span class="line">See the accompanying file LICENSE (the contents of which are also included</span><br><span class="line">in unzip.h, zip.h and wiz.h) for terms of use. If, for some reason, all</span><br><span class="line">of these files are missing, the Info-ZIP license also may be found at:</span><br><span class="line">ftp://ftp.info-zip.org/pub/infozip/license.html and</span><br><span class="line">http://www.info-zip.org/pub/infozip/license.html.</span><br><span class="line">[root@mastera0 ~]# rpm -qi zip</span><br><span class="line">Name</span><br><span class="line">: zip</span><br><span class="line">Version : 3.0</span><br><span class="line">Release : 10.el7</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Thu 23 Jun 2016 01:50:41 PM CST</span><br><span class="line">Group</span><br><span class="line">: Applications/Archiving</span><br><span class="line">Size</span><br><span class="line">: 815045License : BSD</span><br><span class="line">Signature : RSA/SHA256, Thu 03 Apr 2014 06:52:17 AM CST, Key ID 199e2f91fd431d51</span><br><span class="line">Source RPM : zip-3.0-10.el7.src.rpm</span><br><span class="line">Build Date : Tue 28 Jan 2014 06:35:49 AM CST</span><br><span class="line">Build Host : x86-019.build.eng.bos.redhat.com</span><br><span class="line">Relocations : (not relocatable)</span><br><span class="line">Packager : Red Hat, Inc. &lt;http://bugzilla.redhat.com/bugzilla&gt;</span><br><span class="line">Vendor</span><br><span class="line">: Red Hat, Inc.</span><br><span class="line">URL</span><br><span class="line">: http://www.info-zip.org/Zip.html</span><br><span class="line">Summary : A file compression and packaging utility compatible with PKZIP</span><br><span class="line">Description :</span><br><span class="line">The zip program is a compression and file packaging utility. Zip is</span><br><span class="line">analogous to a combination of the UNIX tar and compress commands and</span><br><span class="line">is compatible with PKZIP (a compression and file packaging utility for</span><br><span class="line">MS-DOS systems).</span><br><span class="line">Install the zip package if you need to compress files using the zip</span><br><span class="line">program.</span><br></pre></td></tr></table></figure><h4 id="zip-命令用法"><a href="#zip-命令用法" class="headerlink" title="zip 命令用法"></a>zip 命令用法</h4><p>zip 命令可以用来解压缩文件,或者对文件进行打包操作。 zip 是个使用广泛的压缩程序,文件经它压缩后会另外产生具有 “ .zip” 扩展名的压缩文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">语法 zip( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-A :调整可执行的自动解压缩文件;</span><br><span class="line">-b&lt; 工作目录 &gt; :指定暂时存放文件的目录;</span><br><span class="line">-c :替每个被压缩的文件加上注释;</span><br><span class="line">-d :从压缩文件内删除指定的文件;</span><br><span class="line">-D :压缩文件内不建立目录名称;</span><br><span class="line">-f :此参数的效果和指定 “ -u” 参数类似,但不仅更新既有文件,如果某些文件原本不存在于压缩文</span><br><span class="line">件内,使用本参数会一并将其加入压缩文件中;</span><br><span class="line">-F :尝试修复已损坏的压缩文件;</span><br><span class="line">-g :将文件压缩后附加在已有的压缩文件之后,而非另行建立新的压缩文件;</span><br><span class="line">-h :在线帮助;</span><br><span class="line">-i&lt; 范本样式 &gt; :只压缩符合条件的文件;</span><br><span class="line">-j :只保存文件名称及其内容,而不存放任何目录名称;</span><br><span class="line">-J :删除压缩文件前面不必要的数据;</span><br><span class="line">-k :使用 MS-DOS 兼容格式的文件名称;</span><br><span class="line">-l :压缩文件时,把 LF 字符置换成 LF+CR 字符;</span><br><span class="line">-ll :压缩文件时,把 LF+cp 字符置换成 LF 字符;</span><br><span class="line">-L :显示版权信息;</span><br><span class="line">-m :将文件压缩并加入压缩文件后,删除原始文件,即把文件移到压缩文件中;</span><br><span class="line">-n&lt; 字尾字符串 &gt; :不压缩具有特定字尾字符串的文件;</span><br><span class="line">-o :以压缩文件内拥有最新更改时间的文件为准,将压缩文件的更改时间设成和该文件相同;</span><br><span class="line">-q :不显示指令执行过程;</span><br><span class="line">-r :递归处理,将指定目录下的所有文件和子目录一并处理;</span><br><span class="line">-S :包含系统和隐藏文件;</span><br><span class="line">-t&lt; 日期时间 &gt; :把压缩文件的日期设成指定的日期;</span><br><span class="line">-T :检查备份文件内的每个文件是否正确无误;</span><br><span class="line">-u :更换较新的文件到压缩文件内;</span><br><span class="line">-v :显示指令执行过程或显示版本信息;</span><br><span class="line">-V :保存 VMS 操作系统的文件属性;</span><br><span class="line">-w :在文件名称里假如版本编号,本参数仅在 VMS 操作系统下有效;</span><br><span class="line">-x&lt; 范本样式 &gt; :压缩时排除符合条件的文件;</span><br><span class="line">-X :不保存额外的文件属性;</span><br><span class="line">-y :直接保存符号连接,而非该链接所指向的文件,本参数仅在 UNIX 之类的系统下有效;</span><br><span class="line">-z :替压缩文件加上注释;</span><br><span class="line"><span class="meta">-$</span><span class="bash"> :保存第一个被压缩文件所在磁盘的卷册名称;</span></span><br><span class="line">-&lt; 压缩效率 &gt; :压缩效率是一个介于 1~9 的数值。</span><br><span class="line">参数</span><br><span class="line">zip 压缩包:指定要创建的 zip 压缩包;</span><br><span class="line">文件列表:指定要压缩的文件列表。</span><br><span class="line">实例</span><br><span class="line">zip -q -r html.zip /home/Blinux/html</span><br><span class="line">zip -q -r html.zip *</span><br></pre></td></tr></table></figure><h4 id="unzip-的用法"><a href="#unzip-的用法" class="headerlink" title="unzip 的用法"></a>unzip 的用法</h4><p>unzip 命令用于解压缩由 zip 命令压缩的 “ .zip” 压缩包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">语法 unzip( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-c :将解压缩的结果显示到屏幕上,并对字符做适当的转换;</span><br><span class="line">-f :更新现有的文件;</span><br><span class="line">-l :显示压缩文件内所包含的文件;</span><br><span class="line">-p :与 -c 参数类似,会将解压缩的结果显示到屏幕上,但不会执行任何的转换;</span><br><span class="line">-t :检查压缩文件是否正确;</span><br><span class="line">-u :与 -f 参数类似,但是除了更新现有的文件外,也会将压缩文件中的其他文件解压缩到目录中;</span><br><span class="line">-v :执行时显示详细的信息;</span><br><span class="line">-z :仅显示压缩文件的备注文字;</span><br><span class="line">-a :对文本文件进行必要的字符转换;</span><br><span class="line">-b :不要对文本文件进行字符转换;</span><br><span class="line">-C :压缩文件中的文件名称区分大小写;</span><br><span class="line">-j :不处理压缩文件中原有的目录路径;</span><br><span class="line">-L :将压缩文件中的全部文件名改为小写;</span><br><span class="line">-M :将输出结果送到 more 程序处理;</span><br><span class="line">-n :解压缩时不要覆盖原有的文件;</span><br><span class="line">-o :不必先询问用户, unzip 执行后覆盖原有的文件;</span><br><span class="line">-P&lt; 密码 &gt; :使用 zip 的密码选项;</span><br><span class="line">-q :执行时不显示任何信息;</span><br><span class="line">-s :将文件名中的空白字符转换为底线字符;</span><br><span class="line">-V :保留 VMS 的文件版本信息;</span><br><span class="line">-X :解压缩时同时回存文件原来的 UID/GID ;</span><br><span class="line">-d&lt; 目录 &gt; :指定文件解压缩后所要存储的目录;</span><br><span class="line">-x&lt; 文件 &gt; :指定不要处理 .zip 压缩文件中的哪些文件;</span><br><span class="line">-Z : unzip-Z 等于执行 zipinfo 指令</span><br><span class="line"></span><br><span class="line">参数 压缩包:指定要解压的 “ .zip” 压缩包。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">unzip test.zip</span><br><span class="line">unzip -v test.zip</span><br><span class="line">unzip -n test.zip -d /tmp</span><br></pre></td></tr></table></figure><h3 id="gz"><a href="#gz" class="headerlink" title=".gz"></a>.gz</h3><h4 id="gzip-的用法"><a href="#gzip-的用法" class="headerlink" title="gzip 的用法"></a>gzip 的用法</h4><p>gzip 命令用来压缩文件。 gzip 是个使用广泛的压缩程序,文件经它压缩过后,其名称后面会多处 “ .gz”扩展名。 gzip 是在 Linux 系统中经常使用的一个对文件进行压缩和解压缩的命令,既方便又好用。</p><p>gzip 不仅可以用来压缩大的、较少使用的文件以节省磁盘空间,还可以和 tar 命令一起构成 Linux 操作系统中比较流行的压缩文件格式。据统计, gzip 命令对文本文件有 60% ~ 70% 的压缩率。减少文件大小有两个明显的好处,一是可以减少存储空间,二是通过网络传输文件时,可以减少传输的时间。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">语法 gzip( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-a 或 —— ascii :使用 ASCII 文字模式;</span><br><span class="line">-d 或 --decompress 或 ----uncompress :解开压缩文件;</span><br><span class="line">-f 或 —— force :强行压缩文件。不理会文件名称或硬连接是否存在以及该文件是否为符号连接;</span><br><span class="line">-h 或 —— help :在线帮助;</span><br><span class="line">-l 或 —— list :列出压缩文件的相关信息;</span><br><span class="line">-L 或 —— license :显示版本与版权信息;</span><br><span class="line">-n 或 --no-name :压缩文件时,不保存原来的文件名称及时间戳记;</span><br><span class="line">-N 或 —— name :压缩文件时,保存原来的文件名称及时间戳记;</span><br><span class="line">-q 或 —— quiet :不显示警告信息;</span><br><span class="line">-r 或 —— recursive :递归处理,将指定目录下的所有文件及子目录一并处理;</span><br><span class="line">-S 或 &lt; 压缩字尾字符串 &gt; 或 ----suffix&lt; 压缩字尾字符串 &gt; :更改压缩字尾字符串;</span><br><span class="line">-t 或 —— test :测试压缩文件是否正确无误;</span><br><span class="line">-v 或 —— verbose :显示指令执行过程;</span><br><span class="line">-V 或 —— version :显示版本信息;</span><br><span class="line">-&lt; 压缩效率 &gt; :压缩效率是一个介于 1~9 的数值,预设值为 “ 6” ,指定愈大的数值,压缩效率就会</span><br><span class="line">愈高;</span><br><span class="line">--best :此参数的效果和指定 “ -9” 参数相同;</span><br><span class="line">--fast :此参数的效果和指定 “ -1” 参数相同。</span><br><span class="line"></span><br><span class="line">参数 文件列表:指定要压缩的文件或指定要解压的文件。。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">gzip * 将当前目录下的每个文件都压缩成 .gz 文件</span><br><span class="line">gzip test 将 test 文件压缩成 test.gz 文件并删除源文件</span><br><span class="line">gzip -rv /tmp 第归压缩目录中的所有文件,压缩成 .gz 结尾的文件,并显示指令执行过程</span><br><span class="line">gizp -dr /tmp 第归解压 /tmp 目录下的 .gz 结尾的文件</span><br></pre></td></tr></table></figure><h4 id="gunzip-的用法"><a href="#gunzip-的用法" class="headerlink" title="gunzip 的用法"></a>gunzip 的用法</h4><p>gunzip 命令用来解压缩文件。 gunzip 是个使用广泛的解压缩程序,它用于解开被 gzip 压缩过的文件,这些压缩文件预设最后的扩展名为 .gz 。其实压缩或解压缩,都可通过 gzip 指令单独完成。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">语法 gunzip( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-a 或 —— ascii :使用 ASCII 文字模式;</span><br><span class="line">-c 或 --stdout 或 --to-stdout :把解压后的文件输出到标准输出设备;</span><br><span class="line">-f 或 -force :强行解开压缩文件,不理会文件名称或硬连接是否存在以及该文件是否为符号连接;</span><br><span class="line">-h 或 —— help :在线帮助;</span><br><span class="line">-l 或 —— list :列出压缩文件的相关信息;</span><br><span class="line">-L 或 —— license :显示版本与版权信息;</span><br><span class="line">-n 或 --no-name :解压缩时,若压缩文件内含有原来的文件名称及时间戳记,则将其忽略不予处理;</span><br><span class="line">-N 或 —— name :解压缩时,若压缩文件内含有原来的文件名称及时间戳记,则将其回存到解开</span><br><span class="line">的文件上;</span><br><span class="line">-q 或 —— quiet :不显示警告信息;</span><br><span class="line">-r 或 —— recursive :递归处理,将指定目录下的所有文件及子目录一并处理;</span><br><span class="line">-S 或 &lt; 压缩字尾字符串 &gt; 或 ----suffix&lt; 压缩字尾字符串 &gt; :更改压缩字尾字符串;</span><br><span class="line">-t 或 —— test :测试压缩文件是否正确无误;</span><br><span class="line">-v 或 —— verbose :显示指令执行过程;</span><br><span class="line">-V 或 —— version :显示版本信息;</span><br><span class="line"></span><br><span class="line">参数 文件列表:指定要解压的压缩包。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line">gzip -d test.gz</span><br><span class="line">gunzip test.gz</span><br><span class="line">效果一样</span><br></pre></td></tr></table></figure><h3 id="bz2"><a href="#bz2" class="headerlink" title=".bz2"></a>.bz2</h3><h4 id="bzip2-的用法"><a href="#bzip2-的用法" class="headerlink" title="bzip2 的用法"></a>bzip2 的用法</h4><p>bzip2 命令用于创建和管理(包括解压缩) “ .bz2” 格式的压缩包。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">语法 bzip2( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-c 或 —— stdout :将压缩与解压缩的结果送到标准输出;</span><br><span class="line">-d 或 —— decompress :执行解压缩;</span><br><span class="line">-f 或 -force : bzip2 在压缩或解压缩时,若输出文件与现有文件同名,预设不会覆盖现有文件。若</span><br><span class="line">要覆盖。请使用此参数;</span><br><span class="line">-h 或 —— help :在线帮助;</span><br><span class="line">-k 或 —— keep : bzip2 在压缩或解压缩后,会删除原始文件。若要保留原始文件,请使用此参数;</span><br><span class="line">-s 或 —— small :降低程序执行时内存的使用量;</span><br><span class="line">-t 或 —— test :测试 .bz2 压缩文件的完整性;</span><br><span class="line">-v 或 —— verbose :压缩或解压缩文件时,显示详细的信息;</span><br><span class="line">-z 或 —— compress :强制执行压缩;</span><br><span class="line">-V 或 —— version :显示版本信息;</span><br><span class="line">--repetitive-best :若文件中有重复出现的资料时,可利用此参数提高压缩效果;</span><br><span class="line">--repetitive-fast :若文件中有重复出现的资料时,可利用此参数加快执行效果。</span><br><span class="line"></span><br><span class="line">参数 文件列表:指定要压缩的文件或指定要解压的文件。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">bzip2 test 压缩 test 文件,生成压缩文件 test.bz2 ,并删除源文件</span><br><span class="line">bzip2 -k test 压缩 test 文件,生成压缩文件 test.bz2 ,并保留源文件</span><br><span class="line">bzip2 -d test.bz2 解压文件</span><br><span class="line">bunzip2 test.bz2 解压文件</span><br></pre></td></tr></table></figure><h4 id="bunzip2-的用法"><a href="#bunzip2-的用法" class="headerlink" title="bunzip2 的用法"></a>bunzip2 的用法</h4><p>bunzip2 命令解压缩由 bzip2 指令创建的 ” .bz2” 压缩包。对文件进行压缩与解压缩。此命令类似于“ gzip/gunzip” 命令,只能对文件进行压缩。对于目录只能压缩目录下的所有文件,压缩完成后,在目录下生成以 “ .bz2” 为后缀的压缩包。 bunzip2 其实是 bzip2 的符号链接,即软链接,因此压缩解压都可以通过 bzip2 实现。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# which bzip2</span><br><span class="line">/usr/bin/bzip2</span><br><span class="line">[root@mastera0 ~]# which bunzip2</span><br><span class="line">/usr/bin/bunzip2</span><br><span class="line">[root@mastera0 ~]# ll -i /usr/bin/bzip2</span><br><span class="line">33853111 -rwxr-xr-x. 1 root root 36752 Jul 31 2014 /usr/bin/bzip2</span><br><span class="line">[root@mastera0 ~]# ll -i /usr/bin/bunzip2</span><br><span class="line">34293684 lrwxrwxrwx. 1 root root 5 Jun 23 13:50 /usr/bin/bunzip2 -&gt; bzip2</span><br><span class="line"></span><br><span class="line">bunzip2 [ -fkvsVL ] [ filenames ... ]</span><br><span class="line"></span><br><span class="line">-f 或 --force :解压缩时,若输出的文件与现有文件同名时,预设不会覆盖现有的文件;</span><br><span class="line">-k 或 --keep :在解压缩后,预设会删除原来的压缩文件。若要保留压缩文件,请使用此参数;</span><br><span class="line">-s 或 --small :降低程序执行时,内存的使用量;</span><br><span class="line">-v 或 --verbose :解压缩文件时,显示详细的信息;</span><br><span class="line">-l , --license , -V 或 —— version :显示版本信息。</span><br></pre></td></tr></table></figure><h3 id="xz"><a href="#xz" class="headerlink" title=".xz"></a>.xz</h3><p>XZ Utils 是为 POSIX 平台开发具有高压缩率的工具。它使用 LZMA2 压缩算法,生成的压缩文件比POSIX 平台传统使用的 gzip、bzip2 生成的压缩文件更小,而且解压缩速度也很快。最初 XZ Utils的是基于 LZMA-SDK 开发,但是 LZMA-SDK 包含了一些 WINDOWS 平台的特性,所以 XZ Utils 为以适应 POSIX 平台作了大幅的修改。XZ Utils 的出现也是为了取代 POSIX 系统中旧的 LZMA Utils。XZ Utils 主要包含了下列部分:</p><ul><li>命令行程序 xz ,用来生成和解压缩 .xz 压缩文件。</li><li>一组实用的脚本工具 (xzcat, xdiff, xzgrep 等)提供浏览,查找以及比较 .xz 文件内<br>容等功能。</li><li>liblzma 压缩库,提供算法的实现和近似于 ZLIB 的编程接口。</li><li>提供对 LZMA Utils 的一些兼容</li></ul><p>xz 文件格式</p><p>XZ Utils 工具生成的压缩文件扩展名为 .xz (MIME 类型为”application/x-xz”)。</p><p>.xz 文件格式具有下列特点:</p><ul><li>基于数据流: 易于通过管道 (pipe) 生成压缩文件或解压缩文件。.xz 文件格式与 .gz/.bz2 文件一样,不具备对多个文件进行归档打包的能力。若要处理多个文件,可以和归档工具 tar 结合使用,生成扩展名为 .tar.xz 或 .txz 的压缩文件。</li><li>随机读取: 存储的数据被划分为独立的压缩块,并对每个压缩块进行索引,当每个压缩块比较小时,便能够进行有限的随机读取压缩数据。</li><li>完整性验证: 可以使用 CRC32、CRC64、SHA-256 来进行数据的完整性验证,也可以增加自定义验证方法。</li><li>可连接(concatenation): 类似于 .gz/.bz2 文件,可以把多个压缩数据流连接到一个文件中。解压缩时,就像解压一个正常单压缩流文件一样。</li><li>支持多 filter 和 filter 链: 提供自定义 filter 的能力,也能够将多个 filter 组成filter 链,对数据进行处理。这点与 Unix 命令间使用的管道 (pipe) 类似。</li><li>可填充(padding): 可以在 .xz 文件末尾填充二进制’0’以充满特定大小的空间,比如备份磁带上的一个块 (block)。</li></ul><p>XZ Utils 具有高压缩率,解压速度快的特点。能够生成更小文件的同时,也能提供稳定快速的解压,在对数据大小比较敏感的场合,比如说大数据的网络传输,文件的备份,处理能力有限的嵌入系统等场合,有着十分广泛的用途。</p><h4 id="xz-命令用法"><a href="#xz-命令用法" class="headerlink" title="xz 命令用法"></a>xz 命令用法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">语法 xz ( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-z, --compress</span><br><span class="line">force compression 强制压缩</span><br><span class="line">-d, --decompress, --uncompress</span><br><span class="line">force decompression 解开压缩文件</span><br><span class="line">-t, --test test compressed file integrity 测试压缩文件是否正确无误</span><br><span class="line">-l, --list list information about .xz files 列出压缩文件的相关信息</span><br><span class="line">-k, --keep keep (don't delete) input files 不删除源文件</span><br><span class="line">-f, --force force overwrite of output file and (de)compress links 强制压缩,覆盖输出文件同名的文件</span><br><span class="line">-c, --stdout, --to-stdout write to standard output and don't delete input files 写入标准输出,不要删除输入文件</span><br><span class="line">-0 ... -9 compression preset; default is 6; take compressor *and* decompressor memory usage into account before using 7-9! 压缩效率是一个介于</span><br><span class="line">1~9 的数值,预设值为 “ 6” ,指定愈大的数值,压缩效率就会愈高;解压由县考虑使用 7-9</span><br><span class="line">-e, --extreme try to improve compression ratio by using more CPU time; does not affect decompressor memory requirements 通过使用更多的处理器时间</span><br><span class="line">来提高压缩比;不影响解压时的内存需求</span><br><span class="line">-T, --threads=NUM use at most NUM threads; the default is 1; set to 0 to use the number of processor cores 最多使用的线程数量,默认为 1 ,如果设置为</span><br><span class="line">0 去使用处理器内核的数量</span><br><span class="line">-q, --quiet suppress warnings; specify twice to suppress errors too 抑制警告;指定两次</span><br><span class="line">以抑制错误</span><br><span class="line">-v, --verbose be verbose; specify twice for even more verbose</span><br><span class="line">-h, --help display this short help and exit</span><br><span class="line">-H, --long-help display the long help (lists also the advanced options)</span><br><span class="line">-V, --version display the version number and exit</span><br><span class="line"></span><br><span class="line">参数 文件列表:指定要压缩的文件列表。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line">xz test 压缩一个文件 test ,压缩成功后删除源文件</span><br><span class="line">xz -d -k test.xz 解压 test.xz 文件, -k 参数保证源文件不被删除</span><br><span class="line">xz -l test.xz 查看基本信息,包括压缩率等</span><br><span class="line">xz -k7 test 使用参数 -0, -1, -2, ... -6, ... -9 或参数 --fast, --best 设定压缩率。 xz 命令的默认为-6 。</span><br><span class="line">借助 xargs 命令并行压缩多文件。下面的命令行可以将 /var/log 目录下所有的扩展名为 .log 的文件压缩。通过 xargs 命令同时运行多个 xz 进行压缩。</span><br><span class="line">find /var/log -type f -iname "*.log" -print0 | xargs -P4 -n16 xz -T1</span><br><span class="line">注意:运行此命令须有 root 权限。</span><br></pre></td></tr></table></figure><h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><p>tar 命令可以为 linux 的文件和目录创建档案。利用 tar ,可以为某一特定文件创建档案(备份文件),也可以在档案中改变文件,或者向档案中加入新的文件。 tar 最初被用来在磁带上创建档案,现在,用户可以在任何设备上创建档案。利用 tar 命令,可以把一大堆的文件和目录全部打包成一个文件,这对于备份文件或将几个文件组合成为一个文件以便于网络传输是非常有用的。</p><p>首先要弄清两个概念:打包和压缩。</p><ul><li>打包是指将一大堆文件或目录变成一个总的文件;</li><li>压缩则是将一个大的文件通过一些压缩算法变成一个小文件。</li></ul><p>为什么要区分这两个概念呢?</p><p>这源于 Linux 中很多压缩程序只能针对一个文件进行压缩,这样当你想要压缩一大堆文件时,你得先将这一大堆文件先打成一个包( tar 命令),然后再用压缩程序进行压缩( gzip bzip2 命令)。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">语法 tar ( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line">-A 或 --catenate :新增文件到以存在的备份文件;</span><br><span class="line">-B :设置区块大小;</span><br><span class="line">-c 或 --create :建立新的备份文件;</span><br><span class="line">-C &lt; 目录 &gt; :这个选项用在解压缩,若要在特定目录解压缩,可以使用这个选项。</span><br><span class="line">-d :记录文件的差别;</span><br><span class="line">-x 或 --extract 或 --get :从备份文件中还原文件;</span><br><span class="line">-t 或 --list :列出备份文件的内容;</span><br><span class="line">-z 或 --gzip 或 --ungzip :通过 gzip 指令处理备份文件;</span><br><span class="line">-Z 或 --compress 或 --uncompress :通过 compress 指令处理备份文件;</span><br><span class="line">-f&lt; 备份文件 &gt; 或 --file=&lt; 备份文件 &gt; :指定备份文件;</span><br><span class="line">-v 或 --verbose :显示指令执行过程;</span><br><span class="line">-r :添加文件到已经压缩的文件;</span><br><span class="line">-u :添加改变了和现有的文件到已经存在的压缩文件;</span><br><span class="line">-j :支持 bzip2 解压文件;</span><br><span class="line">-J :支持 xz 解压文件;</span><br><span class="line">-v :显示操作过程;</span><br><span class="line">-l :文件系统边界设置;</span><br><span class="line">-k :保留原有文件不覆盖;</span><br><span class="line">-m :保留文件不被覆盖;</span><br><span class="line">-w :确认压缩文件的正确性;</span><br><span class="line">-p 或 --same-permissions :用原来的文件权限还原文件;</span><br><span class="line">-P 或 --absolute-names :文件名使用绝对名称,不移除文件名称前的 “ /” 号;</span><br><span class="line">-N &lt; 日期格式 &gt; 或 --newer=&lt; 日期时间 &gt; :只将较指定日期更新的文件保存到备份文件里;</span><br><span class="line">--exclude=&lt; 范本样式 &gt; :排除符合范本样式的文件。</span><br><span class="line"></span><br><span class="line">参数 文件列表:指定要打包的文件或目录列表。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line">tar -cvf log.tar log2012.log 仅打包,不压缩! tar -xf 解压</span><br><span class="line">tar -zcvf log.tar.gz log2012.log 打包后,以 gzip 压缩 tar -zxf 解压</span><br><span class="line">tar -jcvf log.tar.bz2 log2012.log 打包后,以 bzip2 压缩 tar -jxf 解压</span><br><span class="line">tar -Jcvf log.tar.xz log2012.log 打包后,以 xz 压缩 tar -Jxf 解压</span><br><span class="line">tar -tf log.tar 查看打包文件</span><br><span class="line">注意 -f 参数后面必须接文件名</span><br></pre></td></tr></table></figure><h2 id="04-Linux压缩打包课后习题"><a href="#04-Linux压缩打包课后习题" class="headerlink" title="04-Linux压缩打包课后习题"></a>04-Linux压缩打包课后习题</h2><ol><li>通过dd创建4个5M的文件,分别为afile;bfile;cfile;dfile,并将这4个文件放在/tmp/test目录中保存</li><li>对这4个相同大小的文件进行压缩,分别使用zip;bzip2;gzip;xz,并观察</li><li>在将压缩文件进行解压,并观察</li><li>将/tmp/test目录进行打包,分别使用gzip和bzip2压缩</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Linux压缩打包&quot;&gt;&lt;a href=&quot;#Linux压缩打包&quot; class=&quot;headerlink&quot; title=&quot;Linux压缩打包&quot;&gt;&lt;/a&gt;Linux压缩打包&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;压缩的意义和原理&quot;&gt;&lt;a href=&quot;#压缩的意
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux Bash简介</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/07-Bash%E7%AE%80%E4%BB%8B/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/07-Bash%E7%AE%80%E4%BB%8B/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.292Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Bash简介"><a href="#Bash简介" class="headerlink" title="Bash简介"></a>Bash简介</h1><p>[TOC]</p><h2 id="SHELL"><a href="#SHELL" class="headerlink" title="SHELL"></a>SHELL</h2><h3 id="shell-简介"><a href="#shell-简介" class="headerlink" title="shell 简介"></a>shell 简介</h3><p>Shell 是一个命令解释器, 是人与操作系统之间的桥梁。 我们平时无论任何操作,最终都要操作硬件,比如输入一个字符 “ a ”, 那么信号 首先会从键盘传递到主板,通过主板总线传递到内存,CPU,显卡等,最终经过显卡的运 算完成后在屏幕的某个位置, 显示一个特定字体的字符 “ a ”, 这一整个过程可以说是 不断的和硬件打交道了,但是如果让人去发送这些硬件操作码显然不适合, 因为这不是人干 的事,所以我们有了操作系统,操作系统通过加载一定的硬件驱动,从而控制硬件,操作硬件,那剩下的事就是如何和操作系统通信了,对于普通的系统管理员来说,这也是一件非常困难的事,为了方便人和操作系统沟通, 我们开发了 shell 。</p><p>Shell 可以将我们平时运行的一些指令解释给操作系统执行, 方便管理员操作系统。而 Shell 的脚本其实是一种命令的堆积,我们将所有需要执行的命令, 以从上至下的方 式写在一个文件当中, 交给 shell 去自动解释执行。</p><h3 id="shell-历史"><a href="#shell-历史" class="headerlink" title="shell 历史"></a>shell 历史</h3><p>在 AT&amp;T 的 Dennis Ritchie 和 Ken Thompson 设计 UNIXTM 的时候, 他们想要为 用户创建一种与他们的新系统交流的方法。那时的操作系统带有命令解释器。命令解释器接受用户的命令,然后解释它们,因而计算机可以使用这些命令。 但是 Ritchie 和 Thompson 想要的不只是这些功能,他们想提供比当时的命令解释器 具备更优异功能的工具。这导致了 Bourne shell ( 通称为 sh )的开发, 由 S.R. Bourne 创建。自从 Bourne shell 的创建, 其它 shell 也被一一开发, 如 C shell ( csh ) 和 Korn shell (ksh ) 。</p><p>当自由软件基金会想寻求一种免费的 shell , 开发者们开始致力于 Bourne shell 以及当 时其它 shell中某些很受欢迎的功能背后的语言。 这个开发结果是 Bourne Again Shell , 或称 bash 。虽然你的Red Hat Linux 包括几 种不同的 shell , bash 是为互动用户提供的默认 shell 。</p><h3 id="常见的-shell"><a href="#常见的-shell" class="headerlink" title="常见的 shell"></a>常见的 shell</h3><ul><li>Bourne shell 即 sh : AT&amp;T 贝尔实验室编写的一个交换式的命令解释器。</li><li>C Shell : Bill Joy 于 20 世纪 80 年代早期开发。为了让用户更容易的使用, 他把语法结构变成了 C语言风格。它新增了命令历史、别名、文件名替换、作业控制等功能。</li><li>korn shell (ksh) 是一个 Unix shell 。它由贝尔实验室的 David Korn 在二十世纪八十 年代早期编写。它完全向上兼容 Bourne shell 并包含了 C shell 的很多特性。</li><li>Bourne-Again SHell : bash 是一个为 GNU 项目编写的 Unix shell 。它的名字是一 系列缩写:Bourne-Again SHell — 这是关于 Bourne shell ( sh )的一个双关语( Bourne again / bornagain ) 。 Bourne shell 是一个早期的重要 shell , 由 Stephen Bourne 在 1978 年前后编写,并同 Version 7 Unix 一起发布。 bash 则在 1987 年由 Brian Fox 创造。 在 1990 年, ChetRamey 成为了主要的维护者。 bash 是大多数 Linux 系统以及 Mac OS X v10.4 默认的 shell ,它能运行于大多数 Unix 风格的操作系统之上, 甚至被移植到了 Microsoft Windows 上的 Cygwin 和MSYS 系统中, 以实现 windows 的 POSIX 虚拟接口。此外, 它也被 DJGPP 项目移植到了 MS- DOS 上。</li><li>POSIX shell : POSIX shell 与 Korn shell 非常的相似, 当前提供 POSIX shell 的最大卖主是Hewlett-Packard 。</li></ul><h3 id="为什么-Shell"><a href="#为什么-Shell" class="headerlink" title="为什么 Shell"></a>为什么 Shell</h3><ul><li>解决重复操作的作业。</li><li>节约时间 , 提高工作效率。</li><li>功能强大,使用简单</li></ul><h3 id="etc-shells"><a href="#etc-shells" class="headerlink" title="/etc/shells"></a>/etc/shells</h3><p><code>/etc/shells</code> 文件记录了目前系统中注册过的 shell,每一个用户可以使用一种 shell,可以通过<code>usermod -s</code> 来修改用户 shell,也可以通过<code>chsh</code> 来更改 shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@redhat6 tmp]# chsh carol</span><br><span class="line">Changing shell for carol.</span><br><span class="line">New shell [/bin/csh]: /bin/sh</span><br><span class="line">Shell changed.</span><br><span class="line">[root@redhat6 tmp]# su - carol</span><br><span class="line">-sh-4.1$ tail /etc/passwd -n1</span><br><span class="line">carol:x:60000:60000:carol:/home/carol:/bin/sh</span><br><span class="line">-sh-4.1$</span><br></pre></td></tr></table></figure><h2 id="bash-功能"><a href="#bash-功能" class="headerlink" title="bash 功能"></a>bash 功能</h2><h3 id="history-功能"><a href="#history-功能" class="headerlink" title="history 功能"></a>history 功能</h3><p>history 命令用于显示指定数目的指令命令,读取历史命令文件中的目录到历史命令缓冲区和将历史命令缓冲区中的目录写入命令文件。 该命令单独使用时,仅显示历史命令,在命令行中,可以使用符号!执行指定序号的历史命令。</p><p>例如,要执行第 2 个历史命令,则输入<code>!2</code>。</p><p>历史命令是被保存在内存中的,当退出或者登录 shell 时,会自动保存或读取。在内存中,历史命令仅能够存储 1000 条历史命令,该数量是由环境变量 <code>HISTSIZE</code> 进行控制。</p><p>HISTSIZE 变量 –变量:反复调用的值,以$符号引用</p><p>定义方式:histsize 数字 临时生效</p><p>/etc/profile 里永久定义</p><p>保存位置:~/.bash_history</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">语法 history(选项)(参数)</span><br><span class="line"></span><br><span class="line">选项 -c :清空当前历史命令;</span><br><span class="line">-a :将历史命令缓冲区中命令写入历史命令文件中;</span><br><span class="line">-r :将历史命令文件中的命令读入当前历史命令缓冲区;</span><br><span class="line">-w:将当前历史命令缓冲区命令写入历史命令文件中。</span><br><span class="line"></span><br><span class="line">参数 打印最近的 n 条历史命令</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">!8 使用第八个命令</span><br><span class="line">!Ser 使用该字符串开头的最近的命令</span><br><span class="line">!!调用上一条命令</span><br><span class="line">!$ 调用上一个命令的参数 = alt+.</span><br><span class="line">Ctrl+R 搜索最近包含字符串的命令</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">history</span><br><span class="line">命令用法</span><br><span class="line">history</span><br><span class="line">-c清空缓存</span><br><span class="line">-r  将~/.bash_history历史命令读入缓存</span><br><span class="line"></span><br><span class="line">方便的调用！num</span><br><span class="line">!! 调用最近一次的命令</span><br><span class="line">!关键字 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实战1.你是黑客，窃取别人的历史命令</span><br><span class="line">~/.bash_history</span><br><span class="line">2.为了防止黑客，你怎么防止一些关键命令被窃取，比如配置用户密码，或者数据库密码等</span><br><span class="line">[root@rhel7 ~]# echo "uplooking123"|passwd --stdin superman</span><br><span class="line">Changing password for user superman.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1）清缓冲</span><br><span class="line">2）删除文件</span><br><span class="line"></span><br><span class="line">[root@rhel7 ~]# export HISTCONTROL=ignorespace</span><br><span class="line">[root@rhel7 ~]# echo 1</span><br><span class="line">1</span><br><span class="line">[root@rhel7 ~]# echo 2</span><br><span class="line">2</span><br><span class="line">[root@rhel7 ~]#  echo 3</span><br><span class="line">3</span><br><span class="line">[root@rhel7 ~]# history</span><br><span class="line">1  HISTCONTROL=ignorespace</span><br><span class="line">2  exprot HISTCONTROL=ignorespace</span><br><span class="line">3  export HISTCONTROL=ignorespace</span><br><span class="line">4  echo 1</span><br><span class="line">5  echo 2</span><br><span class="line">6  history</span><br></pre></td></tr></table></figure><h3 id="别名-alias"><a href="#别名-alias" class="headerlink" title="别名 alias"></a>别名 alias</h3><p>alias 命令用来设置指令的别名。我们可以使用该命令可以将一些较长的命令进行简化。使用 alias 时,用户必须使用单引号’’ 将原来的命令引起来,防止特殊字符导致错误。 alias 命令的作用只局限于该次登入的操作。若要每次登入都能够使用这些命令别名,则可将相应的 alias 命令存放到 bash 的初始化文件/etc/bashrc 中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法 alias(选项)(参数)</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line">-p :打印已经设置的命令别名。</span><br><span class="line"></span><br><span class="line">参数 命令别名设置:定义命令别名,格式为 “ 命令别名=‘ 实际命令 ’” 。</span><br><span class="line"></span><br><span class="line">实例 alias 新的命令=' 原命令 -选项/参数'</span><br><span class="line">alias grep=’grep --color=auto’</span><br></pre></td></tr></table></figure><ul><li>~/.bashrc 针对单个用户生效</li><li>/etc/bashrc 针对全局生效</li></ul><p>实战</p><ol><li>我的工作路径在/tmp/justice/superman/dir1/，每天登陆的服务器都很累，因为要天天输入cd /tmp/justice/superman/dir1/,有什么办法能够轻松一点呢？让我少输入一点命令呢？</li><li>取消我刚刚设置的别名unalias</li></ol><h3 id="tab-键补全功能"><a href="#tab-键补全功能" class="headerlink" title="tab 键补全功能"></a>tab 键补全功能</h3><p>单击补全命令,如果没办法补全,双击可以显示以该字符串开始的文件名都有哪些。(或者命令都有哪些)</p><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><ul><li>Ctrl +A 跳行首</li><li>Ctrl +L 清屏</li><li>Ctrl +e 跳行尾</li><li>Ctrl +c 中断</li><li>Ctrl +R 搜索</li><li>ctrl +d logout</li></ul><h2 id="用户登录流程"><a href="#用户登录流程" class="headerlink" title="用户登录流程"></a>用户登录流程</h2><p>学习用户登录流程的意义:</p><p>我们之前有提到过几个变量,比如 histsize、比如 umask 等。这些功能都可以是针对于某一个用户去设置的。那么我们是怎么知道具体要把这些相关配置信息写入哪一个文件呢?哪一个文件是用于全局的变量的设置的,哪一个文件针对单个用户生效,哪一个文件里面的配置字段会覆盖之前的配置字段呢?这就要用到我们的用户登录流程了。</p><p>五个配置文件的顺序:</p><p>我们用户在登录的时候,会调用一系列的文件,这些文件包括</p><ul><li>/etc/profile</li><li>/etc/profile.d 目录下的所有文件</li><li>/.bash_profile</li><li>~/.bashrc</li><li>/etc/bashrc</li></ul><p>这是我们系统登录过程中用到的五个文件,我们一一来查看。</p><p>/etc/profile</p><p>/etc/profile 里面包含了配置字段 include /etc/profile.d 。这个 include 代表扩展配置文件,当读取该文件的时候,会读取相应的一些扩展配置文件。</p><p>我们通常不会把所有的东西都往一个文件里面去写,一方面是由于全往一个文件里面去写会导致文件特别大,另一方面,不方便我们的修改文件的灵活度。我们要从一个大篇幅的配置文件中找到某一行,非常的累,那么我们就可以将配置文件也分门别类的去写。比如说我创建了一个新的程序,这个程序需要一些变量的设置,我就可以将这些变量写成一个新的文件,放在/etc/profile.d 目录下,那么当我读取 profile 的时候一样能够读到该文件,当我不需要那个程序了,我也不用去找这个配置字段了,直接把对应的配置文件删除就可以了吧。</p><p>~/.bash_profile</p><p>接下来回去读<del>/.bash_profile 文件,由于是家目录下的,这是属于用户个人本身的配置文件,也就是说,写在这个配置文件当中的变量,只针对对应的用户生效。该文件里写的内容一部分是去读取</del>/.bashrc 文件,一部分写了 path 变量的相关内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> .bash_profile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Get the aliases and <span class="built_in">functions</span></span></span><br><span class="line">if [ -f ~/.bashrc ]; then</span><br><span class="line">. ~/.bashrc</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> User specific environment and startup programs</span></span><br><span class="line">PATH=$PATH:$HOME/bin</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure><h3 id="PATH-变量"><a href="#PATH-变量" class="headerlink" title="PATH 变量"></a>PATH 变量</h3><p>PATH 变量是我们系统中的相关命令的路径。PATH 的作用,简化我们的命令写法。</p><p>我们执行的命令一般都在 PATH 指定的路径中,比如说我们的 useradd 命令,实际上执行的是/usr/sbin/useradd ,再比如说 touch 命令,实际上执行的是/bin/touch 命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# echo $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">[root@mastera0 ~]# which useradd</span><br><span class="line">/usr/sbin/useradd</span><br><span class="line">[root@mastera0 ~]# which touch</span><br><span class="line">/usr/bin/touch</span><br><span class="line">[root@mastera0 ~]# vim pathtest</span><br><span class="line">[root@mastera0 ~]# ll pathtest</span><br><span class="line">-rw-r--r--. 1 root root 26 Jun 24 16:58 pathtest</span><br><span class="line">[root@mastera0 ~]# chmod +x pathtest</span><br><span class="line">[root@mastera0 ~]# ll pathtest</span><br><span class="line">-rwxr-xr-x. 1 root root 26 Jun 24 16:58 pathtest</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">-bash: pathtest: command not found</span><br><span class="line">[root@mastera0 ~]# ./pathtest</span><br><span class="line">this is a PATH-test!</span><br><span class="line">[root@mastera0 ~]# cp pathtest /usr/local/bin</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">this is a PATH-test!</span><br><span class="line">[root@mastera0 ~]# which pathtest</span><br><span class="line">/usr/local/bin/pathtest</span><br></pre></td></tr></table></figure><p>那么 PATH 也有一个读取顺序,优先会从第一个位置开始找,比如说我们去/usr/local/sbin 下面创建一个同名的可执行文件 pathtest,内容如下:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# vim pathtest</span><br><span class="line">[root@mastera0 ~]# cp pathtest /usr/local/sbin</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">this is a PATH-test!</span><br><span class="line">[root@mastera0 ~]# ./pathtest</span><br><span class="line">New! I am /usr/local/sbin this is a PATH-test!</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">this is a PATH-test!</span><br><span class="line">[root@mastera0 ~]# export PATH</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">New! I am /usr/local/sbin this is a PATH-test!</span><br></pre></td></tr></table></figure><p>这个就是 PATH 的读取顺序,由于第二个 pathtest 命令的路径/usr/local/sbin 优先于第一个</p><p>pathtest 命令的路径/usr/local/bin,所以执行了第二个 pathtest即/usr/local/sbin/pathtest。然后我们把第二个 pathtest 删除 <code>rm -rf /usr/local/sbin/pathtest</code>,重新 export 一下PATH,export 是设置环境变量的意思。之后我们讲到脚本会去说</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# rm -rf /usr/local/sbin/pathtest</span><br><span class="line">[root@mastera0 ~]# export PATH</span><br><span class="line">[root@mastera0 ~]# pathtest</span><br><span class="line">this is a PATH-test!</span><br></pre></td></tr></table></figure><p>那么这时候再来看一下执行结果是不是又回来了。</p><p>最后,读完这两个<del>/.bash_profile 和</del>/.bashrc 以后,系统最后再去读/etc/bashrc。</p><p>这是我们整个的流程。先后读取顺序分别是</p><ol><li>/etc/profile</li><li>/etc/profile.d/*</li><li>~/.bash_profile</li><li>~/.bashrc</li><li>/etc/bashrc</li></ol><p>记住,后面写的变量会覆盖之前的变量值,所以我们想让哪些变量生效,就一定要清楚写在什么位置。</p><p>比如说,我希望只能够给 student 用户使用的别名应该写到~/.bashrc 目录下</p><p>我希望让全局生效的参数可以放置在/etc/profile 目录下。</p><p><code>Su</code> 和 <code>su -</code>的区别:这就是用户登录流程要注意的事情,系统里面有个很典型的例子,就是 su</p><p><code>Su</code> 代表切换用户。用法是 <code>su - 用户名</code>,或者<code>su</code> 直接跟上用户名。前者叫标准切换,后者叫非标准切换。</p><p>非标准切换有些变量是拿不到的。所以你可以看到 su 之后,我们的位置还在切换之前的位置,而我们 <code>su -</code> 的位置已经切换到用户的家目录了。</p><p>那么是哪些变量没拿到呢?</p><p>我们来做个小实验。</p><p>演示 给 5 个配置文件的头部分别写上 <code>echo &quot;xxx (配置文件名) start&quot;</code>,尾部写上 <code>echo &quot;xxxx(配置文件名) stop&quot;</code></p><p> <code>Man bash</code> 可以告诉你登录流程的相关内容。</p><h3 id="PS1-变量"><a href="#PS1-变量" class="headerlink" title="PS1 变量"></a>PS1 变量</h3><p>/etc/bashrc 中有一个变量 PS1,我们一起来看看他的作用。</p><p><code>man bash</code> 后搜索 ps1 关键词</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\d :代表日期,格式为 weekday month date,例如:"Mon Aug 1"</span><br><span class="line">\H :完整的主机名称。例如:我的机器名称为:fc4.linux,则这个名称就是 fc4.linux</span><br><span class="line">\h :仅取主机的第一个名字,如上例,则为 fc4,.linux 则被省略</span><br><span class="line">\t :显示时间为 24 小时格式,如:HH:MM:SS</span><br><span class="line">\T :显示时间为 12 小时格式</span><br><span class="line">\A :显示时间为 24 小时格式:HH:MM</span><br><span class="line">\u :当前用户的账号名称</span><br><span class="line">\v :BASH 的版本信息</span><br><span class="line">\w :完整的工作目录名称。家目录会以 ~代替</span><br><span class="line">\W :利用 basename 取得工作目录名称,所以只会列出最后一个目录</span><br><span class="line"> :下达的第几个命令</span><br><span class="line">\$ :提示字符,如果是 root 时,提示符为:# ,普通用户则为:$</span><br></pre></td></tr></table></figure><p>the在 PS1 中设置字符序列颜色的格式为:[\e[F;Bm]</p><ul><li><p>F为字体颜色,编号 30~37;</p></li><li><p>B为背景色,编号 40~47 。</p></li><li><p>取消设置:[\e[m]</p></li></ul><p>颜色表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">前景 背景 颜色</span><br><span class="line">30 40 黑色</span><br><span class="line">31 41 红色</span><br><span class="line">32 42 绿色</span><br><span class="line">33 43 黄色</span><br><span class="line">34 44 蓝色</span><br><span class="line">35 45 紫红色</span><br><span class="line">36 46 青蓝色</span><br><span class="line">37 47 白色</span><br><span class="line"></span><br><span class="line">代码</span><br><span class="line">意义</span><br><span class="line">0 OFF</span><br><span class="line">1 高亮显示</span><br><span class="line">4 underline</span><br><span class="line">7 反白显示</span><br><span class="line">8 不可见</span><br></pre></td></tr></table></figure><p>举例:</p><p>PS1=’[[\e[32m]###[\e[31m]\u@[\e[36m]\h \w]$[\e[m]‘</p><ul><li><p>[\e[32m] 设置为绿色</p></li><li><p>### 显示现在运行的是第几条命令</p></li><li><p>[\e[31m] 设置为红色</p></li><li><p>\u@ 当前用户的账号名称@</p></li><li><p>[\e[36m] 青蓝色</p></li><li><p>\h \w</p></li><li><p>\h 仅取主机的第一个名字,\w 是说:显示完整的路径,但是不知到为什么家他显示~而不是绝对路径。</p></li><li><p>[\e[m] 使用来关闭颜色设置的。</p></li></ul><p>要是你没有这个的话;那么,你的命令提示符,包括你通过命令提示符输出的东西都是和最后一次的颜色设置相同( 除了一些有特殊意义的文件 )。</p><p>这个配置写到哪里呢???</p><p>如果只想让当前用户生效,那么应该在用户的根目录下的 “.bashrc”,在里头的最后一行加上,然后保存。然后 source .bashrc 或者 “. .bashrc” 或者注销一下。如果想让所有用户生效,该放哪里?思考题</p><h2 id="Bash简介课后作业"><a href="#Bash简介课后作业" class="headerlink" title="Bash简介课后作业"></a>Bash简介课后作业</h2><ol><li>要求 student 用户登录的时候获取 umask 值为 044, 并且该 值永久生效。</li><li>要求所有普通用户登录时, 最后获取到的 HISTSIZE 值为 500, 而 root 用户获取到的 HISTSIZE 的值为 1000 。</li><li>梳理一下五个文件的登录顺序。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Bash简介&quot;&gt;&lt;a href=&quot;#Bash简介&quot; class=&quot;headerlink&quot; title=&quot;Bash简介&quot;&gt;&lt;/a&gt;Bash简介&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;SHELL&quot;&gt;&lt;a href=&quot;#SHELL&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux 软件安装</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/05-Linux%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/05-Linux%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.289Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux-软件安装"><a href="#Linux-软件安装" class="headerlink" title="Linux 软件安装"></a>Linux 软件安装</h1><p>[TOC]</p><h2 id="源代码安装"><a href="#源代码安装" class="headerlink" title="源代码安装"></a>源代码安装</h2><ul><li>优势 : 可定制，紧跟发布，及时修正Bug</li><li>缺点 : 操作复杂 , 编译时间长 , 极易出现错误，大面积部署复杂且低效，安全性隐患大</li></ul><h3 id="源代码安装步骤"><a href="#源代码安装步骤" class="headerlink" title="源代码安装步骤"></a>源代码安装步骤</h3><ul><li>下载解压,阅读软件包附带的 install 文件和 readme 文件,获取软件的相关信息。</li><li>进入解包之后的目录,执行 “ ./configure” 命令，使用参数设置编译环境和编译模块，例如<code>--prefix</code>为编译做好关于本地环境的配置。</li><li>配置成功后,执行 “ make” 命令进行软件编译。</li><li>编译成功后,执行 “ make install” 命令完成安装。</li><li>最后,执行 “ make clean” 命令删除安装时产生的临时文件</li></ul><h3 id="卸载步骤"><a href="#卸载步骤" class="headerlink" title="卸载步骤"></a>卸载步骤</h3><ul><li>先进入软件的安装目录,然后执行卸载命令即可:<code>make uninstall</code></li><li>如果有的软件包不提供 uninstall 功能,则必须进行手动删除。因此你需要阅读安装目录里面的readme 文件,或者在安装的过程中指定安装目录,即在 ./configure 命令后面添加参数 –prefix ,例如:<code>./configure --prefix=/usr/local/dir</code></li><li>该命令将把软件安装在 /usr/local/ 路径的 dir 目录里。通常情况下,大多数软件都默认安装在 /usr/local 目录里。</li></ul><h3 id="MPlayer源码安装实验"><a href="#MPlayer源码安装实验" class="headerlink" title="MPlayer源码安装实验"></a>MPlayer源码安装实验</h3><blockquote><p>下载软件包到系统某个目录下，本次演示中使用/tmp/mplayer/目录，软件包包括主程序、库函数、皮肤</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget ....</span><br><span class="line">all-20071007.tar.bz2库函数</span><br><span class="line">Blue-1.7.tar.bz2皮肤</span><br><span class="line">MPlayer-1.0rc2.tar.bz2主程序</span><br></pre></td></tr></table></figure><blockquote><p>将压缩包解压</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -jxf</span><br></pre></td></tr></table></figure><blockquote><p>创建目录用来存放库函数</p></blockquote><p><code>mkdir  /usr/local/lib/codes</code></p><blockquote><p>将/tmp/mplayer/all/目录下所有文件复制到/usr/local/lib/codes</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp all-20071007/* /usr/local/lib/codes</span><br><span class="line">ll /usr/local/lib/codes</span><br></pre></td></tr></table></figure><blockquote><p>安装依赖包</p></blockquote><p><code>yum install -y kernel-devel gcc  zlib-devel  gtk2-devel</code></p><blockquote><p>检查安装环境</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp/mplayer/MPlayer-1.0rc2</span><br><span class="line">./configure --enable-gui --codecsdir=/usr/local/lib/codes --enable-x11  --enable-xshape  --language=zh_CN --disable-ivtv --disable-png</span><br></pre></td></tr></table></figure><blockquote><p>编译make</p></blockquote><p><code>make</code></p><blockquote><p>安装</p></blockquote><p><code>make install</code></p><blockquote><p>装皮肤</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这部分不是代码，而是程序装在了哪里</span><br><span class="line">  Install prefix: /usr/local</span><br><span class="line">  Data directory: /usr/local/share/mplayer</span><br><span class="line">  Config direct.: /usr/local/etc/mplayer</span><br></pre></td></tr></table></figure><ul><li>创建目录<code>mkdir /usr/local/share/mplayer/skins/default/</code></li><li>将皮肤文件复制到/usr/local/share/mplayer/default/目录中<br><code>cp /tmp/mplayer/Blue/* /usr/local/share/mplayer/skins/default/</code></li></ul><blockquote><p>从真机桌面用鼠标双击打开图形化界面的rhel6，去测试，是否安装成功。</p></blockquote><p><code>applications---&gt;sound&amp;video----&gt;mplayer</code></p><hr><h2 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h2><p>直接解压缩即可使用</p><p>例如 mycat 数据库代理服务器<br>安装 mycat ,直接解压缩即可使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf Mycat-server-1.5.1-RELEASE-20160328130228-linux.tar.gz -C /usr/local</span><br><span class="line">cd /usr/local;ls</span><br><span class="line">cd mycat;ll</span><br><span class="line">chmod 755 * -R</span><br><span class="line">vim conf/schema.xml</span><br><span class="line">vim conf/server.xml</span><br><span class="line">bin/mycat start</span><br></pre></td></tr></table></figure><h2 id="RPM"><a href="#RPM" class="headerlink" title="RPM"></a>RPM</h2><p>RPM : redhat package management</p><p>rpm 命令是 RPM 软件包的管理工具。 rpm 原本是 Red Hat Linux 发行版专门用来管理 Linux 各项套件的程序,由于它遵循 GPL 规则且功能强大方便,因而广受欢迎。逐渐受到其他发行版的采用。 RPM 套件管理方式的出现,让 Linux 易于安装,升级,间接提升了 Linux 的适用度。</p><p>rpm 的命名规范 : 软件名 - 版本号 - 操作系统平台</p><p>libreoffice4.1-calc-4.1.6.2-1.x86_64.rpm</p><p>zlib-1.2.3-29.el6.x86_64.rpm</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">语法 rpm ( 选项 )( 参数 )</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line"></span><br><span class="line">-a :查询所有套件;</span><br><span class="line">-b&lt; 完成阶段 &gt;&lt; 套件档 &gt;+ 或 -t &lt; 完成阶段 &gt;&lt; 套件档 &gt;+ :设置包装套件的完成阶段,并指定套件档的文件名称;</span><br><span class="line">-c :只列出组态配置文件,本参数需配合 "-l" 参数使用;</span><br><span class="line">-d :只列出文本文件,本参数需配合 "-l" 参数使用;</span><br><span class="line">-e&lt; 套件档 &gt; 或 --erase&lt; 套件档 &gt; :删除指定的套件;</span><br><span class="line">-f&lt; 文件 &gt;+ :查询拥有指定文件的套件;</span><br><span class="line">-h 或 --hash :套件安装时列出标记;</span><br><span class="line">-i :显示套件的相关信息;</span><br><span class="line">-i&lt; 套件档 &gt; 或 --install&lt; 套件档 &gt; :安装指定的套件档;</span><br><span class="line">-l :显示套件的文件列表;</span><br><span class="line">-p&lt; 套件档 &gt;+ :查询指定的 RPM 套件档;</span><br><span class="line">-q :使用询问模式,当遇到任何问题时, rpm 指令会先询问用户;</span><br><span class="line">-R :显示套件的关联性信息;</span><br><span class="line">-s :显示文件状态,本参数需配合 "-l" 参数使用;</span><br><span class="line">-U&lt; 套件档 &gt; 或 --upgrade&lt; 套件档 &gt; :升级指定的套件档;</span><br><span class="line">-v :显示指令执行过程;</span><br><span class="line">-vv :详细显示指令执行过程,便于排错。</span><br><span class="line"></span><br><span class="line">参数 软件包:指定要操纵的 rpm 软件包。</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line">install 安装</span><br><span class="line">1)rpm -ivh [x.rpm] 安装 v\h 显示安装过程中的进度条 verbose\hash</span><br><span class="line">query 查询</span><br><span class="line">2)rpm -q [ 软件名称 ] 查看软件是否安装</span><br><span class="line">3)rpm -qi [ 软件名称 ] 查看软件的详细信息</span><br><span class="line">4)rpm -ql [ 软件名称 ] 查看软件在系统中安装过的文件</span><br><span class="line">5)rpm -qf [ 文件名称 ] 查看文件是由哪个软件包安装出来的</span><br><span class="line">6)rpm -qa 查看系统里所有已经安装过的软件包</span><br><span class="line">卸载 remove</span><br><span class="line">6)rpm -e [ 软件名称 ] 卸载软件</span><br><span class="line">rpm -e --nodeps 不卸载依赖关系</span><br><span class="line">update 升级</span><br><span class="line">7)rpm -U [ 软件名称 ] 升级 , 若没有该软件则安装</span><br><span class="line">8)rpm -F [ 软件名称 ] 升级 , 若没有该软件则不安装</span><br></pre></td></tr></table></figure><h2 id="YUM"><a href="#YUM" class="headerlink" title="YUM"></a>YUM</h2><h3 id="yum-的作用"><a href="#yum-的作用" class="headerlink" title="yum 的作用"></a>yum 的作用</h3><p>作用 : 为了解决包之间的依赖关系而存在的一种管理机制 , 基于 rpm 为前端的包管理机制 .<br>为了解决依赖关系 , 引入了一种仓库的机制 .</p><h3 id="yum-仓库"><a href="#yum-仓库" class="headerlink" title="yum 仓库"></a>yum 仓库</h3><p>仓库 : 用来存放软件和软件之间的依赖关系 , 当我们需要安装软件的时候 , 就可以通过该依赖关系 , 来将相应的依赖包都装上 .repodata 目录就是 yum 的仓库 , 存放软件和软件之间的依赖关系数据 .</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 dvd]# ll repodata/ -d</span><br><span class="line">dr-xr-xr-x. 2 root root 4096 Nov 12</span><br><span class="line">[root@rhel6 dvd]#pwd</span><br><span class="line">/mnt/rhel6.5/x86_64/dvd</span><br></pre></td></tr></table></figure><h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3><p>安装系统的光盘中已经有建号的依赖关系了,即 repodata/ 目录,如果要自己手动制作 rpm 包依赖关系目录,该怎么做呢?</p><h4 id="安装软件-createrepo"><a href="#安装软件-createrepo" class="headerlink" title="安装软件 createrepo"></a>安装软件 createrepo</h4><p>rhel7 默认已经安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 ~]# yum install -y createrepo</span><br><span class="line">Loaded plugins: langpacks, product-id, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager</span><br><span class="line">to register.</span><br><span class="line">server</span><br><span class="line">| 4.1 kB 00:00:00</span><br><span class="line">(1/2): server/group_gz</span><br><span class="line">| 134 kB 00:00:00</span><br><span class="line">(2/2): server/primary_db</span><br><span class="line">| 3.4 MB 00:00:00</span><br><span class="line">Package createrepo-0.9.9-23.el7.noarch already installed and latest version</span><br><span class="line">Nothing to do</span><br></pre></td></tr></table></figure><p>rhel6 要自己安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel6 rc.d]# yum install -y createrepo</span><br><span class="line">Loaded plugins: product-id, refresh-packagekit, security, subscription-manager</span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager</span><br><span class="line">to register.</span><br><span class="line">server</span><br><span class="line">Running Transaction</span><br><span class="line">Installing : deltarpm-3.5-0.5.20090913git.el6.x86_64</span><br><span class="line">1/3</span><br><span class="line">Installing : python-deltarpm-3.5-0.5.20090913git.el6.x86_64</span><br><span class="line">2/3</span><br><span class="line">Installing : createrepo-0.9.9-18.el6.noarch</span><br><span class="line">3/3</span><br><span class="line">Verifying : createrepo-0.9.9-18.el6.noarch</span><br><span class="line">1/3</span><br><span class="line">Verifying : python-deltarpm-3.5-0.5.20090913git.el6.x86_64</span><br><span class="line">2/3</span><br><span class="line">Verifying : deltarpm-3.5-0.5.20090913git.el6.x86_64</span><br><span class="line">3/3</span><br><span class="line">Installed:</span><br><span class="line">createrepo.noarch 0:0.9.9-18.el6</span><br><span class="line">Dependency Installed:</span><br><span class="line">deltarpm.x86_64 0:3.5-0.5.20090913git.el6</span><br><span class="line">Complete!</span><br><span class="line">python-deltarpm.x86_64 0:3.5-0.5.20090913git.el64.3.2 制作 rpm 包依赖关系目录</span><br></pre></td></tr></table></figure><p>以 rhel7 为例从学校服务器上拷贝一些软件到 /tmp/dvd7.1/ 目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# cp /mnt/rhel7.1/x86_64/dvd/Packages/* /tmp/dvd7.1</span><br><span class="line">[root@rhel7 tmp]# cd /tmp/dvd7.1</span><br></pre></td></tr></table></figure><p>制作 rpm 包依赖关系</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 dvd7.1]# createrepo /tmp/dvd7.1/</span><br><span class="line">Spawning worker 0 with 4371 pkgs</span><br><span class="line">Workers Finished</span><br><span class="line">Saving Primary metadata</span><br><span class="line">Saving file lists metadata</span><br><span class="line">Saving other metadata</span><br><span class="line">Generating sqlite DBs</span><br><span class="line">Sqlite DBs complete</span><br></pre></td></tr></table></figure><p>已经成功创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# ll dvd7.1/ |grep repodata</span><br><span class="line">drwxr-xr-x. 2 root root 4096 Mar 18 07:42 repodata</span><br></pre></td></tr></table></figure><h3 id="配置仓库"><a href="#配置仓库" class="headerlink" title="配置仓库"></a>配置仓库</h3><p>为此 , 我们需要优先去配置一个仓库指向文件。这个文件的位置在 /etc/yum.repos.d/ 目录下 , 以 .repo 结尾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel7 tmp]# cd /etc/yum.repos.d/</span><br><span class="line">[root@rhel7 yum.repos.d]# ls</span><br><span class="line">server.repo</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[ 仓库名 ]</span><br><span class="line">name = 说明信息</span><br><span class="line">baseurl = 指向 repodata 目录的上一级 .</span><br><span class="line">enable = 是否启用该仓库 0 代表不启用 ,1 代表启用</span><br><span class="line">gpgcheck = 是否需要检测</span><br><span class="line">其中 baseurl</span><br><span class="line">1. 本地路径 file:///content/rhel6.5..... 以下省略 第三个 / 代表的是根 .</span><br><span class="line">2. 远程路径 协议 :// 位置</span><br><span class="line">      例:   http://</span><br><span class="line">       ftp://</span><br><span class="line">       nfs://</span><br><span class="line">       </span><br><span class="line">[server]</span><br><span class="line">name = rhel7.1 repos</span><br><span class="line">baseurl = http://classroom.example.com/content/rhel6.5/x86_64/dvd/</span><br><span class="line">enable=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">[test]</span><br><span class="line">name = info</span><br><span class="line">baseurl=file:///tmp/dvd7.1/</span><br><span class="line">enable=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure><p>配置完仓库后 , 需要使用</p><ul><li>yum clean all 来清理缓存</li><li>yum makecache 来重新生成缓存 .4.5 yum 安装</li></ul><p>安装</p><ul><li>yum install 软件名 安装指定软件</li><li>yum groupinstall 组名 用来安装一系列的软件包 ,</li><li>yum reinstall 软件名 重新安装指定软件</li></ul><p>-y 选项 , 忽略安装过程出现的 is this ok的交互信息</p><ul><li>yum localinstall 软件名 本地安装指定软件</li></ul><p>查询</p><ul><li>yum list 用来查询所有的软件包</li><li>yum list installed 用来查看已经安装过的软件包</li><li>yum search 字符串 能够将说明信息里含该字符串的相关软件包罗列出来</li><li>yum info 软件包名 用来查看软件包的详细信息</li><li>yum grouplist 组名 用来查询系统里所有的组包</li><li>yum groupinfo 组名 用来查询指定组的相关信息</li></ul><p>升级</p><ul><li>yum update 软件名</li><li>yum upgrade 软件名</li></ul><p>两种写法执行效果没有区别</p><p>卸载</p><ul><li>yum remove 软件名</li></ul><p>不要使用 yum 去卸载 , 会将软件的依赖关系一并卸载掉 .</p><h2 id="Linux-软件安装课后作业"><a href="#Linux-软件安装课后作业" class="headerlink" title="Linux 软件安装课后作业"></a>Linux 软件安装课后作业</h2><ol><li>配置一个 yum 仓库。熟悉一下配置的几个字段内容。</li><li>安装 vsftpd 软件。</li><li>查看 vsftpd 软件的安装文件有哪些</li><li>查看一下 touch 命令是由哪个软件包安装出来的</li><li>搜索一下含 bind 字符串的软件包。</li><li>查询一下 httpd 软件有没有安装 , 没有则将该软件装上。</li><li>查看一下 httpd 软件的版本号及试用平台。</li><li>卸载 vsftpd 软件。</li><li>卸载 httpd 软件 , 不要卸载与其有依赖关系的软件包</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Linux-软件安装&quot;&gt;&lt;a href=&quot;#Linux-软件安装&quot; class=&quot;headerlink&quot; title=&quot;Linux 软件安装&quot;&gt;&lt;/a&gt;Linux 软件安装&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;源代码安装&quot;&gt;&lt;a href=&quot;#源代码
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux Vim 编辑器</title>
    <link href="http://www.toberoot.com/2016/12/22/booboo_linux_base/06-Vim%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    <id>http://www.toberoot.com/2016/12/22/booboo_linux_base/06-Vim%E7%BC%96%E8%BE%91%E5%99%A8/</id>
    <published>2016-12-21T20:06:27.000Z</published>
    <updated>2020-03-23T06:07:52.318Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Vim-编辑器"><a href="#Vim-编辑器" class="headerlink" title="Vim 编辑器"></a>Vim 编辑器</h1><p>[TOC]</p><h2 id="Vim-简介"><a href="#Vim-简介" class="headerlink" title="Vim 简介"></a>Vim 简介</h2><p><img src="pic/10.png" alt="10.png"></p><p>Vim 是 Linux 系统上的最著名的文本/ 代码编辑器,也是早年的 Vi编辑器的加强版，而 gVim 则是其 Windows 版。它的最大特色是完全使用键盘命令进行编辑，脱离了鼠标操作虽然使得入门变得困难,但上手之后键盘流的各种巧妙组合操作却能带来极为大幅的效率提升。</p><p>因此 Vim 和现代的编辑器(如 Sublime Text)有着非常巨大的差异,而且入门学习曲线陡峭,需要记住很多按键组合和命令,如今被看作是高手、Geek 们专用的编辑器。尽管 Vim 已经是古董级的软件,但还是有无数新人迎着困难去学习使用,可见其经典与受欢迎程度。</p><p>另外,由于 Vim 的可配置性非常强,各种插件、语法高亮配色方案等多不胜数,无论作为代码编辑器或是文稿撰写工具都非常给力！</p><p>在 Linux 系统中配置应用服务,实际上就是在修改它的配置文件(配置文件可能有多个,其中包含不同的参数), 而且日常工作中也一定免不了编写文档的事情吧, 这些都是要通过文本编辑器来完成的。</p><p>在热门 Linux 操作系统中都会默认安装vim。</p><h3 id="Vim-难以驾驭的神器"><a href="#Vim-难以驾驭的神器" class="headerlink" title="Vim - 难以驾驭的神器"></a>Vim - 难以驾驭的神器</h3><p>神器总是很难驾驭的,主角总得付出一些努力才能收获到更加强大的力量,对于 Vim 这种上古神器来说更是如此。由于它全程使用键盘操作,你必须记住一堆快捷键、按键组合以及各种命令才能开始使用,很多首次接触 Vim 的人会觉得越学越复杂而中途放弃。然而,坚持下来的朋友就会渐渐地发现这种键盘流操作的设计绝妙之处!</p><p>如果你是一位 IT 界人士,需要或将要与 Linux 系统打交道,那么学习好 Vim 的操作绝对能让你的工作轻松百倍!!</p><p>因为很多时候, Linux 作为服务器是不会开启图形界面,当需要远程操作时,你只能利用SSH“ 命令字符式 ” 的 Shell 界面对其进行操作,这时如果你需要修改服务器上的网页代码或配置文件,VI或 VIM 命令就是你最佳最方便也是最强大的伙伴了!相信我,学好 数理化 VIM ,走遍天下也不怕！</p><h3 id="Vim-入门帮助"><a href="#Vim-入门帮助" class="headerlink" title="Vim 入门帮助"></a>Vim 入门帮助</h3><p><img src="pic/11.png" alt="11.png"></p><p>下面首先对 Vim 做一下最基本的介绍,并给出一些参考信息,以方便对 Vim 不熟悉的读者也能够理解并自<br>己查阅进一步信息。</p><p>Vim 带有完整的帮助文档。</p><ol><li>进入 Vim 后输入 “ :help”即可访问</li><li>新手在操作系统的命令行上输入 vimtutor 命令即可开始学习一个简单的 30 分钟的 Vim 教程2 Vim 命令</li></ol><h3 id="Vim-模式介绍"><a href="#Vim-模式介绍" class="headerlink" title="Vim 模式介绍"></a>Vim 模式介绍</h3><p><img src="pic/12.png" alt="12.png"></p><p>与大部分其它编辑器不同,进入 Vim 后,缺省状态下键入的字符并不会插入到所编辑的文件之中。Vim 的<br>模式(mode ,可以简单地理解为 “ 状态 ” )概念非常重要。需要知道,Vim 有以下几个模式:</p><ul><li>正常(normal)模式,缺省的编辑模式;下面如果不加特殊说明,提到的命令都直接在正常模式下<br>输入;任何其它模式中都可以通过键盘上的 Esc 键回到正常模式。</li><li>命令(command)模式 ,用于执行较长、较复杂的命令;在正常模式下输入 “ :” (一般命令)、 “ /”<br>(正向搜索)或 “ ?”(反向搜索)即可进入该模式;命令模式下的命令要输入回车键(Enter)才算完成。</li><li>插入(insert)模式 ,输入文本时使用;在正常模式下键入 “ i”(insert )或 “ a”(append)即可<br>进入插入模式(也有另外一些命令,如 “ c”,也可以进入插入模式,但这些命令有其它的作用)。</li><li>可视(visual)模式 ,用于选定文本块;可以在正常模式下输入 “ v”(小写)来按字符选定,输入<br>“V” (大写)来按行选定,或输入 “ Ctrl-V”来按方块选定。</li><li>选择(select)模式 ,与普通的 Windows 编辑器较为接近的选择文本块的方式;在以可视模式和<br>选择模式之一选定文本块之后,可以使用 “ Ctrl-G” 切换到另一模式 —— 该模式很少在 Linux 上使用,本<br>文中就不再介绍了。</li></ul><h3 id="正常模式"><a href="#正常模式" class="headerlink" title="正常模式"></a>正常模式</h3><p><img src="pic/13.png" alt="13.png"></p><h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p><img src="pic/14.png" alt="14.png"></p><h3 id="插入模式"><a href="#插入模式" class="headerlink" title="插入模式"></a>插入模式</h3><ul><li>i 光标所在位置插入</li><li>I 光标所在位置行首插入</li><li>o 光标所在位置下方新开一行插入</li><li>O 光标所在位置上方新开一行插入</li><li>a 光标所在位置下一个字符的位置插入</li><li>A 光标所在位置行行尾插入</li></ul><h2 id="Vim-实例"><a href="#Vim-实例" class="headerlink" title="Vim 实例"></a>Vim 实例</h2><p>本实例作为基础教程,拓展部分见附录《Vim 用户手册中文版 7.2》</p><p><img src="pic/15.png" alt="15.png"></p><h3 id="Vim-第一步"><a href="#Vim-第一步" class="headerlink" title="Vim 第一步"></a>Vim 第一步</h3><h4 id="首次运行-Vim"><a href="#首次运行-Vim" class="headerlink" title="首次运行 Vim"></a>首次运行 Vim</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# ll file1</span><br><span class="line">-rw-r--r--. 1 root root 274 Jun 24 12:19 file1</span><br><span class="line">[root@mastera0 ~]# vim file1</span><br></pre></td></tr></table></figure><p>使 Vim 开始编辑一个名为 file1 的文件。屏幕上看起来大致是这样:</p><ul><li>“黑色块” 代表当前光标位置;</li><li>上波浪线(~)表示所在行并不是文件内容的一部分。换句话说,Vim 将 文件之外的部分显示为波浪线;</li><li>在窗口的底部, 一个消息行显示说当前正 在编辑的文件叫 file1,它有 16 行,274 个字符。但前光<br>标所在位置为第一行的第一位</li></ul><p><img src="pic/16.png" alt="16.png"></p><p>如果是新文件呢?</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# vim file</span><br></pre></td></tr></table></figure><p><img src="pic/17.png" alt="17.png"></p><p>在窗口的底部, 一个消息行显示说当前正 在编辑的文件叫 file,并且它是一个新文件。</p><h4 id="插入文本"><a href="#插入文本" class="headerlink" title="插入文本"></a>插入文本</h4><p>Vim 编辑器是一个模式编辑器。这意味着在不同状态下编辑器有不同 的行为模式。两个基本的模式 Normal<br>模式和 Insert 模式。在 Normal 模式下你键入的每一个字符都被视为一个命令。而在 Insert 模式下键入<br>的字符 都作为实际要输入的文本内容。 刚启动时 Vim 工作于 Normal 模式。要进入 Insert 模式你需要使<br>用”i” 命 令(i 意为 Insert)。接下来就可以直接输入了。别怕出错, 错了还可以修 改。比如下面这首程序<br>员的打油诗:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A very intelligent turtle</span><br><span class="line">Found programming UNIX a hurdle</span><br></pre></td></tr></table></figure><p>“turtle” 之后你按下回车键另起一行。最后按下 <Esc> 键退出 Insert 模式 ,回到 Normal 模式。现在你的Vim 窗口中有了这样的两行内容 :</p><p><img src="pic/18.png" alt="18.png"></p><p>现在是什么模式?</p><p>要知道你现在所处的工作模式是什么,打开显示模式的开关:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set showmode</span><br><span class="line">:set noshowmode 关闭显示模式</span><br></pre></td></tr></table></figure><p><img src="pic/19.png" alt="19.png"></p><p>你会看到按下冒号键之后当前光标跑到窗口的最后一行去了。那是使用冒 号命令的地方(顾名思义,冒号命<br>令就是总是以冒号打头的命令) 。最后按 下回车键结束整个命令(所有的冒号命令都以这种方式表明命令的<br>结束).</p><p>现在,如果你键入了”i”命令 Vim 就会在窗口底部显示–INSERT– 。这 表明你目前处于 Insert 模式。<br>如 果 按 下<Esc> 键 返 回 到 Normal 模 式 刚 才 显 示 出 来 的 模 式”–INSERT– 就会消失 ;Normal模式并不会显示 — NORMAL–,作为默认的工作模式它不显示任何字串。</p><p>Vim 新手最头痛的问题就是模式—经常忘记自己置身于何种模式, 或者不经意敲了哪个字符就切换到别的<br>模式去了。</p><p>不管你当前所处的模 式是什么,按下<Esc>都会让你回到 Normal 模式(即使已经在 Normal 模式 下)。有时<br>需要按两次<Esc>,如果 Vim 以一声蜂鸣回答你, 那说明你已经 是在 Normal 模式了。</p><h4 id="移动光标"><a href="#移动光标" class="headerlink" title="移动光标"></a>移动光标</h4><p>回到 Normal 模式后 , 你就可以用下面的命令来移动光标 :</p><ul><li>h 左</li><li>j 下</li><li>k 上</li><li>l 右</li></ul><p>人们一开始会认为这些字符是随意选取的。毕竟有谁 l 来代 表 right 呢 ? 但事实上 , 这些字符都是精心挑选的 :</p><p>在编辑器中移动光 标是十分常用的操作 , 这些字符在键盘上都分布在你右手周围。这样的安 排可以使你最快<br>最方便地使用它们 ( 尤其是对那些用十个手指而不是二指 禅用户而言 ) 。</p><p>备注 : 同时你还可以用箭头键来移动光标。不过这样做实 际上会大大降低你的效率。因为用这些键你需要不<br>停地在 字母区和箭头键之间频繁转换。想象一下要是你在一小时 内这样做一百次会占用你多少时间 ? 另外 , 并<br>不是每个键 盘上都安排有箭头键 , 或者都把它们放在最常见的位置 ; 所以使用 hjkl 还是大有好处。</p><p>练习文件名位 hjkl ,放在共享当中。如果进入了插入模式不要忘了要用 <Esc> 回到 Normal 模 式。 |<br>vimtutor| 也是学习这些命令的一个好去处。</p><p>记住:学习这些命令的最好办法不是使用什么记忆法 , 而是练习。</p><h4 id="删除字符"><a href="#删除字符" class="headerlink" title="删除字符"></a>删除字符</h4><p>要删除一个字符,只需要将光标移到该字符上按下”x”. ( 这是在追 忆古老的打字机时代,在打字机上删除字<br>符就是用 xxxx 来覆盖它) 把光标 移到上面例子中的第一行,键入 xxxxxxx(7 个 x) 来删除”A very “。</p><p>输入其它内容<br>比如:首先键入的命令是 i( 进 入 Insert 模 式), 接着插入”A young”, 然后 退 出 Insert 模式(最后的<Esc>)。</p><p>删除一行</p><p>删除一整行内容使用”dd”命令。删除后下面的行会移上来填补空缺:2.1.5 撤消与重做</p><p>撤销一次操作</p><p>如果你误删了过多的内容。显然你可以再输入一遍,但是命令”u” 更 简便, 它可以撤消上一次的操作 1 。<br>实际看一下它的效果,用”dd” 命令来 删除前面例子中的第一行内容,”u”命令会把它找回来。</p><p>重做<br>如果你撤消了多次,你还可以用 CTRL-R(重做) 来反转撤消的动作。换 句话说,它是对撤消的撤消。</p><p>撤销一行操作</p><p>撤消命令还有另一种形式,”U”命令, 它一次撤消对一行的全部操作。第 二次使用该命令则会撤消前一<br>个”U”的操作。</p><ul><li>删除 very</li><li>删除 turtle</li><li>用”u”撤消”U”</li><li>用”U” 恢复该行</li></ul><p>“U”命令本身也造成了一次改变,这种改变同样可以用”u” 命令 和 CTRL-R 来撤消和重做。看起来这很容易<br>把人搞糊涂,不过别担心, 用”u”和 CTRL-R 你可以找回任何一个操作状态。</p><h4 id="其它编辑命令"><a href="#其它编辑命令" class="headerlink" title="其它编辑命令"></a>其它编辑命令</h4><p>Vim 有一大堆命令来改变文本。这里仅列 出一些最常用的。</p><p>追加 a</p><p>“i” 命令可以在当前光标之前插入文本。但如果你想在当前行的末尾 添加一些内容时怎么办呢?你必需在光<br>标之后插入文本。答案是用”a” 命 令来代替”i”。</p><p>另起一行 o\O</p><ol><li>“o”命令可以在当前行的下面另起一行,并使当前模式转为 Insert 模 式。这样你可以在该命令之后直接输<br>入内容。假设光标位于下面两行中第 一行的某处:</li><li>“O”命令(注意是大写的字母 O)将在当前行的上面另起一行。</li></ol><p>使用命令计数</p><p>假设你要向上移动 9 行。这可以用”kkkkkkkkk”或”9k” 来完成。事实 上,很多命令都可以接受一个数字作<br>为重复执行同一命令的次数。比如刚 才的例子,要在行尾追加三个感叹号,当时用的命令是”a!!!<Esc>“。<br>另 一个办法是用”3a!<Esc>“命令。</p><p>3 说明该命令将被重复执行 3 次。同样, 删 除 3 个字符可以用”3x”。指<br>定的数字要紧挨在它所要修饰的命令前面。</p><h4 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h4><p>要退出 Vim,用命令”ZZ”。该命令保存当前文件并退出 Vim.</p><p>放弃编辑 :q!</p><p>有时你会在做了一连串修改之后突然意识到最好是放弃所有的修改重 新来过。别担心。Vim 中有一个命令可<br>以丢弃所有的修改并退出:<br>:q!<br>别忘了在命令之后加回车。</p><p>放弃编辑并重新载入 :e!</p><p>如果你在放弃所有修改后还想以该文件的初始内容作为开始继续编 辑,还可以用”:e!”命令放弃所有修改并<br>重新载入该文件的原始内容。</p><p>保存并退出:wq :wq!</p><p>一般我们都是需要保存并退出的,有一些文件保存的时候需要强制保存退出,这时加上!即可。比<br>如/etc/shadow2.1.8 求助</p><p>你想做的任何操作都可以在 Vim 的帮助文件里找到答案, 别怕问问 题!<br>:help</p><p>会带你到帮助文件的起始点。</p><p>如果你没有指定一个具体的帮助主题,”:help” 命令会显示上面提到 的帮助文件的起点。Vim 的作者聪明地<br>(也许是懒惰地) 设计了它的帮助系 统: 帮助窗口也是一个普通的编辑窗口。你可以使用跟编辑其它文件时一<br>样的命令来操作帮助文件。比如用 hljk 移动光标。</p><p>退出帮助窗口也跟退出其它文件编辑窗口一样,使用”ZZ” 即可。这只 会关闭帮助窗口,而不是退出 Vim.<br>浏览帮助文件时,你会注意到有一些内容用两个小栅栏围了起来( 比 如|help|)。这表明此处是一个超链接。<br>如果你把光标置于两个小栅栏之间的任何位置然后按下 CTRL-](跳转到一个标签的命令),帮助系统就会带<br>你 到那个指定的主题。(因为一些此处不便讨论的原因,在 Vim 的术语中这种 超链接叫标签。所以 CTRL-]<br>可以跳转到当前光标之下的那个 word 所对应的 链接中 1 。</p><p>几次跳转之后,你可能想回到原来的某个地方,CTRL-T(弹出标签) 可 以回到前一个位置。用命令 CTRL-<br>O(跳转到较早的位置) 也可以。 帮助窗口的开始有一个关于<em>help.txt*的说明。在星号”</em>“ 之间的字 符被<br>帮助系统定义为一个标签的目的地(超链接的目的地).</p><p>要查看关于某个特殊主题的帮助,使用下面的命令形式:<br><code>:help {subject}</code></p><p>例如,查看关于 showmode 的帮助<br><code>:help showmode3.2 改动</code></p><h4 id="光标的指定移动"><a href="#光标的指定移动" class="headerlink" title="光标的指定移动"></a>光标的指定移动</h4><p>“G”命令 指定一 个命令计数, 这个命令就会把光标定位到由命令计数指定的行上。比 如”33G”就会把光标<br>置于第 33 行上。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mastera0 ~]# cp /var/log/messages messages</span><br><span class="line">[root@mastera0 ~]# vim messages</span><br></pre></td></tr></table></figure><p>没有指定命令计数作为参数的话 :</p><ul><li>“G” 会 把 光 标 定 位 到 最 后 一 行 上</li><li>“gg”命令是跳转到第一行的快捷的方法。”1G”效果也是一样, 但是敲 起来就没那么顺手了。</li><li>“%”命令 另一个移动到某行的方法是在命令”%” 之前指定一个命令计数 。 如”50%”将会把光标定位在文件的中间;比”90%” 跳到接文件尾的地 方 。</li></ul><h4 id="简单搜索"><a href="#简单搜索" class="headerlink" title="简单搜索"></a>简单搜索</h4><p>“/string”命令</p><p>“/string”命令可用于搜索一个字符串。比如要找到单词”mysql”, 使用命令:<br><code>/mysql</code></p><p>要查找上次查找的字符串的下一个位置。使用”n” 命令。如果你知 道你要找的确切位置是目标字符串的第几<br>次出现,还可以在”n” 之前放置 一个命令计数。”3n”会去查找目标字符串的第 3 次出现。向光标所在位置以<br>上查找用”N”。</p><p>“?string”命令</p><p>“?”命令与”/“的工作相同,只是搜索方向相反。比如要找到单词”mysql”, 使用命令:<br><code>?mysql忽略大小写</code></p><p>通常情况下你要准确地键入你要查找的东西。如果你并不关心目标字 符中字母的大小写,可以通过设<br>置’ignorecase’选项:<br><code>:set ignorecase</code></p><p>取消则设置’noignorecase’选项:<br><code>:set noignorecase</code></p><p>如果你在编辑一段源程序时看到了一个叫”nr” 的变量。你想查看一 下这个变量就被用在了哪些地方。简单<br>的办法是把光标移到”nr” 上然后 用”*” 命令和”n” 命令一个一个地查找所有的匹配。<br>不过还有更好的办法。使用下面的命令:<br><code>:set hlsearch</code></p><p>现在你要再查找”nr”, Vim 就会以某种形式高亮显示所有符合的匹配。对 于想查看一个变量被用在哪些地<br>方,这个办法太棒了, 不需任何其它的命 令 看得眼花的时候还可以关闭这一功能:<br><code>:set nohlsearch</code></p><p>不过你要在下次搜索时再次使用这一功能就又得打开它。如果你只是想去 掉当前的高亮显示,可以使用下面<br>的命令 :<br><code>:nohlsearch</code></p><h4 id="复制粘贴"><a href="#复制粘贴" class="headerlink" title="复制粘贴"></a>复制粘贴</h4><p>要把文本内容从一处复制到另一处</p><ol><li>先删除 dd 再粘贴 p</li><li>“y” 操作符命令会把文本复制到一个寄存器 中。然后可以用”p”命令把它取回。</li></ol><p>“y”命令</p><ul><li>“yw”来复制一个 word;</li><li>“y2w”命令复制两个 word;</li><li>“yy”复制一行;</li><li>“3yy”复制光标所在行和向下的行,一共三行;</li></ul><p>例如:</p><ol><li>复制 file 文件中的 turtle 并粘贴到该行的最后;</li><li>复制 file 文件中的 intelligent turtle 并粘贴到该行的最后;</li><li>复制 file 文件中的第二行并粘贴到第四行;</li><li>复制 file 文件中的第一行第二行第三行,并粘贴到第五行第六行第七行。</li></ol><h4 id="替换字符"><a href="#替换字符" class="headerlink" title="替换字符"></a>替换字符</h4><ul><li>:s/UNIX/linux 对光标所在行第一个出现的 UNIX 替换成 linux</li><li>:s/UNIX/linux /g 对光标所在行所有 UNIX 都替换成 linux , g 表示全行替换</li><li>:% s/UNIX/linux /g 将全文中的 carol 都替换位 natasha , “%” 指定该命令将作用于所有行上</li></ul><h3 id="Vim-的保护机制"><a href="#Vim-的保护机制" class="headerlink" title="Vim 的保护机制"></a>Vim 的保护机制</h3><p>如果我们没有通过 q 退出,而是通过其他方式强行退出,比如说直接关终端,会导致 vim 的一个报错,当我<br>们下次打开这个文件的时候,会提示<br><code>Found a swap file by the name &quot;.file.swp&quot;</code></p><p>这是因为 vim 他不是实时写入的机制,他会先把文件写到内存,等我们执行 w 操作以后,再写回到原文件。<br>那么在写回原文件,或者执行 q 的放弃操作之前,会生成一个临时的文件,以 . 开头, swp 结尾。当我们看<br>到这种情况,就说明这个文件是在变编辑的过程中强制退出的,或者是正在被人编辑。</p><p>所以这个文件的作用就是防止强制退出造成的数据安全隐患,和防止文件同时被多次修改。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Swap file ".file.swp" already exists!</span><br><span class="line">[O]pen Read-Only, (E)dit anyway, (R)ecover, (D)elete it, (Q)uit, (A)bort:</span><br></pre></td></tr></table></figure><p>我们可以根据他的提示执行相应的操作,比如说 Q ,退出。如果想要顺利编辑这个文件的话,一方面可以使<br>用 E ,无论如何也要编辑,或者先退出,把 swp 文件删除了以后再编辑,也是可以的。</p><p>注意:要使用 vim 需要注意一下权限问题,必须要有读写权限才能使用 vim 。</p><p>可以看一下没有写权限和没有读权限会出现什么问题。</p><hr><h2 id="Vim-编辑器课后作业"><a href="#Vim-编辑器课后作业" class="headerlink" title="Vim 编辑器课后作业"></a>Vim 编辑器课后作业</h2><ol><li>复制<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>的配置文件位/tmp/test</li><li>使用vim编辑该文件，练习不同模式的切换，尤其是正常变插入模式的几种用法</li><li>练习保存的几种命令，包括保存退出，不保存退出。</li><li>vim练习游戏<br> vim大冒险官网    vim-adventures.com</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Vim-编辑器&quot;&gt;&lt;a href=&quot;#Vim-编辑器&quot; class=&quot;headerlink&quot; title=&quot;Vim 编辑器&quot;&gt;&lt;/a&gt;Vim 编辑器&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;Vim-简介&quot;&gt;&lt;a href=&quot;#Vim-简介&quot; class=
      
    
    </summary>
    
    
      <category term="技术培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux系统基础培训" scheme="http://www.toberoot.com/categories/%E6%8A%80%E6%9C%AF%E5%9F%B9%E8%AE%AD/Linux%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD/"/>
    
    
      <category term="培训" scheme="http://www.toberoot.com/tags/%E5%9F%B9%E8%AE%AD/"/>
    
      <category term="Linux" scheme="http://www.toberoot.com/tags/Linux/"/>
    
  </entry>
  
</feed>
